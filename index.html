<!DOCTYPE html>
<html lang="tg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–∞–≤–æ–º–æ—Ç v7 ‚Äî —Ç–∞–Ω–∑–∏–º–æ—Ç–∏ –≥—É—Ä”Ø“≥”£</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --blue:#3b82f6;--blue-d:#1d4ed8;--blue-l:#eff6ff;--blue-m:#dbeafe;
  --red:#ef4444;--green:#10b981;--green-l:#ecfdf5;
  --yellow:#f59e0b;--orange:#f97316;
  --purple:#8b5cf6;--purple-l:#f5f3ff;
  --teal:#0d9488;--pink:#ec4899;
  --gray:#6b7280;--gray-l:#f9fafb;--border:#e5e7eb;
  --text:#111827;--muted:#6b7280;
  --sh:0 1px 3px rgba(0,0,0,.1);--sh-md:0 4px 12px rgba(0,0,0,.1);
  --r:12px;--rl:16px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Rubik',sans-serif;background:#f1f5f9;color:var(--text);min-height:100vh}

/* LOGIN */
.login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#1e3a8a,#3b82f6);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
.login-box{background:#fff;border-radius:24px;padding:30px 24px;width:100%;max-width:360px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.login-logo{text-align:center;font-size:3rem;margin-bottom:8px}
.login-title{text-align:center;font-family:'Nunito',sans-serif;font-weight:900;font-size:1.5rem;color:var(--blue-d);margin-bottom:4px}
.login-sub{text-align:center;font-size:.8rem;color:var(--muted);margin-bottom:20px}
.login-err{background:#fee2e2;color:#dc2626;border-radius:8px;padding:8px 12px;font-size:.8rem;margin-bottom:10px;display:none}

/* HEADER */
.hdr{background:linear-gradient(135deg,#1e3a8a,#3b82f6 70%,#60a5fa);color:#fff;position:sticky;top:0;z-index:50;box-shadow:0 4px 20px rgba(59,130,246,.4)}
.hdr-top{padding:10px 14px;display:flex;align-items:center;justify-content:space-between}
.hdr-brand{display:flex;align-items:center;gap:9px}
.hdr-logo{width:32px;height:32px;background:rgba(255,255,255,.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1rem}
.hdr-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.1rem}
.hdr-sub{font-size:.64rem;opacity:.8}
.hdr-user{display:flex;align-items:center;gap:7px;font-size:.76rem;font-weight:600}
.hdr-avatar{width:28px;height:28px;background:rgba(255,255,255,.25);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;cursor:pointer}

.nav{display:flex;background:rgba(0,0,0,.18)}
.nitem{flex:1;padding:8px 2px;text-align:center;font-size:.63rem;font-weight:600;color:rgba(255,255,255,.6);cursor:pointer;border-bottom:3px solid transparent;transition:.18s;display:flex;flex-direction:column;align-items:center;gap:2px}
.nitem .ni{font-size:.95rem}
.nitem.active{color:#fff;border-bottom-color:#f97316;background:rgba(255,255,255,.12)}
.nitem:hover{color:#fff}

.page{display:none;padding:12px;animation:pIn .2s ease;min-height:calc(100vh - 104px)}
.page.active{display:block}
@keyframes pIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

.card{background:#fff;border-radius:var(--rl);box-shadow:var(--sh);margin-bottom:10px;overflow:hidden}
.card-h{padding:11px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ctitle{font-family:'Nunito',sans-serif;font-weight:800;font-size:.88rem;color:var(--blue-d);display:flex;align-items:center;gap:6px}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:4px;padding:7px 13px;border-radius:8px;border:none;font-family:'Rubik',sans-serif;font-weight:600;font-size:.78rem;cursor:pointer;transition:.15s;white-space:nowrap}
.btn:active{transform:scale(.95)}
.bb{background:var(--blue);color:#fff}.bb:hover{background:var(--blue-d)}
.bg{background:var(--green);color:#fff}.bg:hover{background:#059669}
.br{background:var(--red);color:#fff}
.bgh{background:var(--gray-l);color:var(--text);border:1px solid var(--border)}.bgh:hover{background:var(--border)}
.bpur{background:var(--purple);color:#fff}
.bor{background:var(--orange);color:#fff}
.bsm{padding:5px 10px;font-size:.73rem;border-radius:7px}
.bxs{padding:3px 7px;font-size:.67rem;border-radius:6px}
.bico{width:30px;height:30px;padding:0;border-radius:7px}
.bblk{width:100%}

.fg{margin-bottom:10px}
.fl{display:block;font-size:.7rem;font-weight:700;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.3px}
.fc{width:100%;padding:8px 11px;border:2px solid var(--border);border-radius:8px;font-family:'Rubik',sans-serif;font-size:.845rem;color:var(--text);background:#fff;transition:border-color .17s}
.fc:focus{outline:none;border-color:var(--blue)}
.fr{display:flex;gap:8px}.fr .fg{flex:1}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;align-items:flex-end;justify-content:center}
.overlay.open{display:flex;animation:fIn .17s}
@keyframes fIn{from{opacity:0}to{opacity:1}}
.modal{background:#fff;border-radius:20px 20px 0 0;padding:16px 16px 28px;width:100%;max-width:500px;max-height:92vh;overflow-y:auto;animation:sUp .27s cubic-bezier(.34,1.56,.64,1)}
@keyframes sUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}
.mh{width:36px;height:4px;background:var(--border);border-radius:4px;margin:0 auto 13px}
.mt{font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;margin-bottom:12px}
.mf{display:flex;gap:8px;margin-top:12px}

/* GROUP */
.gcrd{background:#fff;border-radius:var(--rl);box-shadow:var(--sh);margin-bottom:9px;border-left:5px solid var(--blue);transition:box-shadow .2s}
.gcrd.s2{border-left-color:var(--orange)}
.gcrd:hover{box-shadow:var(--sh-md)}
.gct{padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
.gcn{font-family:'Nunito',sans-serif;font-weight:800;font-size:.9rem}
.gcc{font-size:.7rem;color:var(--muted);margin-top:2px}
.gca{padding:0 11px 10px;display:flex;gap:6px;border-top:1px solid var(--border);padding-top:8px}

/* STUDENT */
.srow{display:flex;align-items:center;gap:10px;padding:9px 13px;border-bottom:1px solid var(--border);transition:background .13s;cursor:pointer}
.srow:last-child{border-bottom:none}
.srow:hover{background:var(--blue-l)}
.ava{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.78rem;flex-shrink:0}
.sn{font-weight:600;font-size:.84rem}
.ss{font-size:.68rem;color:var(--muted);margin-top:1px}

/* ATT */
.att-wrap{overflow-x:auto}
.att-table{width:100%;border-collapse:collapse;font-size:.76rem}
.att-table thead th{background:var(--blue);color:#fff;padding:5px 3px;text-align:center;font-weight:700;white-space:nowrap;position:sticky;top:0;z-index:10}
.att-table thead th.nc{text-align:left;min-width:105px;position:sticky;left:0;z-index:15;background:#1e3a8a}
.att-table thead th.sc{background:#1e3a8a;min-width:70px;position:sticky;right:0;z-index:11}
.att-table tbody td{padding:3px 2px;text-align:center;border-bottom:1px solid var(--border);vertical-align:middle}
.att-table tbody td.nc{text-align:left;padding:6px 9px;position:sticky;left:0;background:#fff;z-index:5;border-right:2px solid #93c5fd}
.att-table tbody td.sc{position:sticky;right:0;background:#fff;border-left:2px solid #93c5fd;font-size:.68rem;padding:3px 4px;white-space:nowrap;z-index:6}
.att-table tr:nth-child(even) td{background:#f9fafb}
.att-table tr:nth-child(even) td.nc{background:#f4f7fb}
.att-table tr:nth-child(even) td.sc{background:#f4f7fb}
.att-table td.ds{border-left:2px solid #93c5fd!important}
.att-table th.snh{background:#dc2626!important}
.att-table td.snd{background:#fff1f2!important}
.att-table tr:nth-child(even) td.snd{background:#ffe4e6!important}

.ac{width:26px;height:22px;border-radius:5px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:.67rem;cursor:pointer;transition:transform .11s;user-select:none;margin:auto}
.ac:active{transform:scale(.87)}
.ac:hover{transform:scale(1.18);box-shadow:0 2px 8px rgba(0,0,0,.2)}
.ce{background:#f1f5f9;color:#cbd5e1;border:1px dashed #cbd5e1}
.ca{background:#fee2e2;color:#dc2626;border:1px solid #fca5a5}
.cs{background:#fef3c7;color:#d97706;border:1px solid #fcd34d}
.cu{background:#dbeafe;color:#2563eb;border:1px solid #93c5fd}
.sn2{color:var(--red);font-weight:800}
.sb2{color:var(--yellow);font-weight:700}
.su2{color:var(--blue);font-weight:700}

.vt{display:flex;background:var(--border);border-radius:10px;padding:3px;margin-bottom:9px}
.vtb{flex:1;padding:6px;text-align:center;border-radius:8px;font-size:.74rem;font-weight:600;cursor:pointer;color:var(--muted);transition:.17s}
.vtb.active{background:#fff;color:var(--blue-d);box-shadow:var(--sh)}

.dbar{display:flex;align-items:center;gap:7px;background:#fff;border-radius:var(--r);padding:8px 11px;margin-bottom:9px;box-shadow:var(--sh)}
.dn{width:28px;height:28px;border-radius:7px;background:var(--blue-l);border:none;color:var(--blue);font-size:.88rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700}
.dn:hover{background:var(--blue-m)}
.dl{flex:1;text-align:center;font-weight:700;font-size:.84rem}

.sopt{display:flex;align-items:center;gap:11px;padding:10px 13px;border-radius:var(--r);border:2px solid var(--border);cursor:pointer;transition:.13s;margin-bottom:6px}
.sopt:hover{border-color:var(--blue);background:var(--blue-l)}
.sopt-i{font-size:1.3rem;width:30px;text-align:center}
.sopt-l{font-weight:700;font-size:.84rem}
.sopt-s{font-size:.67rem;color:var(--muted)}

/* STATS */
.sgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:10px}
.sbox{background:#fff;border-radius:var(--r);padding:10px;text-align:center;box-shadow:var(--sh)}
.snum{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.45rem}
.slbl{font-size:.64rem;color:var(--muted);font-weight:600;margin-top:1px}

/* CHARTS */
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.chart-box{background:#fff;border-radius:var(--rl);box-shadow:var(--sh);padding:12px;text-align:center}
.chart-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:.8rem;color:var(--blue-d);margin-bottom:8px}
canvas{max-width:100%;height:auto}

/* PIE manual */
.pie-wrap{position:relative;width:120px;height:120px;margin:0 auto 8px}
.pie-legend{display:flex;flex-direction:column;gap:4px;font-size:.7rem}
.pie-legend-item{display:flex;align-items:center;gap:5px}
.pie-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

/* BAR */
.bar-wrap{display:flex;align-items:flex-end;gap:3px;height:80px;padding:0 4px}
.bar-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.bar-rect{width:100%;border-radius:4px 4px 0 0;min-height:2px;transition:height .3s}
.bar-label{font-size:.55rem;color:var(--muted);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:35px}
.bar-val{font-size:.6rem;font-weight:700;color:var(--text)}

/* TABS segment */
.seg{display:flex;background:var(--border);border-radius:10px;padding:3px;margin-bottom:9px}
.seg-b{flex:1;padding:6px;text-align:center;border-radius:8px;font-size:.73rem;font-weight:600;cursor:pointer;color:var(--muted);transition:.17s}
.seg-b.active{background:#fff;color:var(--blue-d);box-shadow:var(--sh)}
.seg-b.s2.active{color:#92400e;background:#fef3c7}

/* SETTINGS */
.set-s{margin-bottom:12px}
.set-t{font-size:.68rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.35px;margin-bottom:6px;padding:0 3px}
.srow2{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;background:#fff;border-bottom:1px solid var(--border)}
.srow2:first-child{border-radius:var(--r) var(--r) 0 0}
.srow2:last-child{border-bottom:none;border-radius:0 0 var(--r) var(--r)}
.srow2:only-child{border-radius:var(--r)}

.sh-tabs{display:flex;gap:6px;margin-bottom:9px}
.sh-tab{flex:1;padding:7px;text-align:center;border-radius:9px;font-size:.76rem;font-weight:700;cursor:pointer;border:2px solid var(--border);background:#fff;transition:.17s;color:var(--muted)}
.sh-tab.s1.active{border-color:var(--blue);color:var(--blue-d);background:var(--blue-l)}
.sh-tab.s2.active{border-color:var(--orange);color:#92400e;background:#fef3c7}

/* TEACHER */
.tcrd{background:#fff;border-radius:var(--rl);box-shadow:var(--sh);margin-bottom:8px;overflow:hidden}
.tcrd-top{padding:11px 13px;display:flex;align-items:center;gap:10px}
.t-ava{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;color:#fff;flex-shrink:0}
.t-name{font-weight:700;font-size:.88rem}
.t-sub{font-size:.7rem;color:var(--muted);margin-top:1px}
.t-badge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:.65rem;font-weight:700;margin-left:4px}
.perm-toggle{display:flex;flex-wrap:wrap;gap:5px;padding:8px 12px;border-top:1px solid var(--border)}
.perm-chip{padding:4px 10px;border-radius:20px;font-size:.72rem;font-weight:600;cursor:pointer;border:2px solid var(--border);background:var(--gray-l);color:var(--muted);transition:.15s;user-select:none}
.perm-chip.on{background:var(--blue-l);border-color:var(--blue);color:var(--blue-d)}
.perm-chip.off{background:#fee2e2;border-color:#fca5a5;color:#dc2626}

/* GROUPS assign */
.g-assign{display:flex;flex-wrap:wrap;gap:5px;padding:8px 12px;border-top:1px solid var(--border)}
.g-chip{padding:4px 9px;border-radius:20px;font-size:.7rem;font-weight:600;cursor:pointer;border:2px solid var(--border);background:var(--gray-l);color:var(--muted);transition:.15s;user-select:none}
.g-chip.on{background:var(--green-l);border-color:var(--green);color:#065f46}

/* SMS */
.sms-row{display:flex;align-items:flex-start;padding:9px 12px;border-bottom:1px solid var(--border);gap:8px}
.sms-row:last-child{border-bottom:none}
.sms-chk{width:18px;height:18px;accent-color:var(--green);cursor:pointer;flex-shrink:0;margin-top:2px}
.sms-tag{font-size:.65rem;padding:2px 5px;border-radius:4px;font-weight:700}
.tn{background:#fee2e2;color:#dc2626}
.ts{background:#fef3c7;color:#d97706}
.tu{background:#dbeafe;color:#2563eb}

.imp-z{border:2px dashed var(--blue);border-radius:var(--r);padding:16px;text-align:center;cursor:pointer;background:var(--blue-l);transition:.17s}
.imp-z:hover{border-color:var(--blue-d);background:var(--blue-m)}

.bdg{display:inline-block;padding:2px 6px;border-radius:20px;font-size:.64rem;font-weight:700}
.bdb{background:var(--blue-m);color:var(--blue-d)}
.bdo{background:#fef3c7;color:#92400e}
.tchip{display:inline-block;padding:2px 4px;border-radius:4px;font-size:.63rem;font-weight:700;background:#fef3c7;color:#92400e;border:1px solid #fcd34d;margin-left:3px}

.empty{text-align:center;padding:30px 16px;color:var(--muted)}
.ei{font-size:2.4rem;margin-bottom:8px}
.et{font-size:.82rem;line-height:1.5}

.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(62px);background:#1e293b;color:#fff;padding:10px 18px;border-radius:26px;font-size:.82rem;font-weight:600;z-index:999;transition:transform .27s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;box-shadow:0 8px 22px rgba(0,0,0,.3)}
.toast.show{transform:translateX(-50%) translateY(0)}

.filter-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:9px;align-items:center}
/* LESSON CHECKBOXES */
.lesson-chk-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:5px;padding-left:20px}
.lesson-chk-item{display:flex;align-items:center;gap:3px;font-size:.68rem;background:#f9fafb;padding:3px 7px;border-radius:16px;border:1px solid var(--border)}
.lesson-chk-item input[type=checkbox]{margin:0;width:14px;height:14px}

/* Schedule styles */
.schedule-section{background:#f8fafc;border-radius:var(--r);padding:10px;margin:8px 0;border:1px solid var(--border)}
.schedule-title{font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.day-row{display:flex;align-items:center;gap:8px;padding:6px 8px;background:#fff;border-radius:8px;margin-bottom:5px;border:1px solid var(--border)}
.day-row:last-child{margin-bottom:0}
.day-name{width:85px;font-size:.75rem;font-weight:600;color:var(--text);flex-shrink:0}
.day-toggle{width:36px;height:20px;background:var(--border);border-radius:10px;position:relative;cursor:pointer;transition:.2s;flex-shrink:0}
.day-toggle.on{background:var(--green)}
.day-toggle::after{content:'';position:absolute;width:16px;height:16px;background:#fff;border-radius:50%;top:2px;left:2px;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.day-toggle.on::after{left:18px}
.day-lessons{flex:1;display:flex;flex-wrap:wrap;gap:4px}
.day-lesson-chip{padding:3px 8px;border-radius:12px;font-size:.65rem;font-weight:600;cursor:pointer;border:1px solid var(--border);background:#fff;transition:.15s}
.day-lesson-chip.on{background:var(--blue-l);border-color:var(--blue);color:var(--blue-d)}
.day-lesson-chip.off{background:var(--gray-l);border-color:var(--border);color:var(--muted);opacity:.6}

.date-schedule-section{background:#fff9f0;border-radius:var(--r);padding:10px;margin:8px 0;border:1px solid #fcd34d}
.date-schedule-title{font-size:.72rem;font-weight:700;color:#92400e;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.date-row{display:flex;align-items:center;gap:8px;padding:6px 8px;background:#fff;border-radius:8px;margin-bottom:5px;border:1px solid #fcd34d}
.date-input{width:130px;padding:5px 8px;border:1px solid var(--border);border-radius:6px;font-size:.74rem}
.date-lessons{flex:1;display:flex;flex-wrap:wrap;gap:4px}
.date-chip{padding:3px 8px;border-radius:12px;font-size:.65rem;font-weight:600;cursor:pointer;border:1px solid var(--border);background:#fff;transition:.15s}
.date-chip.on{background:#fef3c7;border-color:var(--orange);color:#92400e}
.date-chip.off{background:var(--gray-l);border-color:var(--border);color:var(--muted);opacity:.6}
.date-del{width:24px;height:24px;border-radius:6px;border:none;background:#fee2e2;color:#dc2626;cursor:pointer;font-size:.8rem;display:flex;align-items:center;justify-content:center}
.date-del:hover{background:#fecaca}

.add-date-row{display:flex;gap:8px;align-items:center;margin-top:8px;padding-top:8px;border-top:1px dashed #fcd34d}

/* Group tabs for schedule */
.group-tabs{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
.group-tab{padding:6px 12px;border-radius:8px;font-size:.72rem;font-weight:600;cursor:pointer;border:2px solid var(--border);background:#fff;transition:.17s;color:var(--muted);white-space:nowrap}
.group-tab.active{border-color:var(--blue);color:var(--blue-d);background:var(--blue-l)}
.group-tab:hover{border-color:var(--blue-m)}

/* Collapsible sections */
.collapsible-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--blue-l);border-radius:8px;cursor:pointer;margin-bottom:5px}
.collapsible-header:hover{background:var(--blue-m)}
.collapsible-title{font-size:.78rem;font-weight:700;color:var(--blue-d)}
.collapsible-arrow{font-size:.9rem;transition:.2s}
.collapsible-arrow.open{transform:rotate(180deg)}
.collapsible-content{display:none;padding:5px 0}
.collapsible-content.open{display:block}

/* Group selector for teacher schedule */
.group-schedule-selector{margin-bottom:10px}
.group-schedule-select{width:100%;padding:8px 11px;border:2px solid var(--border);border-radius:8px;font-size:.845rem;background:#fff}
</style>

<!-- ‚ïê‚ïê SUPABASE ‚ïê‚ïê -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
// ‚îÇ  SUPABASE CONFIG ‚Äî URL –≤–∞ KEY-—Ä–æ –¥–∞—Ä –¢–∞–Ω–∑–∏–º–æ—Ç –≤–æ—Ä–∏–¥  ‚îÇ
// ‚îÇ  –∫—É–Ω–µ–¥, —ë –∏–Ω “∑–æ –∏–≤–∞–∑ –∫—É–Ω–µ–¥                          ‚îÇ
// ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
let SUPABASE_URL = localStorage.getItem('sb_url') || 'https://csqdvbiiuhagegtagztg.supabase.co';
let SUPABASE_KEY = localStorage.getItem('sb_key') || 'sb_publishable__TSYV3L6XYK5VQ2c_4Xepg_4xedbvef';

let _sb = null;
let _sbReady = false;

function _initSb() {
  try {
    _sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    return true;
  } catch(e) { return false; }
}
_initSb();

function sbConfigured() {
  return !SUPABASE_URL.includes('YOUR_PROJECT') && !SUPABASE_KEY.includes('YOUR_ANON');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SQL –î–ê–† SUPABASE (1 –ë–û–† –ò“∂–†–û –ö–£–ù–ï–î):
//
//  -- “∂–∞–¥–≤–∞–ª–∏ –∞—Å–æ—Å”£ (–≥—É—Ä”Ø“≥, —Ç–∞–Ω–∑–∏–º–æ—Ç)
//  CREATE TABLE IF NOT EXISTS davomat_data (
//    key TEXT PRIMARY KEY,
//    value JSONB,
//    updated_at TIMESTAMPTZ DEFAULT NOW()
//  );
//
//  -- “∂–∞–¥–≤–∞–ª–∏ –¥–∞–≤–æ–º–æ—Ç (“≥–∞—Ä —è—á–µ–π–∫–∞ = 1 —Å–∞—Ç—Ä)
//  CREATE TABLE IF NOT EXISTS davomat_att (
//    id TEXT PRIMARY KEY,      -- gid:sid:date:lid
//    gid TEXT NOT NULL,
//    sid TEXT NOT NULL,
//    att_date TEXT NOT NULL,   -- YYYY-MM-DD
//    lid TEXT NOT NULL,
//    status JSONB,             -- {st, by, byName, subject, at}
//    updated_at TIMESTAMPTZ DEFAULT NOW()
//  );
//  CREATE INDEX ON davomat_att(gid);
//  CREATE INDEX ON davomat_att(att_date);
//
//  -- –ò“∑–æ–∑–∞—Ç
//  ALTER TABLE davomat_data ENABLE ROW LEVEL SECURITY;
//  ALTER TABLE davomat_att  ENABLE ROW LEVEL SECURITY;
//  CREATE POLICY "all" ON davomat_data FOR ALL USING (true) WITH CHECK (true);
//  CREATE POLICY "all" ON davomat_att  FOR ALL USING (true) WITH CHECK (true);
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Generic key-value (groups, settings) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sbGet(key) {
  if (!sbConfigured() || !_sb) return null;
  try {
    const { data, error } = await _sb.from('davomat_data').select('value').eq('key', key).single();
    if (error || !data) return null;
    return data.value;
  } catch(e) { return null; }
}

async function sbSet(key, value) {
  if (!sbConfigured() || !_sb) return false;
  try {
    const { error } = await _sb.from('davomat_data')
      .upsert({ key, value, updated_at: new Date().toISOString() }, { onConflict: 'key' });
    if (error) console.warn('sbSet error:', error.message);
    return !error;
  } catch(e) { return false; }
}

// ‚îÄ‚îÄ GRANULAR ATTENDANCE SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// “≤–∞—Ä —è—á–µ–π–∫–∞ = 1 —Å–∞—Ç—Ä ‚Üí 2 –æ–º”Ø–∑–≥–æ—Ä —è–∫–≤–∞“õ—Ç —Ç–∞“ì–π–∏—Ä –¥–∏“≥–∞–Ω–¥, –∫–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–µ—Å—Ç!
async function sbSetAtt(gid, attKey, status) {
  if (!sbConfigured() || !_sb) return false;
  // attKey format: sid_YYYY-MM-DD_lid
  const parts = attKey.split('_');
  const sid = parts[0];
  const att_date = parts[1];
  const lid = parts.slice(2).join('_');
  const id = `${gid}:${attKey}`;
  try {
    if (status === null) {
      // Delete (present = no record)
      await _sb.from('davomat_att').delete().eq('id', id);
    } else {
      await _sb.from('davomat_att').upsert({
        id, gid, sid, att_date, lid,
        status,
        updated_at: new Date().toISOString()
      }, { onConflict: 'id' });
    }
    return true;
  } catch(e) { console.warn('sbSetAtt error:', e); return false; }
}

// ‚îÄ‚îÄ Load all attendance for a group from Supabase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sbLoadAtt(gid) {
  if (!sbConfigured() || !_sb) return null;
  try {
    const { data, error } = await _sb.from('davomat_att')
      .select('id,status').eq('gid', gid);
    if (error || !data) return null;
    const result = {};
    data.forEach(row => {
      // id = gid:sid_date_lid ‚Üí extract attKey
      const attKey = row.id.slice(gid.length + 1);
      result[attKey] = row.status;
    });
    return result;
  } catch(e) { return null; }
}

// ‚îÄ‚îÄ Load ALL attendance (for admin full view) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sbLoadAllAtt() {
  if (!sbConfigured() || !_sb) return false;
  try {
    const { data, error } = await _sb.from('davomat_att').select('id,gid,status');
    if (error || !data) return false;
    db.attendance = {};
    data.forEach(row => {
      const attKey = row.id.slice(row.gid.length + 1);
      if (!db.attendance[row.gid]) db.attendance[row.gid] = {};
      db.attendance[row.gid][attKey] = row.status;
    });
    return true;
  } catch(e) { return false; }
}

// ‚îÄ‚îÄ Load from Supabase (startup) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function lDBCloud() {
  if (!sbConfigured()) return false;
  try {
    const [groups, settings] = await Promise.all([sbGet('groups'), sbGet('settings')]);
    let loaded = false;
    if (groups !== null)  { db.groups = groups; loaded = true; }
    if (settings !== null){ db.settings = { ...db.settings, ...settings }; loaded = true; }
    // Load all attendance
    const attOk = await sbLoadAllAtt();
    if (attOk) loaded = true;
    if (loaded) {
      localStorage.setItem('dav7', JSON.stringify(db));
      _sbReady = true;
      return true;
    }
  } catch(e) { console.warn('lDBCloud failed:', e); }
  _sbReady = false;
  return false;
}

// ‚îÄ‚îÄ svCloud: save groups+settings to kv, attendance already saved per-cell ‚îÄ‚îÄ
async function svCloud() {
  localStorage.setItem('dav7', JSON.stringify(db));
  if (!sbConfigured() || !_sb) return;
  Promise.all([
    sbSet('groups', db.groups),
    sbSet('settings', db.settings)
  ]).catch(e => console.warn('Cloud sync error:', e));
}

// ‚îÄ‚îÄ Realtime: listen for attendance changes from other devices ‚îÄ‚îÄ
let _rtChannel = null;
function startRealtimeSync() {
  if (!sbConfigured() || !_sb) return;
  // Disconnect old channel if exists
  if (_rtChannel) { try { _sb.removeChannel(_rtChannel); } catch(e){} }

  _rtChannel = _sb.channel('davomat-live-' + Date.now())
    .on('postgres_changes', {
      event: '*', schema: 'public', table: 'davomat_att'
    }, (payload) => {
      const row = payload.new || payload.old;
      if (!row) return;
      const gid = row.gid;
      // attKey = everything after "gid:" prefix
      const attKey = row.id?.slice(gid?.length + 1);
      if (!gid || !attKey) return;

      // Update in-memory db
      if (!db.attendance[gid]) db.attendance[gid] = {};
      if (payload.eventType === 'DELETE' || !row.status) {
        delete db.attendance[gid][attKey];
      } else {
        db.attendance[gid][attKey] = row.status;
      }
      localStorage.setItem('dav7', JSON.stringify(db));

      // Show sync indicator flash
      updateSyncStatus('online');
      showSyncFlash(gid, row.status);

      // Refresh UI ‚Äî works for Admin (any gid) and teacher (their gid)
      if (typeof attGid !== 'undefined' && attGid === gid) {
        renderAttT?.();
      }
      // If admin is on groups page, show live update badge on group card
      refreshGroupBadge?.(gid);
    })
    .on('postgres_changes', {
      event: '*', schema: 'public', table: 'davomat_data'
    }, (payload) => {
      const key = payload.new?.key;
      const val = payload.new?.value;
      if (!key || !val) return;
      if (key === 'groups')  { db.groups = val; renderGroups?.(); }
      if (key === 'settings'){ db.settings = { ...db.settings, ...val }; }
      localStorage.setItem('dav7', JSON.stringify(db));
    })
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        updateSyncStatus('online');
        console.log('‚úÖ Realtime connected');
      } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
        updateSyncStatus('offline');
        // Reconnect after 5s
        setTimeout(startRealtimeSync, 5000);
      }
    });
}

// ‚îÄ‚îÄ Visual flash when another device updates ‚îÄ‚îÄ
function showSyncFlash(gid, status) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  const prev = el.textContent;
  el.textContent = '‚ö°';
  el.style.color = '#8b5cf6';
  setTimeout(() => { el.textContent = '‚òÅÔ∏è'; el.style.color = '#10b981'; }, 800);
}

// ‚îÄ‚îÄ Refresh group card badge (live update count for admin) ‚îÄ‚îÄ
function refreshGroupBadge(gid) {
  // If admin is viewing groups page, update student count badge
  const curPage = document.querySelector('.page[style*="block"]')?.id;
  if (curPage === 'page-groups') {
    // Just re-render ‚Äî it's fast
    renderGroups?.();
  }
}

// ‚îÄ‚îÄ Connection status indicator ‚îÄ‚îÄ
function updateSyncStatus(status) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  if (status === 'online')  { el.textContent = '‚òÅÔ∏è'; el.style.color = '#10b981'; el.title = 'Supabase –ø–∞–π–≤–∞—Å—Ç ‚Äî realtime sync'; }
  if (status === 'offline') { el.textContent = 'üíæ'; el.style.color = '#f59e0b'; el.title = '–û—Ñ–ª–∞–π–Ω ‚Äî localStorage'; }
  if (status === 'syncing') { el.textContent = 'üîÑ'; el.style.color = '#6b7280'; el.title = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç—Å–∏—è...'; }
}
</script>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">üìö</div>
    <div class="login-title">–î–∞–≤–æ–º–∞—Ç</div>
    <div class="login-sub">–°–∏—Å—Ç–µ–º–∞–∏ “≥–∏—Å–æ–±–≥–∏—Ä–∏–∏ –¥–∞–≤–æ–º–∞—Ç</div>
    <div class="login-err" id="login-err">–†–∞–º–∑ –Ω–æ–¥—É—Ä—É—Å—Ç!</div>
    <div class="fg"><label class="fl">–û–º”Ø–∑–≥–æ—Ä / –†–æ“≥–±–∞—Ä</label>
      <div style="position:relative;margin-bottom:5px">
        <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:.88rem;pointer-events:none">üîç</span>
        <input class="fc" id="login-search" placeholder="–ù–æ–º —ë ID-–∏ –æ–º”Ø–∑–≥–æ—Ä—Ä–æ –Ω–∞–≤–∏—Å–µ–¥..."
          oninput="filterLoginList(this.value)"
          style="padding-left:32px;font-size:.83rem">
      </div>
      <select class="fc" id="login-who" onchange="onLoginWhoChange()">
        <option value="admin">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
      </select>
    </div>

    <div class="fg"><label class="fl">–†–∞–º–∑ (–ø–∞—Ä–æ–ª—å)</label>
      <input class="fc" type="password" id="login-pass" placeholder="–†–∞–º–∑—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn bb bblk" style="margin-top:4px" onclick="doLogin()">üîê –í–æ—Ä–∏–¥—à–∞–≤”£</button>
  </div>
</div>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header class="hdr" id="main-hdr" style="display:none">
  <div class="hdr-top">
    <div class="hdr-brand">
      <div class="hdr-logo">üìö</div>
      <div>
        <div class="hdr-title">–î–∞–≤–æ–º–∞—Ç</div>
        <div class="hdr-sub" id="hdr-sub">v7</div>
      </div>
    </div>
    <div class="hdr-user">
      <span id="hdr-uname"></span><span id="sync-status" style="font-size:.68rem;margin-left:7px;font-weight:700;cursor:default;opacity:.8" title="Cloud sync">‚è≥</span>
      <div class="hdr-avatar" onclick="doLogout()" title="–•–æ—Ä–∏“∑">üö™</div>
    </div>
  </div>
  <div class="nav" id="main-nav"></div>
</header>

<!-- ‚ïê‚ïê PAGES ‚ïê‚ïê -->
<div id="page-groups" class="page" style="display:none">
  <div id="v-gl">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:9px">
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:.94rem;color:#1e3a8a">üìÅ –ì—É—Ä”Ø“≥“≥–æ</div>
      <div style="display:flex;gap:5px" id="grp-admin-btns"></div>
    </div>
    
    <div style="position:relative;margin-bottom:9px">
      <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:.92rem;pointer-events:none;color:var(--muted)">üîé</span>
      <input class="fc" id="g-search" placeholder="–ì—É—Ä”Ø“≥—Ä–æ —ë–±–µ–¥ (–Ω–æ–º / —Ä–∞“õ–∞–º / ID)..." oninput="groupSearch=this.value;renderGroups()" style="padding-left:36px">
    </div>

    <div id="gl-c"></div>
  </div>
  <div id="v-gd" style="display:none">
    <div style="display:flex;align-items:center;gap:7px;margin-bottom:9px">
      <button class="btn bgh bsm" onclick="backG()">‚Üê –ë–æ–∑–≥–∞—à—Ç</button>
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:.94rem;flex:1" id="gd-t"></div>
    </div>
    <div class="card">
      <div class="card-h"><div class="ctitle">üë§ –î–æ–Ω–∏—à“∑”Ø—ë–Ω</div>
        <div style="display:flex;gap:5px">
          <button class="btn bb bsm" onclick="openAddS()">Ôºã –ò–ª–æ–≤–∞</button>
          <button class="btn bgh bsm" onclick="openImp()">üì• –ò–º–ø–æ—Ä—Ç</button>
        </div>
      </div>
      <div id="s-c"></div>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button class="btn bg bsm" onclick="expSXls()">üì§ Excel</button>
      <button class="btn bgh bsm" onclick="expSTxt()">üìÑ –¢–µ–∫—Å—Ç</button>
    </div>
  </div>
</div>

<div id="page-attendance" class="page" style="display:none">
  <div id="att-ng" class="empty"><div class="ei">üìã</div><div class="et">–ê–≤–≤–∞–ª –≥—É—Ä”Ø“≥—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥</div></div>
  <div id="att-main" style="display:none">
    <div style="display:flex;align-items:center;gap:7px;margin-bottom:8px">
      <button class="btn bgh bsm" onclick="attBack()">‚Üê –ì—É—Ä”Ø“≥</button>
      <div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:.9rem;color:#1e3a8a;flex:1" id="att-gl"></div>
    </div>
    <!-- Teacher: subject selector inside attendance (no re-login needed) -->
    <div id="att-subj-tabs" style="display:none;margin-bottom:8px;overflow-x:auto">
      <div id="att-subj-tabs-inner" style="display:flex;gap:6px;padding:2px 0;min-width:max-content"></div>
    </div>
    <div class="vt">
      <div class="vtb active" id="vt-d" onclick="setVM('day')">üìÖ –Ø–∫ —Ä”Ø–∑</div>
      <div class="vtb" id="vt-m" onclick="setVM('month')">üìÜ –Ø–∫ –º–æ“≥</div>
      <div class="vtb" id="vt-r" onclick="setVM('range')">üìä –î–∏–∞–ø–∞–∑–æ–Ω</div>
    </div>
    <div id="cd"><div class="dbar" id="day-nav-bar">
      <button class="dn" id="dn-prev" onclick="dSh(-1)">‚Äπ</button><div class="dl" id="d-lbl"></div><button class="dn" id="dn-next" onclick="dSh(1)">‚Ä∫</button>
      <input type="date" id="d-pick" class="fc" style="width:auto;padding:5px 8px;font-size:.74rem" onchange="onDP()">
    </div></div>
    <div id="cm" style="display:none">
      <div class="dbar">
        <button class="dn" onclick="mSh(-1)">‚Äπ</button><div class="dl" id="m-lbl"></div><button class="dn" onclick="mSh(1)">‚Ä∫</button>
      </div>
      <div id="month-view-badge" style="display:none;text-align:center;font-size:.72rem;background:#fef9c3;color:#854d0e;padding:4px 10px;border-radius:8px;margin:4px 0">
        üëÅ –¢–∞–Ω“≥–æ –¥–∏–¥–∞–Ω ‚Äî –∏–Ω –º–æ“≥ —Ç–∞“ì–π–∏—Ä –¥–æ–¥–∞ –Ω–∞–º–µ—à–∞–≤–∞–¥
      </div>
    </div>
    <div id="cr" style="display:none">
      <div class="dbar" style="gap:8px;flex-wrap:wrap;justify-content:center">
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span style="font-size:.72rem;font-weight:700;color:var(--muted)">–ê–∑</span>
          <input type="date" id="r-from" class="fc" style="width:auto;padding:5px 8px;font-size:.74rem">
          <span style="font-size:.72rem;font-weight:700;color:var(--muted)">–¢–æ</span>
          <input type="date" id="r-to" class="fc" style="width:auto;padding:5px 8px;font-size:.74rem">
          <button class="btn bb bsm" onclick="onRangeApply()">–ù–∞–º–æ–∏—à</button>
        </div>
        <div id="range-view-badge" style="display:none;font-size:.72rem;background:#fef9c3;color:#854d0e;padding:4px 10px;border-radius:8px">
          üëÅ –¢–∞–Ω“≥–æ –¥–∏–¥–∞–Ω ‚Äî –¥–∏–∞–ø–∞–∑–æ–Ω —Ç–∞“ì–π–∏—Ä –¥–æ–¥–∞ –Ω–∞–º–µ—à–∞–≤–∞–¥
        </div>
      </div>
    
    </div>
    <div class="card" style="padding:0"><div class="att-wrap"><table class="att-table" id="att-t"></table></div></div>
    <div class="card" style="padding:9px 12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:.72rem;margin-bottom:7px">
        <span><span class="ac ca" style="display:inline-flex;width:19px;height:17px">–ù</span> –ù–∞–±—É–¥</span>
        <span><span class="ac cs" style="display:inline-flex;width:19px;height:17px">–ë</span> –ë–µ–º–æ—Ä</span>
        <span><span class="ac cu" style="display:inline-flex;width:19px;height:17px">–£</span> –£–∑—Ä</span>
        <span><span class="ac ce" style="display:inline-flex;width:19px;height:17px">‚Äî</span> “≤–æ–∑–∏—Ä</span>
      </div>
      <button class="btn bgh bsm" onclick="refreshAttFromCloud()" id="att-refresh-btn" title="–ú–∞—ä–ª—É–º–æ—Ç—Ä–æ –∞–∑ Cloud –Ω–∞–≤ –∫—É–Ω">üîÑ</button><button class="btn bg bsm" onclick="expAtt()">üì§ Excel</button>
    </div>
  </div>
</div>

<div id="page-sms" class="page" style="display:none">
  <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:.94rem;color:#1e3a8a;margin-bottom:9px">üì® SMS ‚Äî –†”Ø–π—Ö–∞—Ç–∏ “ì–æ–∏–±–æ–Ω</div>
  <div class="card" style="padding:11px">
    <div class="seg" style="margin-bottom:9px" id="sms-shift-seg">
      <div class="seg-b active" onclick="setSmsShift(0)">üåê “≤–∞–º–∞</div>
      <div class="seg-b s1" onclick="setSmsShift(1)">üåÖ –ë–∞—Å—Ç 1</div>
      <div class="seg-b s2" onclick="setSmsShift(2)">üåÜ –ë–∞—Å—Ç 2</div>
    </div>
    <div class="fr" style="flex-wrap:wrap;gap:7px;margin-bottom:0">
      <div class="fg" style="min-width:120px"><label class="fl">–ì—É—Ä”Ø“≥</label><select class="fc" id="sms-gid" onchange="renderSMS()"><option value="">‚Äî “≤–∞–º–∞ ‚Äî</option></select></div>
      <div class="fg"><label class="fl">–†–µ–∂–∏–º</label><select class="fc" id="sms-mode" onchange="renderSMSCtrl()"><option value="day">–Ø–∫ —Ä”Ø–∑</option><option value="month">–Ø–∫ –º–æ“≥</option></select></div>
      <div id="sms-dc" style="display:flex;align-items:flex-end;gap:4px">
        <button class="dn" onclick="smsDSh(-1)">‚Äπ</button><div class="dl" id="sms-dl" style="min-width:85px;font-size:.8rem"></div><button class="dn" onclick="smsDSh(1)">‚Ä∫</button>
        <input type="date" id="sms-dp" class="fc" style="width:auto;padding:4px 7px;font-size:.71rem" onchange="onSmsDP()">
      </div>
      <div id="sms-mc" style="display:none;align-items:flex-end;gap:4px">
        <button class="dn" onclick="smsMS(-1)">‚Äπ</button><div class="dl" id="sms-ml" style="min-width:85px;font-size:.8rem"></div><button class="dn" onclick="smsMS(1)">‚Ä∫</button>
      </div>
    </div>
  </div>
  <div class="card" style="padding:0">
    <div class="card-h"><div class="ctitle">“í–æ–∏–±–æ–Ω</div>
      <div style="display:flex;gap:5px">
        <button class="btn bgh bsm" onclick="selAll(true)">‚úî “≤–∞–º–∞</button>
        <button class="btn bgh bsm" onclick="selAll(false)">‚úò “≤–µ—á</button>
      </div>
    </div>
    <div id="sms-list"></div>
  </div>
  <button class="btn bg bsm" onclick="expSMSXls()">üì§ –≠–∫—Å–ø–æ—Ä—Ç Excel (–ê=–ù–æ–º, –í=–¢–µ–ª)</button>
</div>

<div id="page-stats" class="page" style="display:none">
  <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:.94rem;color:#1e3a8a;margin-bottom:9px">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
  <div class="seg" id="st-shift-seg">
    <div class="seg-b active" onclick="setStShift(0)">üåê “≤–∞–º–∞</div>
    <div class="seg-b s1" onclick="setStShift(1)">üåÖ –ë–∞—Å—Ç 1</div>
    <div class="seg-b s2" onclick="setStShift(2)">üåÜ –ë–∞—Å—Ç 2</div>
  </div>
  <div class="card" style="padding:11px">
    <div class="fr" style="flex-wrap:wrap;gap:7px;margin-bottom:0">
      <div class="fg" style="min-width:120px"><label class="fl">–ì—É—Ä”Ø“≥</label><select class="fc" id="st-gid" onchange="onStGid()"><option value="">‚Äî “≤–∞–º–∞ –≥—É—Ä”Ø“≥ ‚Äî</option></select></div>
      <div class="fg"><label class="fl">–î–∞–≤—Ä–∞</label><select class="fc" id="st-mode" onchange="updStCtrl()"><option value="all">“≤–∞–º–∞ –≤–∞“õ—Ç</option><option value="month">–Ø–∫ –º–æ“≥</option><option value="day">–Ø–∫ —Ä”Ø–∑</option></select></div>
      <div id="st-mc" style="display:none;align-items:flex-end;gap:4px"><button class="dn" onclick="stMS(-1)">‚Äπ</button><span id="st-ml" style="font-size:.78rem;font-weight:700"></span><button class="dn" onclick="stMS(1)">‚Ä∫</button></div>
      <div id="st-dc" style="display:none;align-items:flex-end;gap:4px"><button class="dn" onclick="stDS(-1)">‚Äπ</button><span id="st-dl" style="font-size:.78rem;font-weight:700"></span><button class="dn" onclick="stDS(1)">‚Ä∫</button><input type="date" id="st-dp" class="fc" style="width:auto;padding:4px 7px;font-size:.71rem" onchange="onStDP()"></div>
    </div>
  </div>
  <div class="sgrid" id="st-sum"></div>
  <div class="charts-row" id="st-charts"></div>
  <div class="card" id="st-det-card" style="display:none">
    <div class="card-h"><div class="ctitle" id="st-det-title">üë§ “≤–∞—Ä –¥–æ–Ω–∏—à“∑”Ø</div></div>
    <div id="st-det"></div>
  </div>
  <div class="card" id="st-groups-card">
    <div class="card-h"><div class="ctitle">üìä “≤–∞—Ä –≥—É—Ä”Ø“≥</div></div>
    <div id="st-groups-list"></div>
  </div>
</div>

<div id="page-settings" class="page" style="display:none">
  <div class="set-s"><div class="set-t">–ú–∞—ä–ª—É–º–æ—Ç–∏ —É–º—É–º”£</div>
    <div class="card" style="padding:12px">
      <div class="fg"><label class="fl">–ù–æ–º–∏ –º—É–∞—Å—Å–∏—Å–∞</label><input class="fc" id="s-inst" placeholder="–ö–æ–ª–ª–µ“∑" oninput="saveSets()"></div>
      <div class="fg" style="margin-bottom:0"><label class="fl">–ú—É–∞–ª–ª–∏–º (—Ä–æ“≥–±–∞—Ä)</label><input class="fc" id="s-tchr" placeholder="–ù–æ–º—É –Ω–∞—Å–∞–±" oninput="saveSets()"></div>
    </div>
  </div>
  <div class="set-s"><div class="set-t">üîê –†–∞–º–∑–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
    <div class="card" style="padding:12px">
      <div class="fg"><label class="fl">–†–∞–º–∑–∏ –Ω–∞–≤</label><input class="fc" type="password" id="s-newpw" placeholder="–†–∞–º–∑–∏ –Ω–∞–≤"></div>
      <button class="btn bb bsm" onclick="changeAdminPw()">–¢–∞“ì–π–∏—Ä –¥–æ–¥–∞–Ω</button>
    </div>
  </div>
  <div class="set-s"><div class="set-t">‚è∞ –ë–∞—Å—Ç“≥–æ –≤–∞ –¥–∞—Ä—Å“≥–æ</div>
    <div class="sh-tabs">
      <div class="sh-tab s1 active" id="sh-t1" onclick="setShTab(1)">üåÖ –ë–∞—Å—Ç 1 (–°—É–±“≥)</div>
      <div class="sh-tab s2" id="sh-t2" onclick="setShTab(2)">üåÜ –ë–∞—Å—Ç 2 (–ë–µ–≥–æ“≥)</div>
    </div>
    <div id="sh-lessons"></div>
    <button class="btn bb bsm" style="margin-top:7px" onclick="addLesson()">Ôºã –î–∞—Ä—Å –∏–ª–æ–≤–∞</button>
  </div>
  <div class="set-s"><div class="set-t">üë®‚Äçüè´ –û–º”Ø–∑–≥–æ—Ä–æ–Ω</div>
    <div style="position:relative;margin-bottom:9px">
      <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:.92rem;pointer-events:none;color:var(--muted)">üîç</span>
      <input class="fc" id="t-search" placeholder="–û–º”Ø–∑–≥–æ—Ä—Ä–æ —ë–±–µ–¥..." oninput="teacherSearch=this.value;renderTeachers()" style="padding-left:36px">
    </div>
    <div id="t-list"></div>
    <button class="btn bb bsm" style="margin-top:9px;width:100%" onclick="openModal('m-addt')">Ôºã –û–º”Ø–∑–≥–æ—Ä –∏–ª–æ–≤–∞</button>
  </div>
  <div class="set-s"><div class="set-t">‚òÅÔ∏è Supabase Cloud Sync</div>
  <div class="card" style="padding:12px">
    <div style="font-size:.75rem;color:var(--muted);margin-bottom:10px;line-height:1.5">
      –ë–∞—Ä–æ–∏ –ø–∞–π–≤–∞—Å—Ç –∫–∞—Ä–¥–∞–Ω –±–æ Supabase, URL –≤–∞ API Key-—Ä–æ –∞–∑ <b>supabase.com ‚Üí Settings ‚Üí API</b> –≥–∏—Ä–µ–¥.<br>
      –ü–µ—à –∞–∑ –ø–∞–π–≤–∞—Å—Ç, –¥–∞—Ä <b>SQL Editor</b> –∏–Ω SQL-—Ä–æ –∏“∑—Ä–æ –∫—É–Ω–µ–¥:
    </div>
    <div onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" 
      style="cursor:pointer;font-size:.73rem;color:var(--blue);font-weight:700;margin-bottom:6px">üìã SQL ‚ñº</div>
    <pre id="sb-sql" style="display:none;background:#1e293b;color:#7dd3fc;padding:10px;border-radius:8px;font-size:.65rem;overflow-x:auto;line-height:1.6;white-space:pre-wrap;margin-bottom:8px">-- “∂–∞–¥–≤–∞–ª–∏ 1: –≥—É—Ä”Ø“≥ –≤–∞ —Ç–∞–Ω–∑–∏–º–æ—Ç
CREATE TABLE IF NOT EXISTS davomat_data (
  key TEXT PRIMARY KEY,
  value JSONB,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- “∂–∞–¥–≤–∞–ª–∏ 2: –¥–∞–≤–æ–º–∞—Ç (“≥–∞—Ä —è—á–µ–π–∫–∞ = 1 —Å–∞—Ç—Ä)
CREATE TABLE IF NOT EXISTS davomat_att (
  id TEXT PRIMARY KEY,
  gid TEXT NOT NULL,
  sid TEXT NOT NULL,
  att_date TEXT NOT NULL,
  lid TEXT NOT NULL,
  status JSONB,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_att_gid ON davomat_att(gid);
CREATE INDEX IF NOT EXISTS idx_att_date ON davomat_att(att_date);

-- –ò“∑–æ–∑–∞—Ç (RLS)
ALTER TABLE davomat_data ENABLE ROW LEVEL SECURITY;
ALTER TABLE davomat_att  ENABLE ROW LEVEL SECURITY;
CREATE POLICY "all" ON davomat_data FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "all" ON davomat_att  FOR ALL USING (true) WITH CHECK (true);

-- Realtime —Ñ–∞—ä–æ–ª –∫—É–Ω–µ–¥
ALTER PUBLICATION supabase_realtime ADD TABLE davomat_att;
ALTER PUBLICATION supabase_realtime ADD TABLE davomat_data;</pre>
    <div class="fg"><label class="fl">Project URL</label>
      <input class="fc" id="sb-url" placeholder="https://xxxx.supabase.co" 
        style="font-size:.76rem;font-family:monospace">
    </div>
    <div class="fg"><label class="fl">Anon Key</label>
      <input class="fc" id="sb-key" placeholder="eyJhbGci..." type="password"
        style="font-size:.76rem;font-family:monospace">
    </div>
    <div id="sb-status" style="font-size:.75rem;margin-bottom:8px;padding:6px 10px;border-radius:7px;display:none"></div>
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn bb bsm" onclick="saveSbConfig()">üíæ –ù–∏–≥–æ“≥ –≤–∞ –ü–∞–π–≤–∞—Å—Ç</button>
      <button class="btn bgh bsm" onclick="testSbConn()">üîå –°–∞–Ω“∑–∏—à</button>
      <button class="btn bgh bsm" onclick="pushToCloud()">‚¨ÜÔ∏è –ë–æ—Ä–≥—É–∑–æ—Ä–∏–∏ –±–∞ Cloud</button>
      <button class="btn bgh bsm" onclick="pullFromCloud()">‚¨áÔ∏è –ì–∏—Ä–∏—Ñ—Ç–∞–Ω –∞–∑ Cloud</button>
    </div>
  </div>
</div>

<div class="set-s"><div class="set-t">üíæ Backup</div>
    <div class="card" style="padding:11px">
      <div style="display:flex;gap:7px;flex-wrap:wrap">
        <button class="btn bpur bsm" onclick="expJSON()">üì§ JSON Backup</button>
        <button class="btn bgh bsm" onclick="document.getElementById('imp-json').click()">üì• JSON Backup</button>
        <input type="file" id="imp-json" accept=".json" style="display:none" onchange="impJSON(event)">
      </div>
      <div style="margin-top:9px"><button class="btn br bsm" onclick="clearAll()">üóëÔ∏è –¢–æ–∑–∞ –∫–∞—Ä–¥–∞–Ω</button></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->
<div class="overlay" id="m-addg">
  <div class="modal"><div class="mh"></div><div class="mt">‚ûï –ì—É—Ä”Ø“≥–∏ –Ω–∞–≤</div>
    <div class="fg"><label class="fl">–ù–æ–º–∏ –≥—É—Ä”Ø“≥</label><input class="fc" id="ng-n" placeholder="–§–µ–ª–¥—à–µ—Ä–∏-101"></div>
    <div class="fg"><label class="fl">üÜî ID-–∏ –≥—É—Ä”Ø“≥ (–∏—Ö—Ç–∏—ë—Ä”£)</label><input class="fc" id="ng-c" placeholder="101"></div>
    <div class="fg"><label class="fl">–ë–∞—Å—Ç</label><select class="fc" id="ng-sh"><option value="1">üåÖ –ë–∞—Å—Ç 1 ‚Äî –°—É–±“≥</option><option value="2">üåÜ –ë–∞—Å—Ç 2 ‚Äî –ë–µ–≥–æ“≥</option></select></div>
    <div class="mf"><button class="btn bb bblk" onclick="addGroup()">–ò–ª–æ–≤–∞</button><button class="btn bgh" onclick="closeModal('m-addg')">–ë–µ–∫–æ—Ä</button></div>
  </div>
</div>

<div class="overlay" id="m-edg">
  <div class="modal"><div class="mh"></div><div class="mt">‚úèÔ∏è –¢–∞“≥—Ä–∏—Ä–∏ –≥—É—Ä”Ø“≥</div>
    <input type="hidden" id="edg-id">
    <div class="fg"><label class="fl">–ù–æ–º–∏ –≥—É—Ä”Ø“≥</label><input class="fc" id="edg-n" placeholder="–§–µ–ª–¥—à–µ—Ä–∏-101"></div>
    <div class="fg"><label class="fl">üÜî ID-–∏ –≥—É—Ä”Ø“≥ (–∏—Ö—Ç–∏—ë—Ä”£)</label><input class="fc" id="edg-c" placeholder="101"></div>
    <div class="fg"><label class="fl">–ë–∞—Å—Ç</label>
      <select class="fc" id="edg-sh">
        <option value="1">üåÖ –ë–∞—Å—Ç 1 ‚Äî –°—É–±“≥</option>
        <option value="2">üåÜ –ë–∞—Å—Ç 2 ‚Äî –ë–µ–≥–æ“≥</option>
      </select>
    </div>
    <div class="mf">
      <button class="btn bb bblk" onclick="saveEditGroup()">üíæ –ù–∏–≥–æ“≥</button>
      <button class="btn bgh" onclick="closeModal('m-edg')">–ë–µ–∫–æ—Ä</button>
    </div>
    <div style="margin-top:10px;font-size:.72rem;color:var(--muted);line-height:1.4">
      <div><strong>–≠–∑–æ“≥:</strong> ID-–∏ –¥–æ—Ö–∏–ª”£ —Ç–∞“ì–π–∏—Ä –Ω–∞–º–µ—à–∞–≤–∞–¥.</div>
      <div>ID (—Å–∏—Å—Ç–µ–º–∞–≤”£): <span id="edg-sys" style="font-family:monospace"></span></div>
    </div>
  </div>
</div>


<div class="overlay" id="m-adds">
  <div class="modal"><div class="mh"></div><div class="mt">üë§ –î–æ–Ω–∏—à“∑”Ø–∏ –Ω–∞–≤</div>
    <div class="fr"><div class="fg"><label class="fl">–ù–∞—Å–∞–±</label><input class="fc" id="ns-l"></div><div class="fg"><label class="fl">–ù–æ–º</label><input class="fc" id="ns-f"></div></div>
    <div class="fg"><label class="fl">üÜî ID –¥–æ–Ω–∏—à“∑”Ø</label><input class="fc" id="ns-sid" placeholder="–ú–∞—Å–∞–ª–∞–Ω: 24015"></div>
    <div class="fr"><div class="fg"><label class="fl">–ü–∞–¥–∞—Ä</label><input class="fc" id="ns-fa"></div><div class="fg"><label class="fl">–ú–æ–¥–∞—Ä</label><input class="fc" id="ns-mo"></div></div>
    <div class="fr"><div class="fg"><label class="fl">–¢–µ–ª. —Ö—É–¥</label><input class="fc" id="ns-ph"></div><div class="fg"><label class="fl">–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</label><input class="fc" id="ns-pp"></div></div>
    <div class="mf"><button class="btn bb bblk" onclick="addStudent()">–ò–ª–æ–≤–∞</button><button class="btn bgh" onclick="closeModal('m-adds')">–ë–µ–∫–æ—Ä</button></div>
  </div>
</div>

<div class="overlay" id="m-eds">
  <div class="modal"><div class="mh"></div><div class="mt">‚úèÔ∏è –¢–∞“≥—Ä–∏—Ä–∏ –¥–æ–Ω–∏—à“∑”Ø</div>
    <input type="hidden" id="es-id">
    <div class="fr"><div class="fg"><label class="fl">–ù–∞—Å–∞–±</label><input class="fc" id="es-l"></div><div class="fg"><label class="fl">–ù–æ–º</label><input class="fc" id="es-f"></div></div>
    <div class="fg"><label class="fl">üÜî ID –¥–æ–Ω–∏—à“∑”Ø</label><input class="fc" id="es-sid" placeholder="ID"></div>
    <div class="fr"><div class="fg"><label class="fl">–ü–∞–¥–∞—Ä</label><input class="fc" id="es-fa"></div><div class="fg"><label class="fl">–ú–æ–¥–∞—Ä</label><input class="fc" id="es-mo"></div></div>
    <div class="fr"><div class="fg"><label class="fl">–¢–µ–ª. —Ö—É–¥</label><input class="fc" id="es-ph"></div><div class="fg"><label class="fl">–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</label><input class="fc" id="es-pp"></div></div>
    <div class="fg"><label class="fl">üîÑ –ò–Ω—Ç–∏“õ–æ–ª –±–∞ –≥—É—Ä”Ø“≥</label><select class="fc" id="es-tr"><option value="">‚Äî –ò–Ω—Ç–∏“õ–æ–ª –Ω–µ—Å—Ç ‚Äî</option></select></div>
    <div class="mf"><button class="btn bb" style="flex:2" onclick="saveEdit()">üíæ –ù–∏–≥–æ“≥</button><button class="btn br bsm" onclick="delS()">üóëÔ∏è</button><button class="btn bgh bsm" onclick="closeModal('m-eds')">–ë–µ–∫–æ—Ä</button></div>
  </div>
</div>

<div class="overlay" id="m-imp">
  <div class="modal"><div class="mh"></div><div class="mt">üì• –ò–º–ø–æ—Ä—Ç .txt</div>
    <div style="font-size:.76rem;color:var(--muted);margin-bottom:9px;background:var(--gray-l);padding:8px;border-radius:7px;line-height:1.5"><strong>–§–æ—Ä–º–∞—Ç:</strong> –ù–∞—Å–∞–± –ù–æ–º [–ü–∞–¥–∞—Ä] [–¢–µ–ª]</div>
    <div class="imp-z" onclick="document.getElementById('imp-f').click()"><div style="font-size:1.6rem;margin-bottom:4px">üìÇ</div><div style="font-weight:600;font-size:.82rem">–§–∞–π–ª—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥ (.txt)</div></div>
    <input type="file" id="imp-f" accept=".txt" style="display:none" onchange="onIF(event)">
    <div id="imp-prev" style="margin-top:8px"></div>
    <div class="mf"><button class="btn bb bblk" id="imp-ok" style="display:none" onclick="confImp()">‚úÖ –¢–∞—Å–¥–∏“õ</button><button class="btn bgh" onclick="closeModal('m-imp')">–ë–µ–∫–æ—Ä</button></div>
  </div>
</div>

<div class="overlay" id="m-st">
  <div class="modal"><div class="mh"></div><div class="mt" id="m-st-t">“≤–æ–ª–∞—Ç–∏ –¥–∞–≤–æ–º–∞—Ç</div>
    <div id="m-st-note" style="display:none;margin:8px 0 12px;padding:9px 10px;border-radius:12px;background:var(--gray-l);border:1px solid var(--border);font-size:.74rem;line-height:1.45"></div>
    <div class="sopt" onclick="setSt('present')"><div class="sopt-i">‚úÖ</div><div><div class="sopt-l">“≤–æ–∑–∏—Ä</div><div class="sopt-s">–î–∞—Ä—Å—Ä–æ –¥–∏–¥–∞–∞—Å—Ç</div></div></div>
    <div class="sopt" onclick="setSt('absent')"><div class="sopt-i">‚ùå</div><div><div class="sopt-l" style="color:var(--red)">–ù–∞–±—É–¥ (–ù)</div></div></div>
    <div class="sopt" onclick="setSt('sick')"><div class="sopt-i">ü§í</div><div><div class="sopt-l" style="color:var(--yellow)">–ë–µ–º–æ—Ä (–ë)</div></div></div>
    <div class="sopt" onclick="setSt('excused')"><div class="sopt-i">üìù</div><div><div class="sopt-l" style="color:var(--blue)">–£–∑—Ä (–£)</div></div></div>
    <div class="mf"><button class="btn bgh bblk" onclick="closeModal('m-st')">–ë–µ–∫–æ—Ä</button></div>
  </div>
</div>

<div class="overlay" id="m-addt">
  <div class="modal"><div class="mh"></div><div class="mt">üë®‚Äçüè´ –û–º”Ø–∑–≥–æ—Ä–∏ –Ω–∞–≤</div>
    <div class="fr"><div class="fg"><label class="fl">–ù–∞—Å–∞–±</label><input class="fc" id="nt-l" placeholder="–†–∞“≥–∏–º–æ–≤"></div><div class="fg"><label class="fl">–ù–æ–º</label><input class="fc" id="nt-f" placeholder="–ê–ª”£"></div></div>
    <div class="fg"><label class="fl">–§–∞–Ω (–ø—Ä–µ–¥–º–µ—Ç)</label><input class="fc" id="nt-sub" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"></div>
    <div class="fr">
      <div class="fg"><label class="fl">üÜî ID (—Ä–∞“õ–∞–º–∏ –∫–æ—Ä–º–∞–Ω–¥)</label><input class="fc" id="nt-tid" placeholder="–ú–∞—Å–∞–ª–∞–Ω: 1001"></div>
      <div class="fg"><label class="fl">üìû –¢–µ–ª–µ—Ñ–æ–Ω</label><input class="fc" id="nt-phone" placeholder="+992..."></div>
    </div>
    <div class="fg"><label class="fl">–†–∞–º–∑ (–ø–∞—Ä–æ–ª—å)</label><input class="fc" type="password" id="nt-pw" placeholder="–†–∞–º–∑"></div>
    <div class="mf"><button class="btn bb bblk" onclick="addTeacher()">–ò–ª–æ–≤–∞</button><button class="btn bgh" onclick="closeModal('m-addt')">–ë–µ–∫–æ—Ä</button></div>
  </div>
</div>

<!-- –¢–∞“≥—Ä–∏—Ä–∏ –æ–º”Ø–∑–≥–æ—Ä -->
<div class="overlay" id="m-edt">
  <div class="modal"><div class="mh"></div><div class="mt">‚úèÔ∏è –¢–∞“≥—Ä–∏—Ä–∏ –æ–º”Ø–∑–≥–æ—Ä</div>
    <input type="hidden" id="et-id">
    <div class="fr">
      <div class="fg"><label class="fl">–ù–∞—Å–∞–±</label><input class="fc" id="et-l"></div>
      <div class="fg"><label class="fl">–ù–æ–º</label><input class="fc" id="et-f"></div>
    </div>
    <div class="fg"><label class="fl">–§–∞–Ω (–ø—Ä–µ–¥–º–µ—Ç) ‚Äî –∞—Å–æ—Å”£</label><input class="fc" id="et-sub" placeholder="–ë–∏–æ–ª–æ–≥–∏—è"></div>
    <div class="fr">
      <div class="fg"><label class="fl">üÜî ID</label><input class="fc" id="et-tid" placeholder="–†–∞“õ–∞–º–∏ –∫–æ—Ä–º–∞–Ω–¥"></div>
      <div class="fg"><label class="fl">üìû –¢–µ–ª–µ—Ñ–æ–Ω</label><input class="fc" id="et-phone" placeholder="+992..."></div>
    </div>
    <div class="fg">
      <label class="fl">–†–∞–º–∑–∏ –Ω–∞–≤</label>
      <input class="fc" type="password" id="et-pw" placeholder="–•–æ–ª”£ –º–æ–Ω–µ–¥ ‚Äî –∏–≤–∞–∑ –Ω–∞–º–µ—à–∞–≤–∞–¥">
    </div>
    <div class="mf">
      <button class="btn bb bblk" onclick="saveEditTeacher()">üíæ –ù–∏–≥–æ“≥</button>
      <button class="btn bgh" onclick="closeModal('m-edt')">–ë–µ–∫–æ—Ä</button>
    </div>
  </div>
</div>

<!-- Modal: Add subject to teacher-group -->
<div class="overlay" id="m-add-subj">
  <div class="modal"><div class="mh"></div><div class="mt">üìö –§–∞–Ω –∏–ª–æ–≤–∞ –∫—É–Ω–µ–¥</div>
    <input type="hidden" id="as-tid">
    <input type="hidden" id="as-gid">
    <div class="fg"><label class="fl">–ù–æ–º–∏ —Ñ–∞–Ω</label>
      <input class="fc" id="as-name" placeholder="–ú–∞—Å–∞–ª–∞–Ω: –ë–∏–æ–ª–æ–≥–∏—è">
    </div>
    <div style="background:var(--blue-l);border-radius:8px;padding:8px 11px;font-size:.74rem;color:var(--blue-d);margin-bottom:8px;line-height:1.5">
      üìÖ –°–æ–∞—Ç“≥–æ–∏ –¥–∞—Ä—Å –∞–∑ <b>–¢–∞“õ–≤–∏–º–∏ –¥–∞—Ä—Å“≥–æ</b> –±–∞—Ä–æ–∏ –∏–Ω –æ–º”Ø–∑–≥–æ—Ä —Ç–∞–Ω–∑–∏–º –∫–∞—Ä–¥–∞ –º–µ—à–∞–≤–∞–¥.<br>
      –î–∞—Ä –ø–æ—ë–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–∏ –æ–º”Ø–∑–≥–æ—Ä ‚Üí <b>–¢–∞“õ–≤–∏–º–∏ –¥–∞—Ä—Å“≥–æ</b> ‚Üí —Ä”Ø–∑—É –¥–∞—Ä—Å—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥.
    </div>
    <div class="mf">
      <button class="btn bb bblk" onclick="saveAddSubject()">‚úÖ –ò–ª–æ–≤–∞</button>
      <button class="btn bgh" onclick="closeModal('m-add-subj')">–ë–µ–∫–æ—Ä</button>
    </div>
  </div>
</div>

<!-- Modal: Transfer subject to another teacher -->
<div class="overlay" id="m-transfer-subj">
  <div class="modal"><div class="mh"></div><div class="mt">üîÑ –ò–Ω—Ç–∏“õ–æ–ª–∏ —Ñ–∞–Ω</div>
    <input type="hidden" id="ts-from-tid">
    <input type="hidden" id="ts-gid">
    <input type="hidden" id="ts-subj-id">
    <div id="ts-info" style="background:var(--blue-l);border-radius:8px;padding:9px 12px;font-size:.8rem;margin-bottom:12px;line-height:1.5"></div>
    <div class="fg"><label class="fl">–ë–∞ –∫–∞–¥–æ–º –æ–º”Ø–∑–≥–æ—Ä –∏–Ω—Ç–∏“õ–æ–ª –¥–∏“≥–µ–º?</label>
      <select class="fc" id="ts-to-tid">
        <option value="">‚Äî –û–º”Ø–∑–≥–æ—Ä—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥ ‚Äî</option>
      </select>
    </div>
    <div style="background:#fef3c7;border-radius:8px;padding:9px 12px;font-size:.75rem;color:#92400e;margin-bottom:10px;line-height:1.5">
      ‚ö†Ô∏è “≤–∞–º–∞–∏ –º–∞—ä–ª—É–º–æ—Ç–∏ –¥–∞–≤–æ–º–∞—Ç–∏ –∏–Ω —Ñ–∞–Ω –±–∞ –æ–º”Ø–∑–≥–æ—Ä–∏ –Ω–∞–≤ –º–µ–≥—É–∑–∞—Ä–∞–¥.
    </div>
    <div class="mf">
      <button class="btn bor bblk" onclick="confirmTransferSubject()">üîÑ –ò–Ω—Ç–∏“õ–æ–ª</button>
      <button class="btn bgh" onclick="closeModal('m-transfer-subj')">–ë–µ–∫–æ—Ä</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================
//  DATABASE
// ============================================
let db={
  groups:[],attendance:{},
  settings:{instName:'',teacherName:'',adminPw:'admin',
    shifts:{
      1:[{id:'l1',name:'1-–¥–∞—Ä—Å',time:'08:00'},{id:'l2',name:'2-–¥–∞—Ä—Å',time:'09:00'},{id:'l3',name:'3-–¥–∞—Ä—Å',time:'10:00'},{id:'l4',name:'4-–¥–∞—Ä—Å',time:'11:00'},{id:'l5',name:'5-–¥–∞—Ä—Å',time:'12:00'}],
      2:[{id:'m1',name:'1-–¥–∞—Ä—Å',time:'13:00'},{id:'m2',name:'2-–¥–∞—Ä—Å',time:'14:00'},{id:'m3',name:'3-–¥–∞—Ä—Å',time:'15:00'},{id:'m4',name:'4-–¥–∞—Ä—Å',time:'16:00'},{id:'m5',name:'5-–¥–∞—Ä—Å',time:'17:00'}]
    },
    teachers:[]
  }
};

function lDB(){
  try{const s=localStorage.getItem('dav7');if(s)db=JSON.parse(s);}catch(e){}
  _initDefaults();
}
function _initDefaults(){
  if(!db.groups)db.groups=[];
  if(!db.attendance)db.attendance={};
  if(!db.settings)db.settings={};
  if(!db.settings.adminPw)db.settings.adminPw='admin';
  if(!db.settings.shifts)db.settings.shifts={1:[{id:'l1',name:'1-–¥–∞—Ä—Å',time:'08:00'},{id:'l2',name:'2-–¥–∞—Ä—Å',time:'09:00'},{id:'l3',name:'3-–¥–∞—Ä—Å',time:'10:00'},{id:'l4',name:'4-–¥–∞—Ä—Å',time:'11:00'},{id:'l5',name:'5-–¥–∞—Ä—Å',time:'12:00'}],2:[{id:'m1',name:'1-–¥–∞—Ä—Å',time:'13:00'},{id:'m2',name:'2-–¥–∞—Ä—Å',time:'14:00'},{id:'m3',name:'3-–¥–∞—Ä—Å',time:'15:00'},{id:'m4',name:'4-–¥–∞—Ä—Å',time:'16:00'},{id:'m5',name:'5-–¥–∞—Ä—Å',time:'17:00'}]};
  if(!db.settings.teachers)db.settings.teachers=[];
  db.settings.teachers.forEach(t=>{
    if(!t.scheduleByGroup)t.scheduleByGroup={};
    if(!t.dateScheduleByGroup)t.dateScheduleByGroup={};
    if(!t.groupPerms)t.groupPerms={};
    Object.entries(t.groupPerms).forEach(([gid,gp])=>{
      if(!gp.subjects){
        gp.subjects=[];
        if(gp.allowedLessons&&gp.allowedLessons.length){
          const subjName=t.subject||'–§–∞–Ω';
          gp.allowedLessons.forEach((lid,i)=>{
            gp.subjects.push({id:uid(),name:subjName+(gp.allowedLessons.length>1?' '+(i+1):''),
              lessonId:null,schedule:{},dateSchedule:{}});
          });
        }
      }
      if(!gp.allowedLessons)gp.allowedLessons=[];
      // Migrate per-subject: ensure schedule/dateSchedule exist
      (gp.subjects||[]).forEach(s=>{
        if(!s.schedule)s.schedule={};
        if(!s.dateSchedule)s.dateSchedule={};
        // Migrate: if old scheduleByGroup[gid] exists, move to first subject only once
        if(!s._schedMigrated && t.scheduleByGroup[gid] && Object.keys(t.scheduleByGroup[gid]).length){
          if(gp.subjects.indexOf(s)===0){
            s.schedule=JSON.parse(JSON.stringify(t.scheduleByGroup[gid]));
            s._schedMigrated=true;
          }
        }
        if(!s._dateMigrated && t.dateScheduleByGroup[gid] && Object.keys(t.dateScheduleByGroup[gid]).length){
          if(gp.subjects.indexOf(s)===0){
            s.dateSchedule=JSON.parse(JSON.stringify(t.dateScheduleByGroup[gid]));
            s._dateMigrated=true;
          }
        }
      });
    });
  });
}
// sv() = save to localStorage + async cloud sync
function sv(){svCloud();}
function uid(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5);}
function sortS(a){return[...a].sort((x,y)=>{const la=(x.last||'').toLowerCase(),lb=(y.last||'').toLowerCase();if(la<lb)return-1;if(la>lb)return 1;return(x.first||'').toLowerCase()<(y.first||'').toLowerCase()?-1:1;});}
function ini(s){return((s.last||'').charAt(0)+(s.first||'').charAt(0)).toUpperCase();}
function getLessons(gid){const g=db.groups.find(x=>x.id===gid);const sh=g?.shift||1;return db.settings.shifts[sh]||[];}
function p2(n){return String(n).padStart(2,'0');}
function aKey(sid,y,m,d,lid){return`${sid}_${y}-${p2(m)}-${p2(d)}_${lid}`;}

function normSt(v){return (v&&typeof v==='object')?v.st:v;}
function normBy(v){
  if(!(v&&typeof v==='object'))return null;
  const who=v.byName|| (v.by==='admin'?'–ê–¥–º–∏–Ω':v.by);
  return {who,subject:v.subject||'',tid:v.byTid||'',phone:v.byPhone||'',at:v.at||null,by:v.by||null};
}
function isSun(y,m,d){return new Date(y,m,d).getDay()===0;}
function dimF(y,m){return new Date(y,m+1,0).getDate();}

// Attendance % helpers (per student)
function isNonPresent(st){return st==='absent'||st==='sick'||st==='excused';}
function lessonsForDate(gid, date){
  // Respect teacher lesson permissions & schedules; admin sees all lessons
  if(curUser?.type==='teacher') return getAllowedLessons(gid, date);
  return getLessons(gid);
}
function calcPresencePercent(gid, sid, fromDate, toDate){
  const att=db.attendance?.[gid]||{};
  let total=0, present=0;
  let d=new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
  const end=new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());
  while(d<=end){
    if(d.getDay()!==0){ // skip Sundays
      const ls=lessonsForDate(gid, d) || [];
      ls.forEach(l=>{
        total++;
        const key=aKey(sid, d.getFullYear(), d.getMonth()+1, d.getDate(), l.id);
        const st=att[key];
        if(!isNonPresent(st)) present++;
      });
    }
    d.setDate(d.getDate()+1);
  }
  if(total===0) return 0;
  return Math.round((present/total)*100);
}
function studentMonthPercent(gid, sid, baseDate){
  const dt=baseDate||new Date();
  const y=dt.getFullYear(), m=dt.getMonth();
  const from=new Date(y,m,1);
  const to=new Date(y,m,dimF(y,m));
  return calcPresencePercent(gid,sid,from,to);
}


// ============================================
//  AUTH & PERMISSIONS (with per-group schedule)
// ============================================
let curUser=null;

function buildLoginSelect(){
  const sel=document.getElementById('login-who');
  sel.innerHTML='<option value="admin">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>'+
    (db.settings.teachers||[]).map(t=>`<option value="${t.id}">üë®‚Äçüè´ ${t.last} ${t.first}${t.tid?' ['+t.tid+']':''}</option>`).join('');
  // Reset subject dropdown
  const wrap=document.getElementById('login-subject-wrap');
  if(wrap)wrap.style.display='none';
}
function filterLoginList(q){
  const sel=document.getElementById('login-who');
  const lq=(q||'').toLowerCase().trim();
  const teachers=db.settings.teachers||[];
  const filtered=lq
    ? teachers.filter(t=>{
        const nameMatch=(t.last+' '+t.first).toLowerCase().includes(lq);
        const idMatch=t.tid&&t.tid.toLowerCase().includes(lq);
        return nameMatch||idMatch;
      })
    : teachers;
  sel.innerHTML='<option value="admin">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>'+
    filtered.map(t=>`<option value="${t.id}">üë®‚Äçüè´ ${t.last} ${t.first}${t.tid?' ['+t.tid+']':''}</option>`).join('');
  if(filtered.length===1){sel.value=filtered[0].id;onLoginWhoChange();}
}
function doLogin(){
  const who=document.getElementById('login-who').value;
  const pw=document.getElementById('login-pass').value;
  const err=document.getElementById('login-err');
  if(who==='admin'){
    if(pw!==db.settings.adminPw){err.style.display='block';err.textContent='–†–∞–º–∑–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–æ–¥—É—Ä—É—Å—Ç!';return;}
    curUser={type:'admin'};
  }else{
    const t=db.settings.teachers.find(x=>x.id===who);
    if(!t||pw!==t.pw){err.style.display='block';err.textContent='–†–∞–º–∑ –Ω–æ–¥—É—Ä—É—Å—Ç!';return;}
    // No subject selection on login ‚Äî teacher sees all subjects in cabinet
    curUser={type:'teacher',...t,activeSubject:null};
    // attGid will be set when teacher picks a group/subject in cabinet
    attGid=null;
  }
  err.style.display='none';
  document.getElementById('login-screen').style.display='none';
  document.getElementById('main-hdr').style.display='block';
  // Show active subject in header
  const hdrName=curUser.type==='admin'?'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä':'üë®‚Äçüè´ '+curUser.last+' '+curUser.first;
  document.getElementById('hdr-uname').textContent=hdrName;
  buildNav();
  initApp();
  if (sbConfigured()) {
    startRealtimeSync();
    lDBCloud().then(ok => {
      if(ok){ _initDefaults(); renderGroups?.(); buildLoginSelect?.(); }
    });
  }
}
function doLogout(){
  curUser=null;
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('main-hdr').style.display='none';
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById('login-pass').value='';
  buildLoginSelect();
}

function getPerms(){
  if(!curUser)return[];
  if(curUser.type==='admin')return['groups','attendance','sms','stats','settings'];
  const base=['groups','attendance'];
  const extra=(curUser.perms||[]).filter(p=>['sms','stats'].includes(p));
  return [...base,...extra];
}
function hasPerm(p){return getPerms().includes(p);}

function hasGroupPerm(gid,type){
  if(curUser?.type==='admin')return true;
  const gp=(curUser?.groupPerms||{})[gid];
  if(!gp)return false;
  return gp[type]===true;
}

// NEW: Get allowed lessons considering per-group day of week and specific dates
function getAllowedLessonIds(gid, date){
  if(curUser?.type==='admin') return null; // null = all allowed

  // Teacher with active subject ‚Äî use THAT subject's own schedule ONLY
  const _activeSubj = typeof teacherActiveSubj!=='undefined'?teacherActiveSubj:curUser?.activeSubject;
  if(_activeSubj && _activeSubj.gid===gid){
    const subj=_activeSubj._subjObj; // full subject object
    if(!subj) return []; // no subject config => no access (safer)

    // –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä”Ø–∑
    if(date){
      const dateStr=`${date.getFullYear()}-${p2(date.getMonth()+1)}-${p2(date.getDate())}`;
      const ds=subj.dateSchedule||{};
      if(ds[dateStr] && ds[dateStr].lessons?.length) return ds[dateStr].lessons;

      const dow=date.getDay(); // 0..6
      const sc=subj.schedule||{};
      if(sc[dow] && sc[dow].enabled && sc[dow].lessons?.length) return sc[dow].lessons;

      // –ê–≥–∞—Ä –±–∞—Ä–æ–∏ “≥–∞–º–∏–Ω —Ä”Ø–∑ –¥–∞—Ä—Å –Ω–∞–±–æ—à–∞–¥ ‚Üí —Ö–æ–ª”£ (–Ω–µ –¥–∞–≤–æ–º–∞—Ç, –Ω–µ —Ç–∞“≥—Ä–∏—Ä)
      return [];
    }

    // no date (month view) ‚Äî collect all lesson ids from enabled days
    const sc=subj.schedule||{};
    const all=[];
    [0,1,2,3,4,5,6].forEach(d=>{
      if(sc[d]?.enabled) (sc[d].lessons||[]).forEach(l=>{ if(!all.includes(l)) all.push(l); });
    });

    // Include also specific-date lessons (so month view shows them too)
    const ds=subj.dateSchedule||{};
    Object.values(ds).forEach(v=>{
      (v?.lessons||[]).forEach(l=>{ if(!all.includes(l)) all.push(l); });
    });

    return all;
  }

  // No activeSubject (fallback) ‚Äî union of all subjects in this group
  const gp=(curUser?.groupPerms||{})[gid];
  if(!gp||!gp.att) return [];
  const subjects=gp.subjects||[];

  if(!date){
    // month view without activeSubject: show union of enabled lessons from all subjects
    const all=[];
    subjects.forEach(s=>{
      const sc=s.schedule||{};
      [0,1,2,3,4,5,6].forEach(d=>{
        if(sc[d]?.enabled) (sc[d].lessons||[]).forEach(l=>{ if(!all.includes(l)) all.push(l); });
      });
      const ds=s.dateSchedule||{};
      Object.values(ds).forEach(v=>{
        (v?.lessons||[]).forEach(l=>{ if(!all.includes(l)) all.push(l); });
      });
    });
    return all;
  }

  const dateStr=`${date.getFullYear()}-${p2(date.getMonth()+1)}-${p2(date.getDate())}`;
  const dow=date.getDay();
  const all=[];
  subjects.forEach(s=>{
    const ds=s.dateSchedule||{};
    const sc=s.schedule||{};
    let ids=[];
    if(ds[dateStr]&&ds[dateStr].lessons?.length) ids=ds[dateStr].lessons;
    else if(sc[dow]&&sc[dow].enabled&&sc[dow].lessons?.length) ids=sc[dow].lessons;
    ids.forEach(l=>{if(!all.includes(l))all.push(l);});
  });
  return all;
}

function getAllowedLessons(gid, date){
  const all = getLessons(gid);
  if(curUser?.type==='admin') return all;
  const allowedIds = getAllowedLessonIds(gid, date);
  if(!allowedIds || allowedIds.length === 0) return [];
  return all.filter(l=>allowedIds.includes(l.id));
}

function canChangeView(){
  if(curUser?.type==='admin')return true;
  return curUser?.canChangeView===true;
}

const ALL_PAGES=[
  {id:'groups',icon:'üë•',label:'–ì—É—Ä”Ø“≥“≥–æ'},
  {id:'attendance',icon:'üìã',label:'–î–∞–≤–æ–º–∞—Ç'},
  {id:'sms',icon:'üì®',label:'SMS'},
  {id:'stats',icon:'üìä',label:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'},
  {id:'settings',icon:'‚öôÔ∏è',label:'–¢–∞–Ω–∑–∏–º–æ—Ç'}
];
function buildNav(){
  const nav=document.getElementById('main-nav');
  const perms=getPerms();
  nav.innerHTML=ALL_PAGES.filter(p=>perms.includes(p.id)).map(p=>`
    <div class="nitem" data-p="${p.id}" onclick="gp('${p.id}')"><div class="ni">${p.icon}</div>${p.label}</div>`).join('');
  const first=ALL_PAGES.find(p=>perms.includes(p.id));
  if(first)gp(first.id);
}
function initApp(){
  const adminBtns=document.getElementById('grp-admin-btns');
  if(curUser?.type==='admin'){
    adminBtns.innerHTML=`<button class="btn bgh bsm" onclick="expJSON()">üì§ JSON</button>
      <button class="btn bgh bsm" onclick="document.getElementById('imp-json').click()">üì• JSON</button>
      <input type="file" id="imp-json" accept=".json" style="display:none" onchange="impJSON(event)">
      <button class="btn bb bsm" onclick="openModal('m-addg')">Ôºã –ì—É—Ä”Ø“≥</button>`;
  }else{
    adminBtns.innerHTML='';
  }
  renderGroups();

}

// ============================================
//  NAVIGATION
// ============================================
function gp(p){
  if(!hasPerm(p)){toast('–î–æ—Å—Ç—É–ø –Ω–µ—Å—Ç!');return;}
  document.querySelectorAll('.page').forEach(x=>x.style.display='none');
  document.querySelectorAll('.nitem').forEach(x=>x.classList.remove('active'));
  const pg=document.getElementById('page-'+p);
  if(pg){pg.style.display='block';pg.classList.add('active');}
  document.querySelector(`.nitem[data-p="${p}"]`)?.classList.add('active');
  if(p==='attendance')renderAtt();
  if(p==='sms'){popSMSGroups();renderSMSCtrl();renderSMS();}
  if(p==='stats'){popStGroups();updStCtrl();renderStats();}
  if(p==='settings')renderSettings();
}

// ============================================
//  GROUPS
// ============================================
let curGid=null;
let groupSearch='';

function getVisibleGroups(){
  if(curUser?.type==='admin')return db.groups;
  const gp=curUser?.groupPerms||{};
  return db.groups.filter(g=>{
    const gPerms=gp[g.id];
    return gPerms&&(gPerms.att||gPerms.list);
  });
}
function getSortedGroups(groups){
  return [...(groups||[])].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
}

function renderGroups(){
  const c=document.getElementById('gl-c');
  const allGroups=getSortedGroups(getVisibleGroups());
  const q=(groupSearch||'').toLowerCase().trim();
  const groups=q?allGroups.filter(g=>{
    const nm=(g.name||'').toLowerCase();
    const cd=(g.code||'').toLowerCase();
    const id=(g.id||'').toLowerCase();
    return nm.includes(q)||cd.includes(q)||id.includes(q);
  }):allGroups;
  if(!groups.length){c.innerHTML='<div class="empty"><div class="ei">üìÇ</div><div class="et">–ì—É—Ä”Ø“≥ –Ω–µ—Å—Ç</div></div>';return;}
  c.innerHTML=groups.map((g,gi)=>{
    const sh=g.shift||1;
    const canAtt=hasGroupPerm(g.id,'att');
    const canList=hasGroupPerm(g.id,'list');
    const isAdmin=curUser?.type==='admin';
    return`<div class="gcrd${sh===2?' s2':''}">
      <div class="gct">
        <div>
          <div class="gcn">${gi+1}. ${g.name}${g.code?`<span class="bdg bdb">${g.code}</span>`:''} <span class="bdg ${sh===2?'bdo':'bdb'}">–ë–∞—Å—Ç ${sh}</span></div>
          <div class="gcc">${g.students?.length||0} –¥–æ–Ω–∏—à“∑”Ø</div>
        </div>
        <div style="color:var(--blue);font-size:1.1rem">‚Ä∫</div>
      </div>
      <div class="gca">
        ${(isAdmin||canAtt)?`<button class="btn bb bsm" style="flex:1" onclick="openAtt('${g.id}')">üìã –î–∞–≤–æ–º–∞—Ç</button>`:''}
        ${(isAdmin||canList)?`<button class="btn bgh bsm" style="flex:1" onclick="openGD('${g.id}')">üë• –†”Ø–π—Ö–∞—Ç</button>`:''}
        ${isAdmin?`<button class="btn bgh bico" onclick="openEditGroup('${g.id}')" title="–¢–∞“≥—Ä–∏—Ä">‚úèÔ∏è</button>`:''}${isAdmin?`<button class="btn bgh bico" onclick="delG('${g.id}')" title="“≤–∞–∑—Ñ">üóëÔ∏è</button>`:''}
      </div>
    </div>`;
  }).join('');
}

function openAtt(gid){
  attGid=gid;
  gp('attendance');
  if(sbConfigured()){
    sbLoadAtt(gid).then(attData=>{
      if(attData!==null){
        db.attendance[gid]=attData;
        localStorage.setItem('dav7',JSON.stringify(db));
        renderAttT?.();
      }
    });
  }
}
function attBack(){attGid=null;gp('groups');}

function openGD(gid){
  curGid=gid;
  const g=db.groups.find(x=>x.id===gid);
  document.getElementById('v-gl').style.display='none';
  document.getElementById('v-gd').style.display='block';
  document.getElementById('gd-t').textContent=g.name;
  renderSL(g);
}
function backG(){document.getElementById('v-gl').style.display='block';document.getElementById('v-gd').style.display='none';curGid=null;renderGroups();}

function renderSL(g){
  const c=document.getElementById('s-c');
  const sorted=sortS(g.students||[]);
  if(!sorted.length){c.innerHTML=`<div class="empty"><div class="ei">üë§</div><div class="et">–î–æ–Ω–∏—à“∑”Ø –Ω–µ—Å—Ç</div></div>`;return;}
  c.innerHTML=sorted.map((s,i)=>`
    <div class="srow" onclick="editS('${s.id}')">
      <div class="ava">${ini(s)}</div>
      <div style="flex:1"><div class="sn">${i+1}. ${s.last} ${s.first}${s.sid?` <span class=\"bdg bdo\">ID: ${s.sid}</span>`:''}${s.fromGid?'<span class="tchip">‚Üî</span>':''}<span class="bdg bdb" style="margin-left:6px">“≤—É–∑—É—Ä: ${studentMonthPercent(g.id,s.id)}%</span></div>
      <div class="ss">${s.phone||''}${s.pphone?' ¬∑ üë®‚Äçüë©‚Äçüëß '+s.pphone:''}</div></div>
      <div style="color:var(--blue)">‚Ä∫</div>
    </div>`).join('');
}

function addGroup(){
  const name=document.getElementById('ng-n').value.trim();if(!name){toast('–ù–æ–º—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥!');return;}
  const g={id:uid(),name,code:document.getElementById('ng-c').value.trim(),shift:parseInt(document.getElementById('ng-sh').value)||1,students:[]};
  db.groups.push(g);db.attendance[g.id]={};sv();closeModal('m-addg');
  document.getElementById('ng-n').value='';document.getElementById('ng-c').value='';
  renderGroups();toast('–ì—É—Ä”Ø“≥ –∏–ª–æ–≤–∞ —à—É–¥ ‚úÖ');
}
function delG(gid){if(!confirm('“≤–∞–∑—Ñ?'))return;db.groups=db.groups.filter(x=>x.id!==gid);delete db.attendance[gid];sv();renderGroups();toast('“≤–∞–∑—Ñ —à—É–¥');}


function openEditGroup(gid){
  const g=db.groups.find(x=>x.id===gid); if(!g) return;
  document.getElementById('edg-id').value = g.id;
  document.getElementById('edg-n').value = g.name || '';
  document.getElementById('edg-c').value = g.code || '';
  document.getElementById('edg-sh').value = String(g.shift||1);
  const sys=document.getElementById('edg-sys'); if(sys) sys.textContent = g.id;
  openModal('m-edg');
}
function saveEditGroup(){
  const gid=document.getElementById('edg-id').value;
  const g=db.groups.find(x=>x.id===gid); if(!g) return;
  const name=(document.getElementById('edg-n').value||'').trim();
  if(!name){ toast('–ù–æ–º—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥!'); return; }
  g.name = name;
  g.code = (document.getElementById('edg-c').value||'').trim();
  g.shift = parseInt(document.getElementById('edg-sh').value)||1;
  sv();
  closeModal('m-edg');
  // refresh UI
  renderGroups();
  if(curGid===gid){
    document.getElementById('gd-t').textContent = g.name;
    const attLbl=document.getElementById('att-gl');
    if(attLbl) attLbl.textContent = g.name;
  }
  toast('–ì—É—Ä”Ø“≥ –Ω–∞–≤ —à—É–¥ ‚úÖ');
}


function openAddS(){['ns-sid','ns-l','ns-f','ns-fa','ns-mo','ns-ph','ns-pp'].forEach(id=>document.getElementById(id).value='');openModal('m-adds');}
function addStudent(){
  const g=db.groups.find(x=>x.id===curGid);if(!g)return;
  const last=document.getElementById('ns-l').value.trim(),first=document.getElementById('ns-f').value.trim();
  if(!last&&!first){toast('–ù–æ–º—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥!');return;}
  g.students.push({id:uid(),sid:document.getElementById('ns-sid').value.trim(),last,first,father:document.getElementById('ns-fa').value.trim(),mother:document.getElementById('ns-mo').value.trim(),phone:document.getElementById('ns-ph').value.trim(),pphone:document.getElementById('ns-pp').value.trim(),addedAt:new Date().toISOString()});
  g.students=sortS(g.students);sv();closeModal('m-adds');renderSL(g);toast('–ò–ª–æ–≤–∞ —à—É–¥ ‚úÖ');
}

function editS(sid){
  const g=db.groups.find(x=>x.id===curGid);const s=g?.students.find(x=>x.id===sid);if(!s)return;
  document.getElementById('es-id').value=sid;
  document.getElementById('es-sid').value=(s.sid||'');
  ['l','f','fa','mo','ph','pp'].forEach(k=>document.getElementById('es-'+k).value=s[{l:'last',f:'first',fa:'father',mo:'mother',ph:'phone',pp:'pphone'}[k]]||'');
  const sel=document.getElementById('es-tr');
  sel.innerHTML='<option value="">‚Äî –ò–Ω—Ç–∏“õ–æ–ª –Ω–µ—Å—Ç ‚Äî</option>'+db.groups.filter(gg=>gg.id!==curGid).map(gg=>`<option value="${gg.id}">${gg.name} ‚Äî –ë–∞—Å—Ç ${gg.shift||1}</option>`).join('');
  openModal('m-eds');
}
function saveEdit(){
  const g=db.groups.find(x=>x.id===curGid);const sid=document.getElementById('es-id').value;const s=g?.students.find(x=>x.id===sid);if(!s)return;
  s.last=document.getElementById('es-l').value.trim();s.first=document.getElementById('es-f').value.trim();
  s.father=document.getElementById('es-fa').value.trim();s.mother=document.getElementById('es-mo').value.trim();
  s.phone=document.getElementById('es-ph').value.trim();s.pphone=document.getElementById('es-pp').value.trim();
  s.sid=document.getElementById('es-sid').value.trim();
  const toGid=document.getElementById('es-tr').value;
  if(toGid){
    const toG=db.groups.find(x=>x.id===toGid);if(!toG)return;
    const nid=uid();const ns={...s,id:nid,fromGid:curGid,fromGName:g.name,addedAt:new Date().toISOString()};
    toG.students.push(ns);toG.students=sortS(toG.students);
    if(!db.attendance[toGid])db.attendance[toGid]={};
    Object.entries(db.attendance[curGid]||{}).forEach(([k,v])=>{if(k.startsWith(sid+'_'))db.attendance[toGid][nid+k.slice(sid.length)]=v;});
    g.students=g.students.filter(x=>x.id!==sid);
    Object.keys(db.attendance[curGid]||{}).forEach(k=>{if(k.startsWith(sid+'_'))delete db.attendance[curGid][k];});
    sv();closeModal('m-eds');renderSL(g);toast(s.last+' ‚Üí '+toG.name+' ‚úÖ');return;
  }
  g.students=sortS(g.students);sv();closeModal('m-eds');renderSL(g);toast('–ù–∏–≥–æ“≥ ‚úÖ');
}
function delS(){
  if(!confirm('“≤–∞–∑—Ñ?'))return;
  const g=db.groups.find(x=>x.id===curGid);const sid=document.getElementById('es-id').value;
  g.students=g.students.filter(x=>x.id!==sid);
  Object.keys(db.attendance[curGid]||{}).forEach(k=>{if(k.startsWith(sid+'_'))delete db.attendance[curGid][k];});
  sv();closeModal('m-eds');renderSL(g);toast('“≤–∞–∑—Ñ —à—É–¥');
}

let impD=[];
function openImp(){impD=[];document.getElementById('imp-prev').innerHTML='';document.getElementById('imp-ok').style.display='none';document.getElementById('imp-f').value='';openModal('m-imp');}
function onIF(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    const lines=ev.target.result.split('\n').map(l=>l.trim()).filter(Boolean);
    impD=lines.map(line=>{const parts=line.split(/\s+/);const ph=parts.find(p=>p.startsWith('+')||/^\d{9,}/.test(p))||'';const np=parts.filter(p=>p!==ph);return{id:uid(),last:np[0]||'',first:np[1]||'',father:np[2]||'',mother:'',phone:ph,pphone:'',addedAt:new Date().toISOString()};});
    document.getElementById('imp-prev').innerHTML=`<div style="font-weight:700;color:var(--green);margin-bottom:5px">‚úÖ ${impD.length} —Ç–æ–ø–∏–ª–¥</div><div style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:7px">${impD.map((s,i)=>`<div style="padding:4px 8px;border-bottom:1px solid var(--border);font-size:.75rem">${i+1}. ${s.last} ${s.first}</div>`).join('')}</div>`;
    document.getElementById('imp-ok').style.display='flex';
  };
  r.readAsText(f,'UTF-8');
}
function confImp(){const g=db.groups.find(x=>x.id===curGid);if(!g)return;impD.forEach(s=>g.students.push(s));g.students=sortS(g.students);sv();closeModal('m-imp');renderSL(g);toast(impD.length+' –∏–ª–æ–≤–∞ —à—É–¥ ‚úÖ');}

function expSXls(){const g=db.groups.find(x=>x.id===curGid);if(!g)return;let c='\uFEFF\u2116,\u041d\u0430\u0441\u0430\u0431,\u041d\u043e\u043c,\u041f\u0430\u0434\u0430\u0440,\u041c\u043e\u0434\u0430\u0440,\u0422\u0435\u043b. \u0445\u0443\u0434,\u0422\u0435\u043b. \u0432\u043e\u043b\u0438\u0434\u0430\u0439\u043d\n';sortS(g.students||[]).forEach((s,i)=>c+=`${i+1},"${s.last}","${s.first}","${s.father||''}","${s.mother||''}","${s.phone||''}","${s.pphone||''}"\n`);dl(c,g.name+'_ruyhat.csv','text/csv;charset=utf-8');toast('Excel ‚úÖ');}
function expSTxt(){const g=db.groups.find(x=>x.id===curGid);if(!g)return;let t=`\u0413\u0443\u0440\u04ef\u04b3: ${g.name}\n${'‚îÄ'.repeat(28)}\n`;sortS(g.students||[]).forEach((s,i)=>{t+=`${i+1}. ${s.last} ${s.first} ${s.father||''}\n`;if(s.phone)t+=`   üìû ${s.phone}\n`;if(s.pphone)t+=`   üë®‚Äçüë©‚Äçüëß ${s.pphone}\n`;});dl(t,g.name+'_ruyhat.txt','text/plain;charset=utf-8');toast('–¢–µ–∫—Å—Ç ‚úÖ');}
function dl(c,n,m){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c],{type:m}));a.download=n;a.click();}

// ============================================
//  ATTENDANCE (with per-group schedule)
// ============================================
let attGid=null,vm='day';
let aY=new Date().getFullYear(),aM=new Date().getMonth(),aD=new Date().getDate();
let pCell=null;
const MN=['–Ø–Ω–≤–∞—Ä','–§–µ–≤—Ä–∞–ª','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä','–û–∫—Ç—è–±—Ä','–ù–æ—è–±—Ä','–î–µ–∫–∞–±—Ä'];
const DN=['–Ø–∫—à','–î—É—à','–°–µ—à','–ß–æ—Ä','–ü–∞–Ω','“∂—É–º','–®–∞–Ω'];
const DN_FULL=['–Ø–∫—à–∞–Ω–±–µ','–î—É—à–∞–Ω–±–µ','–°–µ—à–∞–Ω–±–µ','–ß–æ—Ä—à–∞–Ω–±–µ','–ü–∞–Ω“∑—à–∞–Ω–±–µ','“∂—É–º—ä–∞','–®–∞–Ω–±–µ'];

// Currently active subject for teacher (set by tab click)
let teacherActiveSubj = null; // {gid, subjId, subjName, _subjObj}

function renderAtt(){
  // Teacher: build subject/group tabs
  if(curUser?.type==='teacher'){
    buildTeacherSubjTabs();
  }
  if(!attGid){document.getElementById('att-ng').style.display='block';document.getElementById('att-main').style.display='none';return;}
  const g=db.groups.find(x=>x.id===attGid);
  document.getElementById('att-ng').style.display='none';document.getElementById('att-main').style.display='block';
  document.getElementById('att-gl').textContent='üìö '+g.name+(teacherActiveSubj?' ‚Äî '+teacherActiveSubj.subjName:'');
  if(curUser?.type!=='admin'){
    const now=new Date();aY=now.getFullYear();aM=now.getMonth();aD=now.getDate();
    const prev=document.getElementById('dn-prev');const next=document.getElementById('dn-next');
    const pick=document.getElementById('d-pick');
    if(prev)prev.style.opacity='0.3';if(next)next.style.opacity='0.3';
    if(pick)pick.setAttribute('readonly','true');
  }
  setVM(vm,false);
  renderAttT();
}

function buildTeacherSubjTabs(){
  const wrap=document.getElementById('att-subj-tabs');
  const inner=document.getElementById('att-subj-tabs-inner');
  if(!wrap||!inner)return;
  const allSubj=getTeacherSubjects(curUser);
  if(!allSubj.length){wrap.style.display='none';return;}
  wrap.style.display='block';
  inner.innerHTML=allSubj.map(s=>{
    const isActive=teacherActiveSubj&&teacherActiveSubj.subjId===s.subjId&&teacherActiveSubj.gid===s.gid;
    return`<button onclick="selectTeacherSubj('${s.gid}','${s.subjId}')"
      style="white-space:nowrap;padding:6px 12px;border-radius:20px;border:2px solid ${isActive?'var(--blue)':'var(--border)'};
      background:${isActive?'var(--blue)':'#fff'};color:${isActive?'#fff':'var(--text)'};
      font-size:.75rem;font-weight:700;cursor:pointer;transition:.15s">
      üìö ${s.subjName}<br><span style="font-size:.62rem;font-weight:400;opacity:.85">${s.groupName}</span>
    </button>`;
  }).join('');
  // Auto-select first if none active
  if(!teacherActiveSubj&&allSubj.length){
    const s=allSubj[0];
    selectTeacherSubj(s.gid,s.subjId,false);
  }
}

function selectTeacherSubj(gid,subjId,doRender=true){
  const t=curUser;
  const gp=(t.groupPerms||{})[gid];
  const subj=(gp?.subjects||[]).find(s=>s.id===subjId);
  teacherActiveSubj={gid,subjId,subjName:subj?.name||'',_subjObj:subj};
  // Also update curUser.activeSubject for getAllowedLessonIds
  curUser.activeSubject=teacherActiveSubj;
  attGid=gid;
  if(doRender){
    renderAtt();
  }
}
function setVM(mode,doR=true){
  // Teachers can view BOTH day and month, but only edit today
  // (no restriction on mode switching ‚Äî only clickC blocks editing)
  if(curUser?.type!=='admin'&&mode==='day'){
    // Reset day to today for teachers
    const now=new Date();aY=now.getFullYear();aM=now.getMonth();aD=now.getDate();
  }
  vm=mode;
  document.getElementById('vt-d').classList.toggle('active',mode==='day');
  document.getElementById('vt-m').classList.toggle('active',mode==='month');
  document.getElementById('vt-r')?.classList.toggle('active',mode==='range');
  document.getElementById('cd').style.display=mode==='day'?'block':'none';
  document.getElementById('cm').style.display=mode==='month'?'block':'none';
  const crEl=document.getElementById('cr'); if(crEl) crEl.style.display=mode==='range'?'block':'none';
  // Always show view toggle tabs
  const vtEl=document.querySelector('.vt');
  if(vtEl)vtEl.style.display='flex';
  if(doR)renderAttT();
}
function updDL(){const d=new Date(aY,aM,aD);document.getElementById('d-lbl').textContent=`${aD} ${MN[aM]}, ${DN[d.getDay()]}`;document.getElementById('d-pick').value=`${aY}-${p2(aM+1)}-${p2(aD)}`;}
function dSh(n){
  if(curUser?.type!=='admin'){toast('–®—É–º–æ —Ç–∞–Ω“≥–æ —Å–∞–Ω–∞–∏ –∏–º—Ä”Ø–∑—Ä–æ —Ç–∞“ì–π–∏—Ä –¥–æ–¥–∞ –º–µ—Ç–∞–≤–æ–Ω–µ–¥!');return;}
  const d=new Date(aY,aM,aD+n);aY=d.getFullYear();aM=d.getMonth();aD=d.getDate();updDL();renderAttT();
}
function onDP(){
  const v=document.getElementById('d-pick').value;if(!v)return;
  if(curUser?.type!=='admin'){
    // Reset to today
    const now=new Date();
    document.getElementById('d-pick').value=`${now.getFullYear()}-${p2(now.getMonth()+1)}-${p2(now.getDate())}`;
    toast('–®—É–º–æ —Ç–∞–Ω“≥–æ —Å–∞–Ω–∞–∏ –∏–º—Ä”Ø–∑—Ä–æ —Ç–∞“ì–π–∏—Ä –¥–æ–¥–∞ –º–µ—Ç–∞–≤–æ–Ω–µ–¥!');return;
  }
  const[y,m,d]=v.split('-').map(Number);aY=y;aM=m-1;aD=d;updDL();renderAttT();
}
function updML(){document.getElementById('m-lbl').textContent=MN[aM]+' '+aY;}
function mSh(n){
  // Teachers can navigate months for viewing (read-only)
  aM+=n;if(aM<0){aM=11;aY--;}if(aM>11){aM=0;aY++;}
  updML();renderAttT();
  // Show read-only badge when teacher views non-current month
  if(curUser?.type!=='admin'){
    const now=new Date();const isCurrentMonth=(aY===now.getFullYear()&&aM===now.getMonth());
    const badge=document.getElementById('month-view-badge');
    if(badge)badge.style.display=isCurrentMonth?'none':'block';
  }
}

function renderAttT(){if(vm==='day')renderDayT();else if(vm==='month')renderMonthT();else renderRangeT();}
function renderDayT(){
  updDL();const g=db.groups.find(x=>x.id===attGid);if(!g)return;
  const currentDate = new Date(aY, aM, aD);
  const lessons = getAllowedLessons(attGid, currentDate);
  if(lessons.length===0){
    const dayName = DN_FULL[currentDate.getDay()];
    document.getElementById('att-t').innerHTML=`<tr><td colspan="10" class="empty">–ë–∞—Ä–æ–∏ ${g.name} –¥–∞—Ä ${dayName} (${aD} ${MN[aM]}) —è–≥–æ–Ω –¥–∞—Ä—Å —Ç–∞–Ω–∑–∏–º –Ω–∞—à—É–¥–∞–∞—Å—Ç</td></tr>`;
    return;
  }
  const att=db.attendance[attGid]||{};const sorted=sortS(g.students||[]);const sun=isSun(aY,aM,aD);
  let h=`<thead><tr><th class="nc">‚Ññ –î–æ–Ω–∏—à“∑”Ø</th>`;
  lessons.forEach(l=>h+=`<th style="min-width:46px;font-size:.72rem${sun?';background:#dc2626':''}">${l.name}<br><span style="font-size:.58rem;opacity:.8">${l.time||''}</span></th>`);
  h+=`<th class="sc">“∂–∞–º—ä</th></tr></thead><tbody>`;
  sorted.forEach((s,idx)=>{
    let n=0,b=0,u=0;h+=`<tr><td class="nc"><div style="font-size:.77rem;font-weight:700">${idx+1}. ${s.last}</div><div style="font-size:.67rem;color:var(--muted)">${s.first}</div></td>`;
    lessons.forEach(l=>{const k=aKey(s.id,aY,aM+1,aD,l.id);const st=normSt(att[k]);let cls='ce',lb='‚Äî';if(st==='absent'){cls='ca';lb='–ù';n++;}else if(st==='sick'){cls='cs';lb='–ë';b++;}else if(st==='excused'){cls='cu';lb='–£';u++;}h+=`<td${sun?' class="snd"':''}><div class="ac ${cls}" onclick="clickC('${s.id}',${aY},${aM+1},${aD},'${l.id}')">${lb}</div></td>`;});
    h+=`<td class="sc"><span class="sn2">–ù:${n}</span> <span class="sb2">–ë:${b}</span> <span class="su2">–£:${u}</span></td></tr>`;
  });
  document.getElementById('att-t').innerHTML=h+'</tbody>';
}
function renderMonthT(){
  updML();const g=db.groups.find(x=>x.id===attGid);if(!g)return;
  const lessons = getAllowedLessons(attGid, null);
  if(lessons.length===0){document.getElementById('att-t').innerHTML='<tr><td colspan="10" class="empty">–®—É–º–æ –±–∞ —è–≥–æ–Ω –¥–∞—Ä—Å –¥–∞—Å—Ç—Ä–∞—Å”£ –Ω–∞–¥–æ—Ä–µ–¥</td></tr>';return;}
  const att=db.attendance[attGid]||{};const sorted=sortS(g.students||[]);const dM=dimF(aY,aM);const LC=lessons.length;
  let h='<thead><tr><th class="nc" rowspan="2" style="vertical-align:middle;font-size:.74rem">‚Ññ –î–æ–Ω–∏—à“∑”Ø</th>';
  for(let d=1;d<=dM;d++){
    const sun=isSun(aY,aM,d);
    const dayName=DN[new Date(aY,aM,d).getDay()];
    if(sun){
      h+=`<th colspan="1" style="font-size:.62rem;border-left:2px solid rgba(255,255,255,.4);background:#dc2626;min-width:22px">${d}<br><span style="font-size:.55rem;opacity:.9">${dayName}</span></th>`;
    } else {
      h+=`<th colspan="${LC}" style="font-size:.62rem;border-left:2px solid rgba(255,255,255,.4);min-width:${LC*24}px">${d}<br><span style="font-size:.55rem;opacity:.8">${dayName}</span></th>`;
    }
  }
  h+=`<th class="sc" rowspan="2" style="vertical-align:middle;font-size:.62rem">“∂–∞–º—ä</th></tr><tr>`;
  for(let d=1;d<=dM;d++){
    const sun=isSun(aY,aM,d);
    if(sun){
      h+=`<th style="font-size:.55rem;padding:2px 1px;min-width:22px;background:#ef4444;border-left:2px solid rgba(255,255,255,.4)">‚Äî</th>`;
    } else {
      lessons.forEach((l,li)=>{
        h+=`<th ${li===0?'class="ds" ':''} style="font-size:.57rem;padding:2px 1px;min-width:24px;background:rgba(255,255,255,.13)">${l.name.replace('-–¥–∞—Ä—Å','')}</th>`;
      });
    }
  }
  h+='</tr></thead><tbody>';
  sorted.forEach((s,idx)=>{
    let n=0,b=0,u=0;
    h+=`<tr><td class="nc"><div style="font-size:.74rem;font-weight:700">${idx+1}. ${s.last}</div><div style="font-size:.64rem;color:var(--muted)">${s.first}</div></td>`;
    for(let d=1;d<=dM;d++){
      const sun=isSun(aY,aM,d);
      if(sun){
        h+=`<td class="snd" style="padding:2px 1px;border-left:2px solid #fca5a5"><div style="width:20px;height:18px;margin:auto;background:#fca5a5;border-radius:4px;font-size:.6rem;display:flex;align-items:center;justify-content:center;color:#fff">‚Äî</div></td>`;
      } else {
        lessons.forEach((l,li)=>{
          const k=aKey(s.id,aY,aM+1,d,l.id);const st=normSt(att[k]);
          let cls='ce',lb='‚Äî';
          if(st==='absent'){cls='ca';lb='–ù';n++;}
          else if(st==='sick'){cls='cs';lb='–ë';b++;}
          else if(st==='excused'){cls='cu';lb='–£';u++;}
          // Teacher: only today is clickable; past/future = read-only display
          const isToday=(()=>{const now=new Date();return aY===now.getFullYear()&&aM===now.getMonth()&&d===now.getDate();})();
          const cellClickable=curUser?.type==='admin'||isToday;
          h+=`<td class="${li===0?'ds':''}" style="padding:2px 1px"><div class="ac ${cls}" style="width:22px;height:19px;font-size:.63rem;${!cellClickable?'cursor:default;opacity:'+( cls==='ce'?'.35':'1')+';':''}" ${cellClickable?`onclick="clickC('${s.id}',${aY},${aM+1},${d},'${l.id}')"`:''}>${lb}</div></td>`;
        });
      }
    }
    h+=`<td class="sc"><span class="sn2">–ù:${n}</span><br><span class="sb2">–ë:${b}</span><br><span class="su2">–£:${u}</span></td></tr>`;
  });
  document.getElementById('att-t').innerHTML=h+'</tbody>';
}

function onRangeApply(){
  const f=document.getElementById('r-from')?.value;
  const t=document.getElementById('r-to')?.value;
  if(!f||!t){toast('–°–∞–Ω–∞“≥–æ—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥!');return;}
  const d1=new Date(f);const d2=new Date(t);
  if(isNaN(d1)||isNaN(d2)){toast('–°–∞–Ω–∞ –Ω–æ–¥—É—Ä—É—Å—Ç!');return;}
  if(d1>d2){toast('–ê–∑ —Å–∞–Ω–∞ –±–æ—è–¥ —Ö—É—Ä–¥—Ç–∞—Ä –±–æ—à–∞–¥!');return;}
  // Limit range to avoid huge tables
  const days=Math.floor((d2-d1)/86400000)+1;
  if(days>31){toast('–î–∏–∞–ø–∞–∑–æ–Ω –∫–∞–ª–æ–Ω –∞—Å—Ç (–∑–∏—ë–¥–∞ –∞–∑ 31 —Ä”Ø–∑). –õ—É—Ç—Ñ–∞–Ω –∫”Ø—Ç–æ“≥ –∫—É–Ω–µ–¥.');return;}
  rFrom=f;rTo=t;
  renderAttT();
}

// Range state
let rFrom=null, rTo=null;

function renderRangeT(){
  const g=db.groups.find(x=>x.id===attGid);if(!g)return;
  // Default dates: last 7 days
  if(!rFrom||!rTo){
    const d2=new Date();
    const d1=new Date();d1.setDate(d2.getDate()-6);
    rFrom=`${d1.getFullYear()}-${p2(d1.getMonth()+1)}-${p2(d1.getDate())}`;
    rTo=`${d2.getFullYear()}-${p2(d2.getMonth()+1)}-${p2(d2.getDate())}`;
    const rf=document.getElementById('r-from');const rt=document.getElementById('r-to');
    if(rf)rf.value=rFrom;if(rt)rt.value=rTo;
  }
  const rf=document.getElementById('r-from');const rt=document.getElementById('r-to');
  if(rf && !rf.value) rf.value=rFrom;
  if(rt && !rt.value) rt.value=rTo;

  // Show view badge (range is view-only)
  const badge=document.getElementById('range-view-badge');
  if(badge) badge.style.display='block';

  const d1=new Date(rFrom);const d2=new Date(rTo);
  const days=Math.floor((d2-d1)/86400000)+1;
  if(days<=0){document.getElementById('att-t').innerHTML='<tr><td colspan="10" class="empty">–î–∏–∞–ø–∞–∑–æ–Ω –Ω–æ–¥—É—Ä—É—Å—Ç</td></tr>';return;}
  if(days>31){document.getElementById('att-t').innerHTML='<tr><td colspan="10" class="empty">–î–∏–∞–ø–∞–∑–æ–Ω –∫–∞–ª–æ–Ω –∞—Å—Ç (–∑–∏—ë–¥–∞ –∞–∑ 31 —Ä”Ø–∑)</td></tr>';return;}

  const att=db.attendance[attGid]||{};
  const sorted=sortS(g.students||[]);
  // Build list of dates
  const dates=[];
  for(let k=0;k<days;k++){
    const d=new Date(d1);d.setDate(d1.getDate()+k);
    dates.push(d);
  }
  // Precompute lessons per date (permission-aware)
  const lessonsByDate=dates.map(d=>{
    const sun=isSun(d.getFullYear(),d.getMonth(),d.getDate());
    if(sun) return {date:d,sun:true,lessons:[]};
    const ls=getAllowedLessons(attGid,d);
    return {date:d,sun:false,lessons:ls};
  });

  // Header
  let h='<thead><tr><th class="nc" rowspan="2" style="vertical-align:middle;font-size:.74rem">‚Ññ –î–æ–Ω–∏—à“∑”Ø</th>';
  lessonsByDate.forEach(obj=>{
    const d=obj.date;
    const day=d.getDate();
    const mon=MN[d.getMonth()];
    const dayName=DN[d.getDay()];
    if(obj.sun){
      h+=`<th colspan="1" style="font-size:.62rem;border-left:2px solid rgba(255,255,255,.4);background:#dc2626;min-width:22px">${day}<br><span style="font-size:.55rem;opacity:.9">${dayName}</span></th>`;
    }else{
      const lc=(obj.lessons||[]).length || 1;
      h+=`<th colspan="${lc}" style="font-size:.62rem;border-left:2px solid rgba(255,255,255,.4);min-width:${lc*24}px">${day} ${mon}<br><span style="font-size:.55rem;opacity:.8">${dayName}</span></th>`;
    }
  });
  h+=`<th class="sc" rowspan="2" style="vertical-align:middle;font-size:.62rem">“∂–∞–º—ä</th></tr><tr>`;
  lessonsByDate.forEach(obj=>{
    if(obj.sun){
      h+=`<th class="snh" style="font-size:.6rem">‚Äî</th>`;
    }else{
      const ls=obj.lessons||[];
      if(ls.length===0){
        h+=`<th style="font-size:.6rem;opacity:.7">‚Äî</th>`;
      }else{
        ls.forEach((l,li)=>h+=`<th style="font-size:.6rem;opacity:.9">${l.name.replace('–¥–∞—Ä—Å','')}</th>`);
      }
    }
  });
  h+='</tr></thead><tbody>';

  // Body (view-only)
  sorted.forEach((s,idx)=>{
    let n=0,b=0,u=0;
    h+=`<tr><td class="nc"><div style="font-size:.77rem;font-weight:700">${idx+1}. ${s.last}</div><div style="font-size:.67rem;color:var(--muted)">${s.first}</div></td>`;
    lessonsByDate.forEach(obj=>{
      const d=obj.date;
      const y=d.getFullYear(), m=d.getMonth()+1, dd=d.getDate();
      if(obj.sun){
        h+=`<td class="snd">‚Äî</td>`;
        return;
      }
      const ls=obj.lessons||[];
      if(ls.length===0){
        h+=`<td class="ce">‚Äî</td>`;
        return;
      }
      ls.forEach(l=>{
        const k=aKey(s.id,y,m,dd,l.id);
        const v=att[k];
        const st=normSt(v)||'present';
        if(st==='absent')n++; else if(st==='sick')b++; else if(st==='excused')u++;
        let cls='ce',lb='‚Äî';
        if(st==='absent'){cls='ca';lb='–ù';}
        else if(st==='sick'){cls='cs';lb='–ë';}
        else if(st==='excused'){cls='cu';lb='–£';}
        h+=`<td><div class="ac ${cls}">${lb}</div></td>`;
      });
    });
    h+=`<td class="sc">${n?`<span class="sn2">–ù:${n}</span>`:''}${b?` <span class="sb2">–ë:${b}</span>`:''}${u?` <span class="su2">–£:${u}</span>`:''}</td></tr>`;
  });
  h+='</tbody>';
  document.getElementById('att-t').innerHTML=h;
}


function clickC(sid,y,m,d,lid){
  if(curUser?.type!=='admin'){
    // Teacher: only TODAY is editable
    const now=new Date();const ny=now.getFullYear(),nm=now.getMonth()+1,nd=now.getDate();
    if(y!==ny||m!==nm||d!==nd){
      toast('–®—É–º–æ —Ç–∞–Ω“≥–æ —Å–∞–Ω–∞–∏ –∏–º—Ä”Ø–∑—Ä–æ —Ç–∞“ì–π–∏—Ä –¥–æ–¥–∞ –º–µ—Ç–∞–≤–æ–Ω–µ–¥!');return;
    }
    const currentDate=new Date(y,m-1,d);
    const allowed=getAllowedLessonIds(attGid,currentDate);
    if(!allowed.includes(lid)){toast('–®—É–º–æ –±–∞ –∏–Ω –¥–∞—Ä—Å –¥–∞—Å—Ç—Ä–∞—Å”£ –Ω–∞–¥–æ—Ä–µ–¥');return;}
  }
  pCell={sid,key:aKey(sid,y,m,d,lid)};
  const g=db.groups.find(x=>x.id===attGid);
  const s=g?.students.find(x=>x.id===sid);
  const l=getLessons(attGid).find(x=>x.id===lid);

  // Show "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ": who marked the status (for admin)
  const rec=(db.attendance?.[attGid]||{})[pCell.key];
  const meta=normBy(rec);
  const noteEl=document.getElementById('m-st-note');
  if(noteEl){
    const stNow=normSt(rec);
    if(meta && stNow && stNow!=='present'){
      const subj = meta.subject ? ` ¬∑ ${meta.subject}` : '';
      const when = meta.at ? new Date(meta.at).toLocaleString('ru-RU') : '';
      noteEl.style.display='block';
      noteEl.innerHTML =
        `<div style="font-weight:800;margin-bottom:6px;font-size:.82rem">üìù –ö–∏ –º–æ–Ω–¥–∞ —à—É–¥–∞–∞—Å—Ç</div>`+
        `<div style="display:grid;grid-template-columns:auto 1fr;gap:3px 10px;font-size:.76rem">`+
        `<span style="color:var(--muted)">–û–º”Ø–∑–≥–æ—Ä:</span><b>${meta.who}</b>`+
        (meta.subject?`<span style="color:var(--muted)">–§–∞–Ω:</span><b style="color:var(--blue-d)">üìö ${meta.subject}</b>`:'<span></span><span></span>')+
        `<span style="color:var(--muted)">ID:</span><span>${meta.tid||'‚Äî'}</span>`+
        `<span style="color:var(--muted)">–¢–µ–ª:</span><span>${meta.phone||'‚Äî'}</span>`+
        (l?.name?`<span style="color:var(--muted)">–î–∞—Ä—Å:</span><span>${l.name}${l.time?' ('+l.time+')':''}</span>`:'')+
        (when?`<span style="color:var(--muted)">–í–∞“õ—Ç:</span><span>${when}</span>`:'')+
        `</div>`;
    }else if(curUser?.type==='admin' && stNow && stNow!=='present'){
      // Old records (no meta)
      noteEl.style.display='block';
      noteEl.innerHTML =
        `<div style="font-weight:800;margin-bottom:4px">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div>`+
        `<div style="color:var(--muted)">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç (–∏–Ω —Å–∞–±—Ç –¥–∞—Ä –≤–µ—Ä—Å–∏—è–∏ –∫”Ø“≥–Ω–∞ –º–æ–Ω–¥–∞ —à—É–¥–∞–∞—Å—Ç)</div>`;
    }else{
      noteEl.style.display='none';
      noteEl.textContent='';
    }
  }

  document.getElementById('m-st-t').textContent=`${s?.last} ${s?.first} | ${d} ${MN[m-1]} | ${l?.name||lid}`;
  openModal('m-st');
}
function setSt(st){
  if(!pCell)return;
  if(!db.attendance[attGid])db.attendance[attGid]={};

  let payload=null;
  if(st==='present'){
    delete db.attendance[attGid][pCell.key];
    payload=null; // null = delete from Supabase
  }else{
    payload={
      st,
      by: curUser?.type==='admin'?'admin':(curUser?.id||''),
      byName: curUser?.type==='admin'?'–ê–¥–º–∏–Ω':((curUser?.last||'')+' '+(curUser?.first||'')).trim(),
      subject: curUser?.activeSubject?.subjName||curUser?.subject||'',
      byTid: curUser?.tid!=null?String(curUser.tid):'',
      byPhone: curUser?.phone||'',
      at: Date.now()
    };
    db.attendance[attGid][pCell.key]=payload;
  }

  // 1. Save to localStorage immediately (fast)
  localStorage.setItem('dav7',JSON.stringify(db));

  // 2. Save THIS SINGLE CELL to Supabase (granular ‚Äî no conflict!)
  // Other users get update via Realtime subscription automatically
  sbSetAtt(attGid, pCell.key, payload)
    .then(ok => { if(ok) updateSyncStatus('online'); else updateSyncStatus('offline'); })
    .catch(e => { console.warn('att save err',e); updateSyncStatus('offline'); });

  closeModal('m-st');
  renderAttT();
}
function refreshAttFromCloud(){
  if(!sbConfigured()){toast('Supabase –ø–∞–π–≤–∞—Å—Ç –Ω–µ—Å—Ç');return;}
  if(!attGid){return;}
  const btn=document.getElementById('att-refresh-btn');
  if(btn)btn.textContent='‚è≥';
  sbLoadAtt(attGid).then(attData=>{
    if(attData!==null){
      db.attendance[attGid]=attData;
      localStorage.setItem('dav7',JSON.stringify(db));
      renderAttT?.();
      toast('‚úÖ –ù–∞–≤ —à—É–¥');
    } else {
      toast('‚ö†Ô∏è Cloud-–∞–∑ –≥–∏—Ä–∏—Ñ—Ç–∞ –Ω–∞—à—É–¥');
    }
    if(btn)btn.textContent='üîÑ';
  });
}

function expAtt(){
  const g=db.groups.find(x=>x.id===attGid);if(!g)return;
  // For teachers in month view: use all allowed lessons (not tied to specific date)
  const currentDate = vm==='day' ? new Date(aY, aM, aD) : null;
  const lessons = getAllowedLessons(attGid, currentDate);
  if(lessons.length===0){toast('–î–∞—Ä—Å –±–∞—Ä–æ–∏ —ç–∫—Å–ø–æ—Ä—Ç –Ω–µ—Å—Ç');return;}
  const att=db.attendance[attGid]||{};const sorted=sortS(g.students||[]);
  let c='\uFEFF'+`–î–∞–≤–æ–º–∞—Ç: ${g.name}`;
  if(vm==='day'){c+=` ‚Äî ${aD} ${MN[aM]} ${aY}\n\n–î–æ–Ω–∏—à“∑”Ø`;lessons.forEach(l=>c+=`,${l.name}`);c+=',–ù,–ë,–£\n';sorted.forEach(s=>{let row=`"${s.last} ${s.first}"`,n=0,b=0,u=0;lessons.forEach(l=>{const st=normSt(att[aKey(s.id,aY,aM+1,aD,l.id)]);let lb='';if(st==='absent'){lb='–ù';n++;}else if(st==='sick'){lb='–ë';b++;}else if(st==='excused'){lb='–£';u++;}row+=`,${lb}`;});c+=row+`,${n},${b},${u}\n`;});dl(c,`${g.name}_${aD}_${MN[aM]}_${aY}.csv`,'text/csv;charset=utf-8');}
  else{const dM=dimF(aY,aM);c+=` ‚Äî ${MN[aM]} ${aY}\n\n–î–æ–Ω–∏—à“∑”Ø`;for(let d=1;d<=dM;d++)lessons.forEach(l=>c+=`,${d}/${l.name}`);c+=',–ñ–∞–º–∏ –ù,–ñ–∞–º–∏ –ë,–ñ–∞–º–∏ –£\n';sorted.forEach(s=>{let row=`"${s.last} ${s.first}"`,n=0,b=0,u=0;for(let d=1;d<=dM;d++)lessons.forEach(l=>{const st=normSt(att[aKey(s.id,aY,aM+1,d,l.id)]);let lb='';if(st==='absent'){lb='–ù';n++;}else if(st==='sick'){lb='–ë';b++;}else if(st==='excused'){lb='–£';u++;}row+=`,${lb}`;});c+=row+`,${n},${b},${u}\n`;});dl(c,`${g.name}_${MN[aM]}_${aY}.csv`,'text/csv;charset=utf-8');}
  toast('Excel ‚úÖ');
}

// ============================================
//  SMS (with per-group schedule)
// ============================================
let smsY=new Date().getFullYear(),smsM=new Date().getMonth(),smsD=new Date().getDate(),smsShift=0;
function setSmsShift(n){
  smsShift=n;
  document.querySelectorAll('#sms-shift-seg .seg-b').forEach((b,i)=>b.classList.toggle('active',i===n));
  popSMSGroups();renderSMS();
}
function popSMSGroups(){
  const sel=document.getElementById('sms-gid');const groups=getVisibleGroups().filter(g=>smsShift===0||g.shift===smsShift);
  sel.innerHTML='<option value="">‚Äî “≤–∞–º–∞ ‚Äî</option>'+groups.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
}
function renderSMSCtrl(){
  const mode=document.getElementById('sms-mode').value;
  document.getElementById('sms-dc').style.display=mode==='day'?'flex':'none';
  document.getElementById('sms-mc').style.display=mode==='month'?'flex':'none';
  updSmsD();updSmsM();renderSMS();
}
function updSmsD(){document.getElementById('sms-dl').textContent=`${smsD} ${MN[smsM]}`;document.getElementById('sms-dp').value=`${smsY}-${p2(smsM+1)}-${p2(smsD)}`;}
function updSmsM(){document.getElementById('sms-ml').textContent=MN[smsM]+' '+smsY;}
function smsDSh(n){const d=new Date(smsY,smsM,smsD+n);smsY=d.getFullYear();smsM=d.getMonth();smsD=d.getDate();updSmsD();renderSMS();}
function smsMS(n){smsM+=n;if(smsM<0){smsM=11;smsY--;}if(smsM>11){smsM=0;smsY++;}updSmsM();renderSMS();}
function onSmsDP(){const v=document.getElementById('sms-dp').value;if(!v)return;const[y,m,d]=v.split('-').map(Number);smsY=y;smsM=m-1;smsD=d;updSmsD();renderSMS();}

function renderSMS(){
  const gid=document.getElementById('sms-gid').value;
  const mode=document.getElementById('sms-mode').value;
  let groups=getVisibleGroups().filter(g=>smsShift===0||g.shift===smsShift);
  if(gid)groups=groups.filter(x=>x.id===gid);
  let rows=[];
  groups.forEach(g=>{
    const att=db.attendance[g.id]||{};
    const checkDate = mode==='day' ? new Date(smsY, smsM, smsD) : null;
    const lessons = getAllowedLessons(g.id, checkDate);
    if(lessons.length===0) return;
    sortS(g.students||[]).forEach(s=>{
      let abs=[];
      if(mode==='day'){lessons.forEach(l=>{const k=aKey(s.id,smsY,smsM+1,smsD,l.id);const st=normSt(att[k]);if(st&&st!=='present')abs.push({type:st,lesson:l.name,d:smsD,m:smsM+1});});}
      else{const dM=dimF(smsY,smsM);for(let d=1;d<=dM;d++){const dayDate = new Date(smsY, smsM, d); const dayLessons = getAllowedLessons(g.id, dayDate); dayLessons.forEach(l=>{const k=aKey(s.id,smsY,smsM+1,d,l.id);const st=normSt(att[k]);if(st&&st!=='present')abs.push({type:st,lesson:l.name,d,m:smsM+1});});}}
      if(abs.length)rows.push({s,g,abs});
    });
  });
  const c=document.getElementById('sms-list');
  if(!rows.length){c.innerHTML=`<div class="empty"><div class="ei">‚úÖ</div><div class="et">“í–æ–∏–± –Ω–µ—Å—Ç</div></div>`;c.dataset.rows='[]';return;}
  c.innerHTML=rows.map((r,i)=>{
    const tags=r.abs.slice(0,3).map(a=>`<span class="sms-tag t${a.type==='absent'?'n':a.type==='sick'?'s':'u'}">${a.d}/${a.m} ${a.lesson}: ${a.type==='absent'?'–ù':a.type==='sick'?'–ë':'–£'}</span>`).join(' ');
    return`<div class="sms-row">
      <input type="checkbox" class="sms-chk" id="sc-${i}" checked>
      <div style="flex:1">
        <div style="font-weight:600;font-size:.82rem">${r.s.last} ${r.s.first} <span style="font-size:.68rem;color:var(--muted)">[${r.g.name}]</span></div>
        <div style="font-size:.72rem;color:var(--muted)">${r.s.pphone||r.s.phone||'‚Äî'}</div>
        <div style="margin-top:3px;display:flex;flex-wrap:wrap;gap:3px">${tags}${r.abs.length>3?`<span style="font-size:.65rem;color:var(--muted)">+${r.abs.length-3}</span>`:''}</div>
      </div>
    </div>`;
  }).join('');
  c.dataset.rows=JSON.stringify(rows.map(r=>({name:r.s.last+' '+r.s.first,phone:r.s.pphone||r.s.phone||''})));
}
function selAll(v){document.querySelectorAll('.sms-chk').forEach(c=>c.checked=v);}
function expSMSXls(){
  const checks=document.querySelectorAll('.sms-chk');
  const rawRows=document.getElementById('sms-list').dataset.rows;
  if(!rawRows){toast('–†”Ø–π—Ö–∞—Ç —Ö–æ–ª”£');return;}
  const rows=JSON.parse(rawRows);
  const sel=rows.filter((_,i)=>checks[i]?.checked);
  if(!sel.length){toast('–ò–Ω—Ç–∏—Ö–æ–± –Ω–∞—à—É–¥');return;}
  let csv='\uFEFF\u041d\u043e\u043c\u0443 \u043d\u0430\u0441\u0430\u0431,\u0420\u0430\u049b\u0430\u043c\u0438 \u0442\u0435\u043b\u0435\u0444\u043e\u043d\n';
  sel.forEach(r=>csv+=`"${r.name}","${r.phone}"\n`);
  dl(csv,'sms_ghoibon.csv','text/csv;charset=utf-8');toast('Excel: –ê ‚Äî –ù–æ–º, –í ‚Äî –¢–µ–ª ‚úÖ');
}

// ============================================
//  STATS (with per-group schedule)
// ============================================
let stY=new Date().getFullYear(),stM=new Date().getMonth(),stD=new Date().getDate(),stShift=0,stGid='';

function setStShift(n){
  stShift=n;stGid='';
  document.querySelectorAll('#st-shift-seg .seg-b').forEach((b,i)=>b.classList.toggle('active',i===n));
  popStGroups();renderStats();
}
function popStGroups(){
  const sel=document.getElementById('st-gid');
  const groups=getVisibleGroups().filter(g=>stShift===0||g.shift===stShift);
  sel.innerHTML='<option value="">‚Äî “≤–∞–º–∞ –≥—É—Ä”Ø“≥ ‚Äî</option>'+groups.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
}
function onStGid(){stGid=document.getElementById('st-gid').value;renderStats();}
function updStCtrl(){
  const mode=document.getElementById('st-mode').value;
  document.getElementById('st-mc').style.display=mode==='month'?'flex':'none';
  document.getElementById('st-dc').style.display=mode==='day'?'flex':'none';
  if(mode==='month')document.getElementById('st-ml').textContent=MN[stM]+' '+stY;
  if(mode==='day'){document.getElementById('st-dl').textContent=stD+' '+MN[stM];document.getElementById('st-dp').value=`${stY}-${p2(stM+1)}-${p2(stD)}`;}
  renderStats();
}
function stMS(n){stM+=n;if(stM<0){stM=11;stY--;}if(stM>11){stM=0;stY++;}document.getElementById('st-ml').textContent=MN[stM]+' '+stY;renderStats();}
function stDS(n){const d=new Date(stY,stM,stD+n);stY=d.getFullYear();stM=d.getMonth();stD=d.getDate();document.getElementById('st-dl').textContent=stD+' '+MN[stM];document.getElementById('st-dp').value=`${stY}-${p2(stM+1)}-${p2(stD)}`;renderStats();}
function onStDP(){const v=document.getElementById('st-dp').value;if(!v)return;const[y,m,d]=v.split('-').map(Number);stY=y;stM=m-1;stD=d;renderStats();}

function keyMatch(k,sid){
  if(!k.startsWith(sid+'_'))return false;
  const mode=document.getElementById('st-mode').value;if(mode==='all')return true;
  const dp=k.split('_')[1];const[y,m,d]=dp.split('-').map(Number);
  if(mode==='month')return y===stY&&m===stM+1;
  if(mode==='day')return y===stY&&m===stM+1&&d===stD;
  return true;
}

function renderStats(){
  const groups=getVisibleGroups().filter(g=>stShift===0||g.shift===stShift).filter(g=>!stGid||g.id===stGid);
  let totN=0,totB=0,totU=0,totHoz=0;
  let grpData=[];
  groups.forEach(g=>{
    const att=db.attendance[g.id]||{};
    let gN=0,gB=0,gU=0;
    (g.students||[]).forEach(s=>{
      Object.entries(att).forEach(([k,v])=>{
        if(!keyMatch(k,s.id))return;
        const lid = k.split('_')[2];
        const dp = k.split('_')[1];
        const [y,m,d] = dp.split('-').map(Number);
        const recordDate = new Date(y, m-1, d);
        const allowedIds = getAllowedLessonIds(g.id, recordDate);
        if(curUser?.type!=='admin' && allowedIds && !allowedIds.includes(lid)) return;
        if(normSt(v)==='absent'){gN++;totN++;}
        else if(normSt(v)==='sick'){gB++;totB++;}
        else if(normSt(v)==='excused'){gU++;totU++;}
      });
    });
    grpData.push({g,gN,gB,gU});
  });

  document.getElementById('st-sum').innerHTML=`
    <div class="sbox"><div class="snum" style="color:var(--red)">${totN}</div><div class="slbl">–ù–∞–±—É–¥ (–ù)</div></div>
    <div class="sbox"><div class="snum" style="color:var(--yellow)">${totB}</div><div class="slbl">–ë–µ–º–æ—Ä (–ë)</div></div>
    <div class="sbox"><div class="snum" style="color:var(--blue)">${totU}</div><div class="slbl">–£–∑—Ä (–£)</div></div>`;

  const pct=(n)=>totN+totB+totU>0?Math.round(n/(totN+totB+totU)*100):0;
  document.getElementById('st-charts').innerHTML=`
    <div class="chart-box">
      <div class="chart-title">ü•ß –§–æ–∏–∑–∏ “ì–æ–∏–±”£</div>
      ${drawPie([
        {label:'–ù–∞–±—É–¥',val:totN,color:'#ef4444'},
        {label:'–ë–µ–º–æ—Ä',val:totB,color:'#f59e0b'},
        {label:'–£–∑—Ä',val:totU,color:'#3b82f6'}
      ])}
    </div>
    <div class="chart-box">
      <div class="chart-title">üìä “≤–∞—Ä –≥—É—Ä”Ø“≥</div>
      ${drawBar(grpData)}
    </div>`;

  document.getElementById('st-groups-list').innerHTML=grpData.map(({g,gN,gB,gU})=>`
    <div class="srow" onclick="stGid='${g.id}';document.getElementById('st-gid').value='${g.id}';renderStats()">
      <div class="ava" style="background:${g.shift===2?'linear-gradient(135deg,#f97316,#ea580c)':'linear-gradient(135deg,var(--blue),var(--blue-d))'}">–ë${g.shift||1}</div>
      <div style="flex:1"><div class="sn">${g.name}</div>
        <div class="ss"><span style="color:var(--red);font-weight:700">–ù:${gN}</span> ¬∑ <span style="color:var(--yellow);font-weight:700">–ë:${gB}</span> ¬∑ <span style="color:var(--blue);font-weight:700">–£:${gU}</span></div>
      </div>
      <div style="color:var(--blue)">‚Ä∫</div>
    </div>`).join('');

  const showDet=stGid!=='';
  document.getElementById('st-det-card').style.display=showDet?'block':'none';
  if(showDet){
    const g=db.groups.find(x=>x.id===stGid);if(!g)return;
    document.getElementById('st-det-title').textContent='üë§ '+g.name+' ‚Äî –î–æ–Ω–∏—à“∑”Ø—ë–Ω';
    const att=db.attendance[stGid]||{};
    document.getElementById('st-det').innerHTML=sortS(g.students||[]).map((s,i)=>{
      let n=0,b=0,u=0;Object.entries(att).forEach(([k,v])=>{
        if(!keyMatch(k,s.id))return;
        const lid = k.split('_')[2];
        const dp = k.split('_')[1];
        const [y,m,d] = dp.split('-').map(Number);
        const recordDate = new Date(y, m-1, d);
        const allowedIds = getAllowedLessonIds(stGid, recordDate);
        if(curUser?.type!=='admin' && allowedIds && !allowedIds.includes(lid)) return;
        if(normSt(v)==='absent')n++;else if(normSt(v)==='sick')b++;else if(normSt(v)==='excused')u++;
      });
      return`<div class="srow"><div class="ava">${ini(s)}</div><div style="flex:1"><div class="sn">${i+1}. ${s.last} ${s.first}</div><div class="ss"><span style="color:var(--red);font-weight:700">–ù:${n}</span> ¬∑ <span style="color:var(--yellow);font-weight:700">–ë:${b}</span> ¬∑ <span style="color:var(--blue);font-weight:700">–£:${u}</span></div></div></div>`;
    }).join('');
  }
}

function drawPie(data){
  const total=data.reduce((s,d)=>s+d.val,0);
  if(!total)return`<div style="font-size:.8rem;color:var(--muted);padding:20px">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</div>`;
  let startAngle=-Math.PI/2;const r=50,cx=60,cy=60;
  let paths='';const legend=[];
  data.forEach(d=>{
    if(!d.val)return;
    const angle=(d.val/total)*2*Math.PI;const endAngle=startAngle+angle;
    const x1=cx+r*Math.cos(startAngle),y1=cy+r*Math.sin(startAngle);
    const x2=cx+r*Math.cos(endAngle),y2=cy+r*Math.sin(endAngle);
    const largeArc=angle>Math.PI?1:0;
    paths+=`<path d="M${cx},${cy} L${x1.toFixed(1)},${y1.toFixed(1)} A${r},${r} 0 ${largeArc},1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${d.color}" stroke="#fff" stroke-width="2"/>`;
    const pct=Math.round(d.val/total*100);
    legend.push(`<div class="pie-legend-item"><div class="pie-dot" style="background:${d.color}"></div><span>${d.label}: ${d.val} (${pct}%)</span></div>`);
    startAngle=endAngle;
  });
  return`<svg width="120" height="120" viewBox="0 0 120 120" style="display:block;margin:0 auto 8px">${paths}</svg><div class="pie-legend">${legend.join('')}</div>`;
}
function drawBar(grpData){
  if(!grpData.length)return`<div style="font-size:.8rem;color:var(--muted);padding:20px">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</div>`;
  const maxVal=Math.max(...grpData.map(x=>x.gN+x.gB+x.gU),1);
  const bars=grpData.map(({g,gN,gB,gU})=>{
    const total=gN+gB+gU;const h=Math.max(Math.round(total/maxVal*70),total>0?4:0);
    const shortName=g.name.length>8?g.name.substr(0,7)+'‚Ä¶':g.name;
    return`<div class="bar-item"><div class="bar-val">${total||''}</div><div class="bar-rect" style="height:${h}px;background:${g.shift===2?'#f97316':'#3b82f6'};width:100%"></div><div class="bar-label">${shortName}</div></div>`;
  }).join('');
  return`<div class="bar-wrap">${bars}</div>`;
}

// ============================================
//  SETTINGS (with per-group schedule editor)
// ============================================
let curShTab=1;
let expandedTeachers = new Set();
let expandedSubjects = new Set();
let teacherSearch = '';
let selectedGroupForSchedule = {}; // tid -> gid

function renderSettings(){renderSbConfig();
  document.getElementById('s-inst').value=db.settings.instName||'';
  document.getElementById('s-tchr').value=db.settings.teacherName||'';
  renderLT();renderTeachers();
}
function saveSets(){db.settings.instName=document.getElementById('s-inst').value;db.settings.teacherName=document.getElementById('s-tchr').value;sv();}
function changeAdminPw(){const pw=document.getElementById('s-newpw').value.trim();if(!pw){toast('–†–∞–º–∑—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥!');return;}db.settings.adminPw=pw;sv();document.getElementById('s-newpw').value='';toast('–†–∞–º–∑ —Ç–∞“ì–π–∏—Ä —ë—Ñ—Ç ‚úÖ');}

function setShTab(n){curShTab=n;document.getElementById('sh-t1').classList.toggle('active',n===1);document.getElementById('sh-t2').classList.toggle('active',n===2);renderLT();}
function renderLT(){
  const lessons=db.settings.shifts[curShTab]||[];const c=document.getElementById('sh-lessons');
  if(!lessons.length){c.innerHTML=`<div style="color:var(--muted);font-size:.78rem;padding:6px">–î–∞—Ä—Å –Ω–µ—Å—Ç</div>`;return;}
  c.innerHTML=`<div style="background:#fff;border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)">${lessons.map((l,i)=>`<div class="srow2" style="${i===0?'border-radius:var(--r) var(--r) 0 0':''}${i===lessons.length-1?';border-bottom:none;border-radius:0 0 var(--r) var(--r)':''}">
    <div style="display:flex;gap:6px;flex:1"><input class="fc" style="flex:1;max-width:110px" value="${l.name}" oninput="updL('${l.id}','name',this.value)"><input class="fc" type="time" style="width:90px" value="${l.time||''}" oninput="updL('${l.id}','time',this.value)"></div>
    <button class="btn bgh bico" style="margin-left:5px" onclick="delL('${l.id}')">üóëÔ∏è</button>
  </div>`).join('')}</div>`;
}
function addLesson(){if(!db.settings.shifts[curShTab])db.settings.shifts[curShTab]=[];const n=db.settings.shifts[curShTab].length+1;db.settings.shifts[curShTab].push({id:(curShTab===1?'l':'m')+uid(),name:`${n}-–¥–∞—Ä—Å`,time:''});sv();renderLT();}
function updL(id,f,v){[1,2].forEach(sh=>{const l=(db.settings.shifts[sh]||[]).find(x=>x.id===id);if(l){l[f]=v;sv();}});}
function delL(id){db.settings.shifts[curShTab]=db.settings.shifts[curShTab].filter(x=>x.id!==id);sv();renderLT();}

// TEACHERS with per-group schedule editor
const T_COLORS=['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#f97316','#0d9488','#ec4899'];
const DN_SCHEDULE=['–Ø–∫—à–∞–Ω–±–µ','–î—É—à–∞–Ω–±–µ','–°–µ—à–∞–Ω–±–µ','–ß–æ—Ä—à–∞–Ω–±–µ','–ü–∞–Ω“∑—à–∞–Ω–±–µ','“∂—É–º—ä–∞','–®–∞–Ω–±–µ'];

function renderTeachers(){
  const allTeachers=db.settings.teachers||[];const c=document.getElementById('t-list');
  if(!allTeachers.length){c.innerHTML='<div style="color:var(--muted);font-size:.78rem;padding:10px">–û–º”Ø–∑–≥–æ—Ä –Ω–µ—Å—Ç</div>';return;}
  // Filter by search
  const sq=(teacherSearch||'').toLowerCase().trim();
  const teachers=sq?allTeachers.filter(t=>(t.last+' '+t.first+' '+(t.subject||'')).toLowerCase().includes(sq)):allTeachers;
  if(!teachers.length){c.innerHTML='<div style="color:var(--muted);font-size:.78rem;padding:10px;text-align:center">üîç –Å—Ñ—Ç –Ω–∞—à—É–¥</div>';return;}
  const sortedGroups=[...db.groups].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  c.innerHTML=teachers.map((t,ti)=>{
    const realIdx=allTeachers.indexOf(t);
    const color=T_COLORS[realIdx%T_COLORS.length];
    const gp=t.groupPerms||{};
    const isExpanded = expandedTeachers.has(t.id);
    
    // Get groups that teacher has access to
    const teacherGroups = sortedGroups.filter(g => gp[g.id]?.att === true);
    const currentGid = selectedGroupForSchedule[t.id] || (teacherGroups[0]?.id || '');
    
    // Page perms
    const pagePerms=['sms','stats'].map(p=>{
      const labels={sms:'üì® SMS',stats:'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'};
      const on=(t.perms||[]).includes(p);
      return`<div class="perm-chip ${on?'on':'off'}" onclick="togglePerm('${t.id}','${p}')">${labels[p]}</div>`;
    }).join('');
    const canView=t.canChangeView===true;
    const viewChip=`<div class="perm-chip ${canView?'on':'off'}" onclick="toggleViewPerm('${t.id}')">${canView?'üìÖ –†”Ø–∑/–ú–æ“≥':'üìÖ –¢–∞–Ω“≥–æ —Ä”Ø–∑'}</div>`;
    
    // Per-group ‚Äî show groups with SUBJECTS list
    const assignedGroups = sortedGroups.filter(g => gp[g.id]?.subjects?.length || gp[g.id]?.att || gp[g.id]?.list);
    const groupRows = assignedGroups.map(g=>{
      const gperm=gp[g.id]||{};
      const subjects=gperm.subjects||[];
      const glist=gperm.list||false;
      const allLessons=getLessons(g.id);
      const expandedSubjKey = t.id+'::'+g.id;
      const subjRows=subjects.map(subj=>{
        // Read per-subject schedule (new model)
        const sc=subj.schedule||{};
        const activeDays=[1,2,3,4,5,6]
          .filter(d=>sc[d]?.enabled&&sc[d]?.lessons?.length)
          .map(d=>{
            const ls=(sc[d].lessons||[]).map(lid=>{
              const l=allLessons.find(x=>x.id===lid);
              return l?l.name.replace('-–¥–∞—Ä—Å',''):'?';
            }).join(',');
            return ['','–î—É—à','–°–µ—à','–ß–æ—Ä','–ü–∞–Ω','“∂—É–º','–®–∞–Ω'][d]+'('+ls+')';
          }).join(' ¬∑ ');
        const expandKey=t.id+'::'+g.id+'::'+subj.id;
        const isOpen=expandedSubjects.has(expandKey);
        const schedHTML=isOpen?renderSubjectSchedule(t,g,subj):'';
        return`<div style="border:1px solid var(--border);border-radius:8px;margin-bottom:4px;overflow:hidden">
          <div style="display:flex;align-items:center;gap:5px;padding:6px 9px;background:${isOpen?'var(--blue-l)':'#f8fafc'};cursor:pointer"
            onclick="toggleSubjExpand('${t.id}','${g.id}','${subj.id}')">
            <div style="flex:1">
              <span style="font-size:.76rem;font-weight:700">üìö ${subj.name}</span>
              <span style="font-size:.62rem;color:var(--muted);margin-left:5px">${activeDays||'‚ö†Ô∏è –¢–∞“õ–≤–∏–º —Ç–∞–Ω–∑–∏–º –Ω–∞—à—É–¥–∞–∞—Å—Ç'}</span>
            </div>
            <span style="font-size:.75rem;color:var(--muted)">${isOpen?'‚ñ≤':'‚ñº'}</span>
            <button onclick="event.stopPropagation();openTransferSubject('${t.id}','${g.id}','${subj.id}')"
              style="border:none;background:#fef3c7;color:#92400e;border-radius:5px;padding:2px 6px;font-size:.65rem;font-weight:700;cursor:pointer" title="–ò–Ω—Ç–∏“õ–æ–ª">üîÑ</button>
            <button onclick="event.stopPropagation();removeSubject('${t.id}','${g.id}','${subj.id}')"
              style="border:none;background:#fee2e2;color:#dc2626;border-radius:5px;padding:2px 6px;font-size:.65rem;font-weight:700;cursor:pointer" title="“≤–∞–∑—Ñ">‚úï</button>
          </div>
          ${schedHTML}
        </div>`;
      }).join('');
      return`<div style="border-bottom:1px solid var(--border);padding:7px 10px">
        <div style="display:flex;align-items:center;gap:5px;margin-bottom:5px">
          <div style="flex:1;font-size:.78rem;font-weight:700">${g.name}
            <span style="font-size:.66rem;color:var(--muted);font-weight:400"> –ë–∞—Å—Ç ${g.shift||1}</span>
          </div>
          <div class="perm-chip ${glist?'on':'off'}" style="font-size:.67rem;padding:2px 8px" onclick="toggleGPerm('${t.id}','${g.id}','list')" title="–†”Ø–π—Ö–∞—Ç">üë• –†”Ø–π—Ö–∞—Ç</div>
          <button onclick="openAddSubject('${t.id}','${g.id}')"
            style="border:none;background:#dcfce7;color:#166534;border-radius:6px;padding:3px 8px;font-size:.72rem;font-weight:700;cursor:pointer">Ôºã –§–∞–Ω</button>
          <button onclick="removeTeacherGroup('${t.id}','${g.id}')" title="–ì—É—Ä”Ø“≥—Ä–æ “∑—É–¥–æ –∫—É–Ω"
            style="border:none;background:#fee2e2;color:#dc2626;border-radius:6px;padding:3px 6px;font-size:.72rem;font-weight:700;cursor:pointer">‚úï</button>
        </div>
        <div style="padding:0 4px">
          ${subjects.length?subjRows:'<div style="font-size:.72rem;color:var(--muted);font-style:italic;padding:4px 0">–§–∞–Ω –≤–æ–±–∞—Å—Ç–∞ –Ω–∞—à—É–¥–∞–∞—Å—Ç ‚Äî —Ç—É–≥–º–∞–∏ "+ –§–∞–Ω" –∑–∞–Ω–µ–¥</div>'}
        </div>
      </div>`;
    }).join('');
    // Search box to add new group
    const grpSearchBox = `<div style="padding:8px 10px;background:#f8fafc;border-top:1px solid var(--border)">
      <div style="font-size:.68rem;font-weight:700;color:var(--muted);margin-bottom:5px;text-transform:uppercase">Ôºã –ì—É—Ä”Ø“≥ –∏–ª–æ–≤–∞ –∫—É–Ω–µ–¥:</div>
      <div style="position:relative">
        <input class="fc" style="font-size:.77rem;padding:6px 10px 6px 30px"
          placeholder="–ù–æ–º–∏ –≥—É—Ä”Ø“≥—Ä–æ –Ω–∞–≤–∏—Å–µ–¥..."
          id="gsi-${t.id}"
          oninput="showGroupSuggestions('${t.id}',this.value)"
          onfocus="showGroupSuggestions('${t.id}',this.value)"
          autocomplete="off">
        <span style="position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:.8rem;color:var(--muted);pointer-events:none">üîç</span>
      </div>
      <div id="gss-${t.id}" style="margin-top:4px;display:none;border:1px solid var(--border);border-radius:8px;overflow:hidden;max-height:150px;overflow-y:auto;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1)"></div>
    </div>`;
    
    // Schedule now embedded inside each subject card (accordion)
    // No separate section needed
    
    return`<div class="tcrd">
      <div class="tcrd-top" style="cursor:pointer" onclick="toggleTeacherExpand('${t.id}')">
        <div class="t-ava" style="background:${color}">${ini(t)}</div>
        <div style="flex:1">
          <div class="t-name">${t.last} ${t.first}
            ${t.tid?`<span class="t-badge" style="background:#e0f2fe;color:#0369a1">ID: ${t.tid}</span>`:''}
            <span class="t-badge" id="pw-badge-${t.id}" style="background:${color}20;color:${color};cursor:pointer" onclick="togglePwVisible('${t.id}')" title="–†–∞–º–∑—Ä–æ –Ω–∏—à–æ–Ω/–ø–∏–Ω“≥–æ–Ω –∫—É–Ω">üîí ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
          </div>
          <div class="t-sub">${t.subject||'–§–∞–Ω –Ω–µ—Å—Ç'}${t.phone?` ¬∑ üìû ${t.phone}`:''}</div>
        </div>
        <div style="display:flex;align-items:center;gap:5px">
          <span style="font-size:.85rem;color:var(--muted)">${isExpanded?'‚ñ≤':'‚ñº'}</span>
          <button class="btn bgh bxs" onclick="event.stopPropagation();openEditTeacher('${t.id}')" title="–¢–∞“≥—Ä–∏—Ä">‚úèÔ∏è</button>
          <button class="btn br bxs" onclick="event.stopPropagation();delTeacher('${t.id}')" title="“≤–∞–∑—Ñ">üóëÔ∏è</button>
        </div>
      </div>
      ${isExpanded ? `
      <div class="perm-toggle" style="border-top:1px solid var(--border)">
        <div style="font-size:.67rem;color:var(--muted);font-weight:700;text-transform:uppercase;width:100%;padding:2px 0 4px">–°–∞“≥–∏—Ñ–∞“≥–æ:</div>
        ${pagePerms}${viewChip}
      </div>
      <div style="font-size:.67rem;color:var(--muted);font-weight:700;text-transform:uppercase;padding:6px 12px 3px;border-top:1px solid var(--border)">
        –ì—É—Ä”Ø“≥“≥–æ <span style="font-weight:400;color:var(--muted)">(üìã –î–∞–≤–æ–º–∞—Ç ¬∑ üë• –†”Ø–π—Ö–∞—Ç)</span>:
      </div>
      <div>
        ${groupRows || '<div style="color:var(--muted);font-size:.75rem;padding:7px 10px;font-style:italic">–ì—É—Ä”Ø“≥ –≤–æ–±–∞—Å—Ç–∞ –Ω–∞—à—É–¥–∞–∞—Å—Ç</div>'}
        ${grpSearchBox}
      </div>

      ` : ''}
    </div>`;
  }).join('');
}

function selectGroupForSchedule(tid, gid){
  selectedGroupForSchedule[tid] = gid;
  renderTeachers();
}

// Per-subject schedule renderer (replaces per-group)
function renderSubjectSchedule(t, g, s){
  const allLessons = getLessons(g.id);
  const schedule = s.schedule || {};
  const dateSchedule = s.dateSchedule || {};
  const dateEntries = Object.entries(dateSchedule).sort(([a],[b])=>a.localeCompare(b));

  const weekRows = [1,2,3,4,5,6].map(day=>{
    const dc = schedule[day]||{enabled:false,lessons:[]};
    const on = dc.enabled===true;
    return `<div class="day-row">
      <div class="day-name" style="font-size:.72rem">${DN_SCHEDULE[day]}</div>
      <div class="day-toggle ${on?'on':''}" onclick="toggleSubjDay('${t.id}','${g.id}','${s.id}',${day})"></div>
      <div class="day-lessons">
        ${allLessons.map(l=>{
          const isOn=on&&dc.lessons&&dc.lessons.includes(l.id);
          return `<span class="day-lesson-chip ${isOn?'on':'off'}"
            onclick="toggleSubjDayLesson('${t.id}','${g.id}','${s.id}',${day},'${l.id}')"
            style="${!on?'pointer-events:none':''}">${l.name}</span>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');

  const dateRows = dateEntries.map(([date,cfg])=>`
    <div class="date-row">
      <input type="date" class="date-input" value="${date}"
        onchange="updateSubjDateSched('${t.id}','${g.id}','${s.id}','${date}',this.value)">
      <div class="date-lessons">
        ${allLessons.map(l=>{
          const isOn=cfg.lessons&&cfg.lessons.includes(l.id);
          return `<span class="date-chip ${isOn?'on':'off'}"
            onclick="toggleSubjDateLesson('${t.id}','${g.id}','${s.id}','${date}','${l.id}')">${l.name}</span>`;
        }).join('')}
      </div>
      <button class="date-del" onclick="removeSubjDateSched('${t.id}','${g.id}','${s.id}','${date}')">√ó</button>
    </div>`).join('');

  return `<div style="margin:6px 10px;border:2px solid var(--blue-m);border-radius:10px;overflow:hidden">
    <div style="background:var(--blue-l);padding:7px 11px;font-size:.76rem;font-weight:700;color:var(--blue-d);display:flex;align-items:center;gap:6px">
      üìö ${s.name} <span style="font-weight:400;color:var(--muted);font-size:.68rem">‚Äî ${g.name}</span>
    </div>
    <div style="padding:6px 8px">
      <div style="font-size:.67rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:4px">üìÜ –†”Ø–∑“≥–æ–∏ “≥–∞—Ñ—Ç–∞</div>
      ${weekRows}
      <div style="font-size:.67rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin:8px 0 4px">üìÖ –°–∞–Ω–∞“≥–æ–∏ –º–∞—Ö—Å—É—Å</div>
      ${dateRows||'<div style="font-size:.72rem;color:var(--muted);padding:4px 0;font-style:italic">–°–∞–Ω–∞ –∏–ª–æ–≤–∞ –Ω–∞—à—É–¥–∞–∞—Å—Ç</div>'}
      <div class="add-date-row" style="border-top:1px dashed #fcd34d;margin-top:6px;padding-top:6px">
        <input type="date" class="date-input" id="nd-${t.id}-${g.id}-${s.id}">
        <button class="btn bb bsm" onclick="addSubjDateSched('${t.id}','${g.id}','${s.id}')">Ôºã –°–∞–Ω–∞</button>
      </div>
    </div>
  </div>`;
}

function getSubj(tid,gid,sid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return null;
  return ((t.groupPerms||{})[gid]?.subjects||[]).find(s=>s.id===sid)||null;
}
function toggleSubjDay(tid,gid,sid,day){
  const s=getSubj(tid,gid,sid);if(!s)return;
  if(!s.schedule)s.schedule={};
  if(!s.schedule[day])s.schedule[day]={enabled:false,lessons:[]};
  s.schedule[day].enabled=!s.schedule[day].enabled;
  sv();renderTeachers();
}
function toggleSubjDayLesson(tid,gid,sid,day,lid){
  const s=getSubj(tid,gid,sid);if(!s)return;
  if(!s.schedule?.[day])return;
  if(!s.schedule[day].lessons)s.schedule[day].lessons=[];
  const idx=s.schedule[day].lessons.indexOf(lid);
  if(idx>-1)s.schedule[day].lessons.splice(idx,1);
  else s.schedule[day].lessons.push(lid);
  sv();renderTeachers();
}
function addSubjDateSched(tid,gid,sid){
  const inp=document.getElementById(`nd-${tid}-${gid}-${sid}`);
  const date=inp?.value;if(!date){toast('–°–∞–Ω–∞—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥!');return;}
  const s=getSubj(tid,gid,sid);if(!s)return;
  if(!s.dateSchedule)s.dateSchedule={};
  if(s.dateSchedule[date]){toast('–ò–Ω —Å–∞–Ω–∞ –∞–ª–ª–∞–∫–∞–π –≤—É“∑—É–¥ –¥–æ—Ä–∞–¥!');return;}
  s.dateSchedule[date]={lessons:[]};
  sv();renderTeachers();toast('–°–∞–Ω–∞ –∏–ª–æ–≤–∞ —à—É–¥ ‚úÖ');
}
function updateSubjDateSched(tid,gid,sid,oldDate,newDate){
  if(!newDate)return;
  const s=getSubj(tid,gid,sid);if(!s||!s.dateSchedule)return;
  if(s.dateSchedule[newDate]&&oldDate!==newDate){toast('–ò–Ω —Å–∞–Ω–∞ –∞–ª–ª–∞–∫–∞–π –≤—É“∑—É–¥ –¥–æ—Ä–∞–¥!');renderTeachers();return;}
  s.dateSchedule[newDate]=s.dateSchedule[oldDate];
  delete s.dateSchedule[oldDate];
  sv();renderTeachers();
}
function toggleSubjDateLesson(tid,gid,sid,date,lid){
  const s=getSubj(tid,gid,sid);if(!s||!s.dateSchedule?.[date])return;
  if(!s.dateSchedule[date].lessons)s.dateSchedule[date].lessons=[];
  const idx=s.dateSchedule[date].lessons.indexOf(lid);
  if(idx>-1)s.dateSchedule[date].lessons.splice(idx,1);
  else s.dateSchedule[date].lessons.push(lid);
  sv();renderTeachers();
}
function removeSubjDateSched(tid,gid,sid,date){
  const s=getSubj(tid,gid,sid);if(!s)return;
  delete s.dateSchedule[date];
  sv();renderTeachers();toast('–°–∞–Ω–∞ “≥–∞–∑—Ñ —à—É–¥');
}

// Old functions kept for backward compat (not called from UI)
function renderScheduleSectionForGroup(){return '';}
function renderDateScheduleSectionForGroup(){return '';}
function selectGroupForSchedule(tid,gid){selectedGroupForSchedule[tid]=gid;renderTeachers();}

function toggleTeacherExpand(tid){
  if(expandedTeachers.has(tid)){expandedTeachers.delete(tid);}
  else{expandedTeachers.add(tid);}
  renderTeachers();
}
function toggleSubjExpand(tid,gid,sid){
  const key=tid+'::'+gid+'::'+sid;
  if(expandedSubjects.has(key)){expandedSubjects.delete(key);}
  else{expandedSubjects.add(key);}
  renderTeachers();
}

// Old group-level schedule functions ‚Äî replaced by per-subject versions above
function toggleDayEnabledForGroup(){}
function toggleDayLessonForGroup(){}
function addDateScheduleForGroup(){}
function updateDateScheduleForGroup(){}
function toggleDateLessonForGroup(){}
function removeDateScheduleForGroup(){}

function addTeacher(){
  const last=document.getElementById('nt-l').value.trim();const first=document.getElementById('nt-f').value.trim();
  if(!last&&!first){toast('–ù–æ–º—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥!');return;}
  const pw=document.getElementById('nt-pw').value.trim()||'1234';
  const tid=document.getElementById('nt-tid').value.trim();
  const phone=document.getElementById('nt-phone').value.trim();
  // Check if ID already used
  if(tid&&(db.settings.teachers||[]).some(t=>t.tid===tid)){toast('–ò–Ω ID –∞–ª–ª–∞–∫–∞–π –≤—É“∑—É–¥ –¥–æ—Ä–∞–¥!');return;}
  const t={id:uid(),tid,phone,last,first,subject:document.getElementById('nt-sub').value.trim(),pw,perms:[],groupPerms:{},canChangeView:false,scheduleByGroup:{},dateScheduleByGroup:{}};
  if(!db.settings.teachers)db.settings.teachers=[];
  db.settings.teachers.push(t);sv();closeModal('m-addt');
  document.getElementById('nt-tid').value='';
  document.getElementById('nt-phone').value='';
  ['nt-l','nt-f','nt-sub','nt-pw'].forEach(id=>document.getElementById(id).value='');
  renderTeachers();buildLoginSelect();toast('–û–º”Ø–∑–≥–æ—Ä –∏–ª–æ–≤–∞ —à—É–¥ ‚úÖ');
}
function delTeacher(id){if(!confirm('“≤–∞–∑—Ñ?'))return;db.settings.teachers=db.settings.teachers.filter(x=>x.id!==id);sv();renderTeachers();buildLoginSelect();toast('“≤–∞–∑—Ñ —à—É–¥');}

// ‚îÄ‚îÄ Edit teacher name/password ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePwVisible(tid){
  const el=document.getElementById('pw-badge-'+tid);
  if(!el)return;
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(el.dataset.shown==='1'){
    el.textContent='üîí ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    el.dataset.shown='0';
  } else {
    el.textContent='üîì '+t.pw;
    el.dataset.shown='1';
    // Auto-hide after 5 seconds
    setTimeout(()=>{if(el.dataset.shown==='1'){el.textContent='üîí ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';el.dataset.shown='0';}},5000);
  }
}
function openEditTeacher(tid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  document.getElementById('et-id').value=tid;
  document.getElementById('et-l').value=t.last||'';
  document.getElementById('et-f').value=t.first||'';
  document.getElementById('et-sub').value=t.subject||'';
  document.getElementById('et-tid').value=t.tid||'';
  document.getElementById('et-phone').value=t.phone||'';
  document.getElementById('et-pw').value='';
  openModal('m-edt');
}
function saveEditTeacher(){
  const eid=document.getElementById('et-id').value;
  const t=db.settings.teachers.find(x=>x.id===eid);if(!t)return;
  const l=document.getElementById('et-l').value.trim();
  const f=document.getElementById('et-f').value.trim();
  if(!l&&!f){toast('–ù–æ–º—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥!');return;}
  if(l)t.last=l;if(f)t.first=f;
  t.subject=document.getElementById('et-sub').value.trim();
  const newTid=document.getElementById('et-tid').value.trim();
  if(newTid&&newTid!==t.tid&&(db.settings.teachers||[]).some(x=>x.id!==eid&&x.tid===newTid)){
    toast('–ò–Ω ID –∞–ª–ª–∞–∫–∞–π –≤—É“∑—É–¥ –¥–æ—Ä–∞–¥!');return;
  }
  t.tid=newTid;
  t.phone=document.getElementById('et-phone').value.trim();
  const pw=document.getElementById('et-pw').value.trim();
  if(pw)t.pw=pw;
  sv();closeModal('m-edt');renderTeachers();buildLoginSelect();toast('–ù–∏–≥–æ“≥ —à—É–¥ ‚úÖ');
}

// ‚îÄ‚îÄ Group assignment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function removeTeacherGroup(tid,gid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  delete t.groupPerms[gid];
  sv();renderTeachers();
}

let _gssTimer=null;
function showGroupSuggestions(tid,q){
  const box=document.getElementById('gss-'+tid);if(!box)return;
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  const gp=t.groupPerms||{};
  // Unassigned groups only
  const unassigned=db.groups.filter(g=>!gp[g.id]?.att&&!gp[g.id]?.list);
  const lq=(q||'').toLowerCase().trim();
  const matches=lq
    ? unassigned.filter(g=>g.name.toLowerCase().includes(lq)||String(g.code||'').toLowerCase().includes(lq))
    : unassigned.slice(0,12); // show first 12 when empty
  if(!matches.length){
    box.style.display='none';return;
  }
  box.style.display='block';
  box.innerHTML=matches.map(g=>`
    <div onclick="addGroupToTeacher('${tid}','${g.id}')"
      style="padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border);font-size:.8rem;font-weight:600;display:flex;align-items:center;gap:8px"
      onmouseover="this.style.background='var(--blue-l)'"
      onmouseout="this.style.background=''">
      <span style="background:${g.shift===2?'#fed7aa':'#dbeafe'};color:${g.shift===2?'#c2410c':'#1e40af'};border-radius:5px;padding:1px 6px;font-size:.68rem">–ë${g.shift||1}</span>
      ${g.name}${g.code?` <span style="color:var(--muted);font-weight:400;font-size:.72rem">${g.code}</span>`:''}
    </div>`).join('');
}
function addGroupToTeacher(tid,gid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  if(!t.groupPerms[gid])t.groupPerms[gid]={att:true,list:false,allowedLessons:[]};
  else{t.groupPerms[gid].att=true;}
  sv();
  // Hide dropdown and clear input
  const box=document.getElementById('gss-'+tid);if(box)box.style.display='none';
  const inp=document.getElementById('gsi-'+tid);if(inp)inp.value='';
  renderTeachers();
  // Reopen expanded state
  if(!expandedTeachers.has(tid))expandedTeachers.add(tid);
  renderTeachers();
  toast('–ì—É—Ä”Ø“≥ –∏–ª–æ–≤–∞ —à—É–¥ ‚úÖ');
}
function togglePerm(tid,perm){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.perms)t.perms=[];
  if(t.perms.includes(perm))t.perms=t.perms.filter(x=>x!==perm);else t.perms.push(perm);
  sv();renderTeachers();
}
function toggleViewPerm(tid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  t.canChangeView=!t.canChangeView;sv();renderTeachers();
}
function toggleGPerm(tid,gid,type){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  if(!t.groupPerms[gid])t.groupPerms[gid]={att:false,list:false,allowedLessons:[]};
  t.groupPerms[gid][type]=!t.groupPerms[gid][type];
  if(type==='att' && !t.groupPerms[gid].att){
    t.groupPerms[gid].allowedLessons=[];
  }
  sv();renderTeachers();
}
function toggleLessonPerm(tid,gid,lid,checked){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  if(!t.groupPerms[gid])t.groupPerms[gid]={att:false,list:false,allowedLessons:[]};
  if(!t.groupPerms[gid].allowedLessons)t.groupPerms[gid].allowedLessons=[];
  if(checked){
    if(!t.groupPerms[gid].allowedLessons.includes(lid)){
      t.groupPerms[gid].allowedLessons.push(lid);
    }
  }else{
    t.groupPerms[gid].allowedLessons = t.groupPerms[gid].allowedLessons.filter(id=>id!==lid);
  }
  sv();renderTeachers();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE CONFIG MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSbConfig(){
  const u=document.getElementById('sb-url');
  const k=document.getElementById('sb-key');
  if(u)u.value=localStorage.getItem('sb_url')||'';
  if(k)k.value=localStorage.getItem('sb_key')||'';
  // Show current status
  if(sbConfigured()) setSbStatus('‚òÅÔ∏è –ü–∞–π–≤–∞—Å—Ç –∞—Å—Ç: '+SUPABASE_URL,'#f0f9ff','#0369a1');
}
function saveSbConfig(){
  const url=document.getElementById('sb-url').value.trim();
  const key=document.getElementById('sb-key').value.trim();
  if(!url||!key){setSbStatus('‚ùå URL –≤–∞ Key-—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥','#fee2e2','#dc2626');return;}
  // Save directly as individual keys (used on next load)
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  localStorage.setItem('sb_cfg', JSON.stringify({url, key}));
  setSbStatus('‚úÖ –ù–∏–≥–æ“≥ —à—É–¥ ‚Äî –±–∞—Ä–æ–∏ –ø–∞–π–≤–∞—Å—Ç —Ç—É–≥–º–∞–∏ "–°–∞–Ω“∑–∏—à" –∑–∞–Ω–µ–¥','#dcfce7','#166534');
  // Re-init Supabase client with new credentials
  SUPABASE_URL = url;
  SUPABASE_KEY = key;
  _initSb();
  updateSyncStatus('syncing');
  // Try connecting
  lDBCloud().then(ok => {
    if(ok){ updateSyncStatus('online'); startRealtimeSync(); _initDefaults(); renderGroups?.(); buildLoginSelect?.(); setSbStatus('‚úÖ –ü–∞–π–≤–∞—Å—Ç —à—É–¥ –≤–∞ –º–∞—ä–ª—É–º–æ—Ç –≥–∏—Ä–∏—Ñ—Ç–∞ —à—É–¥!','#dcfce7','#166534'); }
    else { updateSyncStatus('offline'); setSbStatus('‚ö†Ô∏è –ù–∏–≥–æ“≥ —à—É–¥, –∞–º–º–æ –ø–∞–π–≤–∞—Å—Ç –Ω–∞—à—É–¥. URL/Key-—Ä–æ —Å–∞–Ω“∑–µ–¥','#fef9c3','#854d0e'); }
  });
}
async function testSbConn(){
  const url=document.getElementById('sb-url').value.trim()||SUPABASE_URL;
  const key=document.getElementById('sb-key').value.trim()||SUPABASE_KEY;
  setSbStatus('üîÑ –°–∞–Ω“∑–∏—à –¥–∞—Ä “∑–∞—Ä–∞—ë–Ω...','#f0f9ff','#0369a1');
  try{
    const r=await fetch(`${url}/rest/v1/davomat_data?limit=1`,{headers:{'apikey':key,'Authorization':'Bearer '+key}});
    if(r.ok||r.status===406){setSbStatus('‚úÖ –ü–∞–π–≤–∞—Å—Ç–∏ –±–æ–º—É–≤–∞—Ñ—Ñ–∞“õ!','#dcfce7','#166534');}
    else setSbStatus(`‚ùå –•–∞—Ç–æ ${r.status}: ${r.statusText}`,'#fee2e2','#dc2626');
  }catch(e){setSbStatus('‚ùå –ü–∞–π–≤–∞—Å—Ç –Ω–∞—à—É–¥: '+e.message,'#fee2e2','#dc2626');}
}
function setSbStatus(msg,bg,color){
  const el=document.getElementById('sb-status');
  if(!el)return;el.textContent=msg;el.style.background=bg;el.style.color=color;el.style.display='block';
}
async function pushToCloud(){
  setSbStatus('‚¨ÜÔ∏è –ë–æ—Ä–≥—É–∑–æ—Ä”£ –¥–∞—Ä “∑–∞—Ä–∞—ë–Ω...','#f0f9ff','#0369a1');
  try {
    // 1. Push groups + settings
    await Promise.all([sbSet('groups', db.groups), sbSet('settings', db.settings)]);
    // 2. Push all attendance cells
    const attRows=[];
    Object.entries(db.attendance||{}).forEach(([gid,gatt])=>{
      Object.entries(gatt||{}).forEach(([attKey,status])=>{
        const parts=attKey.split('_');
        const sid=parts[0], att_date=parts[1], lid=parts.slice(2).join('_');
        attRows.push({id:`${gid}:${attKey}`,gid,sid,att_date,lid,status,updated_at:new Date().toISOString()});
      });
    });
    if(attRows.length){
      // Upsert in batches of 500
      for(let i=0;i<attRows.length;i+=500){
        await _sb.from('davomat_att').upsert(attRows.slice(i,i+500),{onConflict:'id'});
      }
    }
    setSbStatus(`‚úÖ –ë–æ—Ä–≥—É–∑–æ—Ä”£ —à—É–¥! –ì—É—Ä”Ø“≥: ${db.groups?.length||0}, –Ø—á–µ–π–∫–∞“≥–æ–∏ –¥–∞–≤–æ–º–∞—Ç: ${attRows.length}`,'#dcfce7','#166534');
  } catch(e) {
    setSbStatus('‚ùå –•–∞—Ç–æ: '+e.message,'#fee2e2','#dc2626');
  }
}
async function pullFromCloud(){
  setSbStatus('‚¨áÔ∏è –ì–∏—Ä–∏—Ñ—Ç–∞–Ω...','#f0f9ff','#0369a1');
  const ok=await lDBCloud();
  if(ok){_initDefaults();renderGroups();buildLoginSelect();setSbStatus('‚úÖ –ú–∞—ä–ª—É–º–æ—Ç –∞–∑ Cloud –≥–∏—Ä–∏—Ñ—Ç–∞ —à—É–¥!','#dcfce7','#166534');}
  else setSbStatus('‚ùå –ì–∏—Ä–∏—Ñ—Ç–∞–Ω –Ω–∞—à—É–¥','#fee2e2','#dc2626');
}

// Supabase config –∞–∑ localStorage –¥–∞—Ä –±–æ–ª–æ –±–æ—Ä —à—É–¥ (sb_url, sb_key)
// Re-init client if config exists
if(sbConfigured()) _initSb();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUBJECT MANAGEMENT (multi-subject per teacher per group)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Get all subject-group combinations for a teacher (for login)
function getTeacherSubjects(t){
  const result=[];
  const gp=t.groupPerms||{};
  Object.entries(gp).forEach(([gid,gperm])=>{
    const g=db.groups.find(x=>x.id===gid);if(!g)return;
    const subjects=gperm.subjects||[];
    subjects.forEach(subj=>{
      result.push({gid,groupName:g.name,shift:g.shift||1,subjId:subj.id,subjName:subj.name,lessonId:subj.lessonId});
    });
  });
  return result;
}

// Login: when teacher selected, show subject dropdown
function onLoginWhoChange(){
  // No subject selection on login screen ‚Äî teacher selects inside cabinet
}

// Open "Add Subject" modal for a teacher-group
function openAddSubject(tid,gid){
  document.getElementById('as-tid').value=tid;
  document.getElementById('as-gid').value=gid;
  document.getElementById('as-name').value='';
  openModal('m-add-subj');
}
function saveAddSubject(){
  const tid=document.getElementById('as-tid').value;
  const gid=document.getElementById('as-gid').value;
  const name=document.getElementById('as-name').value.trim();
  if(!name){toast('–ù–æ–º–∏ —Ñ–∞–Ω—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥!');return;}
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  if(!t.groupPerms[gid])t.groupPerms[gid]={subjects:[],att:true,list:false,allowedLessons:[]};
  if(!t.groupPerms[gid].subjects)t.groupPerms[gid].subjects=[];
  // Check duplicate name
  if(t.groupPerms[gid].subjects.some(s=>s.name.toLowerCase()===name.toLowerCase())){
    toast('–ò–Ω —Ñ–∞–Ω –∞–ª–ª–∞–∫–∞–π –≤—É“∑—É–¥ –¥–æ—Ä–∞–¥!');return;
  }
  // Subject without lessonId ‚Äî schedule set via —Ç–∞“õ–≤–∏–º
  t.groupPerms[gid].subjects.push({id:uid(),name,lessonId:null});
  t.groupPerms[gid].att=true;
  // allowedLessons = from schedule (handled by getAllowedLessonIds)
  sv();closeModal('m-add-subj');renderTeachers();buildLoginSelect();
  toast('–§–∞–Ω –∏–ª–æ–≤–∞ —à—É–¥ ‚úÖ');
}
function removeSubject(tid,gid,subjId){
  if(!confirm('–ò–Ω —Ñ–∞–Ω—Ä–æ “≥–∞–∑—Ñ –∫—É–Ω–µ–º?'))return;
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms?.[gid]?.subjects)return;
  t.groupPerms[gid].subjects=t.groupPerms[gid].subjects.filter(s=>s.id!==subjId);
  t.groupPerms[gid].allowedLessons=t.groupPerms[gid].subjects.map(s=>s.lessonId);
  if(!t.groupPerms[gid].subjects.length)t.groupPerms[gid].att=false;
  sv();renderTeachers();buildLoginSelect();toast('–§–∞–Ω “≥–∞–∑—Ñ —à—É–¥');
}

// Transfer subject to another teacher
function openTransferSubject(fromTid,gid,subjId){
  const fromT=db.settings.teachers.find(x=>x.id===fromTid);if(!fromT)return;
  const subj=fromT.groupPerms?.[gid]?.subjects?.find(s=>s.id===subjId);if(!subj)return;
  const g=db.groups.find(x=>x.id===gid);
  document.getElementById('ts-from-tid').value=fromTid;
  document.getElementById('ts-gid').value=gid;
  document.getElementById('ts-subj-id').value=subjId;
  document.getElementById('ts-info').innerHTML=
    `<b>–§–∞–Ω:</b> ${subj.name}<br><b>–ì—É—Ä”Ø“≥:</b> ${g?.name||gid}<br><b>–ê–∑:</b> ${fromT.last} ${fromT.first}`;
  const sel=document.getElementById('ts-to-tid');
  sel.innerHTML='<option value="">‚Äî –û–º”Ø–∑–≥–æ—Ä—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥ ‚Äî</option>'+
    db.settings.teachers
      .filter(t=>t.id!==fromTid)
      .map(t=>`<option value="${t.id}">${t.last} ${t.first}${t.subject?' ‚Äî '+t.subject:''}</option>`)
      .join('');
  openModal('m-transfer-subj');
}
function confirmTransferSubject(){
  const fromTid=document.getElementById('ts-from-tid').value;
  const gid=document.getElementById('ts-gid').value;
  const subjId=document.getElementById('ts-subj-id').value;
  const toTid=document.getElementById('ts-to-tid').value;
  if(!toTid){toast('–û–º”Ø–∑–≥–æ—Ä—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥!');return;}
  const fromT=db.settings.teachers.find(x=>x.id===fromTid);
  const toT=db.settings.teachers.find(x=>x.id===toTid);
  if(!fromT||!toT)return;
  const subj=fromT.groupPerms?.[gid]?.subjects?.find(s=>s.id===subjId);if(!subj)return;
  // Add to new teacher
  if(!toT.groupPerms)toT.groupPerms={};
  if(!toT.groupPerms[gid])toT.groupPerms[gid]={subjects:[],att:true,list:false,allowedLessons:[]};
  if(!toT.groupPerms[gid].subjects)toT.groupPerms[gid].subjects=[];
  toT.groupPerms[gid].subjects.push({...subj,id:uid()});
  toT.groupPerms[gid].att=true;
  toT.groupPerms[gid].allowedLessons=toT.groupPerms[gid].subjects.map(s=>s.lessonId);
  // Remove from old teacher
  fromT.groupPerms[gid].subjects=fromT.groupPerms[gid].subjects.filter(s=>s.id!==subjId);
  fromT.groupPerms[gid].allowedLessons=fromT.groupPerms[gid].subjects.map(s=>s.lessonId);
  if(!fromT.groupPerms[gid].subjects.length)fromT.groupPerms[gid].att=false;
  // NOTE: db.attendance stays unchanged ‚Äî same lessonId, same keys
  sv();closeModal('m-transfer-subj');renderTeachers();buildLoginSelect();
  toast(`‚úÖ ${subj.name} ‚Üí ${toT.last} ${toT.first} –∏–Ω—Ç–∏“õ–æ–ª —à—É–¥`);
}

// JSON Backup
function expJSON(){dl(JSON.stringify(db,null,2),'davomat_backup_'+new Date().toISOString().slice(0,10)+'.json','application/json');toast('JSON Backup ‚úÖ');}
function impJSON(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{db=JSON.parse(ev.target.result);sv();renderGroups();toast('JSON –∏–º–ø–æ—Ä—Ç ‚úÖ');}catch(err){toast('–•–∞—Ç–æ: —Ñ–∞–π–ª –Ω–æ–¥—É—Ä—É—Å—Ç!');}};r.readAsText(f,'UTF-8');}
function clearAll(){if(!confirm('“≤–∞–º–∞—Ä–æ —Ç–æ–∑–∞ –º–µ–∫—É–Ω–µ–º?'))return;const sh=db.settings.shifts;const adminPw=db.settings.adminPw;db={groups:[],attendance:{},settings:{instName:'',teacherName:'',adminPw,shifts:sh,teachers:[]}};sv();renderGroups();toast('–¢–æ–∑–∞ —à—É–¥');}

// ============================================
//  MODAL / TOAST
// ============================================
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));
let _tt;
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>t.classList.remove('show'),2700);}

// ============================================
//  INIT
// ============================================
lDB(); // Load from localStorage first (instant)
_initDefaults();

document.addEventListener('click', e=>{
  document.querySelectorAll('[id^="gss-"]').forEach(el=>{
    if(!el.contains(e.target)&&!e.target.id?.startsWith('gsi-'))el.style.display='none';
  });
});
updDL();updML();updSmsD();updSmsM();
buildLoginSelect();
document.getElementById('main-hdr').style.display='none';

// Then load from Supabase (async ‚Äî updates UI when ready)
(async()=>{
  if(SUPABASE_URL.includes('YOUR_PROJECT')){
    updateSyncStatus('offline');
    return;
  }
  updateSyncStatus('syncing');
  const ok = await lDBCloud();
  if(ok){
    updateSyncStatus('online');
    _initDefaults();
    buildLoginSelect();
    startRealtimeSync();
  } else {
    updateSyncStatus('offline');
  }
})();
</script>
</body>
</html>
