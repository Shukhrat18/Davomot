<!DOCTYPE html>
<html lang="tg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItCU0LDQstC+0LzQvtGCIOKAlCDQodC40YHRgtC10LzQsNC4INC00LDQstC+0LzQvtGCIiwKICAic2hvcnRfbmFtZSI6ICLQlNCw0LLQvtC80L7RgiIsCiAgImRlc2NyaXB0aW9uIjogItCh0LjRgdGC0LXQvNCw0Lgg0rPQuNGB0L7QsdCz0LjRgNC40Lgg0LTQsNCy0L7QvNC+0YLQuCDQtNC+0L3QuNGI0rfTr9GR0L0iLAogICJzdGFydF91cmwiOiAiLi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdC1wcmltYXJ5IiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDkwOTBmIiwKICAidGhlbWVfY29sb3IiOiAiIzYzNjZmMSIsCiAgImxhbmciOiAidGciLAogICJkaXIiOiAibHRyIiwKICAic2NvcGUiOiAiLi8iLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBMU1USWdOVEV5SWo0S0lDQThaR1ZtY3o0S0lDQWdJRHhzYVc1bFlYSkhjbUZrYVdWdWRDQnBaRDBpWnlJZ2VERTlJakFsSWlCNU1UMGlNQ1VpSUhneVBTSXhNREFsSWlCNU1qMGlNVEF3SlNJK0NpQWdJQ0FnSUR4emRHOXdJRzltWm5ObGREMGlNQ1VpSUhOMGVXeGxQU0p6ZEc5d0xXTnZiRzl5T2lNMk16WTJaakVpTHo0S0lDQWdJQ0FnUEhOMGIzQWdiMlptYzJWMFBTSXhNREFsSWlCemRIbHNaVDBpYzNSdmNDMWpiMnh2Y2pvak5HWTBObVUxSWk4K0NpQWdJQ0E4TDJ4cGJtVmhja2R5WVdScFpXNTBQZ29nSUR3dlpHVm1jejRLSUNBOGNtVmpkQ0IzYVdSMGFEMGlOVEV5SWlCb1pXbG5hSFE5SWpVeE1pSWdjbmc5SWpFeE1DSWdabWxzYkQwaWRYSnNLQ05uS1NJdlBnb2dJRHh5WldOMElIZzlJakV5TUNJZ2VUMGlNVFF3SWlCM2FXUjBhRDBpTWpjeUlpQm9aV2xuYUhROUlqTXdJaUJ5ZUQwaU1UVWlJR1pwYkd3OUluSm5ZbUVvTWpVMUxESTFOU3d5TlRVc0xqa3BJaTgrQ2lBZ1BISmxZM1FnZUQwaU1USXdJaUI1UFNJeU1EQWlJSGRwWkhSb1BTSXlNREFpSUdobGFXZG9kRDBpTWpJaUlISjRQU0l4TVNJZ1ptbHNiRDBpY21kaVlTZ3lOVFVzTWpVMUxESTFOU3d1TmlraUx6NEtJQ0E4Y21WamRDQjRQU0l4TWpBaUlIazlJakkxTUNJZ2QybGtkR2c5SWpJME1DSWdhR1ZwWjJoMFBTSXlNaUlnY25nOUlqRXhJaUJtYVd4c1BTSnlaMkpoS0RJMU5Td3lOVFVzTWpVMUxDNDJLU0l2UGdvZ0lEeHlaV04wSUhnOUlqRXlNQ0lnZVQwaU16QXdJaUIzYVdSMGFEMGlNVGd3SWlCb1pXbG5hSFE5SWpJeUlpQnllRDBpTVRFaUlHWnBiR3c5SW5KblltRW9NalUxTERJMU5Td3lOVFVzTGpZcElpOCtDaUFnUEhKbFkzUWdlRDBpTVRJd0lpQjVQU0l6TlRBaUlIZHBaSFJvUFNJeU1qQWlJR2hsYVdkb2REMGlNaklpSUhKNFBTSXhNU0lnWm1sc2JEMGljbWRpWVNneU5UVXNNalUxTERJMU5Td3VORFVwSWk4K0NpQWdQR05wY21Oc1pTQmplRDBpTXpnMUlpQmplVDBpTXpVMUlpQnlQU0k1TUNJZ1ptbHNiRDBpY21kaVlTZ3lOVFVzTWpVMUxESTFOU3d1TURncElpOCtDaUFnUEhSbGVIUWdlRDBpTXpnMUlpQjVQU0l6TnpBaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlJR1p2Ym5RdGMybDZaVDBpTnpBaUlHWnBiR3c5SW5kb2FYUmxJaUJtYjI1MExXWmhiV2xzZVQwaVFYSnBZV3dpUHVLY2t6d3ZkR1Y0ZEQ0S1BDOXpkbWMrIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBMU1USWdOVEV5SWo0S0lDQThaR1ZtY3o0S0lDQWdJRHhzYVc1bFlYSkhjbUZrYVdWdWRDQnBaRDBpWnlJZ2VERTlJakFsSWlCNU1UMGlNQ1VpSUhneVBTSXhNREFsSWlCNU1qMGlNVEF3SlNJK0NpQWdJQ0FnSUR4emRHOXdJRzltWm5ObGREMGlNQ1VpSUhOMGVXeGxQU0p6ZEc5d0xXTnZiRzl5T2lNMk16WTJaakVpTHo0S0lDQWdJQ0FnUEhOMGIzQWdiMlptYzJWMFBTSXhNREFsSWlCemRIbHNaVDBpYzNSdmNDMWpiMnh2Y2pvak5HWTBObVUxSWk4K0NpQWdJQ0E4TDJ4cGJtVmhja2R5WVdScFpXNTBQZ29nSUR3dlpHVm1jejRLSUNBOGNtVmpkQ0IzYVdSMGFEMGlOVEV5SWlCb1pXbG5hSFE5SWpVeE1pSWdjbmc5SWpFeE1DSWdabWxzYkQwaWRYSnNLQ05uS1NJdlBnb2dJRHh5WldOMElIZzlJakV5TUNJZ2VUMGlNVFF3SWlCM2FXUjBhRDBpTWpjeUlpQm9aV2xuYUhROUlqTXdJaUJ5ZUQwaU1UVWlJR1pwYkd3OUluSm5ZbUVvTWpVMUxESTFOU3d5TlRVc0xqa3BJaTgrQ2lBZ1BISmxZM1FnZUQwaU1USXdJaUI1UFNJeU1EQWlJSGRwWkhSb1BTSXlNREFpSUdobGFXZG9kRDBpTWpJaUlISjRQU0l4TVNJZ1ptbHNiRDBpY21kaVlTZ3lOVFVzTWpVMUxESTFOU3d1TmlraUx6NEtJQ0E4Y21WamRDQjRQU0l4TWpBaUlIazlJakkxTUNJZ2QybGtkR2c5SWpJME1DSWdhR1ZwWjJoMFBTSXlNaUlnY25nOUlqRXhJaUJtYVd4c1BTSnlaMkpoS0RJMU5Td3lOVFVzTWpVMUxDNDJLU0l2UGdvZ0lEeHlaV04wSUhnOUlqRXlNQ0lnZVQwaU16QXdJaUIzYVdSMGFEMGlNVGd3SWlCb1pXbG5hSFE5SWpJeUlpQnllRDBpTVRFaUlHWnBiR3c5SW5KblltRW9NalUxTERJMU5Td3lOVFVzTGpZcElpOCtDaUFnUEhKbFkzUWdlRDBpTVRJd0lpQjVQU0l6TlRBaUlIZHBaSFJvUFNJeU1qQWlJR2hsYVdkb2REMGlNaklpSUhKNFBTSXhNU0lnWm1sc2JEMGljbWRpWVNneU5UVXNNalUxTERJMU5Td3VORFVwSWk4K0NpQWdQR05wY21Oc1pTQmplRDBpTXpnMUlpQmplVDBpTXpVMUlpQnlQU0k1TUNJZ1ptbHNiRDBpY21kaVlTZ3lOVFVzTWpVMUxESTFOU3d1TURncElpOCtDaUFnUEhSbGVIUWdlRDBpTXpnMUlpQjVQU0l6TnpBaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlJR1p2Ym5RdGMybDZaVDBpTnpBaUlHWnBiR3c5SW5kb2FYUmxJaUJtYjI1MExXWmhiV2xzZVQwaVFYSnBZV3dpUHVLY2t6d3ZkR1Y0ZEQ0S1BDOXpkbWMrIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0sCiAgInNob3J0Y3V0cyI6IFsKICAgIHsKICAgICAgIm5hbWUiOiAi0JTQsNCy0L7QvNC+0YIiLAogICAgICAidXJsIjogIi4vI2F0dGVuZGFuY2UiLAogICAgICAiZGVzY3JpcHRpb24iOiAi0JTQsNCy0L7QvNC+0YLQuCDQuNC80YDTr9C3IgogICAgfSwKICAgIHsKICAgICAgIm5hbWUiOiAi0KHRgtCw0YLQuNGB0YLQuNC60LAiLAogICAgICAidXJsIjogIi4vI3N0YXRzIiwKICAgICAgImRlc2NyaXB0aW9uIjogItKy0LjRgdC+0LHQvtGC0Lgg0YPQvNGD0LzToyIKICAgIH0KICBdLAogICJjYXRlZ29yaWVzIjogWwogICAgImVkdWNhdGlvbiIsCiAgICAicHJvZHVjdGl2aXR5IgogIF0sCiAgInByZWZlcl9yZWxhdGVkX2FwcGxpY2F0aW9ucyI6IGZhbHNlCn0=">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Давомот">
<meta name="application-name" content="Давомот">
<meta name="msapplication-TileColor" content="#6366f1">
<meta name="theme-color" content="#6366f1" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#6366f1">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZyIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM2MzY2ZjEiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNGY0NmU1Ii8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjExMCIgZmlsbD0idXJsKCNnKSIvPgogIDxyZWN0IHg9IjEyMCIgeT0iMTQwIiB3aWR0aD0iMjcyIiBoZWlnaHQ9IjMwIiByeD0iMTUiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsLjkpIi8+CiAgPHJlY3QgeD0iMTIwIiB5PSIyMDAiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjIiIHJ4PSIxMSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwuNikiLz4KICA8cmVjdCB4PSIxMjAiIHk9IjI1MCIgd2lkdGg9IjI0MCIgaGVpZ2h0PSIyMiIgcng9IjExIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LC42KSIvPgogIDxyZWN0IHg9IjEyMCIgeT0iMzAwIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjIyIiByeD0iMTEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsLjYpIi8+CiAgPHJlY3QgeD0iMTIwIiB5PSIzNTAiIHdpZHRoPSIyMjAiIGhlaWdodD0iMjIiIHJ4PSIxMSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwuNDUpIi8+CiAgPGNpcmNsZSBjeD0iMzg1IiBjeT0iMzU1IiByPSI5MCIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwuMDgpIi8+CiAgPHRleHQgeD0iMzg1IiB5PSIzNzAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iNzAiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0iQXJpYWwiPuKckzwvdGV4dD4KPC9zdmc+">
<meta name="format-detection" content="telephone=no">
<meta name="msapplication-tap-highlight" content="no">
<title>Давомот — Системаи ҳисобгирии давомот</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,400;0,600;0,700;0,800;0,900;1,700&family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        nunito: ['Nunito', 'sans-serif'],
        rubik: ['Rubik', 'sans-serif'],
      },
      colors: {
        primary: { DEFAULT:'#3b82f6', dark:'#1d4ed8', light:'#eff6ff', mid:'#dbeafe' },
        success: { DEFAULT:'#10b981', dark:'#059669', light:'#ecfdf5' },
        danger:  { DEFAULT:'#ef4444', light:'#fee2e2' },
        warn:    { DEFAULT:'#f59e0b', light:'#fef3c7' },
        accent:  { DEFAULT:'#f97316' },
        violet:  { DEFAULT:'#8b5cf6', dark:'#6d28d9', light:'#f5f3ff' },
      },
      boxShadow: {
        'card': '0 2px 16px rgba(0,0,0,.08)',
        'card-hover': '0 8px 32px rgba(0,0,0,.14)',
        'header': '0 4px 24px rgba(59,130,246,.35)',
        'modal': '0 24px 80px rgba(0,0,0,.25)',
        'toast': '0 8px 24px rgba(0,0,0,.25)',
      },
      borderRadius: {
        'card': '16px',
        'xl2': '20px',
        'xl3': '24px',
      },
      keyframes: {
        slideUp:   { from:{ transform:'translateY(60px)', opacity:'0' }, to:{ transform:'translateY(0)', opacity:'1' } },
        fadeIn:    { from:{ opacity:'0' }, to:{ opacity:'1' } },
        pageIn:    { from:{ opacity:'0', transform:'translateY(8px)' }, to:{ opacity:'1', transform:'translateY(0)' } },
        toastIn:   { from:{ transform:'translateX(-50%) translateY(70px)', opacity:'0' }, to:{ transform:'translateX(-50%) translateY(0)', opacity:'1' } },
        pulse2:    { '0%,100%':{ opacity:'1' }, '50%':{ opacity:'.55' } },
        scaleIn:   { from:{ transform:'scale(.92)', opacity:'0' }, to:{ transform:'scale(1)', opacity:'1' } },
        shimmer:   { '0%':{ backgroundPosition:'-200% 0' }, '100%':{ backgroundPosition:'200% 0' } },
      },
      animation: {
        'slide-up': 'slideUp .3s cubic-bezier(.34,1.56,.64,1)',
        'fade-in':  'fadeIn .2s ease',
        'page-in':  'pageIn .22s ease',
        'toast-in': 'toastIn .3s cubic-bezier(.34,1.56,.64,1)',
        'pulse2':   'pulse2 1.8s ease-in-out infinite',
        'scale-in': 'scaleIn .25s cubic-bezier(.34,1.56,.64,1)',
        'shimmer':  'shimmer 2s linear infinite',
      }
    }
  }
}
</script>
<style>
/* ═══════════════════════════════════════════════════════════
   ДАВОМОТ v12 — AI PREMIUM DARK THEME
   Modern glassmorphism + subtle gradients + sharp typography
   ══════════════════════════════════════════════════════════ */

@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Rubik:wght@300;400;500;600;700&display=swap');

:root {
  /* Core palette */
  --bg:        #09090f;
  --bg-2:      #0f0f1a;
  --bg-3:      #161625;
  --bg-4:      #1c1c30;
  --surface:   #1a1a2e;
  --surface-2: #22223b;
  --surface-3: #2a2a4a;
  --border:    rgba(255,255,255,.07);
  --border-2:  rgba(255,255,255,.12);
  --border-3:  rgba(255,255,255,.18);

  /* Text */
  --text:      #f0f0ff;
  --text-2:    #a8a8c8;
  --text-3:    #6b6b8a;
  --text-4:    #444460;

  /* Brand accent */
  --blue:      #6366f1;
  --blue-d:    #4f46e5;
  --blue-l:    rgba(99,102,241,.12);
  --blue-m:    rgba(99,102,241,.2);
  --blue-glow: rgba(99,102,241,.35);

  /* Status colors */
  --red:       #f87171;
  --red-bg:    rgba(248,113,113,.12);
  --red-border:rgba(248,113,113,.25);
  --yellow:    #fbbf24;
  --yellow-bg: rgba(251,191,36,.1);
  --yellow-border:rgba(251,191,36,.25);
  --green:     #34d399;
  --green-bg:  rgba(52,211,153,.1);
  --green-border:rgba(52,211,153,.25);
  --teal:      #22d3ee;
  --purple:    #a78bfa;
  --orange:    #fb923c;
  --pink:      #f472b6;

  /* Glass */
  --glass:     rgba(255,255,255,.04);
  --glass-2:   rgba(255,255,255,.07);
  --glass-hover:rgba(255,255,255,.09);

  /* Shadows */
  --sh:        0 2px 12px rgba(0,0,0,.4);
  --sh-md:     0 8px 32px rgba(0,0,0,.5);
  --sh-lg:     0 20px 60px rgba(0,0,0,.6);

  /* Radius */
  --r:         14px;
  --rl:        18px;
  --rxl:       22px;
}

/* ── RESET ── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
::selection { background: rgba(99,102,241,.35); color: #fff; }
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-4); }

body {
  font-family: 'Rubik', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 14px;
  background-image:
    radial-gradient(ellipse 80% 50% at 50% -20%, rgba(99,102,241,.15) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(167,139,250,.07) 0%, transparent 50%);
  background-attachment: fixed;
}

/* ═══ LOGIN ═══ */
.login-screen {
  position: fixed; inset: 0; z-index: 1000;
  display: flex; align-items: center; justify-content: center; padding: 20px;
  background:
    radial-gradient(ellipse 100% 80% at 50% -10%, rgba(99,102,241,.3) 0%, transparent 55%),
    radial-gradient(ellipse 70% 60% at 10% 90%, rgba(167,139,250,.15) 0%, transparent 50%),
    radial-gradient(ellipse 60% 50% at 90% 50%, rgba(34,211,238,.08) 0%, transparent 45%),
    linear-gradient(180deg, #06060f 0%, #0a0a18 100%);
  overflow: hidden;
}
.login-screen::before {
  content: '';
  position: absolute; inset: 0; pointer-events: none;
  background-image:
    radial-gradient(circle at 20% 30%, rgba(99,102,241,.06) 0%, transparent 40%),
    radial-gradient(circle at 80% 70%, rgba(167,139,250,.05) 0%, transparent 35%);
  animation: breathe 8s ease-in-out infinite alternate;
}
@keyframes breathe { from { opacity: .6; } to { opacity: 1; } }

.login-box {
  position: relative; z-index: 2;
  background: rgba(15,15,28,.9);
  backdrop-filter: blur(24px) saturate(1.4);
  border: 1px solid rgba(99,102,241,.2);
  border-radius: var(--rxl);
  padding: 40px 32px;
  width: 100%; max-width: 390px;
  box-shadow: 0 40px 80px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.04), inset 0 1px 0 rgba(255,255,255,.07);
  animation: loginAppear .5s cubic-bezier(.34,1.2,.64,1);
}
@keyframes loginAppear {
  from { transform: translateY(30px) scale(.96); opacity: 0; }
  to   { transform: translateY(0) scale(1); opacity: 1; }
}
.login-logo { text-align: center; margin-bottom: 18px; }
.login-logo-icon {
  display: inline-flex; align-items: center; justify-content: center;
  width: 76px; height: 76px; font-size: 2.2rem;
  background: linear-gradient(135deg, rgba(99,102,241,.25), rgba(167,139,250,.15));
  border: 1px solid rgba(99,102,241,.35);
  border-radius: 22px;
  box-shadow: 0 8px 32px rgba(99,102,241,.3), inset 0 1px 0 rgba(255,255,255,.1);
  backdrop-filter: blur(8px);
}
.login-title {
  font-family: 'Nunito', sans-serif; font-weight: 900;
  font-size: 1.85rem; letter-spacing: -1px; text-align: center;
  background: linear-gradient(135deg, #fff 30%, #a78bfa 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.login-sub { text-align: center; font-size: .75rem; color: var(--text-3); margin-top: 6px; line-height: 1.6; }
.login-err {
  display: none; align-items: center; gap: 8px;
  background: var(--red-bg); color: var(--red);
  border: 1px solid var(--red-border);
  border-radius: 10px; padding: 10px 14px; font-size: .8rem; font-weight: 500;
  margin-bottom: 14px; margin-top: 4px;
}

/* ═══ HEADER ═══ */
.hdr {
  background: rgba(10,10,20,.85);
  backdrop-filter: blur(20px) saturate(1.3);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 50;
  box-shadow: 0 1px 0 rgba(255,255,255,.04), 0 4px 24px rgba(0,0,0,.4);
}
.hdr-top {
  padding: 11px 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.hdr-brand { display: flex; align-items: center; gap: 10px; }
.hdr-logo {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, rgba(99,102,241,.3), rgba(167,139,250,.2));
  border: 1px solid rgba(99,102,241,.3);
  border-radius: 11px; display: flex; align-items: center; justify-content: center;
  font-size: .95rem;
  box-shadow: 0 0 16px rgba(99,102,241,.2);
}
.hdr-title { font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 1rem; color: var(--text); }
.hdr-sub { font-size: .58rem; color: var(--text-3); margin-top: 1px; }
.hdr-user { display: flex; align-items: center; gap: 8px; }
.hdr-avatar {
  width: 32px; height: 32px;
  background: var(--glass-2); border: 1px solid var(--border-2);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: .82rem; cursor: pointer;
  transition: background .18s, transform .18s;
}
.hdr-avatar:hover { background: var(--glass-hover); transform: scale(1.08); }

/* ═══ NAV ═══ */
.nav {
  display: flex;
  border-top: 1px solid var(--border);
  background: rgba(0,0,0,.2);
}
.nitem {
  flex: 1; padding: 8px 4px; text-align: center;
  font-size: .6rem; font-weight: 600; color: var(--text-3);
  cursor: pointer; border-bottom: 2px solid transparent;
  transition: all .2s; display: flex; flex-direction: column; align-items: center; gap: 2px;
  letter-spacing: .2px; text-transform: uppercase;
}
.nitem .ni { font-size: .92rem; }
.nitem.active {
  color: #fff; border-bottom-color: var(--blue);
  background: linear-gradient(180deg, rgba(99,102,241,.1) 0%, transparent 100%);
}
.nitem.active .ni { transform: scale(1.12); }
.nitem:hover:not(.active) { color: var(--text-2); background: var(--glass); }

/* ═══ PAGES ═══ */
.page { display: none; padding: 14px; min-height: calc(100vh - 110px); }
.page.active { display: block; animation: pageSlide .22s ease; }
@keyframes pageSlide { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

/* ═══ CARDS ═══ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--rl); margin-bottom: 10px; overflow: hidden;
  transition: border-color .2s;
}
.card:hover { border-color: var(--border-2); }
.card-h {
  padding: 12px 15px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.ctitle {
  font-family: 'Nunito', sans-serif; font-weight: 800; font-size: .85rem;
  color: var(--text); display: flex; align-items: center; gap: 6px;
}

/* ═══ GROUP CARDS ═══ */
.gcrd {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--rl); margin-bottom: 9px;
  border-left: 3px solid var(--blue);
  transition: border-color .2s, box-shadow .2s, transform .2s;
  overflow: hidden;
}
.gcrd.s2 { border-left-color: var(--orange); }
.gcrd:hover {
  border-color: var(--border-2);
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
  transform: translateY(-1px);
}
.gct { padding: 13px 15px; display: flex; align-items: center; justify-content: space-between; }
.gcn { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: .9rem; color: var(--text); }
.gcc { font-size: .7rem; color: var(--text-3); margin-top: 3px; }
.gca {
  padding: 8px 12px 11px; display: flex; gap: 6px;
  border-top: 1px solid var(--border); background: rgba(0,0,0,.15);
}

/* ═══ STUDENTS ═══ */
.srow {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; border-bottom: 1px solid var(--border);
  transition: background .15s; cursor: pointer;
}
.srow:last-child { border-bottom: none; }
.srow:hover { background: var(--glass-2); }
.ava {
  width: 36px; height: 36px; border-radius: 50%;
  background: linear-gradient(135deg, var(--blue), var(--blue-d));
  color: #fff; display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: .75rem; flex-shrink: 0;
  box-shadow: 0 2px 8px var(--blue-glow);
}
.sn { font-weight: 600; font-size: .84rem; color: var(--text); }
.ss { font-size: .67rem; color: var(--text-3); margin-top: 2px; }

/* ═══ BUTTONS ═══ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 5px;
  padding: 8px 14px; border-radius: 10px; border: none;
  font-family: 'Rubik', sans-serif; font-weight: 600; font-size: .77rem;
  cursor: pointer; transition: all .18s cubic-bezier(.34,1.3,.64,1); white-space: nowrap;
  position: relative; overflow: hidden;
}
.btn:active { transform: scale(.92); }

.bb {
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: #fff; box-shadow: 0 2px 10px rgba(99,102,241,.35);
}
.bb:hover { background: linear-gradient(135deg, #7274f5, #6366f1); box-shadow: 0 4px 18px rgba(99,102,241,.5); transform: translateY(-1px); }

.bg {
  background: linear-gradient(135deg, #10b981, #059669);
  color: #fff; box-shadow: 0 2px 10px rgba(16,185,129,.25);
}
.bg:hover { box-shadow: 0 4px 16px rgba(16,185,129,.4); transform: translateY(-1px); }

.br {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: #fff; box-shadow: 0 2px 10px rgba(239,68,68,.25);
}
.br:hover { box-shadow: 0 4px 16px rgba(239,68,68,.4); transform: translateY(-1px); }

.bgh {
  background: var(--surface-2); color: var(--text-2);
  border: 1px solid var(--border-2);
}
.bgh:hover { background: var(--surface-3); color: var(--text); border-color: var(--border-3); }

.bpur {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: #fff; box-shadow: 0 2px 10px rgba(139,92,246,.3);
}
.bpur:hover { box-shadow: 0 4px 18px rgba(139,92,246,.45); transform: translateY(-1px); }

.bor {
  background: linear-gradient(135deg, #f97316, #ea580c);
  color: #fff; box-shadow: 0 2px 10px rgba(249,115,22,.25);
}

.bsm { padding: 5px 10px; font-size: .72rem; border-radius: 8px; }
.bxs { padding: 3px 7px; font-size: .66rem; border-radius: 6px; }
.bico { width: 32px; height: 32px; padding: 0; border-radius: 9px; }
.bblk { width: 100%; }

/* ═══ FORM FIELDS ═══ */
.fg { margin-bottom: 11px; }
.fl {
  display: block; font-size: .68rem; font-weight: 700; color: var(--text-3);
  margin-bottom: 5px; text-transform: uppercase; letter-spacing: .4px;
}
.fc {
  width: 100%; padding: 9px 13px;
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: 10px; color: var(--text);
  font-family: 'Rubik', sans-serif; font-size: .84rem;
  transition: border-color .2s, box-shadow .2s;
}
.fc:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px var(--blue-m); }
.fc::placeholder { color: var(--text-4); }
.fc option { background: var(--surface-2); color: var(--text); }
.fr { display: flex; gap: 8px; } .fr .fg { flex: 1; }

/* ═══ MODAL ═══ */
.overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.75); backdrop-filter: blur(6px);
  z-index: 200; align-items: flex-end; justify-content: center;
}
.overlay.open { display: flex; animation: overlayIn .2s ease; }
@keyframes overlayIn { from { opacity: 0; } to { opacity: 1; } }

.modal {
  background: var(--bg-3);
  border: 1px solid var(--border-2);
  border-top: 1px solid rgba(99,102,241,.2);
  border-radius: 24px 24px 0 0;
  padding: 16px 18px 36px;
  width: 100%; max-width: 520px; max-height: 92vh; overflow-y: auto;
  animation: modalUp .3s cubic-bezier(.34,1.2,.64,1);
  box-shadow: 0 -8px 40px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.06);
}
@keyframes modalUp {
  from { transform: translateY(60px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}
.mh {
  width: 40px; height: 4px; border-radius: 4px; margin: 0 auto 15px;
  background: linear-gradient(90deg, var(--surface-3), var(--surface-2), var(--surface-3));
}
.mt { font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 1rem; color: var(--text); margin-bottom: 14px; }
.mf { display: flex; gap: 8px; margin-top: 14px; }

/* ═══ ATTENDANCE TABLE ═══ */
.att-wrap { overflow-x: auto; border-radius: var(--r); }
.att-table { width: 100%; border-collapse: collapse; font-size: .73rem; }
.att-table thead th {
  background: var(--surface-2); color: var(--text-2);
  padding: 6px 3px; text-align: center; font-weight: 700; white-space: nowrap;
  border-bottom: 1px solid var(--border-2);
  position: sticky; top: 0; z-index: 10;
}
.att-table thead th.nc {
  text-align: left; min-width: 110px;
  position: sticky; left: 0; z-index: 15;
  background: var(--surface-3);
}
.att-table thead th.sc {
  background: var(--surface-3); min-width: 72px;
  position: sticky; right: 0; z-index: 11;
}
.att-table tbody td {
  padding: 3px 2px; text-align: center;
  border-bottom: 1px solid var(--border); vertical-align: middle;
  background: var(--surface);
}
.att-table tbody td.nc {
  text-align: left; padding: 7px 10px;
  position: sticky; left: 0; z-index: 5;
  background: var(--surface-2); border-right: 1px solid var(--border-2);
  color: var(--text);
}
.att-table tbody td.sc {
  position: sticky; right: 0; z-index: 6;
  background: var(--surface-2); border-left: 1px solid var(--border-2);
  font-size: .67rem; padding: 3px 5px; white-space: nowrap; color: var(--text-2);
}
.att-table tr:nth-child(even) td { background: rgba(255,255,255,.015); }
.att-table tr:nth-child(even) td.nc { background: var(--surface-2); }
.att-table tr:nth-child(even) td.sc { background: var(--surface-2); }
.att-table td.ds { border-left: 1px solid rgba(99,102,241,.2) !important; }
.att-table th.snh { background: rgba(248,113,113,.2) !important; color: var(--red) !important; }
.att-table td.snd { background: rgba(248,113,113,.06) !important; }

/* ═══ ATTENDANCE CELLS ═══ */
.ac {
  width: 28px; height: 23px; border-radius: 7px;
  display: inline-flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: .65rem; cursor: pointer;
  transition: transform .15s cubic-bezier(.34,1.5,.64,1), box-shadow .15s;
  user-select: none; margin: auto;
}
.ac:hover { transform: scale(1.22); box-shadow: 0 4px 12px rgba(0,0,0,.4); }
.ac:active { transform: scale(.85); }

.ce { background: rgba(255,255,255,.04); color: var(--text-4); border: 1px dashed rgba(255,255,255,.1); }
.ca { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }
.cs { background: var(--yellow-bg); color: var(--yellow); border: 1px solid var(--yellow-border); }
.cu { background: var(--blue-l); color: var(--blue); border: 1px solid rgba(99,102,241,.3); }

.sn2 { color: var(--red); font-weight: 800; }
.sb2 { color: var(--yellow); font-weight: 700; }
.su2 { color: var(--teal); font-weight: 700; }

/* ═══ VIEW TOGGLE ═══ */
.vt, .seg {
  display: flex;
  background: var(--surface-2); border: 1px solid var(--border);
  border-radius: 12px; padding: 3px; margin-bottom: 10px;
}
.vtb, .seg-b {
  flex: 1; padding: 7px 6px; text-align: center;
  border-radius: 9px; font-size: .72rem; font-weight: 600;
  cursor: pointer; color: var(--text-3); transition: all .2s;
}
.vtb.active, .seg-b.active {
  background: var(--surface-3); color: var(--text);
  box-shadow: 0 2px 8px rgba(0,0,0,.3);
  border: 1px solid var(--border-2);
}
.seg-b.s2.active { color: var(--orange); border-color: rgba(251,146,60,.3); }

/* ═══ DAY BAR ═══ */
.dbar {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 9px 12px; margin-bottom: 10px;
}
.dn {
  width: 30px; height: 30px; border-radius: 8px;
  background: var(--surface-2); border: 1px solid var(--border-2);
  color: var(--text-2); font-size: .88rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .18s;
}
.dn:hover { background: var(--surface-3); color: var(--text); border-color: var(--blue); }
.dl { flex: 1; text-align: center; font-weight: 700; font-size: .84rem; color: var(--text); }

/* ═══ STATUS OPTIONS (modal) ═══ */
.sopt {
  display: flex; align-items: center; gap: 12px;
  padding: 11px 14px; border-radius: var(--r);
  border: 1px solid var(--border-2); cursor: pointer;
  transition: all .18s; margin-bottom: 7px;
  background: var(--surface-2);
}
.sopt:hover { border-color: var(--blue); background: var(--blue-l); }
.sopt-i { font-size: 1.3rem; width: 30px; text-align: center; }
.sopt-l { font-weight: 700; font-size: .84rem; color: var(--text); }
.sopt-s { font-size: .68rem; color: var(--text-3); }

/* ═══ STATS DASHBOARD ═══ */
.sgrid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 10px; }
.sbox { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 11px; text-align: center; }
.snum { font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 1.4rem; }
.slbl { font-size: .62rem; color: var(--text-3); font-weight: 600; margin-top: 2px; }

.dash-sum { display: grid; grid-template-columns: repeat(4,1fr); gap: 7px; margin-bottom: 12px; }
.dash-sbox {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 11px 8px; text-align: center;
  transition: border-color .2s, transform .2s;
}
.dash-sbox:hover { border-color: var(--border-2); transform: translateY(-1px); }
.dash-sbox.red   { border-top: 2px solid var(--red); }
.dash-sbox.yellow{ border-top: 2px solid var(--yellow); }
.dash-sbox.blue  { border-top: 2px solid var(--blue); }
.dash-sbox.green { border-top: 2px solid var(--green); }
.dash-snum { font-size: 1.3rem; font-weight: 900; font-family: 'Nunito', sans-serif; line-height: 1.1; }
.dash-slbl { font-size: .57rem; color: var(--text-3); font-weight: 600; margin-top: 3px; }

.dash-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
.dash-chart-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--rl); padding: 13px 15px;
}
.dash-chart-card.full { grid-column: 1/-1; }
.dash-chart-title { font-size: .72rem; font-weight: 800; color: var(--text-2); margin-bottom: 10px; letter-spacing: .2px; }

.dash-grp-grid { display: grid; grid-template-columns: 1fr; gap: 9px; margin-bottom: 10px; }
.dash-grp-card {
  background: var(--surface); border: 1px solid var(--border);
  border-left: 3px solid var(--border-2);
  border-radius: var(--rl); overflow: hidden; cursor: pointer;
  transition: border-color .2s, box-shadow .2s, transform .2s;
}
.dash-grp-card:hover {
  border-color: var(--border-2);
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
  transform: translateY(-1px);
}
.dash-grp-top { display: flex; align-items: center; gap: 10px; padding: 12px 14px 7px; }
.dash-grp-rank { font-size: 1.2rem; width: 32px; text-align: center; flex-shrink: 0; }
.dash-grp-info { flex: 1; min-width: 0; }
.dash-grp-name { font-size: .9rem; font-weight: 800; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dash-grp-meta { font-size: .67rem; color: var(--text-3); margin-top: 2px; display: flex; align-items: center; flex-wrap: wrap; gap: 4px; }
.dash-grp-pct { text-align: center; flex-shrink: 0; }
.dash-grp-pct-big { font-size: 1.5rem; font-weight: 900; line-height: 1; font-family: 'Nunito', sans-serif; }
.dash-grp-pct-lbl { font-size: .55rem; font-weight: 600; color: var(--text-3); }
.dash-grp-bars { padding: 2px 14px 12px 56px; }
.dash-bar-row { display: flex; align-items: center; gap: 7px; margin-bottom: 5px; }
.dash-bar-lbl { font-size: .62rem; font-weight: 700; color: var(--text-3); width: 60px; flex-shrink: 0; }
.dash-bar-bg { flex: 1; height: 8px; background: var(--surface-2); border-radius: 4px; overflow: hidden; }
.dash-bar-fill { height: 100%; border-radius: 4px; transition: width .6s cubic-bezier(.4,0,.2,1); }
.dash-bar-pct { font-size: .62rem; font-weight: 800; color: var(--text-2); width: 30px; text-align: right; flex-shrink: 0; }
.dash-att-row { display: flex; justify-content: space-between; font-size: .62rem; color: var(--text-3); margin-top: 6px; margin-bottom: 3px; padding-right: 30px; }
.dash-att-bar-bg { height: 10px; background: var(--surface-2); border-radius: 5px; overflow: hidden; margin-right: 30px; }
.dash-att-bar-fill { height: 100%; border-radius: 5px; transition: width .65s cubic-bezier(.4,0,.2,1); }
.st-srow { padding: 9px 13px; border-bottom: 1px solid var(--border); }
.st-srow:last-child { border-bottom: none; }
.st-srow-top { display: flex; align-items: center; gap: 9px; margin-bottom: 5px; }
.st-export-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; padding: 10px 13px; border-top: 1px solid var(--border); background: rgba(0,0,0,.2); }

/* ═══ CHARTS ═══ */
canvas { max-width: 100%; height: auto; }
#st-pie { height: 170px !important; }
#st-bar { height: 170px !important; }
#st-line { height: 120px !important; }
@media (min-width: 900px) {
  #st-pie, #st-bar { height: 150px !important; }
  #st-line { height: 100px !important; }
  #page-stats .dash-chart-card { padding: 10px 13px; }
}

/* ═══ CHARTS MANUAL ═══ */
.pie-wrap { position: relative; width: 120px; height: 120px; margin: 0 auto 8px; }
.pie-legend { display: flex; flex-direction: column; gap: 4px; font-size: .7rem; }
.pie-legend-item { display: flex; align-items: center; gap: 5px; color: var(--text-2); }
.pie-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* ═══ SMS ═══ */
.sms-row { display: flex; align-items: flex-start; padding: 9px 13px; border-bottom: 1px solid var(--border); gap: 9px; background: var(--surface); }
.sms-row:last-child { border-bottom: none; }
.sms-chk { width: 17px; height: 17px; accent-color: var(--blue); cursor: pointer; flex-shrink: 0; margin-top: 2px; }
.sms-tag { font-size: .64rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
.tn { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }
.ts { background: var(--yellow-bg); color: var(--yellow); border: 1px solid var(--yellow-border); }
.tu { background: var(--blue-l); color: var(--blue); border: 1px solid rgba(99,102,241,.25); }

/* ═══ SETTINGS ═══ */
.set-s { margin-bottom: 14px; }
.set-t {
  font-size: .66rem; font-weight: 800; color: var(--text-3);
  text-transform: uppercase; letter-spacing: .5px;
  margin-bottom: 7px; padding: 0 2px;
  display: flex; align-items: center; gap: 8px;
}
.set-t::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, var(--border-2), transparent); }
.srow2 {
  display: flex; align-items: center; justify-content: space-between;
  padding: 11px 14px; background: var(--surface); border-bottom: 1px solid var(--border);
}
.srow2:first-child { border-radius: var(--r) var(--r) 0 0; }
.srow2:last-child { border-bottom: none; border-radius: 0 0 var(--r) var(--r); }
.srow2:only-child { border-radius: var(--r); }

/* ═══ TEACHER CARDS ═══ */
.tcrd {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--rl); margin-bottom: 9px; overflow: hidden;
  transition: border-color .2s;
}
.tcrd:hover { border-color: var(--border-2); }
.tcrd-top { padding: 12px 14px; display: flex; align-items: center; gap: 10px; }
.t-ava {
  width: 40px; height: 40px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: .88rem; color: #fff; flex-shrink: 0;
}
.t-name { font-weight: 700; font-size: .87rem; color: var(--text); }
.t-sub { font-size: .7rem; color: var(--text-3); margin-top: 2px; }
.t-badge { display: inline-block; padding: 2px 7px; border-radius: 20px; font-size: .64rem; font-weight: 700; }
.perm-toggle { display: flex; flex-wrap: wrap; gap: 5px; padding: 9px 13px; border-top: 1px solid var(--border); }
.perm-chip {
  padding: 5px 11px; border-radius: 20px; font-size: .71rem; font-weight: 600;
  cursor: pointer; border: 1px solid var(--border-2); background: var(--surface-2);
  color: var(--text-3); transition: all .18s; user-select: none;
}
.perm-chip:hover { border-color: var(--border-3); color: var(--text-2); }
.perm-chip.on { background: var(--blue-l); border-color: rgba(99,102,241,.35); color: #a5b4fc; }
.perm-chip.off { background: var(--red-bg); border-color: var(--red-border); color: var(--red); }

/* ═══ GROUP ASSIGN ═══ */
.g-assign { display: flex; flex-wrap: wrap; gap: 5px; padding: 9px 13px; border-top: 1px solid var(--border); }
.g-chip {
  padding: 4px 10px; border-radius: 20px; font-size: .69rem; font-weight: 600;
  cursor: pointer; border: 1px solid var(--border-2); background: var(--surface-2);
  color: var(--text-3); transition: all .18s; user-select: none;
}
.g-chip.on { background: var(--green-bg); border-color: var(--green-border); color: var(--green); }

/* ═══ SHIFTS ═══ */
.sh-tabs { display: flex; gap: 7px; margin-bottom: 10px; }
.sh-tab {
  flex: 1; padding: 8px; text-align: center; border-radius: 10px;
  font-size: .75rem; font-weight: 700; cursor: pointer;
  border: 1px solid var(--border-2); background: var(--surface-2);
  transition: all .18s; color: var(--text-3);
}
.sh-tab.s1.active { border-color: rgba(99,102,241,.4); color: #a5b4fc; background: var(--blue-l); }
.sh-tab.s2.active { border-color: rgba(251,146,60,.35); color: var(--orange); background: rgba(251,146,60,.08); }

/* ═══ SCHEDULE ═══ */
.schedule-section { background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--r); padding: 11px; margin: 9px 0; }
.schedule-title { font-size: .71rem; font-weight: 700; color: var(--text-3); text-transform: uppercase; margin-bottom: 9px; display: flex; align-items: center; gap: 6px; letter-spacing: .3px; }
.day-row { display: flex; align-items: center; gap: 9px; padding: 7px 9px; background: var(--surface); border-radius: 9px; margin-bottom: 5px; border: 1px solid var(--border); }
.day-row:last-child { margin-bottom: 0; }
.day-name { width: 88px; font-size: .74rem; font-weight: 600; color: var(--text-2); flex-shrink: 0; }
.day-toggle { width: 38px; height: 21px; background: var(--surface-3); border-radius: 11px; position: relative; cursor: pointer; transition: background .2s; flex-shrink: 0; }
.day-toggle.on { background: var(--green); }
.day-toggle::after { content: ''; position: absolute; width: 17px; height: 17px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: left .2s; box-shadow: 0 1px 3px rgba(0,0,0,.3); }
.day-toggle.on::after { left: 19px; }
.day-lessons { flex: 1; display: flex; flex-wrap: wrap; gap: 4px; }
.day-lesson-chip { padding: 3px 8px; border-radius: 12px; font-size: .64rem; font-weight: 600; cursor: pointer; border: 1px solid var(--border-2); background: var(--surface-2); color: var(--text-3); transition: all .15s; }
.day-lesson-chip.on { background: var(--blue-l); border-color: rgba(99,102,241,.3); color: #a5b4fc; }

.date-schedule-section { background: rgba(251,191,36,.06); border: 1px solid var(--yellow-border); border-radius: var(--r); padding: 11px; margin: 9px 0; }
.date-schedule-title { font-size: .71rem; font-weight: 700; color: var(--yellow); text-transform: uppercase; margin-bottom: 9px; display: flex; align-items: center; gap: 6px; }
.date-row { display: flex; align-items: center; gap: 9px; padding: 7px 9px; background: var(--surface); border-radius: 9px; margin-bottom: 5px; border: 1px solid var(--yellow-border); }
.date-input { width: 130px; padding: 5px 9px; border: 1px solid var(--border-2); border-radius: 7px; font-size: .74rem; background: var(--surface-2); color: var(--text); }
.date-lessons { flex: 1; display: flex; flex-wrap: wrap; gap: 4px; }
.date-chip { padding: 3px 8px; border-radius: 12px; font-size: .64rem; font-weight: 600; cursor: pointer; border: 1px solid var(--border-2); background: var(--surface-2); color: var(--text-3); transition: all .15s; }
.date-chip.on { background: var(--yellow-bg); border-color: var(--yellow-border); color: var(--yellow); }
.date-chip.off { opacity: .5; }
.date-del { width: 24px; height: 24px; border-radius: 6px; border: none; background: var(--red-bg); color: var(--red); cursor: pointer; font-size: .8rem; display: flex; align-items: center; justify-content: center; }
.add-date-row { display: flex; gap: 8px; align-items: center; margin-top: 9px; padding-top: 9px; border-top: 1px dashed var(--yellow-border); }

/* ═══ GROUP TABS ═══ */
.group-tabs { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
.group-tab { padding: 6px 13px; border-radius: 9px; font-size: .71rem; font-weight: 600; cursor: pointer; border: 1px solid var(--border-2); background: var(--surface-2); color: var(--text-3); transition: all .18s; }
.group-tab.active { border-color: rgba(99,102,241,.35); color: #a5b4fc; background: var(--blue-l); }

/* ═══ COLLAPSIBLE ═══ */
.collapsible-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 9px; cursor: pointer; margin-bottom: 5px; transition: border-color .18s; }
.collapsible-header:hover { border-color: var(--border-2); }
.collapsible-title { font-size: .77rem; font-weight: 700; color: var(--text-2); }
.collapsible-arrow { font-size: .88rem; transition: transform .2s; color: var(--text-3); }
.collapsible-arrow.open { transform: rotate(180deg); }
.collapsible-content { display: none; padding: 5px 0; }
.collapsible-content.open { display: block; }
.group-schedule-selector { margin-bottom: 10px; }
.group-schedule-select { width: 100%; padding: 8px 11px; border: 1px solid var(--border-2); border-radius: 9px; font-size: .84rem; background: var(--surface-2); color: var(--text); }

/* ═══ SUPABASE CONFIG ═══ */
.imp-z { border: 1px dashed rgba(99,102,241,.3); border-radius: var(--r); padding: 16px; text-align: center; cursor: pointer; background: var(--blue-l); transition: all .18s; color: var(--text-2); }
.imp-z:hover { border-color: rgba(99,102,241,.5); background: var(--blue-m); }

/* ═══ BADGES ═══ */
.bdg { display: inline-block; padding: 2px 7px; border-radius: 20px; font-size: .63rem; font-weight: 700; }
.bdb { background: var(--blue-l); color: #a5b4fc; border: 1px solid rgba(99,102,241,.25); }
.bdo { background: rgba(251,146,60,.12); color: var(--orange); border: 1px solid rgba(251,146,60,.25); }
.tchip { display: inline-block; padding: 2px 5px; border-radius: 4px; font-size: .62rem; font-weight: 700; background: rgba(251,146,60,.1); color: var(--orange); border: 1px solid rgba(251,146,60,.2); margin-left: 3px; }

.sa-badge { display: inline-block; padding: 2px 8px; border-radius: 20px; background: linear-gradient(135deg, rgba(139,92,246,.25), rgba(109,40,217,.2)); color: var(--purple); border: 1px solid rgba(139,92,246,.3); font-size: .64rem; font-weight: 700; margin-left: 4px; }

/* ═══ LESSON CHECKBOXES ═══ */
.lesson-chk-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; padding-left: 20px; }
.lesson-chk-item { display: flex; align-items: center; gap: 4px; font-size: .67rem; background: var(--surface-2); padding: 3px 8px; border-radius: 16px; border: 1px solid var(--border); color: var(--text-2); }
.lesson-chk-item input[type=checkbox] { margin: 0; width: 13px; height: 13px; accent-color: var(--blue); }

/* ═══ EMPTY STATE ═══ */
.empty { text-align: center; padding: 40px 16px; color: var(--text-3); }
.ei { font-size: 2.4rem; margin-bottom: 10px; opacity: .5; }
.et { font-size: .82rem; line-height: 1.6; color: var(--text-3); }

/* ═══ FILTER BAR ═══ */
.filter-bar { display: flex; gap: 7px; flex-wrap: wrap; margin-bottom: 10px; align-items: center; }

/* ═══ TOAST ═══ */
.toast {
  position: fixed; bottom: 24px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: rgba(22,22,40,.95);
  backdrop-filter: blur(16px) saturate(1.5);
  border: 1px solid var(--border-2);
  color: var(--text); padding: 11px 22px; border-radius: 30px;
  font-size: .81rem; font-weight: 600; z-index: 999;
  transition: transform .3s cubic-bezier(.34,1.4,.64,1), opacity .2s;
  white-space: nowrap;
  box-shadow: 0 12px 36px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.06);
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* ═══ SYNC STATUS ═══ */
#sync-status {
  font-size: .64rem; font-weight: 700; padding: 3px 9px;
  border-radius: 16px; cursor: default; transition: all .3s;
  background: var(--glass-2); border: 1px solid var(--border-2); color: var(--text-3);
}

/* ═══ SUPABASE SECTION ═══ */
.sb-section { background: var(--surface-2); border: 1px solid rgba(99,102,241,.2); border-radius: var(--rl); padding: 14px; }

/* ═══ RESPONSIVE ═══ */
@media (max-width: 380px) {
  .dash-sum { grid-template-columns: repeat(2,1fr); }
  .dash-charts { grid-template-columns: 1fr; }
  .dash-chart-card.full { grid-column: auto; }
}

/* ═══ FOCUS ═══ */
:focus-visible { outline: 2px solid rgba(99,102,241,.6); outline-offset: 2px; border-radius: 6px; }

/* ═══ PWA SAFE AREAS ═══ */
@supports (padding: env(safe-area-inset-bottom)) {
  .hdr { padding-top: env(safe-area-inset-top); }
  body { padding-bottom: env(safe-area-inset-bottom); }
  .toast { bottom: calc(24px + env(safe-area-inset-bottom)); }
}

/* ═══ PWA STANDALONE MODE ═══ */
@media (display-mode: standalone) {
  .login-screen { padding-top: env(safe-area-inset-top, 20px); }
  .hdr { padding-top: max(env(safe-area-inset-top, 0px), 0px); }
}

/* Install button hover */
#pwa-install-btn:hover {
  background: linear-gradient(135deg, rgba(99,102,241,.4), rgba(167,139,250,.25)) !important;
  transform: scale(1.04);
}
</style>

<!-- ══ SUPABASE ══ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js">
</script>
<script>
// ── Chart.js Dark Theme Defaults ──
document.addEventListener('DOMContentLoaded', () => {
  if(typeof Chart !== 'undefined') {
    Chart.defaults.color = '#6b6b8a';
    Chart.defaults.borderColor = 'rgba(255,255,255,.06)';
    Chart.defaults.font.family = "'Rubik', sans-serif";
    Chart.defaults.font.size = 10;
    Chart.defaults.plugins.legend.labels.color = '#a8a8c8';
    Chart.defaults.plugins.legend.labels.boxWidth = 10;
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(22,22,40,.95)';
    Chart.defaults.plugins.tooltip.borderColor = 'rgba(255,255,255,.1)';
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    Chart.defaults.plugins.tooltip.titleColor = '#f0f0ff';
    Chart.defaults.plugins.tooltip.bodyColor = '#a8a8c8';
    Chart.defaults.plugins.tooltip.padding = 10;
    Chart.defaults.plugins.tooltip.cornerRadius = 10;
    Chart.defaults.scale.grid.color = 'rgba(255,255,255,.05)';
    Chart.defaults.scale.ticks.color = '#6b6b8a';
  }
});
</script>
<script>
// ┌──────────────────────────────────────────────────────┐
// │  SUPABASE CONFIG — URL ва KEY-ро дар Танзимот ворид  │
// │  кунед, ё ин ҷо иваз кунед                          │
// └──────────────────────────────────────────────────────┘
let SUPABASE_URL = localStorage.getItem('sb_url') || 'https://rqesqppmasqthowvqypb.supabase.co';
let SUPABASE_KEY = localStorage.getItem('sb_key') || 'sb_publishable_Q9SIZ27tEc_EClUAkKP6oA_V7SFn-1T';

let _sb = null;
let _sbReady = false;

function _initSb() {
  try {
    _sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    return true;
  } catch(e) { return false; }
}
_initSb();

function sbConfigured() {
  return !SUPABASE_URL.includes('YOUR_PROJECT') && !SUPABASE_KEY.includes('YOUR_ANON');
}

// ═══════════════════════════════════════════════════════
//  SQL ДАР SUPABASE (1 БОР ИҶРО КУНЕД):
//
//  -- Ҷадвали асосӣ (гурӯҳ, танзимот)
//  CREATE TABLE IF NOT EXISTS davomat_data (
//    key TEXT PRIMARY KEY,
//    value JSONB,
//    updated_at TIMESTAMPTZ DEFAULT NOW()
//  );
//
//  -- Ҷадвали давомот (ҳар ячейка = 1 сатр)
//  CREATE TABLE IF NOT EXISTS davomat_att (
//    id TEXT PRIMARY KEY,      -- gid:sid:date:lid
//    gid TEXT NOT NULL,
//    sid TEXT NOT NULL,
//    att_date TEXT NOT NULL,   -- YYYY-MM-DD
//    lid TEXT NOT NULL,
//    status JSONB,             -- {st, by, byName, subject, at}
//    updated_at TIMESTAMPTZ DEFAULT NOW()
//  );
//  CREATE INDEX ON davomat_att(gid);
//  CREATE INDEX ON davomat_att(att_date);
//
//  -- Иҷозат
//  ALTER TABLE davomat_data ENABLE ROW LEVEL SECURITY;
//  ALTER TABLE davomat_att  ENABLE ROW LEVEL SECURITY;
//  CREATE POLICY "all" ON davomat_data FOR ALL USING (true) WITH CHECK (true);
//  CREATE POLICY "all" ON davomat_att  FOR ALL USING (true) WITH CHECK (true);
// ═══════════════════════════════════════════════════════

// ── Generic key-value (groups, settings) ──────────────
async function sbGet(key) {
  if (!sbConfigured() || !_sb) return null;
  try {
    const { data, error } = await _sb.from('davomat_data').select('value').eq('key', key).single();
    if (error || !data) return null;
    return data.value;
  } catch(e) { return null; }
}

async function sbSet(key, value) {
  if (!sbConfigured() || !_sb) return false;
  try {
    const { error } = await _sb.from('davomat_data')
      .upsert({ key, value, updated_at: new Date().toISOString() }, { onConflict: 'key' });
    if (error) console.warn('sbSet error:', error.message);
    return !error;
  } catch(e) { return false; }
}

// ── GRANULAR ATTENDANCE SAVE ───────────────────────────
// Ҳар ячейка = 1 сатр → 2 омӯзгор яквақт тағйир диҳанд, конфликт нест!
async function sbSetAtt(gid, attKey, status) {
  if (!sbConfigured() || !_sb) return false;
  // attKey format: sid_YYYY-MM-DD_lid
  const parts = attKey.split('_');
  const sid = parts[0];
  const att_date = parts[1];
  const lid = parts.slice(2).join('_');
  const id = `${gid}:${attKey}`;
  try {
    if (status === null) {
      // Delete (present = no record)
      await _sb.from('davomat_att').delete().eq('id', id);
    } else {
      await _sb.from('davomat_att').upsert({
        id, gid, sid, att_date, lid,
        status,
        updated_at: new Date().toISOString()
      }, { onConflict: 'id' });
    }
    return true;
  } catch(e) { console.warn('sbSetAtt error:', e); return false; }
}

// ── Load all attendance for a group from Supabase ──────
async function sbLoadAtt(gid) {
  if (!sbConfigured() || !_sb) return null;
  try {
    const { data, error } = await _sb.from('davomat_att')
      .select('id,status').eq('gid', gid);
    if (error || !data) return null;
    const result = {};
    data.forEach(row => {
      // id = gid:sid_date_lid → extract attKey
      const attKey = row.id.slice(gid.length + 1);
      result[attKey] = row.status;
    });
    return result;
  } catch(e) { return null; }
}

// ── Load ALL attendance (for admin full view) ──────────
async function sbLoadAllAtt() {
  if (!sbConfigured() || !_sb) return false;
  try {
    const { data, error } = await _sb.from('davomat_att').select('id,gid,status');
    if (error || !data) return false;
    db.attendance = {};
    data.forEach(row => {
      const attKey = row.id.slice(row.gid.length + 1);
      if (!db.attendance[row.gid]) db.attendance[row.gid] = {};
      db.attendance[row.gid][attKey] = row.status;
    });
    return true;
  } catch(e) { return false; }
}

// ── Load from Supabase (startup) ───────────────────────
async function lDBCloud() {
  if (!sbConfigured()) return false;
  try {
    const [groups, settings] = await Promise.all([sbGet('groups'), sbGet('settings')]);
    let loaded = false;
    if (groups !== null)  { db.groups = groups; loaded = true; }
    if (settings !== null){ db.settings = { ...db.settings, ...settings }; loaded = true; }
    // Load all attendance
    const attOk = await sbLoadAllAtt();
    if (attOk) loaded = true;
    if (loaded) {
      localStorage.setItem('dav7', JSON.stringify(db));
      _sbReady = true;
      return true;
    }
  } catch(e) { console.warn('lDBCloud failed:', e); }
  _sbReady = false;
  return false;
}

// ── svCloud: save groups+settings to kv, attendance already saved per-cell ──
async function svCloud() {
  localStorage.setItem('dav7', JSON.stringify(db));
  if (!sbConfigured() || !_sb) return;
  Promise.all([
    sbSet('groups', db.groups),
    sbSet('settings', db.settings)
  ]).catch(e => console.warn('Cloud sync error:', e));
}

// ── Realtime: listen for attendance changes from other devices ──
let _rtChannel = null;
function startRealtimeSync() {
  if (!sbConfigured() || !_sb) return;
  // Disconnect old channel if exists
  if (_rtChannel) { try { _sb.removeChannel(_rtChannel); } catch(e){} }

  _rtChannel = _sb.channel('davomat-live-' + Date.now())
    .on('postgres_changes', {
      event: '*', schema: 'public', table: 'davomat_att'
    }, (payload) => {
      const row = payload.new || payload.old;
      if (!row) return;
      const gid = row.gid;
      // attKey = everything after "gid:" prefix
      const attKey = row.id?.slice(gid?.length + 1);
      if (!gid || !attKey) return;

      // Update in-memory db
      if (!db.attendance[gid]) db.attendance[gid] = {};
      if (payload.eventType === 'DELETE' || !row.status) {
        delete db.attendance[gid][attKey];
      } else {
        db.attendance[gid][attKey] = row.status;
      }
      localStorage.setItem('dav7', JSON.stringify(db));

      // Show sync indicator flash
      updateSyncStatus('online');
      showSyncFlash(gid, row.status);

      // Refresh UI — works for Admin (any gid) and teacher (their gid)
      if (typeof attGid !== 'undefined' && attGid === gid) {
        renderAttT?.();
      }
      // If admin is on groups page, show live update badge on group card
      refreshGroupBadge?.(gid);
    })
    .on('postgres_changes', {
      event: '*', schema: 'public', table: 'davomat_data'
    }, (payload) => {
      const key = payload.new?.key;
      const val = payload.new?.value;
      if (!key || !val) return;
      if (key === 'groups')  { db.groups = val; renderGroups?.(); }
      if (key === 'settings'){ db.settings = { ...db.settings, ...val }; }
      localStorage.setItem('dav7', JSON.stringify(db));
    })
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        updateSyncStatus('online');
        console.log('✅ Realtime connected');
      } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
        updateSyncStatus('offline');
        // Reconnect after 5s
        setTimeout(startRealtimeSync, 5000);
      }
    });
}

// ── Visual flash when another device updates ──
function showSyncFlash(gid, status) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  const prev = el.textContent;
  el.textContent = '⚡';
  el.style.color = '#8b5cf6';
  setTimeout(() => { el.textContent = '☁️'; el.style.color = '#10b981'; }, 800);
}

// ── Refresh group card badge (live update count for admin) ──
function refreshGroupBadge(gid) {
  // If admin is viewing groups page, update student count badge
  const curPage = document.querySelector('.page[style*="block"]')?.id;
  if (curPage === 'page-groups') {
    // Just re-render — it's fast
    renderGroups?.();
  }
}

// ── Connection status indicator ──
function updateSyncStatus(status) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  if (status === 'online') {
    el.textContent = '☁️ Online';
    el.style.background = 'rgba(16,185,129,.22)';
    el.style.borderColor = 'rgba(16,185,129,.4)';
    el.style.color = '#6ee7b7';
    el.title = 'Supabase пайваст — realtime sync';
  } else if (status === 'offline') {
    el.textContent = '💾 Offline';
    el.style.background = 'rgba(239,68,68,.18)';
    el.style.borderColor = 'rgba(239,68,68,.35)';
    el.style.color = '#fca5a5';
    el.title = 'Офлайн — localStorage';
  } else if (status === 'syncing') {
    el.textContent = '🔄 Синк';
    el.style.background = 'rgba(245,158,11,.18)';
    el.style.borderColor = 'rgba(245,158,11,.35)';
    el.style.color = '#fde68a';
    el.title = 'Синхронизатсия...';
  }
}

</script>
</head>
<body style="scroll-behavior:smooth">

<!-- ══ LOGIN ══ -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-icon">📋</div>
    </div>
    <div class="login-title">Давомот</div>
    <div class="login-sub">
      Системаи ҳисобгирии давомоти донишҷӯён<br>
      <span style="font-size:.68rem;opacity:.6">SubAdmin Edition — 2025</span>
    </div>
    <div style="margin-bottom:18px"></div>
    <div class="login-err" id="login-err">
      <span>⚠️</span> <span id="login-err-text">Рамз нодуруст!</span>
    </div>
    <div class="fg" style="margin-bottom:12px">
      <label class="fl" style="font-weight:800;color:var(--text-3);font-size:.7rem;letter-spacing:.4px;margin-bottom:7px;text-transform:uppercase">👤 ВОРИД ШАВЕД ҲАМЧУН</label>
      <div style="position:relative;margin-bottom:7px">
        <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:.88rem;pointer-events:none;color:#94a3b8">🔍</span>
        <input class="fc" id="login-search" placeholder="Ном ё ID-и омӯзгорро нависед..."
          oninput="filterLoginList(this.value)"
          style="padding-left:34px;font-size:.83rem;border-radius:10px">
      </div>
      <select class="fc" id="login-who" onchange="onLoginWhoChange()" style="border-radius:10px;font-weight:600">
        <option value="admin">👑 Администратор</option>
      </select>
    </div>

    <div class="fg" id="login-subject-wrap" style="display:none;margin-bottom:12px">
      <label class="fl" style="font-weight:800;color:var(--text-3);font-size:.7rem;letter-spacing:.4px;margin-bottom:7px;text-transform:uppercase">📚 ФАН</label>
      <select class="fc" id="login-subject" style="border-radius:10px;font-weight:600"></select>
    </div>

    <div class="fg" style="margin-bottom:14px">
      <label class="fl" style="font-weight:800;color:var(--text-3);font-size:.7rem;letter-spacing:.4px;margin-bottom:7px;text-transform:uppercase">🔐 РАМЗ (ПАРОЛЬ)</label>
      <input class="fc" type="password" id="login-pass" placeholder="Рамзро ворид кунед" onkeydown="if(event.key==='Enter')doLogin()" style="border-radius:10px">
    </div>
    <button class="btn bb bblk" style="margin-top:2px;padding:12px;font-size:.85rem;border-radius:12px;letter-spacing:.3px;font-weight:700" onclick="doLogin()">🔐 ВОРИДШАВӢ</button>

    <div style="text-align:center;margin-top:18px;font-size:.64rem;color:var(--text-4);display:flex;align-items:center;justify-content:center;gap:8px">
      <span style="display:inline-block;width:24px;height:1px;background:var(--border-2)"></span>
      Давомот © 2025
      <span style="display:inline-block;width:24px;height:1px;background:var(--border-2)"></span>
    </div>
  </div>
</div>

<!-- ══ HEADER ══ -->
<header class="hdr" id="main-hdr" style="display:none">
  <div class="hdr-top">
    <div class="hdr-brand" style="gap:10px">
      <div class="hdr-logo" style="width:38px;height:38px;border-radius:12px;font-size:1.1rem;border:1px solid rgba(255,255,255,.2)">📋</div>
      <div>
        <div class="hdr-title" style="font-size:1.08rem;font-weight:900;letter-spacing:-.3px">Давомот</div>
        <div class="hdr-sub" id="hdr-sub" style="font-size:.59rem;opacity:.65;letter-spacing:.2px">Системаи давомот</div>
      </div>
    </div>
    <div class="hdr-user" style="gap:7px">
      <button id="pwa-install-btn" onclick="pwaInstall()" title="Ба телефон насб кун" style="display:none;align-items:center;gap:4px;background:rgba(99,102,241,.25);border:1px solid rgba(99,102,241,.4);border-radius:14px;color:#a5b4fc;font-size:.62rem;font-weight:700;padding:4px 9px;cursor:pointer;white-space:nowrap;transition:all .18s">
        📲 Насб
      </button>
      <div id="sync-status" title="Ҳолати пайвастшавӣ" style="font-size:.65rem;padding:3px 8px;border-radius:16px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);cursor:default;transition:all .3s;font-weight:700;letter-spacing:.1px">⏳</div>
      <span id="hdr-uname" style="font-size:.75rem;font-weight:700;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;opacity:.92"></span>
      <div class="hdr-avatar" onclick="doLogout()" title="Хориҷ" style="width:32px;height:32px;font-size:.85rem;border-radius:10px;border:1.5px solid rgba(255,255,255,.25)">🚪</div>
    </div>
  </div>
  <div class="nav" id="main-nav"></div>
</header>

<!-- ══ PAGES ══ -->
<div id="page-groups" class="page" style="display:none">
  <div id="v-gl">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:9px">
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:.94rem;color:#1e3a8a">📁 Гурӯҳҳо</div>
      <div style="display:flex;gap:5px" id="grp-admin-btns"></div>
    </div>
    
    <div style="position:relative;margin-bottom:9px">
      <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:.92rem;pointer-events:none;color:var(--muted)">🔎</span>
      <input class="fc" id="g-search" placeholder="Гурӯҳро ёбед (ном / рақам / ID)..." oninput="groupSearch=this.value;renderGroups()" style="padding-left:36px">
    </div>

    <div id="gl-c"></div>
  </div>
  <div id="v-gd" style="display:none">
    <div style="display:flex;align-items:center;gap:7px;margin-bottom:9px">
      <button class="btn bgh bsm" onclick="backG()">← Бозгашт</button>
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:.94rem;flex:1" id="gd-t"></div>
    </div>
    <div class="card">
      <div class="card-h"><div class="ctitle">👤 Донишҷӯён</div>
        <div style="display:flex;gap:5px">
          <button class="btn bb bsm" onclick="openAddS()">＋ Илова</button>
          <button class="btn bgh bsm" onclick="openImp()">📥 Импорт</button>
        </div>
      </div>
      <div id="s-c"></div>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button class="btn bg bsm" onclick="expSXls()">📤 Excel</button>
      <button class="btn bgh bsm" onclick="expSTxt()">📄 Текст</button>
    </div>
  </div>
</div>

<div id="page-attendance" class="page" style="display:none">
  <div id="att-ng" class="empty"><div class="ei">📋</div><div class="et">Аввал гурӯҳро интихоб кунед</div></div>
  <div id="att-main" style="display:none">
    <div style="display:flex;align-items:center;gap:7px;margin-bottom:8px">
      <button class="btn bgh bsm" onclick="attBack()">← Гурӯҳ</button>
      <div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:.9rem;color:#1e3a8a;flex:1" id="att-gl"></div>
    </div>
    <!-- Teacher: subject selector inside attendance (no re-login needed) -->
    <div id="att-subj-tabs" style="display:none;margin-bottom:8px;overflow-x:auto">
      <div id="att-subj-tabs-inner" style="display:flex;gap:6px;padding:2px 0;min-width:max-content"></div>
    </div>
    <div class="vt">
      <div class="vtb active" id="vt-d" onclick="setVM('day')">📅 Як рӯз</div>
      <div class="vtb" id="vt-m" onclick="setVM('month')">📆 Як моҳ</div>
      <div class="vtb" id="vt-r" onclick="setVM('range')">📊 Диапазон</div>
    </div>
    <div id="cd"><div class="dbar" id="day-nav-bar">
      <button class="dn" id="dn-prev" onclick="dSh(-1)">‹</button><div class="dl" id="d-lbl"></div><button class="dn" id="dn-next" onclick="dSh(1)">›</button>
      <input type="date" id="d-pick" class="fc" style="width:auto;padding:5px 8px;font-size:.74rem" onchange="onDP()">
    </div></div>
    <div id="cm" style="display:none">
      <div class="dbar">
        <button class="dn" onclick="mSh(-1)">‹</button><div class="dl" id="m-lbl"></div><button class="dn" onclick="mSh(1)">›</button>
      </div>
      <div id="month-view-badge" style="display:none;text-align:center;font-size:.72rem;background:#fef9c3;color:#854d0e;padding:4px 10px;border-radius:8px;margin:4px 0">
        👁 Танҳо дидан — ин моҳ тағйир дода намешавад
      </div>
    </div>
    <div id="cr" style="display:none">
      <div class="dbar" style="gap:8px;flex-wrap:wrap;justify-content:center">
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span style="font-size:.72rem;font-weight:700;color:var(--muted)">Аз</span>
          <input type="date" id="r-from" class="fc" style="width:auto;padding:5px 8px;font-size:.74rem">
          <span style="font-size:.72rem;font-weight:700;color:var(--muted)">То</span>
          <input type="date" id="r-to" class="fc" style="width:auto;padding:5px 8px;font-size:.74rem">
          <button class="btn bb bsm" onclick="onRangeApply()">Намоиш</button>
        </div>
        <div id="range-view-badge" style="display:none;font-size:.72rem;background:#fef9c3;color:#854d0e;padding:4px 10px;border-radius:8px">
          👁 Танҳо дидан — диапазон тағйир дода намешавад
        </div>
      </div>
    
    </div>
    <div class="card" style="padding:0"><div class="att-wrap"><table class="att-table" id="att-t"></table></div></div>
    <div class="card" style="padding:9px 12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:.72rem;margin-bottom:7px">
        <span><span class="ac ca" style="display:inline-flex;width:19px;height:17px">Н</span> Набуд</span>
        <span><span class="ac cs" style="display:inline-flex;width:19px;height:17px">Б</span> Бемор</span>
        <span><span class="ac cu" style="display:inline-flex;width:19px;height:17px">У</span> Узр</span>
        <span><span class="ac ce" style="display:inline-flex;width:19px;height:17px">—</span> Ҳозир</span>
      </div>
      <button class="btn bgh bsm" onclick="refreshAttFromCloud()" id="att-refresh-btn" title="Маълумотро аз Cloud нав кун">🔄</button><button class="btn bg bsm" onclick="expAtt()">📤 Excel</button>
    </div>
  </div>
</div>

<div id="page-sms" class="page" style="display:none">
  <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:.94rem;color:#1e3a8a;margin-bottom:9px">📨 SMS — Рӯйхати ғоибон</div>
  <div class="card" style="padding:11px">
    <div class="seg" style="margin-bottom:9px" id="sms-shift-seg">
      <div class="seg-b active" onclick="setSmsShift(0)">🌐 Ҳама</div>
      <div class="seg-b s1" onclick="setSmsShift(1)">🌅 Баст 1</div>
      <div class="seg-b s2" onclick="setSmsShift(2)">🌆 Баст 2</div>
    </div>
    <div class="fr" style="flex-wrap:wrap;gap:7px;margin-bottom:0">
      <div class="fg" style="min-width:120px"><label class="fl">Гурӯҳ</label><select class="fc" id="sms-gid" onchange="renderSMS()"><option value="">— Ҳама —</option></select></div>
      <div class="fg"><label class="fl">Режим</label><select class="fc" id="sms-mode" onchange="renderSMSCtrl()"><option value="day">Як рӯз</option><option value="month">Як моҳ</option></select></div>
      <div id="sms-dc" style="display:flex;align-items:flex-end;gap:4px">
        <button class="dn" onclick="smsDSh(-1)">‹</button><div class="dl" id="sms-dl" style="min-width:85px;font-size:.8rem"></div><button class="dn" onclick="smsDSh(1)">›</button>
        <input type="date" id="sms-dp" class="fc" style="width:auto;padding:4px 7px;font-size:.71rem" onchange="onSmsDP()">
      </div>
      <div id="sms-mc" style="display:none;align-items:flex-end;gap:4px">
        <button class="dn" onclick="smsMS(-1)">‹</button><div class="dl" id="sms-ml" style="min-width:85px;font-size:.8rem"></div><button class="dn" onclick="smsMS(1)">›</button>
      </div>
    </div>
  </div>
  <div class="card" style="padding:0">
    <div class="card-h"><div class="ctitle">Ғоибон</div>
      <div style="display:flex;gap:5px">
        <button class="btn bgh bsm" onclick="selAll(true)">✔ Ҳама</button>
        <button class="btn bgh bsm" onclick="selAll(false)">✘ Ҳеч</button>
      </div>
    </div>
    <div id="sms-list"></div>
  </div>
  <button class="btn bg bsm" onclick="expSMSXls()">📤 Экспорт Excel (А=Ном, В=Тел)</button>
</div>

<div id="page-stats" class="page" style="display:none">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:9px">
  <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:.94rem;color:#1e3a8a">
    📊 Статистика
  </div>
  <div style="display:flex;gap:5px">
    <button class="btn bgh bxs" onclick="scaleStats(0.85)">−</button>
    <button class="btn bgh bxs" onclick="scaleStats(1)">100%</button>
    <button class="btn bgh bxs" onclick="scaleStats(1.1)">+</button>
  </div>
</div>
  <div class="seg" id="st-shift-seg">
    <div class="seg-b active" onclick="setStShift(0)">🌐 Ҳама</div>
    <div class="seg-b s1" onclick="setStShift(1)">🌅 Баст 1</div>
    <div class="seg-b s2" onclick="setStShift(2)">🌆 Баст 2</div>
  </div>
  <div class="card" style="padding:11px">
    <div class="fr" style="flex-wrap:wrap;gap:7px;margin-bottom:0">
      <div class="fg" style="min-width:120px"><label class="fl">Гурӯҳ</label><select class="fc" id="st-gid" onchange="onStGid()"><option value="">— Ҳама гурӯҳ —</option></select></div>
      <div class="fg"><label class="fl">Давра</label><select class="fc" id="st-mode" onchange="updStCtrl()">
        <option value="all">Ҳама вақт</option>
        <option value="month" selected>📆 Як моҳ</option>
        <option value="day">📅 Як рӯз</option>
        <option value="range">📊 Диапазон</option>
      </select></div>
      <div id="st-mc" style="display:flex;align-items:flex-end;gap:4px">
        <button class="dn" onclick="stMS(-1)">‹</button><span id="st-ml" style="font-size:.78rem;font-weight:700"></span><button class="dn" onclick="stMS(1)">›</button>
      </div>
      <div id="st-dc" style="display:none;align-items:flex-end;gap:4px">
        <button class="dn" onclick="stDS(-1)">‹</button><span id="st-dl" style="font-size:.78rem;font-weight:700"></span><button class="dn" onclick="stDS(1)">›</button>
        <input type="date" id="st-dp" class="fc" style="width:auto;padding:4px 7px;font-size:.71rem" onchange="onStDP()">
      </div>
      <div id="st-rc" style="display:none;align-items:flex-end;gap:5px;flex-wrap:wrap">
        <span style="font-size:.7rem;font-weight:700;color:var(--muted)">Аз</span>
        <input type="date" id="st-rf" class="fc" style="width:auto;padding:4px 7px;font-size:.71rem">
        <span style="font-size:.7rem;font-weight:700;color:var(--muted)">То</span>
        <input type="date" id="st-rt" class="fc" style="width:auto;padding:4px 7px;font-size:.71rem">
        <button class="btn bb bsm" onclick="renderStats()">Намоиш</button>
      </div>
    </div>
  </div>
  <!-- Summary boxes -->
  <div class="dash-sum" id="st-sum"></div>
  <!-- Charts -->
  <div class="dash-charts" id="st-charts-wrap">
    <div class="dash-chart-card">
      <div class="dash-chart-title">🥧 Фоизи ғоибӣ</div>
      <canvas id="st-pie" height="160"></canvas>
    </div>
    <div class="dash-chart-card">
      <div class="dash-chart-title">📊 Гурӯҳ муқоиса</div>
      <canvas id="st-bar" height="160"></canvas>
    </div>
    <div class="dash-chart-card full" id="st-line-wrap">
      <div class="dash-chart-title">📈 Тренд ғоибӣ (рӯзона)</div>
      <canvas id="st-line" height="90"></canvas>
    </div>
  </div>
  <!-- Group dashboard cards -->
  <div class="dash-grp-grid" id="st-grp-grid"></div>
  <!-- Student detail (shown when group card clicked) -->
  <div class="card" id="st-det-card" style="display:none">
    <div class="card-h">
      <div class="ctitle" id="st-det-title">👤 Ҳар донишҷӯ</div>
      <button class="btn bgh bsm" onclick="stGid='';document.getElementById('st-gid').value='';document.getElementById('st-det-card').style.display='none'">← Бозгашт</button>
    </div>
    <div id="st-det"></div>
    <div class="st-export-row">
      <button class="btn bg bsm" onclick="expStatsXls()">📥 Excel экспорт</button>
      <span id="st-exp-hint" style="font-size:.7rem;color:var(--muted)"></span>
    </div>
  </div>
  <!-- compat -->
  <div id="st-groups-card" style="display:none"><div id="st-groups-list"></div></div>
  <div id="st-charts" style="display:none"></div>
</div>

<div id="page-settings" class="page" style="display:none">
  <!-- PWA Install Section -->
  <div class="set-s">
    <div class="set-t">📲 Барнома ба телефон</div>
    <div style="background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(167,139,250,.07));border:1px solid rgba(99,102,241,.25);border-radius:var(--rl);padding:16px 15px;display:flex;align-items:center;gap:13px">
      <div style="width:52px;height:52px;background:linear-gradient(135deg,rgba(99,102,241,.3),rgba(167,139,250,.2));border:1px solid rgba(99,102,241,.3);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0">📋</div>
      <div style="flex:1">
        <div style="font-weight:800;font-size:.88rem;color:var(--text);margin-bottom:3px">Давомот PWA</div>
        <div style="font-size:.72rem;color:var(--text-3);line-height:1.5;margin-bottom:10px">Барномаро ба экрани асосии телефон насб кунед — офлайн кор мекунад, мисли app аст!</div>
        <button onclick="pwaInstall()" style="display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;border:none;border-radius:10px;padding:8px 16px;font-size:.78rem;font-weight:700;cursor:pointer;box-shadow:0 3px 12px rgba(99,102,241,.4);transition:all .2s">
          📲 Ба телефон насб кун
        </button>
        <div id="pwa-status-text" style="font-size:.68rem;color:var(--text-3);margin-top:8px;line-height:1.4">
          💡 Chrome: Меню (⋮) → "Ба экран илова" нишон медиҳад
        </div>
      </div>
    </div>
  </div>

  <div class="set-s"><div class="set-t">Маълумоти умумӣ</div>
    <div class="card" style="padding:12px">
      <div class="fg"><label class="fl">Номи муассиса</label><input class="fc" id="s-inst" placeholder="Коллеҷ" oninput="saveSets()"></div>
      <div class="fg" style="margin-bottom:0"><label class="fl">Муаллим (роҳбар)</label><input class="fc" id="s-tchr" placeholder="Ному насаб" oninput="saveSets()"></div>
    </div>
  </div>
  <div class="set-s"><div class="set-t">🔐 Рамзи администратор</div>
    <div class="card" style="padding:12px">
      <div class="fg"><label class="fl">Рамзи нав</label><input class="fc" type="password" id="s-newpw" placeholder="Рамзи нав"></div>
      <button class="btn bb bsm" onclick="changeAdminPw()">Тағйир додан</button>
    </div>
  </div>

  <div class="set-s"><div class="set-t">🛡️ Суб-Администраторон</div>
    <div style="font-size:.73rem;color:var(--muted);margin-bottom:7px;line-height:1.5;padding:0 3px">
      Суб-Админ мисли Admin маълумотро мебинад — аммо танҳо саҳифаҳое ки шумо ичозат додаед.
    </div>
    <div id="sa-list"></div>
    <button class="btn bb bsm" style="margin-top:8px;width:100%" onclick="openModal('m-addsa')">＋ Суб-Админ илова</button>
  </div>
  <div class="set-s"><div class="set-t">⏰ Бастҳо ва дарсҳо</div>
    <div class="sh-tabs">
      <div class="sh-tab s1 active" id="sh-t1" onclick="setShTab(1)">🌅 Баст 1 (Субҳ)</div>
      <div class="sh-tab s2" id="sh-t2" onclick="setShTab(2)">🌆 Баст 2 (Бегоҳ)</div>
    </div>
    <div id="sh-lessons"></div>
    <button class="btn bb bsm" style="margin-top:7px" onclick="addLesson()">＋ Дарс илова</button>
  </div>
  <div class="set-s"><div class="set-t">👨‍🏫 Омӯзгорон</div>
    <div style="position:relative;margin-bottom:9px">
      <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:.92rem;pointer-events:none;color:var(--muted)">🔍</span>
      <input class="fc" id="t-search" placeholder="Омӯзгорро ёбед..." oninput="teacherSearch=this.value;renderTeachers()" style="padding-left:36px">
    </div>
    <div id="t-list"></div>
    <button class="btn bb bsm" style="margin-top:9px;width:100%" onclick="openModal('m-addt')">＋ Омӯзгор илова</button>
  </div>
  <div class="set-s"><div class="set-t">☁️ Supabase Cloud Sync</div>
  <div class="card" style="padding:12px">
    <div style="font-size:.75rem;color:var(--muted);margin-bottom:10px;line-height:1.5">
      Барои пайваст кардан бо Supabase, URL ва API Key-ро аз <b>supabase.com → Settings → API</b> гиред.<br>
      Пеш аз пайваст, дар <b>SQL Editor</b> ин SQL-ро иҷро кунед:
    </div>
    <div onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" 
      style="cursor:pointer;font-size:.73rem;color:var(--blue);font-weight:700;margin-bottom:6px">📋 SQL ▼</div>
    <pre id="sb-sql" style="display:none;background:#1e293b;color:#7dd3fc;padding:10px;border-radius:8px;font-size:.65rem;overflow-x:auto;line-height:1.6;white-space:pre-wrap;margin-bottom:8px">-- Ҷадвали 1: гурӯҳ ва танзимот
CREATE TABLE IF NOT EXISTS davomat_data (
  key TEXT PRIMARY KEY,
  value JSONB,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ҷадвали 2: давомот (ҳар ячейка = 1 сатр)
CREATE TABLE IF NOT EXISTS davomat_att (
  id TEXT PRIMARY KEY,
  gid TEXT NOT NULL,
  sid TEXT NOT NULL,
  att_date TEXT NOT NULL,
  lid TEXT NOT NULL,
  status JSONB,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_att_gid ON davomat_att(gid);
CREATE INDEX IF NOT EXISTS idx_att_date ON davomat_att(att_date);

-- Иҷозат (RLS)
ALTER TABLE davomat_data ENABLE ROW LEVEL SECURITY;
ALTER TABLE davomat_att  ENABLE ROW LEVEL SECURITY;
DO $$ BEGIN
  CREATE POLICY "all" ON davomat_data FOR ALL USING (true) WITH CHECK (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;
DO $$ BEGIN
  CREATE POLICY "all" ON davomat_att FOR ALL USING (true) WITH CHECK (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

-- Realtime фаъол кунед (агар хато диҳад, аллакай фаъол аст)
DO $$ BEGIN
  ALTER PUBLICATION supabase_realtime ADD TABLE davomat_att;
EXCEPTION WHEN others THEN NULL; END $$;
DO $$ BEGIN
  ALTER PUBLICATION supabase_realtime ADD TABLE davomat_data;
EXCEPTION WHEN others THEN NULL; END $$;</pre>
    <div class="fg"><label class="fl">Project URL</label>
      <input class="fc" id="sb-url" placeholder="https://xxxx.supabase.co" 
        style="font-size:.76rem;font-family:monospace">
    </div>
    <div class="fg"><label class="fl">Anon Key</label>
      <input class="fc" id="sb-key" placeholder="eyJhbGci..." type="password"
        style="font-size:.76rem;font-family:monospace">
    </div>
    <div id="sb-status" style="font-size:.75rem;margin-bottom:8px;padding:6px 10px;border-radius:7px;display:none"></div>
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn bb bsm" onclick="saveSbConfig()">💾 Нигоҳ ва Пайваст</button>
      <button class="btn bgh bsm" onclick="testSbConn()">🔌 Санҷиш</button>
      <button class="btn bgh bsm" onclick="pushToCloud()">⬆️ Боргузории ба Cloud</button>
      <button class="btn bgh bsm" onclick="pullFromCloud()">⬇️ Гирифтан аз Cloud</button>
    </div>
  </div>
</div>

<div class="set-s"><div class="set-t">💾 Backup</div>
    <div class="card" style="padding:11px">
      <div style="display:flex;gap:7px;flex-wrap:wrap">
        <button class="btn bpur bsm" onclick="expJSON()">📤 JSON Backup</button>
        <button class="btn bgh bsm" onclick="document.getElementById('imp-json').click()">📥 JSON Backup</button>
        <input type="file" id="imp-json" accept=".json" style="display:none" onchange="impJSON(event)">
      </div>
      <div style="margin-top:9px"><button class="btn br bsm" onclick="clearAll()">🗑️ Тоза кардан</button></div>
    </div>
  </div>
</div>

<!-- ══ MODALS ══ -->
<div class="overlay" id="m-addg">
  <div class="modal"><div class="mh"></div><div class="mt">➕ Гурӯҳи нав</div>
    <div class="fg"><label class="fl">Номи гурӯҳ</label><input class="fc" id="ng-n" placeholder="Фелдшери-101"></div>
    <div class="fg"><label class="fl">🆔 ID-и гурӯҳ (ихтиёрӣ)</label><input class="fc" id="ng-c" placeholder="101"></div>
    <div class="fg"><label class="fl">Баст</label><select class="fc" id="ng-sh"><option value="1">🌅 Баст 1 — Субҳ</option><option value="2">🌆 Баст 2 — Бегоҳ</option></select></div>
    <div class="mf"><button class="btn bb bblk" onclick="addGroup()">Илова</button><button class="btn bgh" onclick="closeModal('m-addg')">Бекор</button></div>
  </div>
</div>

<div class="overlay" id="m-edg">
  <div class="modal"><div class="mh"></div><div class="mt">✏️ Таҳрири гурӯҳ</div>
    <input type="hidden" id="edg-id">
    <div class="fg"><label class="fl">Номи гурӯҳ</label><input class="fc" id="edg-n" placeholder="Фелдшери-101"></div>
    <div class="fg"><label class="fl">🆔 ID-и гурӯҳ (ихтиёрӣ)</label><input class="fc" id="edg-c" placeholder="101"></div>
    <div class="fg"><label class="fl">Баст</label>
      <select class="fc" id="edg-sh">
        <option value="1">🌅 Баст 1 — Субҳ</option>
        <option value="2">🌆 Баст 2 — Бегоҳ</option>
      </select>
    </div>
    <div class="mf">
      <button class="btn bb bblk" onclick="saveEditGroup()">💾 Нигоҳ</button>
      <button class="btn bgh" onclick="closeModal('m-edg')">Бекор</button>
    </div>
    <div style="margin-top:10px;font-size:.72rem;color:var(--muted);line-height:1.4">
      <div><strong>Эзоҳ:</strong> ID-и дохилӣ тағйир намешавад.</div>
      <div>ID (системавӣ): <span id="edg-sys" style="font-family:monospace"></span></div>
    </div>
  </div>
</div>


<div class="overlay" id="m-adds">
  <div class="modal"><div class="mh"></div><div class="mt">👤 Донишҷӯи нав</div>
    <div class="fr"><div class="fg"><label class="fl">Насаб</label><input class="fc" id="ns-l"></div><div class="fg"><label class="fl">Ном</label><input class="fc" id="ns-f"></div></div>
    <div class="fg"><label class="fl">🆔 ID донишҷӯ</label><input class="fc" id="ns-sid" placeholder="Масалан: 24015"></div>
    <div class="fr"><div class="fg"><label class="fl">Падар</label><input class="fc" id="ns-fa"></div><div class="fg"><label class="fl">Модар</label><input class="fc" id="ns-mo"></div></div>
    <div class="fr"><div class="fg"><label class="fl">Тел. худ</label><input class="fc" id="ns-ph"></div><div class="fg"><label class="fl">Тел. волидайн</label><input class="fc" id="ns-pp"></div></div>
    <div class="mf"><button class="btn bb bblk" onclick="addStudent()">Илова</button><button class="btn bgh" onclick="closeModal('m-adds')">Бекор</button></div>
  </div>
</div>

<div class="overlay" id="m-eds">
  <div class="modal"><div class="mh"></div><div class="mt">✏️ Таҳрири донишҷӯ</div>
    <input type="hidden" id="es-id">
    <div class="fr"><div class="fg"><label class="fl">Насаб</label><input class="fc" id="es-l"></div><div class="fg"><label class="fl">Ном</label><input class="fc" id="es-f"></div></div>
    <div class="fg"><label class="fl">🆔 ID донишҷӯ</label><input class="fc" id="es-sid" placeholder="ID"></div>
    <div class="fr"><div class="fg"><label class="fl">Падар</label><input class="fc" id="es-fa"></div><div class="fg"><label class="fl">Модар</label><input class="fc" id="es-mo"></div></div>
    <div class="fr"><div class="fg"><label class="fl">Тел. худ</label><input class="fc" id="es-ph"></div><div class="fg"><label class="fl">Тел. волидайн</label><input class="fc" id="es-pp"></div></div>
    <div class="fg"><label class="fl">🔄 Интиқол ба гурӯҳ</label><select class="fc" id="es-tr"><option value="">— Интиқол нест —</option></select></div>
    <div class="mf"><button class="btn bb" style="flex:2" onclick="saveEdit()">💾 Нигоҳ</button><button class="btn br bsm" onclick="delS()">🗑️</button><button class="btn bgh bsm" onclick="closeModal('m-eds')">Бекор</button></div>
  </div>
</div>

<div class="overlay" id="m-imp">
  <div class="modal"><div class="mh"></div><div class="mt">📥 Импорт .txt</div>
    <div style="font-size:.76rem;color:var(--muted);margin-bottom:9px;background:var(--gray-l);padding:8px;border-radius:7px;line-height:1.5"><strong>Формат:</strong> Насаб Ном [Падар] [Тел]</div>
    <div class="imp-z" onclick="document.getElementById('imp-f').click()"><div style="font-size:1.6rem;margin-bottom:4px">📂</div><div style="font-weight:600;font-size:.82rem">Файлро интихоб кунед (.txt)</div></div>
    <input type="file" id="imp-f" accept=".txt" style="display:none" onchange="onIF(event)">
    <div id="imp-prev" style="margin-top:8px"></div>
    <div class="mf"><button class="btn bb bblk" id="imp-ok" style="display:none" onclick="confImp()">✅ Тасдиқ</button><button class="btn bgh" onclick="closeModal('m-imp')">Бекор</button></div>
  </div>
</div>

<div class="overlay" id="m-st">
  <div class="modal"><div class="mh"></div><div class="mt" id="m-st-t">Ҳолати давомот</div>
    <div id="m-st-note" style="display:none;margin:8px 0 12px;padding:9px 10px;border-radius:12px;background:var(--gray-l);border:1px solid var(--border);font-size:.74rem;line-height:1.45"></div>
    <div class="sopt" onclick="setSt('present')"><div class="sopt-i">✅</div><div><div class="sopt-l">Ҳозир</div><div class="sopt-s">Дарсро дидааст</div></div></div>
    <div class="sopt" onclick="setSt('absent')"><div class="sopt-i">❌</div><div><div class="sopt-l" style="color:var(--red)">Набуд (Н)</div></div></div>
    <div class="sopt" onclick="setSt('sick')"><div class="sopt-i">🤒</div><div><div class="sopt-l" style="color:var(--yellow)">Бемор (Б)</div></div></div>
    <div class="sopt" onclick="setSt('excused')"><div class="sopt-i">📝</div><div><div class="sopt-l" style="color:var(--blue)">Узр (У)</div></div></div>
    <div class="mf"><button class="btn bgh bblk" onclick="closeModal('m-st')">Бекор</button></div>
  </div>
</div>

<div class="overlay" id="m-addt">
  <div class="modal"><div class="mh"></div><div class="mt">👨‍🏫 Омӯзгори нав</div>
    <div class="fr"><div class="fg"><label class="fl">Насаб</label><input class="fc" id="nt-l" placeholder="Раҳимов"></div><div class="fg"><label class="fl">Ном</label><input class="fc" id="nt-f" placeholder="Алӣ"></div></div>
    <div class="fg"><label class="fl">Фан (предмет)</label><input class="fc" id="nt-sub" placeholder="Математика"></div>
    <div class="fr">
      <div class="fg"><label class="fl">🆔 ID (рақами корманд)</label><input class="fc" id="nt-tid" placeholder="Масалан: 1001"></div>
      <div class="fg"><label class="fl">📞 Телефон</label><input class="fc" id="nt-phone" placeholder="+992..."></div>
    </div>
    <div class="fg"><label class="fl">Рамз (пароль)</label><input class="fc" type="password" id="nt-pw" placeholder="Рамз"></div>
    <div class="mf"><button class="btn bb bblk" onclick="addTeacher()">Илова</button><button class="btn bgh" onclick="closeModal('m-addt')">Бекор</button></div>
  </div>
</div>

<!-- Таҳрири омӯзгор -->
<div class="overlay" id="m-edt">
  <div class="modal"><div class="mh"></div><div class="mt">✏️ Таҳрири омӯзгор</div>
    <input type="hidden" id="et-id">
    <div class="fr">
      <div class="fg"><label class="fl">Насаб</label><input class="fc" id="et-l"></div>
      <div class="fg"><label class="fl">Ном</label><input class="fc" id="et-f"></div>
    </div>
    <div class="fg"><label class="fl">Фан (предмет) — асосӣ</label><input class="fc" id="et-sub" placeholder="Биология"></div>
    <div class="fr">
      <div class="fg"><label class="fl">🆔 ID</label><input class="fc" id="et-tid" placeholder="Рақами корманд"></div>
      <div class="fg"><label class="fl">📞 Телефон</label><input class="fc" id="et-phone" placeholder="+992..."></div>
    </div>
    <div class="fg">
      <label class="fl">Рамзи нав</label>
      <input class="fc" type="password" id="et-pw" placeholder="Холӣ монед — иваз намешавад">
    </div>
    <div class="mf">
      <button class="btn bb bblk" onclick="saveEditTeacher()">💾 Нигоҳ</button>
      <button class="btn bgh" onclick="closeModal('m-edt')">Бекор</button>
    </div>
  </div>
</div>

<!-- Modal: Add subject to teacher-group -->
<div class="overlay" id="m-add-subj">
  <div class="modal"><div class="mh"></div><div class="mt">📚 Фан илова кунед</div>
    <input type="hidden" id="as-tid">
    <input type="hidden" id="as-gid">
    <div class="fg"><label class="fl">Номи фан</label>
      <input class="fc" id="as-name" placeholder="Масалан: Биология">
    </div>
    <div style="background:var(--blue-l);border-radius:8px;padding:8px 11px;font-size:.74rem;color:var(--blue-d);margin-bottom:8px;line-height:1.5">
      📅 Соатҳои дарс аз <b>Тақвими дарсҳо</b> барои ин омӯзгор танзим карда мешавад.<br>
      Дар поёни карточкаи омӯзгор → <b>Тақвими дарсҳо</b> → рӯзу дарсро интихоб кунед.
    </div>
    <div class="mf">
      <button class="btn bb bblk" onclick="saveAddSubject()">✅ Илова</button>
      <button class="btn bgh" onclick="closeModal('m-add-subj')">Бекор</button>
    </div>
  </div>
</div>

<!-- Modal: Transfer subject to another teacher -->
<div class="overlay" id="m-transfer-subj">
  <div class="modal"><div class="mh"></div><div class="mt">🔄 Интиқоли фан</div>
    <input type="hidden" id="ts-from-tid">
    <input type="hidden" id="ts-gid">
    <input type="hidden" id="ts-subj-id">
    <div id="ts-info" style="background:var(--blue-l);border-radius:8px;padding:9px 12px;font-size:.8rem;margin-bottom:12px;line-height:1.5"></div>
    <div class="fg"><label class="fl">Ба кадом омӯзгор интиқол диҳем?</label>
      <select class="fc" id="ts-to-tid">
        <option value="">— Омӯзгорро интихоб кунед —</option>
      </select>
    </div>
    <div style="background:#fef3c7;border-radius:8px;padding:9px 12px;font-size:.75rem;color:#92400e;margin-bottom:10px;line-height:1.5">
      ⚠️ Ҳамаи маълумоти давомоти ин фан ба омӯзгори нав мегузарад.
    </div>
    <div class="mf">
      <button class="btn bor bblk" onclick="confirmTransferSubject()">🔄 Интиқол</button>
      <button class="btn bgh" onclick="closeModal('m-transfer-subj')">Бекор</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ══ MODAL: ADD SUB-ADMIN ══ -->
<div class="overlay" id="m-addsa">
  <div class="modal"><div class="mh"></div><div class="mt">🛡️ Суб-Администратори нав</div>
    <div class="fg"><label class="fl">Ном / Унвон</label>
      <input class="fc" id="sa-name" placeholder="Масалан: Методист, Директор, Нозир"></div>
    <div class="fg"><label class="fl">Рамз (пароль)</label>
      <input class="fc" type="password" id="sa-pw" placeholder="Рамз"></div>
    <div class="fg"><label class="fl">Саҳифаҳои иҷозатдор:</label>
      <div id="sa-pages-check" style="display:flex;flex-direction:column;gap:6px;margin-top:4px">
        <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;padding:6px 10px;background:#f8fafc;border-radius:8px;border:1px solid var(--border);cursor:pointer">
          <input type="checkbox" value="groups" id="sap-groups" style="width:16px;height:16px;accent-color:var(--blue)">
          👥 Гурӯҳҳо — рӯйхати донишҷӯён
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;padding:6px 10px;background:#f8fafc;border-radius:8px;border:1px solid var(--border);cursor:pointer">
          <input type="checkbox" value="attendance" id="sap-attendance" style="width:16px;height:16px;accent-color:var(--blue)">
          📋 Давомот — ҳамаи гурӯҳҳо (VIEW танҳо)
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;padding:6px 10px;background:#f8fafc;border-radius:8px;border:1px solid var(--border);cursor:pointer">
          <input type="checkbox" value="sms" id="sap-sms" style="width:16px;height:16px;accent-color:var(--blue)">
          📨 SMS — рӯйхати ғоибон
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;padding:6px 10px;background:#f8fafc;border-radius:8px;border:1px solid var(--border);cursor:pointer">
          <input type="checkbox" value="stats" id="sap-stats" checked style="width:16px;height:16px;accent-color:var(--blue)">
          📊 Статистика — ҳамаи гурӯҳҳо
        </label>
      </div>
    </div>
    <div class="mf">
      <button class="btn bb bblk" onclick="addSubAdmin()">✅ Илова</button>
      <button class="btn bgh" onclick="closeModal('m-addsa')">Бекор</button>
    </div>
  </div>
</div>

<!-- ══ MODAL: EDIT SUB-ADMIN ══ -->
<div class="overlay" id="m-editsa">
  <div class="modal"><div class="mh"></div><div class="mt">✏️ Суб-Администратор</div>
    <input type="hidden" id="sa-edit-id">
    <div class="fg"><label class="fl">Ном / Унвон</label>
      <input class="fc" id="sa-edit-name" placeholder="Ном"></div>
    <div class="fg"><label class="fl">Рамзи нав (холӣ = иваз намешавад)</label>
      <input class="fc" type="password" id="sa-edit-pw" placeholder="Рамзи нав"></div>
    <div class="fg"><label class="fl">Саҳифаҳои иҷозатдор:</label>
      <div id="sa-edit-pages" style="display:flex;flex-direction:column;gap:6px;margin-top:4px">
        <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;padding:6px 10px;background:#f8fafc;border-radius:8px;border:1px solid var(--border);cursor:pointer">
          <input type="checkbox" value="groups" id="saep-groups" style="width:16px;height:16px;accent-color:var(--blue)">
          👥 Гурӯҳҳо
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;padding:6px 10px;background:#f8fafc;border-radius:8px;border:1px solid var(--border);cursor:pointer">
          <input type="checkbox" value="attendance" id="saep-attendance" style="width:16px;height:16px;accent-color:var(--blue)">
          📋 Давомот
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;padding:6px 10px;background:#f8fafc;border-radius:8px;border:1px solid var(--border);cursor:pointer">
          <input type="checkbox" value="sms" id="saep-sms" style="width:16px;height:16px;accent-color:var(--blue)">
          📨 SMS
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;padding:6px 10px;background:#f8fafc;border-radius:8px;border:1px solid var(--border);cursor:pointer">
          <input type="checkbox" value="stats" id="saep-stats" style="width:16px;height:16px;accent-color:var(--blue)">
          📊 Статистика
        </label>
      </div>
    </div>
    <div class="mf">
      <button class="btn bb bblk" onclick="saveSubAdmin()">💾 Нигоҳ</button>
      <button class="btn br bsm" onclick="delSubAdmin()">🗑️</button>
      <button class="btn bgh" onclick="closeModal('m-editsa')">Бекор</button>
    </div>
  </div>
</div>

<script>
// ============================================
//  DATABASE
// ============================================
let db={
  groups:[],attendance:{},
  settings:{instName:'',teacherName:'',adminPw:'admin',
    shifts:{
      1:[{id:'l1',name:'1-дарс',time:'08:00'},{id:'l2',name:'2-дарс',time:'09:00'},{id:'l3',name:'3-дарс',time:'10:00'},{id:'l4',name:'4-дарс',time:'11:00'},{id:'l5',name:'5-дарс',time:'12:00'}],
      2:[{id:'m1',name:'1-дарс',time:'13:00'},{id:'m2',name:'2-дарс',time:'14:00'},{id:'m3',name:'3-дарс',time:'15:00'},{id:'m4',name:'4-дарс',time:'16:00'},{id:'m5',name:'5-дарс',time:'17:00'}]
    },
    teachers:[],
    subAdmins:[]
  }
};

function lDB(){
  try{const s=localStorage.getItem('dav7');if(s)db=JSON.parse(s);}catch(e){}
  _initDefaults();
}
function _initDefaults(){
  if(!db.groups)db.groups=[];
  if(!db.attendance)db.attendance={};
  if(!db.settings)db.settings={};
  if(!db.settings.adminPw)db.settings.adminPw='admin';
  if(!db.settings.shifts)db.settings.shifts={1:[{id:'l1',name:'1-дарс',time:'08:00'},{id:'l2',name:'2-дарс',time:'09:00'},{id:'l3',name:'3-дарс',time:'10:00'},{id:'l4',name:'4-дарс',time:'11:00'},{id:'l5',name:'5-дарс',time:'12:00'}],2:[{id:'m1',name:'1-дарс',time:'13:00'},{id:'m2',name:'2-дарс',time:'14:00'},{id:'m3',name:'3-дарс',time:'15:00'},{id:'m4',name:'4-дарс',time:'16:00'},{id:'m5',name:'5-дарс',time:'17:00'}]};
  if(!db.settings.teachers)db.settings.teachers=[];
  if(!db.settings.subAdmins)db.settings.subAdmins=[];
  db.settings.teachers.forEach(t=>{
    if(!t.scheduleByGroup)t.scheduleByGroup={};
    if(!t.dateScheduleByGroup)t.dateScheduleByGroup={};
    if(!t.groupPerms)t.groupPerms={};
    Object.entries(t.groupPerms).forEach(([gid,gp])=>{
      if(!gp.subjects){
        gp.subjects=[];
        if(gp.allowedLessons&&gp.allowedLessons.length){
          const subjName=t.subject||'Фан';
          gp.allowedLessons.forEach((lid,i)=>{
            gp.subjects.push({id:uid(),name:subjName+(gp.allowedLessons.length>1?' '+(i+1):''),
              lessonId:null,schedule:{},dateSchedule:{}});
          });
        }
      }
      if(!gp.allowedLessons)gp.allowedLessons=[];
      // Migrate per-subject: ensure schedule/dateSchedule exist
      (gp.subjects||[]).forEach(s=>{
        if(!s.schedule)s.schedule={};
        if(!s.dateSchedule)s.dateSchedule={};
        // Migrate: if old scheduleByGroup[gid] exists, move to first subject only once
        if(!s._schedMigrated && t.scheduleByGroup[gid] && Object.keys(t.scheduleByGroup[gid]).length){
          if(gp.subjects.indexOf(s)===0){
            s.schedule=JSON.parse(JSON.stringify(t.scheduleByGroup[gid]));
            s._schedMigrated=true;
          }
        }
        if(!s._dateMigrated && t.dateScheduleByGroup[gid] && Object.keys(t.dateScheduleByGroup[gid]).length){
          if(gp.subjects.indexOf(s)===0){
            s.dateSchedule=JSON.parse(JSON.stringify(t.dateScheduleByGroup[gid]));
            s._dateMigrated=true;
          }
        }
      });
    });
  });
}
// sv() = save to localStorage + async cloud sync
function sv(){svCloud();}
function uid(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5);}
function sortS(a){return[...a].sort((x,y)=>{const la=(x.last||'').toLowerCase(),lb=(y.last||'').toLowerCase();if(la<lb)return-1;if(la>lb)return 1;return(x.first||'').toLowerCase()<(y.first||'').toLowerCase()?-1:1;});}
function ini(s){return((s.last||'').charAt(0)+(s.first||'').charAt(0)).toUpperCase();}
function getLessons(gid){const g=db.groups.find(x=>x.id===gid);const sh=g?.shift||1;return db.settings.shifts[sh]||[];}
function p2(n){return String(n).padStart(2,'0');}
function aKey(sid,y,m,d,lid){return`${sid}_${y}-${p2(m)}-${p2(d)}_${lid}`;}

function normSt(v){return (v&&typeof v==='object')?v.st:v;}
function normBy(v){
  if(!(v&&typeof v==='object'))return null;
  const who=v.byName|| (v.by==='admin'?'Админ':v.by);
  return {who,subject:v.subject||'',tid:v.byTid||'',phone:v.byPhone||'',at:v.at||null,by:v.by||null};
}
function isSun(y,m,d){return new Date(y,m,d).getDay()===0;}
function dimF(y,m){return new Date(y,m+1,0).getDate();}

// Attendance % helpers (per student)
function isNonPresent(st){return st==='absent'||st==='sick'||st==='excused';}
function lessonsForDate(gid, date){
  // Respect teacher lesson permissions & schedules; admin sees all lessons
  if(curUser?.type==='teacher') return getAllowedLessons(gid, date);
  return getLessons(gid);
}
function calcPresencePercent(gid, sid, fromDate, toDate){
  const att=db.attendance?.[gid]||{};
  let total=0, present=0;
  let d=new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
  const end=new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());
  while(d<=end){
    if(d.getDay()!==0){ // skip Sundays
      const ls=lessonsForDate(gid, d) || [];
      ls.forEach(l=>{
        total++;
        const key=aKey(sid, d.getFullYear(), d.getMonth()+1, d.getDate(), l.id);
        const st=att[key];
        if(!isNonPresent(st)) present++;
      });
    }
    d.setDate(d.getDate()+1);
  }
  if(total===0) return 0;
  return Math.round((present/total)*100);
}
function studentMonthPercent(gid, sid, baseDate){
  const dt=baseDate||new Date();
  const y=dt.getFullYear(), m=dt.getMonth();
  const from=new Date(y,m,1);
  const to=new Date(y,m,dimF(y,m));
  return calcPresencePercent(gid,sid,from,to);
}


// ============================================
//  AUTH & PERMISSIONS (with per-group schedule)
// ============================================
let curUser=null;

function buildLoginSelect(){
  const sel=document.getElementById('login-who');
  const subAdmOpts=(db.settings.subAdmins||[]).map(sa=>`<option value="sa::${sa.id}">🛡️ ${sa.name}</option>`).join('');
  sel.innerHTML='<option value="admin">👑 Администратор</option>'+subAdmOpts+
    (db.settings.teachers||[]).map(t=>`<option value="${t.id}">👨‍🏫 ${t.last} ${t.first}${t.tid?' ['+t.tid+']':''}</option>`).join('');
  // Reset subject dropdown
  const wrap=document.getElementById('login-subject-wrap');
  if(wrap)wrap.style.display='none';
}
function filterLoginList(q){
  const sel=document.getElementById('login-who');
  const lq=(q||'').toLowerCase().trim();
  const teachers=db.settings.teachers||[];
  const subAdmins=db.settings.subAdmins||[];
  const filteredT=lq
    ? teachers.filter(t=>{
        const nameMatch=(t.last+' '+t.first).toLowerCase().includes(lq);
        const idMatch=t.tid&&t.tid.toLowerCase().includes(lq);
        return nameMatch||idMatch;
      })
    : teachers;
  const filteredSA=lq
    ? subAdmins.filter(sa=>sa.name.toLowerCase().includes(lq))
    : subAdmins;
  const subAdmOpts=filteredSA.map(sa=>`<option value="sa::${sa.id}">🛡️ ${sa.name}</option>`).join('');
  sel.innerHTML='<option value="admin">👑 Администратор</option>'+subAdmOpts+
    filteredT.map(t=>`<option value="${t.id}">👨‍🏫 ${t.last} ${t.first}${t.tid?' ['+t.tid+']':''}</option>`).join('');
  if(filteredT.length===1&&!filteredSA.length){sel.value=filteredT[0].id;onLoginWhoChange();}
}
function doLogin(){
  const who=document.getElementById('login-who').value;
  const pw=document.getElementById('login-pass').value;
  const err=document.getElementById('login-err');
  if(who==='admin'){
    if(pw!==db.settings.adminPw){err.style.display='flex';(document.getElementById('login-err-text')||err).textContent='Рамзи администратор нодуруст!';return;}
    curUser={type:'admin'};
  }else if(who.startsWith('sa::')){
    // Sub-Admin login
    const saId=who.slice(4);
    const sa=(db.settings.subAdmins||[]).find(x=>x.id===saId);
    if(!sa||pw!==sa.pw){err.style.display='flex';(document.getElementById('login-err-text')||err).textContent='Рамзи Суб-Админ нодуруст!';return;}
    curUser={type:'subadmin',...sa};
  }else{
    const t=db.settings.teachers.find(x=>x.id===who);
    if(!t||pw!==t.pw){err.style.display='flex';(document.getElementById('login-err-text')||err).textContent='Рамзи омӯзгор нодуруст!';return;}
    // No subject selection on login — teacher sees all subjects in cabinet
    curUser={type:'teacher',...t,activeSubject:null};
    // attGid will be set when teacher picks a group/subject in cabinet
    attGid=null;
  }
  err.style.display='none';
  document.getElementById('login-screen').style.display='none';
  document.getElementById('main-hdr').style.display='block';
  // Show active subject in header
  const hdrName=curUser.type==='admin'?'👑 Администратор':
    curUser.type==='subadmin'?'🛡️ '+curUser.name:
    '👨‍🏫 '+curUser.last+' '+curUser.first;
  document.getElementById('hdr-uname').textContent=hdrName;
  buildNav();
  initApp();
  if (sbConfigured()) {
    startRealtimeSync();
    lDBCloud().then(ok => {
      if(ok){ _initDefaults(); renderGroups?.(); buildLoginSelect?.(); }
    });
  }
}
function doLogout(){
  curUser=null;
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('main-hdr').style.display='none';
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById('login-pass').value='';
  buildLoginSelect();
}

function getPerms(){
  if(!curUser)return[];
  if(curUser.type==='admin')return['groups','attendance','sms','stats','settings'];
  // Sub-Admin: ҳамаи саҳифаҳое ки Admin ичозат додааст
  if(curUser.type==='subadmin'){
    return(curUser.pages||[]);
  }
  const base=['groups','attendance'];
  const extra=(curUser.perms||[]).filter(p=>['sms','stats'].includes(p));
  return [...base,...extra];
}
function hasPerm(p){return getPerms().includes(p);}

function hasGroupPerm(gid,type){
  if(curUser?.type==='admin')return true;
  if(curUser?.type==='subadmin')return true; // SubAdmin ҳама гурӯҳро мебинад
  const gp=(curUser?.groupPerms||{})[gid];
  if(!gp)return false;
  return gp[type]===true;
}

// NEW: Get allowed lessons considering per-group day of week and specific dates
function getAllowedLessonIds(gid, date){
  if(curUser?.type==='admin' || curUser?.type==='subadmin') return null; // null = all allowed

  // Teacher with active subject — use THAT subject's own schedule
  const _activeSubj = typeof teacherActiveSubj!=='undefined'?teacherActiveSubj:curUser?.activeSubject;
  if(_activeSubj && _activeSubj.gid===gid){
    const subj=_activeSubj._subjObj;
    if(!subj) return []; // subject object not found → no access
    if(date){
      const dateStr=`${date.getFullYear()}-${p2(date.getMonth()+1)}-${p2(date.getDate())}`;
      const ds=subj.dateSchedule||{};
      if(ds[dateStr]&&ds[dateStr].lessons?.length) return ds[dateStr].lessons;
      const dow=date.getDay();
      const sc=subj.schedule||{};
      if(sc[dow]&&sc[dow].enabled&&sc[dow].lessons?.length) return sc[dow].lessons;
      return []; // this date not in schedule → no access
    } else {
      // no date — collect all lesson ids across all scheduled days
      const sc=subj.schedule||{};
      const all=[];
      [1,2,3,4,5,6].forEach(d=>{if(sc[d]?.enabled)sc[d].lessons?.forEach(l=>{if(!all.includes(l))all.push(l);});});
      return all; // empty = no schedule set at all
    }
  }

  // No activeSubject — collect from ALL subjects of this group
  const gp=(curUser?.groupPerms||{})[gid];
  if(!gp||!gp.att) return [];
  const subjects=gp.subjects||[];
  if(!subjects.length) return [];
  if(!date){
    // collect all scheduled lessons across all subjects
    const all=[];
    subjects.forEach(s=>{
      const sc=s.schedule||{};
      [1,2,3,4,5,6].forEach(d=>{if(sc[d]?.enabled)sc[d].lessons?.forEach(l=>{if(!all.includes(l))all.push(l);});});
    });
    return all;
  }
  const dateStr=`${date.getFullYear()}-${p2(date.getMonth()+1)}-${p2(date.getDate())}`;
  const dow=date.getDay();
  const all=[];
  subjects.forEach(s=>{
    const ds=s.dateSchedule||{};
    const sc=s.schedule||{};
    let ids=[];
    if(ds[dateStr]&&ds[dateStr].lessons?.length) ids=ds[dateStr].lessons;
    else if(sc[dow]&&sc[dow].enabled&&sc[dow].lessons?.length) ids=sc[dow].lessons;
    // if neither — this subject has no class this day → skip (no fallback!)
    ids.forEach(l=>{if(!all.includes(l))all.push(l);});
  });
  return all; // empty = no subjects scheduled for this date
}

function getAllowedLessons(gid, date){
  const all = getLessons(gid);
  if(curUser?.type==='admin' || curUser?.type==='subadmin') return all;
  const allowedIds = getAllowedLessonIds(gid, date);
  if(!allowedIds || allowedIds.length === 0) return [];
  return all.filter(l=>allowedIds.includes(l.id));
}

function canChangeView(){
  if(curUser?.type==='admin')return true;
  return curUser?.canChangeView===true;
}

const ALL_PAGES=[
  {id:'groups',icon:'👥',label:'Гурӯҳҳо'},
  {id:'attendance',icon:'📋',label:'Давомот'},
  {id:'sms',icon:'📨',label:'SMS'},
  {id:'stats',icon:'📊',label:'Статистика'},
  {id:'settings',icon:'⚙️',label:'Танзимот'}
];
function buildNav(){
  const nav=document.getElementById('main-nav');
  const perms=getPerms();
  nav.innerHTML=ALL_PAGES.filter(p=>perms.includes(p.id)).map(p=>`
    <div class="nitem" data-p="${p.id}" onclick="gp('${p.id}')"><div class="ni">${p.icon}</div>${p.label}</div>`).join('');
  const first=ALL_PAGES.find(p=>perms.includes(p.id));
  if(first)gp(first.id);
}
function initApp(){
  const adminBtns=document.getElementById('grp-admin-btns');
  if(curUser?.type==='admin'){
    adminBtns.innerHTML=`<button class="btn bgh bsm" onclick="expJSON()">📤 JSON</button>
      <button class="btn bgh bsm" onclick="document.getElementById('imp-json').click()">📥 JSON</button>
      <input type="file" id="imp-json" accept=".json" style="display:none" onchange="impJSON(event)">
      <button class="btn bb bsm" onclick="openModal('m-addg')">＋ Гурӯҳ</button>`;
  }else if(curUser?.type==='subadmin'){
    // SubAdmin: танҳо excel/json export, гурӯҳ илова/ҳазф НЕСТ
    adminBtns.innerHTML=`<button class="btn bgh bsm" onclick="expJSON()">📤 JSON</button>`;
  }else{
    adminBtns.innerHTML='';
  }
  renderGroups();
}

// ============================================
//  NAVIGATION
// ============================================
function gp(p){
  if(!hasPerm(p)){toast('Доступ нест!');return;}
  document.querySelectorAll('.page').forEach(x=>x.style.display='none');
  document.querySelectorAll('.nitem').forEach(x=>x.classList.remove('active'));
  const pg=document.getElementById('page-'+p);
  if(pg){pg.style.display='block';pg.classList.add('active');}
  document.querySelector(`.nitem[data-p="${p}"]`)?.classList.add('active');
  if(p==='attendance')renderAtt();
  if(p==='sms'){popSMSGroups();renderSMSCtrl();renderSMS();}
  if(p==='stats'){popStGroups();if(!document.getElementById('st-ml').textContent)document.getElementById('st-ml').textContent=MN[stM]+' '+stY;updStCtrl();}
  if(p==='settings')renderSettings();
}

// ============================================
//  GROUPS
// ============================================
let curGid=null;
let groupSearch='';

function getVisibleGroups(){
  if(curUser?.type==='admin')return db.groups;
  if(curUser?.type==='subadmin')return db.groups; // SubAdmin ҳама гурӯҳро мебинад
  const gp=curUser?.groupPerms||{};
  return db.groups.filter(g=>{
    const gPerms=gp[g.id];
    return gPerms&&(gPerms.att||gPerms.list);
  });
}
function getSortedGroups(groups){
  return [...(groups||[])].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
}

function renderGroups(){
  const c=document.getElementById('gl-c');
  const allGroups=getSortedGroups(getVisibleGroups());
  const q=(groupSearch||'').toLowerCase().trim();
  const groups=q?allGroups.filter(g=>{
    const nm=(g.name||'').toLowerCase();
    const cd=(g.code||'').toLowerCase();
    const id=(g.id||'').toLowerCase();
    return nm.includes(q)||cd.includes(q)||id.includes(q);
  }):allGroups;
  if(!groups.length){c.innerHTML='<div class="empty"><div class="ei">📂</div><div class="et">Гурӯҳ нест</div></div>';return;}
  c.innerHTML=groups.map((g,gi)=>{
    const sh=g.shift||1;
    const canAtt=hasGroupPerm(g.id,'att');
    const canList=hasGroupPerm(g.id,'list');
    const isAdmin=curUser?.type==='admin'||curUser?.type==='subadmin';
    return`<div class="gcrd${sh===2?' s2':''}">
      <div class="gct">
        <div>
          <div class="gcn">${gi+1}. ${g.name}${g.code?`<span class="bdg bdb">${g.code}</span>`:''} <span class="bdg ${sh===2?'bdo':'bdb'}">Баст ${sh}</span></div>
          <div class="gcc">${g.students?.length||0} донишҷӯ</div>
        </div>
        <div style="color:var(--blue);font-size:1.1rem">›</div>
      </div>
      <div class="gca">
        ${(isAdmin||canAtt)?`<button class="btn bb bsm" style="flex:1" onclick="openAtt('${g.id}')">📋 Давомот</button>`:''}
        ${(isAdmin||canList)?`<button class="btn bgh bsm" style="flex:1" onclick="openGD('${g.id}')">👥 Рӯйхат</button>`:''}
        ${curUser?.type==='admin'?`<button class="btn bgh bico" onclick="openEditGroup('${g.id}')" title="Таҳрир">✏️</button>`:''}${curUser?.type==='admin'?`<button class="btn bgh bico" onclick="delG('${g.id}')" title="Ҳазф">🗑️</button>`:''}
      </div>
    </div>`;
  }).join('');
}

function openAtt(gid){
  attGid=gid;
  gp('attendance');
  if(sbConfigured()){
    sbLoadAtt(gid).then(attData=>{
      if(attData!==null){
        db.attendance[gid]=attData;
        localStorage.setItem('dav7',JSON.stringify(db));
        renderAttT?.();
      }
    });
  }
}
function attBack(){attGid=null;gp('groups');}

function openGD(gid){
  curGid=gid;
  const g=db.groups.find(x=>x.id===gid);
  document.getElementById('v-gl').style.display='none';
  document.getElementById('v-gd').style.display='block';
  document.getElementById('gd-t').textContent=g.name;
  renderSL(g);
}
function backG(){document.getElementById('v-gl').style.display='block';document.getElementById('v-gd').style.display='none';curGid=null;renderGroups();}

function renderSL(g){
  const c=document.getElementById('s-c');
  const sorted=sortS(g.students||[]);
  if(!sorted.length){c.innerHTML=`<div class="empty"><div class="ei">👤</div><div class="et">Донишҷӯ нест</div></div>`;return;}
  c.innerHTML=sorted.map((s,i)=>`
    <div class="srow" onclick="editS('${s.id}')">
      <div class="ava">${ini(s)}</div>
      <div style="flex:1"><div class="sn">${i+1}. ${s.last} ${s.first}${s.sid?` <span class=\"bdg bdo\">ID: ${s.sid}</span>`:''}${s.fromGid?'<span class="tchip">↔</span>':''}<span class="bdg bdb" style="margin-left:6px">Ҳузур: ${studentMonthPercent(g.id,s.id)}%</span></div>
      <div class="ss">${s.phone||''}${s.pphone?' · 👨‍👩‍👧 '+s.pphone:''}</div></div>
      <div style="color:var(--blue)">›</div>
    </div>`).join('');
}

function addGroup(){
  const name=document.getElementById('ng-n').value.trim();if(!name){toast('Номро ворид кунед!');return;}
  const g={id:uid(),name,code:document.getElementById('ng-c').value.trim(),shift:parseInt(document.getElementById('ng-sh').value)||1,students:[]};
  db.groups.push(g);db.attendance[g.id]={};sv();closeModal('m-addg');
  document.getElementById('ng-n').value='';document.getElementById('ng-c').value='';
  renderGroups();toast('Гурӯҳ илова шуд ✅');
}
function delG(gid){if(!confirm('Ҳазф?'))return;db.groups=db.groups.filter(x=>x.id!==gid);delete db.attendance[gid];sv();renderGroups();toast('Ҳазф шуд');}


function openEditGroup(gid){
  const g=db.groups.find(x=>x.id===gid); if(!g) return;
  document.getElementById('edg-id').value = g.id;
  document.getElementById('edg-n').value = g.name || '';
  document.getElementById('edg-c').value = g.code || '';
  document.getElementById('edg-sh').value = String(g.shift||1);
  const sys=document.getElementById('edg-sys'); if(sys) sys.textContent = g.id;
  openModal('m-edg');
}
function saveEditGroup(){
  const gid=document.getElementById('edg-id').value;
  const g=db.groups.find(x=>x.id===gid); if(!g) return;
  const name=(document.getElementById('edg-n').value||'').trim();
  if(!name){ toast('Номро ворид кунед!'); return; }
  g.name = name;
  g.code = (document.getElementById('edg-c').value||'').trim();
  g.shift = parseInt(document.getElementById('edg-sh').value)||1;
  sv();
  closeModal('m-edg');
  // refresh UI
  renderGroups();
  if(curGid===gid){
    document.getElementById('gd-t').textContent = g.name;
    const attLbl=document.getElementById('att-gl');
    if(attLbl) attLbl.textContent = g.name;
  }
  toast('Гурӯҳ нав шуд ✅');
}


function openAddS(){['ns-sid','ns-l','ns-f','ns-fa','ns-mo','ns-ph','ns-pp'].forEach(id=>document.getElementById(id).value='');openModal('m-adds');}
function addStudent(){
  const g=db.groups.find(x=>x.id===curGid);if(!g)return;
  const last=document.getElementById('ns-l').value.trim(),first=document.getElementById('ns-f').value.trim();
  if(!last&&!first){toast('Номро ворид кунед!');return;}
  g.students.push({id:uid(),sid:document.getElementById('ns-sid').value.trim(),last,first,father:document.getElementById('ns-fa').value.trim(),mother:document.getElementById('ns-mo').value.trim(),phone:document.getElementById('ns-ph').value.trim(),pphone:document.getElementById('ns-pp').value.trim(),addedAt:new Date().toISOString()});
  g.students=sortS(g.students);sv();closeModal('m-adds');renderSL(g);toast('Илова шуд ✅');
}

function editS(sid){
  const g=db.groups.find(x=>x.id===curGid);const s=g?.students.find(x=>x.id===sid);if(!s)return;
  document.getElementById('es-id').value=sid;
  document.getElementById('es-sid').value=(s.sid||'');
  ['l','f','fa','mo','ph','pp'].forEach(k=>document.getElementById('es-'+k).value=s[{l:'last',f:'first',fa:'father',mo:'mother',ph:'phone',pp:'pphone'}[k]]||'');
  const sel=document.getElementById('es-tr');
  sel.innerHTML='<option value="">— Интиқол нест —</option>'+db.groups.filter(gg=>gg.id!==curGid).map(gg=>`<option value="${gg.id}">${gg.name} — Баст ${gg.shift||1}</option>`).join('');
  openModal('m-eds');
}
function saveEdit(){
  const g=db.groups.find(x=>x.id===curGid);const sid=document.getElementById('es-id').value;const s=g?.students.find(x=>x.id===sid);if(!s)return;
  s.last=document.getElementById('es-l').value.trim();s.first=document.getElementById('es-f').value.trim();
  s.father=document.getElementById('es-fa').value.trim();s.mother=document.getElementById('es-mo').value.trim();
  s.phone=document.getElementById('es-ph').value.trim();s.pphone=document.getElementById('es-pp').value.trim();
  s.sid=document.getElementById('es-sid').value.trim();
  const toGid=document.getElementById('es-tr').value;
  if(toGid){
    const toG=db.groups.find(x=>x.id===toGid);if(!toG)return;
    const nid=uid();const ns={...s,id:nid,fromGid:curGid,fromGName:g.name,addedAt:new Date().toISOString()};
    toG.students.push(ns);toG.students=sortS(toG.students);
    if(!db.attendance[toGid])db.attendance[toGid]={};
    Object.entries(db.attendance[curGid]||{}).forEach(([k,v])=>{if(k.startsWith(sid+'_'))db.attendance[toGid][nid+k.slice(sid.length)]=v;});
    g.students=g.students.filter(x=>x.id!==sid);
    Object.keys(db.attendance[curGid]||{}).forEach(k=>{if(k.startsWith(sid+'_'))delete db.attendance[curGid][k];});
    sv();closeModal('m-eds');renderSL(g);toast(s.last+' → '+toG.name+' ✅');return;
  }
  g.students=sortS(g.students);sv();closeModal('m-eds');renderSL(g);toast('Нигоҳ ✅');
}
function delS(){
  if(!confirm('Ҳазф?'))return;
  const g=db.groups.find(x=>x.id===curGid);const sid=document.getElementById('es-id').value;
  g.students=g.students.filter(x=>x.id!==sid);
  Object.keys(db.attendance[curGid]||{}).forEach(k=>{if(k.startsWith(sid+'_'))delete db.attendance[curGid][k];});
  sv();closeModal('m-eds');renderSL(g);toast('Ҳазф шуд');
}

let impD=[];
function openImp(){impD=[];document.getElementById('imp-prev').innerHTML='';document.getElementById('imp-ok').style.display='none';document.getElementById('imp-f').value='';openModal('m-imp');}
function onIF(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    const lines=ev.target.result.split('\n').map(l=>l.trim()).filter(Boolean);
    impD=lines.map(line=>{const parts=line.split(/\s+/);const ph=parts.find(p=>p.startsWith('+')||/^\d{9,}/.test(p))||'';const np=parts.filter(p=>p!==ph);return{id:uid(),last:np[0]||'',first:np[1]||'',father:np[2]||'',mother:'',phone:ph,pphone:'',addedAt:new Date().toISOString()};});
    document.getElementById('imp-prev').innerHTML=`<div style="font-weight:700;color:var(--green);margin-bottom:5px">✅ ${impD.length} топилд</div><div style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:7px">${impD.map((s,i)=>`<div style="padding:4px 8px;border-bottom:1px solid var(--border);font-size:.75rem">${i+1}. ${s.last} ${s.first}</div>`).join('')}</div>`;
    document.getElementById('imp-ok').style.display='flex';
  };
  r.readAsText(f,'UTF-8');
}
function confImp(){const g=db.groups.find(x=>x.id===curGid);if(!g)return;impD.forEach(s=>g.students.push(s));g.students=sortS(g.students);sv();closeModal('m-imp');renderSL(g);toast(impD.length+' илова шуд ✅');}

function expSXls(){const g=db.groups.find(x=>x.id===curGid);if(!g)return;let c='\uFEFF\u2116,\u041d\u0430\u0441\u0430\u0431,\u041d\u043e\u043c,\u041f\u0430\u0434\u0430\u0440,\u041c\u043e\u0434\u0430\u0440,\u0422\u0435\u043b. \u0445\u0443\u0434,\u0422\u0435\u043b. \u0432\u043e\u043b\u0438\u0434\u0430\u0439\u043d\n';sortS(g.students||[]).forEach((s,i)=>c+=`${i+1},"${s.last}","${s.first}","${s.father||''}","${s.mother||''}","${s.phone||''}","${s.pphone||''}"\n`);dl(c,g.name+'_ruyhat.csv','text/csv;charset=utf-8');toast('Excel ✅');}
function expSTxt(){const g=db.groups.find(x=>x.id===curGid);if(!g)return;let t=`\u0413\u0443\u0440\u04ef\u04b3: ${g.name}\n${'─'.repeat(28)}\n`;sortS(g.students||[]).forEach((s,i)=>{t+=`${i+1}. ${s.last} ${s.first} ${s.father||''}\n`;if(s.phone)t+=`   📞 ${s.phone}\n`;if(s.pphone)t+=`   👨‍👩‍👧 ${s.pphone}\n`;});dl(t,g.name+'_ruyhat.txt','text/plain;charset=utf-8');toast('Текст ✅');}
function dl(c,n,m){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c],{type:m}));a.download=n;a.click();}

// ============================================
//  ATTENDANCE (with per-group schedule)
// ============================================
let attGid=null,vm='day';
let aY=new Date().getFullYear(),aM=new Date().getMonth(),aD=new Date().getDate();
let pCell=null;
const MN=['Январ','Феврал','Март','Апрел','Май','Июн','Июл','Август','Сентябр','Октябр','Ноябр','Декабр'];
const DN=['Якш','Душ','Сеш','Чор','Пан','Ҷум','Шан'];
const DN_FULL=['Якшанбе','Душанбе','Сешанбе','Чоршанбе','Панҷшанбе','Ҷумъа','Шанбе'];

// Currently active subject for teacher (set by tab click)
let teacherActiveSubj = null; // {gid, subjId, subjName, _subjObj}

function renderAtt(){
  // Teacher: build subject/group tabs
  if(curUser?.type==='teacher'){
    buildTeacherSubjTabs();
  }
  if(!attGid){document.getElementById('att-ng').style.display='block';document.getElementById('att-main').style.display='none';return;}
  const g=db.groups.find(x=>x.id===attGid);
  document.getElementById('att-ng').style.display='none';document.getElementById('att-main').style.display='block';
  document.getElementById('att-gl').textContent='📚 '+g.name+(teacherActiveSubj?' — '+teacherActiveSubj.subjName:'');
  if(curUser?.type!=='admin'){
    const now=new Date();aY=now.getFullYear();aM=now.getMonth();aD=now.getDate();
    const prev=document.getElementById('dn-prev');const next=document.getElementById('dn-next');
    const pick=document.getElementById('d-pick');
    if(prev)prev.style.opacity='0.3';if(next)next.style.opacity='0.3';
    if(pick)pick.setAttribute('readonly','true');
  }
  setVM(vm,false);
  renderAttT();
}

function buildTeacherSubjTabs(){
  const wrap=document.getElementById('att-subj-tabs');
  const inner=document.getElementById('att-subj-tabs-inner');
  if(!wrap||!inner)return;
  const allSubj=getTeacherSubjects(curUser);
  if(!allSubj.length){wrap.style.display='none';return;}
  wrap.style.display='block';
  inner.innerHTML=allSubj.map(s=>{
    const isActive=teacherActiveSubj&&teacherActiveSubj.subjId===s.subjId&&teacherActiveSubj.gid===s.gid;
    return`<button onclick="selectTeacherSubj('${s.gid}','${s.subjId}')"
      style="white-space:nowrap;padding:6px 12px;border-radius:20px;border:2px solid ${isActive?'var(--blue)':'var(--border)'};
      background:${isActive?'var(--blue)':'#fff'};color:${isActive?'#fff':'var(--text)'};
      font-size:.75rem;font-weight:700;cursor:pointer;transition:.15s">
      📚 ${s.subjName}<br><span style="font-size:.62rem;font-weight:400;opacity:.85">${s.groupName}</span>
    </button>`;
  }).join('');
  // Auto-select first if none active
  if(!teacherActiveSubj&&allSubj.length){
    const s=allSubj[0];
    selectTeacherSubj(s.gid,s.subjId,false);
  }
}

function selectTeacherSubj(gid,subjId,doRender=true){
  const t=curUser;
  const gp=(t.groupPerms||{})[gid];
  const subj=(gp?.subjects||[]).find(s=>s.id===subjId);
  teacherActiveSubj={gid,subjId,subjName:subj?.name||'',_subjObj:subj};
  // Also update curUser.activeSubject for getAllowedLessonIds
  curUser.activeSubject=teacherActiveSubj;
  attGid=gid;
  if(doRender){
    renderAtt();
  }
}
function setVM(mode,doR=true){
  // Teachers can view BOTH day and month, but only edit today
  // (no restriction on mode switching — only clickC blocks editing)
  if(curUser?.type!=='admin'&&mode==='day'){
    // Reset day to today for teachers
    const now=new Date();aY=now.getFullYear();aM=now.getMonth();aD=now.getDate();
  }
  vm=mode;
  document.getElementById('vt-d').classList.toggle('active',mode==='day');
  document.getElementById('vt-m').classList.toggle('active',mode==='month');
  document.getElementById('vt-r')?.classList.toggle('active',mode==='range');
  document.getElementById('cd').style.display=mode==='day'?'block':'none';
  document.getElementById('cm').style.display=mode==='month'?'block':'none';
  const crEl=document.getElementById('cr'); if(crEl) crEl.style.display=mode==='range'?'block':'none';
  // Always show view toggle tabs
  const vtEl=document.querySelector('.vt');
  if(vtEl)vtEl.style.display='flex';
  if(doR)renderAttT();
}
function updDL(){const d=new Date(aY,aM,aD);document.getElementById('d-lbl').textContent=`${aD} ${MN[aM]}, ${DN[d.getDay()]}`;document.getElementById('d-pick').value=`${aY}-${p2(aM+1)}-${p2(aD)}`;}
function dSh(n){
  if(curUser?.type!=='admin'){toast('Шумо танҳо санаи имрӯзро тағйир дода метавонед!');return;}
  const d=new Date(aY,aM,aD+n);aY=d.getFullYear();aM=d.getMonth();aD=d.getDate();updDL();renderAttT();
}
function onDP(){
  const v=document.getElementById('d-pick').value;if(!v)return;
  if(curUser?.type!=='admin'){
    // Reset to today
    const now=new Date();
    document.getElementById('d-pick').value=`${now.getFullYear()}-${p2(now.getMonth()+1)}-${p2(now.getDate())}`;
    toast('Шумо танҳо санаи имрӯзро тағйир дода метавонед!');return;
  }
  const[y,m,d]=v.split('-').map(Number);aY=y;aM=m-1;aD=d;updDL();renderAttT();
}
function updML(){document.getElementById('m-lbl').textContent=MN[aM]+' '+aY;}
function mSh(n){
  // Teachers can navigate months for viewing (read-only)
  aM+=n;if(aM<0){aM=11;aY--;}if(aM>11){aM=0;aY++;}
  updML();renderAttT();
  // Show read-only badge when teacher views non-current month
  if(curUser?.type!=='admin'){
    const now=new Date();const isCurrentMonth=(aY===now.getFullYear()&&aM===now.getMonth());
    const badge=document.getElementById('month-view-badge');
    if(badge)badge.style.display=isCurrentMonth?'none':'block';
  }
}

function renderAttT(){if(vm==='day')renderDayT();else if(vm==='month')renderMonthT();else renderRangeT();}
function renderDayT(){
  updDL();const g=db.groups.find(x=>x.id===attGid);if(!g)return;
  const currentDate = new Date(aY, aM, aD);
  const lessons = getAllowedLessons(attGid, currentDate);
  if(lessons.length===0){
    const dayName = DN_FULL[currentDate.getDay()];
    document.getElementById('att-t').innerHTML=`<tr><td colspan="10" class="empty">Барои ${g.name} дар ${dayName} (${aD} ${MN[aM]}) ягон дарс танзим нашудааст</td></tr>`;
    return;
  }
  const att=db.attendance[attGid]||{};const sorted=sortS(g.students||[]);const sun=isSun(aY,aM,aD);
  let h=`<thead><tr><th class="nc">№ Донишҷӯ</th>`;
  lessons.forEach(l=>h+=`<th style="min-width:46px;font-size:.72rem${sun?';background:#dc2626':''}">${l.name}<br><span style="font-size:.58rem;opacity:.8">${l.time||''}</span></th>`);
  h+=`<th class="sc">Ҷамъ</th></tr></thead><tbody>`;
  sorted.forEach((s,idx)=>{
    let n=0,b=0,u=0;h+=`<tr><td class="nc"><div style="font-size:.77rem;font-weight:700">${idx+1}. ${s.last}</div><div style="font-size:.67rem;color:var(--muted)">${s.first}</div></td>`;
    lessons.forEach(l=>{const k=aKey(s.id,aY,aM+1,aD,l.id);const st=normSt(att[k]);let cls='ce',lb='—';if(st==='absent'){cls='ca';lb='Н';n++;}else if(st==='sick'){cls='cs';lb='Б';b++;}else if(st==='excused'){cls='cu';lb='У';u++;}h+=`<td${sun?' class="snd"':''}><div class="ac ${cls}" onclick="clickC('${s.id}',${aY},${aM+1},${aD},'${l.id}')">${lb}</div></td>`;});
    h+=`<td class="sc"><span class="sn2">Н:${n}</span> <span class="sb2">Б:${b}</span> <span class="su2">У:${u}</span></td></tr>`;
  });
  document.getElementById('att-t').innerHTML=h+'</tbody>';
}
function renderMonthT(){
  updML();const g=db.groups.find(x=>x.id===attGid);if(!g)return;
  const att=db.attendance[attGid]||{};const sorted=sortS(g.students||[]);const dM=dimF(aY,aM);

  // Per-day lessons — respect schedule, NO fallback to all lessons
  const lessonsByDay=[];
  for(let d=1;d<=dM;d++){
    if(isSun(aY,aM,d)){lessonsByDay.push([]);continue;}
    lessonsByDay.push(getAllowedLessons(attGid,new Date(aY,aM,d)));
  }
  const hasAny=lessonsByDay.some(ls=>ls.length>0);
  if(!hasAny&&curUser?.type==='teacher'){
    document.getElementById('att-t').innerHTML='<tr><td colspan="10" class="empty">Ин моҳ барои ин гурӯҳ ягон дарс танзим нашудааст</td></tr>';return;
  }

  let h='<thead><tr><th class="nc" rowspan="2" style="vertical-align:middle;font-size:.74rem">№ Донишҷӯ</th>';
  for(let d=1;d<=dM;d++){
    const sun=isSun(aY,aM,d);
    const dayName=DN[new Date(aY,aM,d).getDay()];
    const ls=lessonsByDay[d-1];
    const lc=sun?1:Math.max(1,ls.length);
    if(sun){
      h+=`<th colspan="1" style="font-size:.62rem;border-left:2px solid rgba(255,255,255,.4);background:#dc2626;min-width:22px">${d}<br><span style="font-size:.55rem;opacity:.9">${dayName}</span></th>`;
    }else{
      h+=`<th colspan="${lc}" style="font-size:.62rem;border-left:2px solid rgba(255,255,255,.4);min-width:${lc*24}px">${d}<br><span style="font-size:.55rem;opacity:.8">${dayName}</span></th>`;
    }
  }
  h+=`<th class="sc" rowspan="2" style="vertical-align:middle;font-size:.62rem">Ҷамъ</th></tr><tr>`;
  for(let d=1;d<=dM;d++){
    const sun=isSun(aY,aM,d);const ls=lessonsByDay[d-1];
    if(sun){
      h+=`<th style="font-size:.55rem;padding:2px 1px;min-width:22px;background:#ef4444;border-left:2px solid rgba(255,255,255,.4)">—</th>`;
    }else if(!ls.length){
      h+=`<th style="font-size:.55rem;padding:2px 1px;min-width:22px;background:rgba(255,255,255,.05);color:rgba(255,255,255,.25)">—</th>`;
    }else{
      ls.forEach((l,li)=>{
        h+=`<th ${li===0?'class="ds" ':''} style="font-size:.57rem;padding:2px 1px;min-width:24px;background:rgba(255,255,255,.13)">${l.name.replace('-дарс','')}</th>`;
      });
    }
  }
  h+='</tr></thead><tbody>';
  sorted.forEach((s,idx)=>{
    let n=0,b=0,u=0;
    h+=`<tr><td class="nc"><div style="font-size:.74rem;font-weight:700">${idx+1}. ${s.last}</div><div style="font-size:.64rem;color:var(--muted)">${s.first}</div></td>`;
    for(let d=1;d<=dM;d++){
      const sun=isSun(aY,aM,d);const ls=lessonsByDay[d-1];
      if(sun){
        h+=`<td class="snd" style="padding:2px 1px;border-left:2px solid #fca5a5"><div style="width:20px;height:18px;margin:auto;background:#fca5a5;border-radius:4px;font-size:.6rem;display:flex;align-items:center;justify-content:center;color:#fff">—</div></td>`;
      }else if(!ls.length){
        h+=`<td style="padding:2px 1px"><div style="width:22px;height:19px;margin:auto;border-radius:4px;background:#f1f5f9"></div></td>`;
      }else{
        ls.forEach((l,li)=>{
          const k=aKey(s.id,aY,aM+1,d,l.id);const st=normSt(att[k]);
          let cls='ce',lb='—';
          if(st==='absent'){cls='ca';lb='Н';n++;}else if(st==='sick'){cls='cs';lb='Б';b++;}else if(st==='excused'){cls='cu';lb='У';u++;}
          const isToday=(()=>{const now=new Date();return aY===now.getFullYear()&&aM===now.getMonth()&&d===now.getDate();})();
          const cellClickable=curUser?.type==='admin'||isToday;
          h+=`<td class="${li===0?'ds':''}" style="padding:2px 1px"><div class="ac ${cls}" style="width:22px;height:19px;font-size:.63rem;${!cellClickable?'cursor:default;opacity:'+(cls==='ce'?'.35':'1')+';':''}" ${cellClickable?`onclick="clickC('${s.id}',${aY},${aM+1},${d},'${l.id}')"`:''}>${lb}</div></td>`;
        });
      }
    }
    h+=`<td class="sc"><span class="sn2">Н:${n}</span><br><span class="sb2">Б:${b}</span><br><span class="su2">У:${u}</span></td></tr>`;
  });
  document.getElementById('att-t').innerHTML=h+'</tbody>';
}

function onRangeApply(){
  const f=document.getElementById('r-from')?.value;
  const t=document.getElementById('r-to')?.value;
  if(!f||!t){toast('Санаҳоро интихоб кунед!');return;}
  const d1=new Date(f);const d2=new Date(t);
  if(isNaN(d1)||isNaN(d2)){toast('Сана нодуруст!');return;}
  if(d1>d2){toast('Аз сана бояд хурдтар бошад!');return;}
  // Limit range to avoid huge tables
  const days=Math.floor((d2-d1)/86400000)+1;
  if(days>31){toast('Диапазон калон аст (зиёда аз 31 рӯз). Лутфан кӯтоҳ кунед.');return;}
  rFrom=f;rTo=t;
  renderAttT();
}

// Range state
let rFrom=null, rTo=null;

function renderRangeT(){
  const g=db.groups.find(x=>x.id===attGid);if(!g)return;
  // Default dates: last 7 days
  if(!rFrom||!rTo){
    const d2=new Date();
    const d1=new Date();d1.setDate(d2.getDate()-6);
    rFrom=`${d1.getFullYear()}-${p2(d1.getMonth()+1)}-${p2(d1.getDate())}`;
    rTo=`${d2.getFullYear()}-${p2(d2.getMonth()+1)}-${p2(d2.getDate())}`;
    const rf=document.getElementById('r-from');const rt=document.getElementById('r-to');
    if(rf)rf.value=rFrom;if(rt)rt.value=rTo;
  }
  const rf=document.getElementById('r-from');const rt=document.getElementById('r-to');
  if(rf && !rf.value) rf.value=rFrom;
  if(rt && !rt.value) rt.value=rTo;

  // Show view badge (range is view-only)
  const badge=document.getElementById('range-view-badge');
  if(badge) badge.style.display='block';

  const d1=new Date(rFrom);const d2=new Date(rTo);
  const days=Math.floor((d2-d1)/86400000)+1;
  if(days<=0){document.getElementById('att-t').innerHTML='<tr><td colspan="10" class="empty">Диапазон нодуруст</td></tr>';return;}
  if(days>31){document.getElementById('att-t').innerHTML='<tr><td colspan="10" class="empty">Диапазон калон аст (зиёда аз 31 рӯз)</td></tr>';return;}

  const att=db.attendance[attGid]||{};
  const sorted=sortS(g.students||[]);
  // Build list of dates
  const dates=[];
  for(let k=0;k<days;k++){
    const d=new Date(d1);d.setDate(d1.getDate()+k);
    dates.push(d);
  }
  // Precompute lessons per date (permission-aware)
  const lessonsByDate=dates.map(d=>{
    const sun=isSun(d.getFullYear(),d.getMonth(),d.getDate());
    if(sun) return {date:d,sun:true,lessons:[]};
    const ls=getAllowedLessons(attGid,d);
    return {date:d,sun:false,lessons:ls};
  });

  // Header
  let h='<thead><tr><th class="nc" rowspan="2" style="vertical-align:middle;font-size:.74rem">№ Донишҷӯ</th>';
  lessonsByDate.forEach(obj=>{
    const d=obj.date;
    const day=d.getDate();
    const mon=MN[d.getMonth()];
    const dayName=DN[d.getDay()];
    if(obj.sun){
      h+=`<th colspan="1" style="font-size:.62rem;border-left:2px solid rgba(255,255,255,.4);background:#dc2626;min-width:22px">${day}<br><span style="font-size:.55rem;opacity:.9">${dayName}</span></th>`;
    }else{
      const lc=(obj.lessons||[]).length || 1;
      h+=`<th colspan="${lc}" style="font-size:.62rem;border-left:2px solid rgba(255,255,255,.4);min-width:${lc*24}px">${day} ${mon}<br><span style="font-size:.55rem;opacity:.8">${dayName}</span></th>`;
    }
  });
  h+=`<th class="sc" rowspan="2" style="vertical-align:middle;font-size:.62rem">Ҷамъ</th></tr><tr>`;
  lessonsByDate.forEach(obj=>{
    if(obj.sun){
      h+=`<th class="snh" style="font-size:.6rem">—</th>`;
    }else{
      const ls=obj.lessons||[];
      if(ls.length===0){
        h+=`<th style="font-size:.6rem;opacity:.7">—</th>`;
      }else{
        ls.forEach((l,li)=>h+=`<th style="font-size:.6rem;opacity:.9">${l.name.replace('дарс','')}</th>`);
      }
    }
  });
  h+='</tr></thead><tbody>';

  // Body (view-only)
  sorted.forEach((s,idx)=>{
    let n=0,b=0,u=0;
    h+=`<tr><td class="nc"><div style="font-size:.77rem;font-weight:700">${idx+1}. ${s.last}</div><div style="font-size:.67rem;color:var(--muted)">${s.first}</div></td>`;
    lessonsByDate.forEach(obj=>{
      const d=obj.date;
      const y=d.getFullYear(), m=d.getMonth()+1, dd=d.getDate();
      if(obj.sun){
        h+=`<td class="snd">—</td>`;
        return;
      }
      const ls=obj.lessons||[];
      if(ls.length===0){
        h+=`<td class="ce">—</td>`;
        return;
      }
      ls.forEach(l=>{
        const k=aKey(s.id,y,m,dd,l.id);
        const v=att[k];
        const st=normSt(v)||'present';
        if(st==='absent')n++; else if(st==='sick')b++; else if(st==='excused')u++;
        let cls='ce',lb='—';
        if(st==='absent'){cls='ca';lb='Н';}
        else if(st==='sick'){cls='cs';lb='Б';}
        else if(st==='excused'){cls='cu';lb='У';}
        h+=`<td><div class="ac ${cls}">${lb}</div></td>`;
      });
    });
    h+=`<td class="sc">${n?`<span class="sn2">Н:${n}</span>`:''}${b?` <span class="sb2">Б:${b}</span>`:''}${u?` <span class="su2">У:${u}</span>`:''}</td></tr>`;
  });
  h+='</tbody>';
  document.getElementById('att-t').innerHTML=h;
}


function clickC(sid,y,m,d,lid){
  if(curUser?.type==='subadmin'){
    // SubAdmin: READ-ONLY, тағйир дода наметавонад
    toast('👁 Шумо танҳо дидан мекунед — тағйир дода намешавад');return;
  }
  if(curUser?.type!=='admin'){
    // Teacher: only TODAY is editable
    const now=new Date();const ny=now.getFullYear(),nm=now.getMonth()+1,nd=now.getDate();
    if(y!==ny||m!==nm||d!==nd){
      toast('Шумо танҳо санаи имрӯзро тағйир дода метавонед!');return;
    }
    const currentDate=new Date(y,m-1,d);
    const allowed=getAllowedLessonIds(attGid,currentDate);
    if(!allowed.includes(lid)){toast('Шумо ба ин дарс дастрасӣ надоред');return;}
  }
  pCell={sid,key:aKey(sid,y,m,d,lid)};
  const g=db.groups.find(x=>x.id===attGid);
  const s=g?.students.find(x=>x.id===sid);
  const l=getLessons(attGid).find(x=>x.id===lid);

  // Show "Примечание": who marked the status (for admin)
  const rec=(db.attendance?.[attGid]||{})[pCell.key];
  const meta=normBy(rec);
  const noteEl=document.getElementById('m-st-note');
  if(noteEl){
    const stNow=normSt(rec);
    if(meta && stNow && stNow!=='present'){
      const subj = meta.subject ? ` · ${meta.subject}` : '';
      const when = meta.at ? new Date(meta.at).toLocaleString('ru-RU') : '';
      noteEl.style.display='block';
      noteEl.innerHTML =
        `<div style="font-weight:800;margin-bottom:6px;font-size:.82rem">📝 Ки монда шудааст</div>`+
        `<div style="display:grid;grid-template-columns:auto 1fr;gap:3px 10px;font-size:.76rem">`+
        `<span style="color:var(--muted)">Омӯзгор:</span><b>${meta.who}</b>`+
        (meta.subject?`<span style="color:var(--muted)">Фан:</span><b style="color:var(--blue-d)">📚 ${meta.subject}</b>`:'<span></span><span></span>')+
        `<span style="color:var(--muted)">ID:</span><span>${meta.tid||'—'}</span>`+
        `<span style="color:var(--muted)">Тел:</span><span>${meta.phone||'—'}</span>`+
        (l?.name?`<span style="color:var(--muted)">Дарс:</span><span>${l.name}${l.time?' ('+l.time+')':''}</span>`:'')+
        (when?`<span style="color:var(--muted)">Вақт:</span><span>${when}</span>`:'')+
        `</div>`;
    }else if(curUser?.type==='admin' && stNow && stNow!=='present'){
      // Old records (no meta)
      noteEl.style.display='block';
      noteEl.innerHTML =
        `<div style="font-weight:800;margin-bottom:4px">📝 Примечание</div>`+
        `<div style="color:var(--muted)">Маълумот нест (ин сабт дар версияи кӯҳна монда шудааст)</div>`;
    }else{
      noteEl.style.display='none';
      noteEl.textContent='';
    }
  }

  document.getElementById('m-st-t').textContent=`${s?.last} ${s?.first} | ${d} ${MN[m-1]} | ${l?.name||lid}`;
  openModal('m-st');
}
function setSt(st){
  if(!pCell)return;
  if(!db.attendance[attGid])db.attendance[attGid]={};

  let payload=null;
  if(st==='present'){
    delete db.attendance[attGid][pCell.key];
    payload=null; // null = delete from Supabase
  }else{
    payload={
      st,
      by: curUser?.type==='admin'?'admin':(curUser?.id||''),
      byName: curUser?.type==='admin'?'Админ':((curUser?.last||'')+' '+(curUser?.first||'')).trim(),
      subject: curUser?.activeSubject?.subjName||curUser?.subject||'',
      byTid: curUser?.tid!=null?String(curUser.tid):'',
      byPhone: curUser?.phone||'',
      at: Date.now()
    };
    db.attendance[attGid][pCell.key]=payload;
  }

  // 1. Save to localStorage immediately (fast)
  localStorage.setItem('dav7',JSON.stringify(db));

  // 2. Save THIS SINGLE CELL to Supabase (granular — no conflict!)
  // Other users get update via Realtime subscription automatically
  sbSetAtt(attGid, pCell.key, payload)
    .then(ok => { if(ok) updateSyncStatus('online'); else updateSyncStatus('offline'); })
    .catch(e => { console.warn('att save err',e); updateSyncStatus('offline'); });

  closeModal('m-st');
  renderAttT();
}
function refreshAttFromCloud(){
  if(!sbConfigured()){toast('Supabase пайваст нест');return;}
  if(!attGid){return;}
  const btn=document.getElementById('att-refresh-btn');
  if(btn)btn.textContent='⏳';
  sbLoadAtt(attGid).then(attData=>{
    if(attData!==null){
      db.attendance[attGid]=attData;
      localStorage.setItem('dav7',JSON.stringify(db));
      renderAttT?.();
      toast('✅ Нав шуд');
    } else {
      toast('⚠️ Cloud-аз гирифта нашуд');
    }
    if(btn)btn.textContent='🔄';
  });
}

function expAtt(){
  const g=db.groups.find(x=>x.id===attGid);if(!g)return;
  // For teachers in month view: use all allowed lessons (not tied to specific date)
  const currentDate = vm==='day' ? new Date(aY, aM, aD) : null;
  const lessons = getAllowedLessons(attGid, currentDate);
  if(lessons.length===0){toast('Дарс барои экспорт нест');return;}
  const att=db.attendance[attGid]||{};const sorted=sortS(g.students||[]);
  let c='\uFEFF'+`Давомот: ${g.name}`;
  if(vm==='day'){c+=` — ${aD} ${MN[aM]} ${aY}\n\nДонишҷӯ`;lessons.forEach(l=>c+=`,${l.name}`);c+=',Н,Б,У\n';sorted.forEach(s=>{let row=`"${s.last} ${s.first}"`,n=0,b=0,u=0;lessons.forEach(l=>{const st=normSt(att[aKey(s.id,aY,aM+1,aD,l.id)]);let lb='';if(st==='absent'){lb='Н';n++;}else if(st==='sick'){lb='Б';b++;}else if(st==='excused'){lb='У';u++;}row+=`,${lb}`;});c+=row+`,${n},${b},${u}\n`;});dl(c,`${g.name}_${aD}_${MN[aM]}_${aY}.csv`,'text/csv;charset=utf-8');}
  else{const dM=dimF(aY,aM);c+=` — ${MN[aM]} ${aY}\n\nДонишҷӯ`;for(let d=1;d<=dM;d++)lessons.forEach(l=>c+=`,${d}/${l.name}`);c+=',Жами Н,Жами Б,Жами У\n';sorted.forEach(s=>{let row=`"${s.last} ${s.first}"`,n=0,b=0,u=0;for(let d=1;d<=dM;d++)lessons.forEach(l=>{const st=normSt(att[aKey(s.id,aY,aM+1,d,l.id)]);let lb='';if(st==='absent'){lb='Н';n++;}else if(st==='sick'){lb='Б';b++;}else if(st==='excused'){lb='У';u++;}row+=`,${lb}`;});c+=row+`,${n},${b},${u}\n`;});dl(c,`${g.name}_${MN[aM]}_${aY}.csv`,'text/csv;charset=utf-8');}
  toast('Excel ✅');
}

// ============================================
//  SMS (with per-group schedule)
// ============================================
let smsY=new Date().getFullYear(),smsM=new Date().getMonth(),smsD=new Date().getDate(),smsShift=0;
function setSmsShift(n){
  smsShift=n;
  document.querySelectorAll('#sms-shift-seg .seg-b').forEach((b,i)=>b.classList.toggle('active',i===n));
  popSMSGroups();renderSMS();
}
function popSMSGroups(){
  const sel=document.getElementById('sms-gid');const groups=getVisibleGroups().filter(g=>smsShift===0||g.shift===smsShift);
  sel.innerHTML='<option value="">— Ҳама —</option>'+groups.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
}
function renderSMSCtrl(){
  const mode=document.getElementById('sms-mode').value;
  document.getElementById('sms-dc').style.display=mode==='day'?'flex':'none';
  document.getElementById('sms-mc').style.display=mode==='month'?'flex':'none';
  updSmsD();updSmsM();renderSMS();
}
function updSmsD(){document.getElementById('sms-dl').textContent=`${smsD} ${MN[smsM]}`;document.getElementById('sms-dp').value=`${smsY}-${p2(smsM+1)}-${p2(smsD)}`;}
function updSmsM(){document.getElementById('sms-ml').textContent=MN[smsM]+' '+smsY;}
function smsDSh(n){const d=new Date(smsY,smsM,smsD+n);smsY=d.getFullYear();smsM=d.getMonth();smsD=d.getDate();updSmsD();renderSMS();}
function smsMS(n){smsM+=n;if(smsM<0){smsM=11;smsY--;}if(smsM>11){smsM=0;smsY++;}updSmsM();renderSMS();}
function onSmsDP(){const v=document.getElementById('sms-dp').value;if(!v)return;const[y,m,d]=v.split('-').map(Number);smsY=y;smsM=m-1;smsD=d;updSmsD();renderSMS();}

function renderSMS(){
  const gid=document.getElementById('sms-gid').value;
  const mode=document.getElementById('sms-mode').value;
  let groups=getVisibleGroups().filter(g=>smsShift===0||g.shift===smsShift);
  if(gid)groups=groups.filter(x=>x.id===gid);
  let rows=[];
  groups.forEach(g=>{
    const att=db.attendance[g.id]||{};
    const checkDate = mode==='day' ? new Date(smsY, smsM, smsD) : null;
    const lessons = getAllowedLessons(g.id, checkDate);
    if(lessons.length===0) return;
    sortS(g.students||[]).forEach(s=>{
      let abs=[];
      if(mode==='day'){lessons.forEach(l=>{const k=aKey(s.id,smsY,smsM+1,smsD,l.id);const st=normSt(att[k]);if(st&&st!=='present')abs.push({type:st,lesson:l.name,d:smsD,m:smsM+1});});}
      else{const dM=dimF(smsY,smsM);for(let d=1;d<=dM;d++){const dayDate = new Date(smsY, smsM, d); const dayLessons = getAllowedLessons(g.id, dayDate); dayLessons.forEach(l=>{const k=aKey(s.id,smsY,smsM+1,d,l.id);const st=normSt(att[k]);if(st&&st!=='present')abs.push({type:st,lesson:l.name,d,m:smsM+1});});}}
      if(abs.length)rows.push({s,g,abs});
    });
  });
  const c=document.getElementById('sms-list');
  if(!rows.length){c.innerHTML=`<div class="empty"><div class="ei">✅</div><div class="et">Ғоиб нест</div></div>`;c.dataset.rows='[]';return;}
  c.innerHTML=rows.map((r,i)=>{
    const tags=r.abs.slice(0,3).map(a=>`<span class="sms-tag t${a.type==='absent'?'n':a.type==='sick'?'s':'u'}">${a.d}/${a.m} ${a.lesson}: ${a.type==='absent'?'Н':a.type==='sick'?'Б':'У'}</span>`).join(' ');
    return`<div class="sms-row">
      <input type="checkbox" class="sms-chk" id="sc-${i}" checked>
      <div style="flex:1">
        <div style="font-weight:600;font-size:.82rem">${r.s.last} ${r.s.first} <span style="font-size:.68rem;color:var(--muted)">[${r.g.name}]</span></div>
        <div style="font-size:.72rem;color:var(--muted)">${r.s.pphone||r.s.phone||'—'}</div>
        <div style="margin-top:3px;display:flex;flex-wrap:wrap;gap:3px">${tags}${r.abs.length>3?`<span style="font-size:.65rem;color:var(--muted)">+${r.abs.length-3}</span>`:''}</div>
      </div>
    </div>`;
  }).join('');
  c.dataset.rows=JSON.stringify(rows.map(r=>({name:r.s.last+' '+r.s.first,phone:r.s.pphone||r.s.phone||''})));
}
function selAll(v){document.querySelectorAll('.sms-chk').forEach(c=>c.checked=v);}
function expSMSXls(){
  const checks=document.querySelectorAll('.sms-chk');
  const rawRows=document.getElementById('sms-list').dataset.rows;
  if(!rawRows){toast('Рӯйхат холӣ');return;}
  const rows=JSON.parse(rawRows);
  const sel=rows.filter((_,i)=>checks[i]?.checked);
  if(!sel.length){toast('Интихоб нашуд');return;}
  let csv='\uFEFF\u041d\u043e\u043c\u0443 \u043d\u0430\u0441\u0430\u0431,\u0420\u0430\u049b\u0430\u043c\u0438 \u0442\u0435\u043b\u0435\u0444\u043e\u043d\n';
  sel.forEach(r=>csv+=`"${r.name}","${r.phone}"\n`);
  dl(csv,'sms_ghoibon.csv','text/csv;charset=utf-8');toast('Excel: А — Ном, В — Тел ✅');
}

// ============================================
//  STATS (with per-group schedule)
// ============================================
let stY=new Date().getFullYear(),stM=new Date().getMonth(),stD=new Date().getDate(),stShift=0,stGid='';

function setStShift(n){
  stShift=n;stGid='';
  document.querySelectorAll('#st-shift-seg .seg-b').forEach((b,i)=>b.classList.toggle('active',i===n));
  popStGroups();renderStats();
}
function popStGroups(){
  const sel=document.getElementById('st-gid');
  const groups=getVisibleGroups().filter(g=>stShift===0||g.shift===stShift);
  sel.innerHTML='<option value="">— Ҳама гурӯҳ —</option>'+groups.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
}
function onStGid(){stGid=document.getElementById('st-gid').value;renderStats();}
function updStCtrl(){
  const mode=document.getElementById('st-mode').value;
  document.getElementById('st-mc').style.display=mode==='month'?'flex':'none';
  document.getElementById('st-dc').style.display=mode==='day'?'flex':'none';
  const rc=document.getElementById('st-rc');if(rc)rc.style.display=mode==='range'?'flex':'none';
  if(mode==='month')document.getElementById('st-ml').textContent=MN[stM]+' '+stY;
  if(mode==='day'){document.getElementById('st-dl').textContent=stD+' '+MN[stM];document.getElementById('st-dp').value=`${stY}-${p2(stM+1)}-${p2(stD)}`;}
  if(mode==='range'){
    const rf=document.getElementById('st-rf');const rt=document.getElementById('st-rt');
    if(rt&&!rt.value){const d2=new Date();const d1=new Date();d1.setDate(d2.getDate()-29);
      rt.value=`${d2.getFullYear()}-${p2(d2.getMonth()+1)}-${p2(d2.getDate())}`;
      rf.value=`${d1.getFullYear()}-${p2(d1.getMonth()+1)}-${p2(d1.getDate())}`;}
  }
  renderStats();
}
function stMS(n){stM+=n;if(stM<0){stM=11;stY--;}if(stM>11){stM=0;stY++;}document.getElementById('st-ml').textContent=MN[stM]+' '+stY;renderStats();}
function stDS(n){const d=new Date(stY,stM,stD+n);stY=d.getFullYear();stM=d.getMonth();stD=d.getDate();document.getElementById('st-dl').textContent=stD+' '+MN[stM];document.getElementById('st-dp').value=`${stY}-${p2(stM+1)}-${p2(stD)}`;renderStats();}
function onStDP(){const v=document.getElementById('st-dp').value;if(!v)return;const[y,m,d]=v.split('-').map(Number);stY=y;stM=m-1;stD=d;renderStats();}

function keyMatch(k,sid){
  if(!k.startsWith(sid+'_'))return false;
  const mode=document.getElementById('st-mode').value;
  if(mode==='all')return true;
  const dp=k.split('_')[1];const[y,m,d]=dp.split('-').map(Number);
  if(mode==='month')return y===stY&&m===stM+1;
  if(mode==='day')return y===stY&&m===stM+1&&d===stD;
  if(mode==='range'){
    const rf=document.getElementById('st-rf')?.value;
    const rt=document.getElementById('st-rt')?.value;
    if(!rf||!rt)return true;
    const kd=new Date(y,m-1,d);
    return kd>=new Date(rf)&&kd<=new Date(rt);
  }
  return true;
}

function stGetRange(){
  const mode=document.getElementById('st-mode').value;
  if(mode==='day')return{from:new Date(stY,stM,stD),to:new Date(stY,stM,stD)};
  if(mode==='month')return{from:new Date(stY,stM,1),to:new Date(stY,stM,dimF(stY,stM))};
  if(mode==='range'){
    const rf=document.getElementById('st-rf')?.value;
    const rt=document.getElementById('st-rt')?.value;
    if(rf&&rt)return{from:new Date(rf),to:new Date(rt)};
  }
  return null;
}

function pctClr(p){return p>=80?'#22c55e':p>=60?'#f59e0b':'#ef4444';}

// Count total possible lessons for a group in range (ҳамаи имконпазир)
function grpTotalLessons(gid, stuCount){
  const range=stGetRange();
  if(!range)return 0;
  let total=0;
  let d=new Date(range.from);
  const end=new Date(range.to);
  while(d<=end){
    if(d.getDay()!==0){
      const ls=lessonsForDate(gid,d)||[];
      total+=ls.length;
    }
    d.setDate(d.getDate()+1);
  }
  return total*stuCount;
}

// Per-student N/B/U counts from recorded entries
function studNBU(gid, s){
  const att=db.attendance[gid]||{};
  let n=0,b=0,u=0;
  Object.entries(att).forEach(([k,v])=>{
    if(!keyMatch(k,s.id))return;
    const lid=k.split('_')[2];
    const dp=k.split('_')[1];const[y,m,d]=dp.split('-').map(Number);
    const rDate=new Date(y,m-1,d);
    const aIds=getAllowedLessonIds(gid,rDate);
    if(curUser?.type!=='admin'&&aIds&&!aIds.includes(lid))return;
    const st=normSt(v);
    if(st==='absent')n++;else if(st==='sick')b++;else if(st==='excused')u++;
  });
  return{n,b,u};
}

const _stCharts={};
function _destroyChart(id){if(_stCharts[id]){_stCharts[id].destroy();delete _stCharts[id];}}

function renderStats(){
  const mode=document.getElementById('st-mode').value;
  const groups=getVisibleGroups().filter(g=>stShift===0||g.shift===stShift).filter(g=>!stGid||g.id===stGid);

  // ── Collect data ──────────────────────────────────────
  let totN=0,totB=0,totU=0,totPossible=0;
  let grpData=[];

  groups.forEach(g=>{
    const studs=g.students||[];
    let gN=0,gB=0,gU=0;
    const studRows=[];
    studs.forEach(s=>{
      const{n,b,u}=studNBU(g.id,s);
      gN+=n;gB+=b;gU+=u;
      studRows.push({s,n,b,u});
    });
    totN+=gN;totB+=gB;totU+=gU;
    // Total possible lessons for group in range
    const gPoss=grpTotalLessons(g.id,studs.length);
    totPossible+=gPoss;
    // If no schedule data (mode=all or gPoss=0), fallback: use recorded
    const gTot=gPoss>0?gPoss:(gN+gB+gU);
    const gAtt=Math.max(0,gTot-gN-gB-gU);
    const gPct=gTot>0?Math.round(gAtt/gTot*100):null;
    const gPctN=gTot>0?Math.round(gN/gTot*100):0;
    const gPctB=gTot>0?Math.round(gB/gTot*100):0;
    const gPctU=gTot>0?Math.round(gU/gTot*100):0;
    grpData.push({g,gN,gB,gU,gTot,gAtt,gPct,gPctN,gPctB,gPctU,studs,studRows});
  });

  const totAtt=Math.max(0,totPossible>0?totPossible-totN-totB-totU:0);
  const totTot=totPossible>0?totPossible:(totN+totB+totU);
  const totPct=totTot>0?Math.round(totAtt/totTot*100):null;
  const pctTxt=totPct!=null?totPct+'%':'—';
  const pctC=totPct!=null?pctClr(totPct):'#94a3b8';

  // ── Summary boxes ─────────────────────────────────────
  document.getElementById('st-sum').innerHTML=`
    <div class="dash-sbox"><div class="dash-snum" style="color:#ef4444">${totN}</div><div class="dash-slbl">🔴 Набуд</div></div>
    <div class="dash-sbox"><div class="dash-snum" style="color:#f59e0b">${totB}</div><div class="dash-slbl">🟡 Бемор</div></div>
    <div class="dash-sbox"><div class="dash-snum" style="color:#3b82f6">${totU}</div><div class="dash-slbl">🔵 Узр</div></div>
    <div class="dash-sbox"><div class="dash-snum" style="color:${pctC}">${pctTxt}</div><div class="dash-slbl">✅ Иштирок</div></div>`;

  // ── Chart.js charts ───────────────────────────────────
  _renderCharts(grpData, totN, totB, totU, totAtt, mode, groups);

  // ── Group dashboard cards ─────────────────────────────
  const sorted=[...grpData].sort((a,b)=>(b.gPct??-1)-(a.gPct??-1));
  const medals=['🥇','🥈','🥉'];
  const grid=document.getElementById('st-grp-grid');
  if(grid){
    if(!sorted.length){
      grid.innerHTML='<div style="padding:30px;text-align:center;color:#94a3b8;font-size:.85rem">Маълумот нест</div>';
    } else {
      grid.innerHTML=sorted.map(({g,gN,gB,gU,gTot,gAtt,gPct,gPctN,gPctB,gPctU},idx)=>{
        const pc=gPct??0;const cl=pctClr(pc);
        const bClr=idx===0?'#22c55e':idx===1?'#f59e0b':idx===2?'#3b82f6':'#cbd5e1';
        const shBg=g.shift===2?'linear-gradient(135deg,#f97316,#ea580c)':'linear-gradient(135deg,#3b82f6,#1d4ed8)';
        const rank=idx<3?medals[idx]:`${idx+1}`;
        const stuC=(g.students||[]).length;
        return`<div class="dash-grp-card" style="border-left-color:${bClr}" onclick="stGid='${g.id}';document.getElementById('st-gid').value='${g.id}';renderStats()">
          <div class="dash-grp-top">
            <div class="dash-grp-rank">${rank}</div>
            <div class="dash-grp-info">
              <div class="dash-grp-name">${g.name}</div>
              <div class="dash-grp-meta">
                <span style="background:${shBg};color:#fff;border-radius:4px;padding:1px 6px;font-size:.58rem;font-weight:700">Баст ${g.shift||1}</span>
                <span>${stuC} донишҷӯ</span>
                <span style="color:#ef4444">Н:${gN}</span>·<span style="color:#f59e0b">Б:${gB}</span>·<span style="color:#3b82f6">У:${gU}</span>
              </div>
            </div>
            <div class="dash-grp-pct">
              <div class="dash-grp-pct-big" style="color:${cl}">${gPct!=null?pc+'%':'—'}</div>
              <div class="dash-grp-pct-lbl" style="color:${cl}">иштирок</div>
            </div>
          </div>
          <div class="dash-grp-bars">
            <div class="dash-bar-row">
              <span class="dash-bar-lbl" style="color:#ef4444">🔴 Набуд:${gN}</span>
              <div class="dash-bar-bg"><div class="dash-bar-fill" style="width:${gPctN}%;background:#ef4444"></div></div>
              <span class="dash-bar-pct" style="color:#ef4444">${gPctN}%</span>
            </div>
            <div class="dash-bar-row">
              <span class="dash-bar-lbl" style="color:#f59e0b">🟡 Бемор:${gB}</span>
              <div class="dash-bar-bg"><div class="dash-bar-fill" style="width:${gPctB}%;background:#f59e0b"></div></div>
              <span class="dash-bar-pct" style="color:#f59e0b">${gPctB}%</span>
            </div>
            <div class="dash-bar-row">
              <span class="dash-bar-lbl" style="color:#3b82f6">🔵 Узр:${gU}</span>
              <div class="dash-bar-bg"><div class="dash-bar-fill" style="width:${gPctU}%;background:#3b82f6"></div></div>
              <span class="dash-bar-pct" style="color:#3b82f6">${gPctU}%</span>
            </div>
            ${gPct!=null?`<div class="dash-att-row"><span>✅ Иштирок дошт: ${gAtt} дарс</span><span style="font-weight:800;color:${cl}">${pc}%</span></div>
            <div class="dash-att-bar-bg"><div class="dash-att-bar-fill" style="width:${pc}%;background:${cl}"></div></div>`:''}
          </div>
        </div>`;
      }).join('');
    }
  }

  // ── Student detail ─────────────────────────────────────
  const showDet=stGid!=='';
  document.getElementById('st-det-card').style.display=showDet?'block':'none';
  if(showDet){
    const grp=grpData.find(x=>x.g.id===stGid);if(!grp)return;
    document.getElementById('st-det-title').textContent='👤 '+grp.g.name+' — Донишҷӯён';
    const mLabel={all:'Ҳама вақт',month:MN[stM]+' '+stY,day:stD+' '+MN[stM]+' '+stY,range:'Диапазон'}[mode]||'';
    const hint=document.getElementById('st-exp-hint');if(hint)hint.textContent=grp.g.name+' — '+mLabel;
    // Per-student total possible lessons
    const stuPoss=grpTotalLessons(grp.g.id,1);
    const detSorted=[...grp.studRows].map(row=>{
      const sTot=stuPoss>0?stuPoss:(row.n+row.b+row.u);
      const sAtt=Math.max(0,sTot-row.n-row.b-row.u);
      const sPct=sTot>0?Math.round(sAtt/sTot*100):null;
      const pN=sTot>0?Math.round(row.n/sTot*100):0;
      const pB=sTot>0?Math.round(row.b/sTot*100):0;
      const pU=sTot>0?Math.round(row.u/sTot*100):0;
      return{...row,sTot,sAtt,sPct,pN,pB,pU};
    }).sort((a,b)=>(a.sPct??101)-(b.sPct??101));
    document.getElementById('st-det').innerHTML=detSorted.map((row,i)=>{
      const{s,n,b,u,sTot,sAtt,sPct,pN,pB,pU}=row;
      const pc=sPct??0;const cl=pctClr(pc);
      return`<div class="st-srow">
        <div class="st-srow-top">
          <div class="ava" style="width:30px;height:30px;font-size:.7rem;flex-shrink:0">${ini(s)}</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:.78rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${i+1}. ${s.last} ${s.first}</div>
            <div style="font-size:.67rem;color:#64748b">${sTot} дарс · ҳозир: ${sAtt}</div>
          </div>
          <div style="text-align:right;flex-shrink:0;margin-left:8px">
            <div style="font-size:.86rem;font-weight:900;color:${cl}">${sPct!=null?pc+'%':'—'}</div>
            <div style="font-size:.56rem;color:#94a3b8">иштирок</div>
          </div>
        </div>
        ${sTot>0?`<div style="display:flex;flex-direction:column;gap:3px;padding-left:38px">
          <div class="dash-bar-row"><span class="dash-bar-lbl" style="color:#ef4444;width:58px">🔴 Н:${n}</span><div class="dash-bar-bg"><div class="dash-bar-fill" style="width:${pN}%;background:#ef4444"></div></div><span class="dash-bar-pct" style="color:#ef4444">${pN}%</span></div>
          <div class="dash-bar-row"><span class="dash-bar-lbl" style="color:#f59e0b;width:58px">🟡 Б:${b}</span><div class="dash-bar-bg"><div class="dash-bar-fill" style="width:${pB}%;background:#f59e0b"></div></div><span class="dash-bar-pct" style="color:#f59e0b">${pB}%</span></div>
          <div class="dash-bar-row"><span class="dash-bar-lbl" style="color:#3b82f6;width:58px">🔵 У:${u}</span><div class="dash-bar-bg"><div class="dash-bar-fill" style="width:${pU}%;background:#3b82f6"></div></div><span class="dash-bar-pct" style="color:#3b82f6">${pU}%</span></div>
        </div>`:''}
      </div>`;
    }).join('');
  }
}

function _renderCharts(grpData,totN,totB,totU,totAtt,mode,groups){
  if(typeof Chart==='undefined')return;

  // ── PIE ──
  const pieEl=document.getElementById('st-pie');
  _destroyChart('pie');
  if(pieEl){
    const tot=totN+totB+totU+totAtt;
    if(tot>0){
      _stCharts.pie=new Chart(pieEl,{
        type:'doughnut',
        data:{labels:['Набуд','Бемор','Узр','Иштирок'],datasets:[{
          data:[totN,totB,totU,totAtt],
          backgroundColor:['#ef4444','#f59e0b','#3b82f6','#22c55e'],
          borderWidth:3,borderColor:'#fff',hoverOffset:10
        }]},
        options:{responsive:true,maintainAspectRatio:false,cutout:'72%',radius:'85%',animation:{duration:550,easing:'easeOutQuart'},
          plugins:{legend:{position:'bottom',labels:{font:{size:9},padding:6,usePointStyle:true}},
            tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.parsed} (${Math.round(ctx.parsed/tot*100)}%)`}}}}
      });
    } else {
      if(pieEl.parentElement)pieEl.parentElement.querySelector('.dash-chart-title').textContent='🥧 Маълумот нест';
    }
  }

  // ── BAR (stacked) ──
  const barEl=document.getElementById('st-bar');
  _destroyChart('bar');
  if(barEl&&grpData.length){
    const labels=grpData.map(x=>x.g.name.length>9?x.g.name.substr(0,8)+'…':x.g.name);
    _stCharts.bar=new Chart(barEl,{
      type:'bar',
      data:{labels,datasets:[
        {label:'Набуд',data:grpData.map(x=>x.gN),backgroundColor:'rgba(239,68,68,.85)',borderRadius:4,borderSkipped:false,barThickness:10,categoryPercentage:0.65,barPercentage:0.75},
        {label:'Бемор',data:grpData.map(x=>x.gB),backgroundColor:'rgba(245,158,11,.85)',borderRadius:4,borderSkipped:false,barThickness:10,categoryPercentage:0.65,barPercentage:0.75},
        {label:'Узр',data:grpData.map(x=>x.gU),backgroundColor:'rgba(59,130,246,.85)',borderRadius:4,borderSkipped:false,barThickness:10,categoryPercentage:0.65,barPercentage:0.75}
      ]},
      options:{responsive:true,maintainAspectRatio:false,animation:{duration:450,easing:'easeOutQuart'},
        plugins:{legend:{labels:{font:{size:10},usePointStyle:true}},tooltip:{mode:'index',intersect:false}},
        scales:{x:{stacked:true,ticks:{font:{size:8},maxRotation:0,minRotation:0}},y:{stacked:true,beginAtZero:true,ticks:{font:{size:8},maxRotation:0,minRotation:0}}}}
    });
  }

  // ── LINE (daily trend) ──
  const lineEl=document.getElementById('st-line');
  const lineWrap=document.getElementById('st-line-wrap');
  _destroyChart('line');
  const range=stGetRange();
  const from=range?range.from:new Date(stY,stM,1);
  const to=range?range.to:new Date(stY,stM,dimF(stY,stM));
  const days=Math.round((to-from)/86400000)+1;
  if(lineEl&&days<=62){
    if(lineWrap)lineWrap.style.display='block';
    const lbls=[],dN=[],dB=[],dU=[];
    let d=new Date(from);
    while(d<=to){
      if(d.getDay()!==0){
        lbls.push(`${d.getDate()}/${d.getMonth()+1}`);
        let n=0,b=0,u=0;
        groups.forEach(g=>{
          const att=db.attendance[g.id]||{};
          (g.students||[]).forEach(s=>{
            const ls=lessonsForDate(g.id,d)||[];
            ls.forEach(l=>{
              const k=aKey(s.id,d.getFullYear(),d.getMonth()+1,d.getDate(),l.id);
              const st=normSt(att[k]);
              if(st==='absent')n++;else if(st==='sick')b++;else if(st==='excused')u++;
            });
          });
        });
        dN.push(n);dB.push(b);dU.push(u);
      }
      d.setDate(d.getDate()+1);
    }
    _stCharts.line=new Chart(lineEl,{
      type:'line',
      data:{labels:lbls,datasets:[
        {label:'Набуд',data:dN,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.12)',fill:true,tension:.35,pointRadius:2,borderWidth:1.5,pointHoverRadius:4},
        {label:'Бемор',data:dB,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.08)',fill:true,tension:.35,pointRadius:2,borderWidth:1.5,pointHoverRadius:4},
        {label:'Узр',data:dU,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.08)',fill:true,tension:.35,pointRadius:2,borderWidth:1.5,pointHoverRadius:4}
      ]},
      options:{responsive:true,maintainAspectRatio:false,animation:{duration:650,easing:'easeOutCubic'},
        interaction:{mode:'index',intersect:false},
        plugins:{legend:{labels:{font:{size:10},usePointStyle:true}},tooltip:{mode:'index'}},
        scales:{x:{ticks:{font:{size:8},maxTicksLimit:20}},y:{beginAtZero:true,ticks:{font:{size:9}}}}}
    });
  } else if(lineWrap) {
    lineWrap.style.display='none';
  }
}

function expStatsXls(){
  const grp=db.groups.find(x=>x.id===stGid);
  if(!grp){toast('Аввал гурӯҳро интихоб кунед!');return;}
  const mode=document.getElementById('st-mode').value;
  const mLbl={all:'Хама',month:MN[stM]+' '+stY,day:stD+' '+MN[stM]+' '+stY,range:'Диапазон'}[mode]||'';
  const stuPoss=grpTotalLessons(grp.id,1);
  const rows=sortS(grp.students||[]).map(s=>{
    const{n,b,u}=studNBU(grp.id,s);
    const sTot=stuPoss>0?stuPoss:(n+b+u);
    const sAtt=Math.max(0,sTot-n-b-u);
    const sPct=sTot>0?Math.round(sAtt/sTot*100):null;
    return{name:s.last+' '+s.first,n,b,u,sTot,sAtt,pct:sPct};
  }).sort((a,b)=>(a.pct??101)-(b.pct??101));
  let c='\uFEFF';
  c+=`Статистика: ${grp.name}\n`;c+=`Давра: ${mLbl}\n\n`;
  c+=`#,Донишчу,Набуд,Бемор,Узр,Жами дарс,Иштирок дошт,Иштирок %\n`;
  rows.forEach((r,i)=>c+=`${i+1},"${r.name}",${r.n},${r.b},${r.u},${r.sTot},${r.sAtt},${r.pct!=null?r.pct+'%':'—'}\n`);
  dl(c,grp.name+'_'+mLbl.replace(/ /g,'_')+'.csv','text/csv;charset=utf-8');
  toast('Excel экспорт ✅');
}

// ============================================
//  SETTINGS (with per-group schedule editor)
// ============================================
let curShTab=1;
let expandedTeachers = new Set();
let expandedSubjects = new Set();
let teacherSearch = '';
let selectedGroupForSchedule = {}; // tid -> gid

function renderSettings(){renderSbConfig();
  document.getElementById('s-inst').value=db.settings.instName||'';
  document.getElementById('s-tchr').value=db.settings.teacherName||'';
  renderLT();renderTeachers();renderSubAdmins();
}

// ══ SUB-ADMIN MANAGEMENT ══════════════════════════
const SA_PAGES=[
  {id:'groups',  icon:'👥', label:'Гурӯҳҳо'},
  {id:'attendance',icon:'📋', label:'Давомот'},
  {id:'sms',     icon:'📨', label:'SMS'},
  {id:'stats',   icon:'📊', label:'Статистика'},
];

function renderSubAdmins(){
  const list=document.getElementById('sa-list');if(!list)return;
  const sas=db.settings.subAdmins||[];
  if(!sas.length){
    list.innerHTML='<div style="color:var(--muted);font-size:.78rem;padding:8px 3px">Суб-Админ нест</div>';
    return;
  }
  list.innerHTML=sas.map(sa=>{
    const pageLabels=(sa.pages||[]).map(p=>{
      const pg=SA_PAGES.find(x=>x.id===p);
      return pg?`<span style="background:var(--blue-m);color:var(--blue-d);border-radius:5px;padding:1px 6px;font-size:.65rem;font-weight:700">${pg.icon} ${pg.label}</span>`:'';
    }).join(' ');
    return`<div style="background:#fff;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.08);margin-bottom:7px;overflow:hidden">
      <div style="display:flex;align-items:center;gap:10px;padding:11px 13px">
        <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:700;flex-shrink:0">🛡️</div>
        <div style="flex:1">
          <div style="font-weight:700;font-size:.88rem">${sa.name}</div>
          <div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:3px">${pageLabels||'<span style="font-size:.72rem;color:var(--muted)">Саҳифа нест</span>'}</div>
        </div>
        <button class="btn bgh bsm" onclick="openEditSubAdmin('${sa.id}')">✏️ Таҳрир</button>
      </div>
    </div>`;
  }).join('');
}

function addSubAdmin(){
  const name=document.getElementById('sa-name').value.trim();
  const pw=document.getElementById('sa-pw').value.trim();
  if(!name){toast('Номро ворид кунед!');return;}
  if(!pw){toast('Рамзро ворид кунед!');return;}
  const pages=['groups','attendance','sms','stats'].filter(p=>document.getElementById('sap-'+p)?.checked);
  if(!db.settings.subAdmins)db.settings.subAdmins=[];
  db.settings.subAdmins.push({id:uid(),name,pw,pages});
  sv();closeModal('m-addsa');
  document.getElementById('sa-name').value='';
  document.getElementById('sa-pw').value='';
  renderSubAdmins();buildLoginSelect();
  toast('Суб-Админ илова шуд ✅');
}

function openEditSubAdmin(id){
  const sa=(db.settings.subAdmins||[]).find(x=>x.id===id);if(!sa)return;
  document.getElementById('sa-edit-id').value=id;
  document.getElementById('sa-edit-name').value=sa.name||'';
  document.getElementById('sa-edit-pw').value='';
  ['groups','attendance','sms','stats'].forEach(p=>{
    const el=document.getElementById('saep-'+p);
    if(el)el.checked=(sa.pages||[]).includes(p);
  });
  openModal('m-editsa');
}

function saveSubAdmin(){
  const id=document.getElementById('sa-edit-id').value;
  const sa=(db.settings.subAdmins||[]).find(x=>x.id===id);if(!sa)return;
  const name=document.getElementById('sa-edit-name').value.trim();
  if(!name){toast('Номро ворид кунед!');return;}
  sa.name=name;
  const pw=document.getElementById('sa-edit-pw').value.trim();
  if(pw)sa.pw=pw;
  sa.pages=['groups','attendance','sms','stats'].filter(p=>document.getElementById('saep-'+p)?.checked);
  sv();closeModal('m-editsa');renderSubAdmins();buildLoginSelect();
  toast('Нигоҳ шуд ✅');
}

function delSubAdmin(){
  const id=document.getElementById('sa-edit-id').value;
  if(!confirm('Суб-Админро ҳазф кунем?'))return;
  db.settings.subAdmins=(db.settings.subAdmins||[]).filter(x=>x.id!==id);
  sv();closeModal('m-editsa');renderSubAdmins();buildLoginSelect();
  toast('Ҳазф шуд');
}
function saveSets(){db.settings.instName=document.getElementById('s-inst').value;db.settings.teacherName=document.getElementById('s-tchr').value;sv();}
function changeAdminPw(){const pw=document.getElementById('s-newpw').value.trim();if(!pw){toast('Рамзро ворид кунед!');return;}db.settings.adminPw=pw;sv();document.getElementById('s-newpw').value='';toast('Рамз тағйир ёфт ✅');}

function setShTab(n){curShTab=n;document.getElementById('sh-t1').classList.toggle('active',n===1);document.getElementById('sh-t2').classList.toggle('active',n===2);renderLT();}
function renderLT(){
  const lessons=db.settings.shifts[curShTab]||[];const c=document.getElementById('sh-lessons');
  if(!lessons.length){c.innerHTML=`<div style="color:var(--muted);font-size:.78rem;padding:6px">Дарс нест</div>`;return;}
  c.innerHTML=`<div style="background:#fff;border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)">${lessons.map((l,i)=>`<div class="srow2" style="${i===0?'border-radius:var(--r) var(--r) 0 0':''}${i===lessons.length-1?';border-bottom:none;border-radius:0 0 var(--r) var(--r)':''}">
    <div style="display:flex;gap:6px;flex:1"><input class="fc" style="flex:1;max-width:110px" value="${l.name}" oninput="updL('${l.id}','name',this.value)"><input class="fc" type="time" style="width:90px" value="${l.time||''}" oninput="updL('${l.id}','time',this.value)"></div>
    <button class="btn bgh bico" style="margin-left:5px" onclick="delL('${l.id}')">🗑️</button>
  </div>`).join('')}</div>`;
}
function addLesson(){if(!db.settings.shifts[curShTab])db.settings.shifts[curShTab]=[];const n=db.settings.shifts[curShTab].length+1;db.settings.shifts[curShTab].push({id:(curShTab===1?'l':'m')+uid(),name:`${n}-дарс`,time:''});sv();renderLT();}
function updL(id,f,v){[1,2].forEach(sh=>{const l=(db.settings.shifts[sh]||[]).find(x=>x.id===id);if(l){l[f]=v;sv();}});}
function delL(id){db.settings.shifts[curShTab]=db.settings.shifts[curShTab].filter(x=>x.id!==id);sv();renderLT();}

// TEACHERS with per-group schedule editor
const T_COLORS=['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#f97316','#0d9488','#ec4899'];
const DN_SCHEDULE=['Якшанбе','Душанбе','Сешанбе','Чоршанбе','Панҷшанбе','Ҷумъа','Шанбе'];

function renderTeachers(){
  const allTeachers=db.settings.teachers||[];const c=document.getElementById('t-list');
  if(!allTeachers.length){c.innerHTML='<div style="color:var(--muted);font-size:.78rem;padding:10px">Омӯзгор нест</div>';return;}
  // Filter by search
  const sq=(teacherSearch||'').toLowerCase().trim();
  const teachers=sq?allTeachers.filter(t=>(t.last+' '+t.first+' '+(t.subject||'')).toLowerCase().includes(sq)):allTeachers;
  if(!teachers.length){c.innerHTML='<div style="color:var(--muted);font-size:.78rem;padding:10px;text-align:center">🔍 Ёфт нашуд</div>';return;}
  const sortedGroups=[...db.groups].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  c.innerHTML=teachers.map((t,ti)=>{
    const realIdx=allTeachers.indexOf(t);
    const color=T_COLORS[realIdx%T_COLORS.length];
    const gp=t.groupPerms||{};
    const isExpanded = expandedTeachers.has(t.id);
    
    // Get groups that teacher has access to
    const teacherGroups = sortedGroups.filter(g => gp[g.id]?.att === true);
    const currentGid = selectedGroupForSchedule[t.id] || (teacherGroups[0]?.id || '');
    
    // Page perms
    const pagePerms=['sms','stats'].map(p=>{
      const labels={sms:'📨 SMS',stats:'📊 Статистика'};
      const on=(t.perms||[]).includes(p);
      return`<div class="perm-chip ${on?'on':'off'}" onclick="togglePerm('${t.id}','${p}')">${labels[p]}</div>`;
    }).join('');
    const canView=t.canChangeView===true;
    const viewChip=`<div class="perm-chip ${canView?'on':'off'}" onclick="toggleViewPerm('${t.id}')">${canView?'📅 Рӯз/Моҳ':'📅 Танҳо рӯз'}</div>`;
    
    // Per-group — show groups with SUBJECTS list
    const assignedGroups = sortedGroups.filter(g => gp[g.id]?.subjects?.length || gp[g.id]?.att || gp[g.id]?.list);
    const groupRows = assignedGroups.map(g=>{
      const gperm=gp[g.id]||{};
      const subjects=gperm.subjects||[];
      const glist=gperm.list||false;
      const allLessons=getLessons(g.id);
      const expandedSubjKey = t.id+'::'+g.id;
      const subjRows=subjects.map(subj=>{
        // Read per-subject schedule (new model)
        const sc=subj.schedule||{};
        const activeDays=[1,2,3,4,5,6]
          .filter(d=>sc[d]?.enabled&&sc[d]?.lessons?.length)
          .map(d=>{
            const ls=(sc[d].lessons||[]).map(lid=>{
              const l=allLessons.find(x=>x.id===lid);
              return l?l.name.replace('-дарс',''):'?';
            }).join(',');
            return ['','Душ','Сеш','Чор','Пан','Ҷум','Шан'][d]+'('+ls+')';
          }).join(' · ');
        const expandKey=t.id+'::'+g.id+'::'+subj.id;
        const isOpen=expandedSubjects.has(expandKey);
        const schedHTML=isOpen?renderSubjectSchedule(t,g,subj):'';
        return`<div style="border:1px solid var(--border);border-radius:8px;margin-bottom:4px;overflow:hidden">
          <div style="display:flex;align-items:center;gap:5px;padding:6px 9px;background:${isOpen?'var(--blue-l)':'#f8fafc'};cursor:pointer"
            onclick="toggleSubjExpand('${t.id}','${g.id}','${subj.id}')">
            <div style="flex:1">
              <span style="font-size:.76rem;font-weight:700">📚 ${subj.name}</span>
              <span style="font-size:.62rem;color:var(--muted);margin-left:5px">${activeDays||'⚠️ Тақвим танзим нашудааст'}</span>
            </div>
            <span style="font-size:.75rem;color:var(--muted)">${isOpen?'▲':'▼'}</span>
            <button onclick="event.stopPropagation();openTransferSubject('${t.id}','${g.id}','${subj.id}')"
              style="border:none;background:#fef3c7;color:#92400e;border-radius:5px;padding:2px 6px;font-size:.65rem;font-weight:700;cursor:pointer" title="Интиқол">🔄</button>
            <button onclick="event.stopPropagation();removeSubject('${t.id}','${g.id}','${subj.id}')"
              style="border:none;background:#fee2e2;color:#dc2626;border-radius:5px;padding:2px 6px;font-size:.65rem;font-weight:700;cursor:pointer" title="Ҳазф">✕</button>
          </div>
          ${schedHTML}
        </div>`;
      }).join('');
      return`<div style="border-bottom:1px solid var(--border);padding:7px 10px">
        <div style="display:flex;align-items:center;gap:5px;margin-bottom:5px">
          <div style="flex:1;font-size:.78rem;font-weight:700">${g.name}
            <span style="font-size:.66rem;color:var(--muted);font-weight:400"> Баст ${g.shift||1}</span>
          </div>
          <div class="perm-chip ${glist?'on':'off'}" style="font-size:.67rem;padding:2px 8px" onclick="toggleGPerm('${t.id}','${g.id}','list')" title="Рӯйхат">👥 Рӯйхат</div>
          <button onclick="openAddSubject('${t.id}','${g.id}')"
            style="border:none;background:#dcfce7;color:#166534;border-radius:6px;padding:3px 8px;font-size:.72rem;font-weight:700;cursor:pointer">＋ Фан</button>
          <button onclick="removeTeacherGroup('${t.id}','${g.id}')" title="Гурӯҳро ҷудо кун"
            style="border:none;background:#fee2e2;color:#dc2626;border-radius:6px;padding:3px 6px;font-size:.72rem;font-weight:700;cursor:pointer">✕</button>
        </div>
        <div style="padding:0 4px">
          ${subjects.length?subjRows:'<div style="font-size:.72rem;color:var(--muted);font-style:italic;padding:4px 0">Фан вобаста нашудааст — тугмаи "+ Фан" занед</div>'}
        </div>
      </div>`;
    }).join('');
    // Search box to add new group
    const grpSearchBox = `<div style="padding:8px 10px;background:#f8fafc;border-top:1px solid var(--border)">
      <div style="font-size:.68rem;font-weight:700;color:var(--muted);margin-bottom:5px;text-transform:uppercase">＋ Гурӯҳ илова кунед:</div>
      <div style="position:relative">
        <input class="fc" style="font-size:.77rem;padding:6px 10px 6px 30px"
          placeholder="Номи гурӯҳро нависед..."
          id="gsi-${t.id}"
          oninput="showGroupSuggestions('${t.id}',this.value)"
          onfocus="showGroupSuggestions('${t.id}',this.value)"
          autocomplete="off">
        <span style="position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:.8rem;color:var(--muted);pointer-events:none">🔍</span>
      </div>
      <div id="gss-${t.id}" style="margin-top:4px;display:none;border:1px solid var(--border);border-radius:8px;overflow:hidden;max-height:150px;overflow-y:auto;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1)"></div>
    </div>`;
    
    // Schedule now embedded inside each subject card (accordion)
    // No separate section needed
    
    return`<div class="tcrd">
      <div class="tcrd-top" style="cursor:pointer" onclick="toggleTeacherExpand('${t.id}')">
        <div class="t-ava" style="background:${color}">${ini(t)}</div>
        <div style="flex:1">
          <div class="t-name">${t.last} ${t.first}
            ${t.tid?`<span class="t-badge" style="background:#e0f2fe;color:#0369a1">ID: ${t.tid}</span>`:''}
            <span class="t-badge" id="pw-badge-${t.id}" style="background:${color}20;color:${color};cursor:pointer" onclick="togglePwVisible('${t.id}')" title="Рамзро нишон/пинҳон кун">🔒 ••••</span>
          </div>
          <div class="t-sub">${t.subject||'Фан нест'}${t.phone?` · 📞 ${t.phone}`:''}</div>
        </div>
        <div style="display:flex;align-items:center;gap:5px">
          <span style="font-size:.85rem;color:var(--muted)">${isExpanded?'▲':'▼'}</span>
          <button class="btn bgh bxs" onclick="event.stopPropagation();openEditTeacher('${t.id}')" title="Таҳрир">✏️</button>
          <button class="btn br bxs" onclick="event.stopPropagation();delTeacher('${t.id}')" title="Ҳазф">🗑️</button>
        </div>
      </div>
      ${isExpanded ? `
      <div class="perm-toggle" style="border-top:1px solid var(--border)">
        <div style="font-size:.67rem;color:var(--muted);font-weight:700;text-transform:uppercase;width:100%;padding:2px 0 4px">Саҳифаҳо:</div>
        ${pagePerms}${viewChip}
      </div>
      <div style="font-size:.67rem;color:var(--muted);font-weight:700;text-transform:uppercase;padding:6px 12px 3px;border-top:1px solid var(--border)">
        Гурӯҳҳо <span style="font-weight:400;color:var(--muted)">(📋 Давомот · 👥 Рӯйхат)</span>:
      </div>
      <div>
        ${groupRows || '<div style="color:var(--muted);font-size:.75rem;padding:7px 10px;font-style:italic">Гурӯҳ вобаста нашудааст</div>'}
        ${grpSearchBox}
      </div>

      ` : ''}
    </div>`;
  }).join('');
}

function selectGroupForSchedule(tid, gid){
  selectedGroupForSchedule[tid] = gid;
  renderTeachers();
}

// Per-subject schedule renderer (replaces per-group)
function renderSubjectSchedule(t, g, s){
  const allLessons = getLessons(g.id);
  const schedule = s.schedule || {};
  const dateSchedule = s.dateSchedule || {};
  const dateEntries = Object.entries(dateSchedule).sort(([a],[b])=>a.localeCompare(b));

  const weekRows = [1,2,3,4,5,6].map(day=>{
    const dc = schedule[day]||{enabled:false,lessons:[]};
    const on = dc.enabled===true;
    return `<div class="day-row">
      <div class="day-name" style="font-size:.72rem">${DN_SCHEDULE[day]}</div>
      <div class="day-toggle ${on?'on':''}" onclick="toggleSubjDay('${t.id}','${g.id}','${s.id}',${day})"></div>
      <div class="day-lessons">
        ${allLessons.map(l=>{
          const isOn=on&&dc.lessons&&dc.lessons.includes(l.id);
          return `<span class="day-lesson-chip ${isOn?'on':'off'}"
            onclick="toggleSubjDayLesson('${t.id}','${g.id}','${s.id}',${day},'${l.id}')"
            style="${!on?'pointer-events:none':''}">${l.name}</span>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');

  const dateRows = dateEntries.map(([date,cfg])=>`
    <div class="date-row">
      <input type="date" class="date-input" value="${date}"
        onchange="updateSubjDateSched('${t.id}','${g.id}','${s.id}','${date}',this.value)">
      <div class="date-lessons">
        ${allLessons.map(l=>{
          const isOn=cfg.lessons&&cfg.lessons.includes(l.id);
          return `<span class="date-chip ${isOn?'on':'off'}"
            onclick="toggleSubjDateLesson('${t.id}','${g.id}','${s.id}','${date}','${l.id}')">${l.name}</span>`;
        }).join('')}
      </div>
      <button class="date-del" onclick="removeSubjDateSched('${t.id}','${g.id}','${s.id}','${date}')">×</button>
    </div>`).join('');

  return `<div style="margin:6px 10px;border:2px solid var(--blue-m);border-radius:10px;overflow:hidden">
    <div style="background:var(--blue-l);padding:7px 11px;font-size:.76rem;font-weight:700;color:var(--blue-d);display:flex;align-items:center;gap:6px">
      📚 ${s.name} <span style="font-weight:400;color:var(--muted);font-size:.68rem">— ${g.name}</span>
    </div>
    <div style="padding:6px 8px">
      <div style="font-size:.67rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:4px">📆 Рӯзҳои ҳафта</div>
      ${weekRows}
      <div style="font-size:.67rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin:8px 0 4px">📅 Санаҳои махсус</div>
      ${dateRows||'<div style="font-size:.72rem;color:var(--muted);padding:4px 0;font-style:italic">Сана илова нашудааст</div>'}
      <div class="add-date-row" style="border-top:1px dashed #fcd34d;margin-top:6px;padding-top:6px">
        <input type="date" class="date-input" id="nd-${t.id}-${g.id}-${s.id}">
        <button class="btn bb bsm" onclick="addSubjDateSched('${t.id}','${g.id}','${s.id}')">＋ Сана</button>
      </div>
    </div>
  </div>`;
}

function getSubj(tid,gid,sid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return null;
  return ((t.groupPerms||{})[gid]?.subjects||[]).find(s=>s.id===sid)||null;
}
function toggleSubjDay(tid,gid,sid,day){
  const s=getSubj(tid,gid,sid);if(!s)return;
  if(!s.schedule)s.schedule={};
  if(!s.schedule[day])s.schedule[day]={enabled:false,lessons:[]};
  s.schedule[day].enabled=!s.schedule[day].enabled;
  sv();renderTeachers();
}
function toggleSubjDayLesson(tid,gid,sid,day,lid){
  const s=getSubj(tid,gid,sid);if(!s)return;
  if(!s.schedule?.[day])return;
  if(!s.schedule[day].lessons)s.schedule[day].lessons=[];
  const idx=s.schedule[day].lessons.indexOf(lid);
  if(idx>-1)s.schedule[day].lessons.splice(idx,1);
  else s.schedule[day].lessons.push(lid);
  sv();renderTeachers();
}
function addSubjDateSched(tid,gid,sid){
  const inp=document.getElementById(`nd-${tid}-${gid}-${sid}`);
  const date=inp?.value;if(!date){toast('Санаро интихоб кунед!');return;}
  const s=getSubj(tid,gid,sid);if(!s)return;
  if(!s.dateSchedule)s.dateSchedule={};
  if(s.dateSchedule[date]){toast('Ин сана аллакай вуҷуд дорад!');return;}
  s.dateSchedule[date]={lessons:[]};
  sv();renderTeachers();toast('Сана илова шуд ✅');
}
function updateSubjDateSched(tid,gid,sid,oldDate,newDate){
  if(!newDate)return;
  const s=getSubj(tid,gid,sid);if(!s||!s.dateSchedule)return;
  if(s.dateSchedule[newDate]&&oldDate!==newDate){toast('Ин сана аллакай вуҷуд дорад!');renderTeachers();return;}
  s.dateSchedule[newDate]=s.dateSchedule[oldDate];
  delete s.dateSchedule[oldDate];
  sv();renderTeachers();
}
function toggleSubjDateLesson(tid,gid,sid,date,lid){
  const s=getSubj(tid,gid,sid);if(!s||!s.dateSchedule?.[date])return;
  if(!s.dateSchedule[date].lessons)s.dateSchedule[date].lessons=[];
  const idx=s.dateSchedule[date].lessons.indexOf(lid);
  if(idx>-1)s.dateSchedule[date].lessons.splice(idx,1);
  else s.dateSchedule[date].lessons.push(lid);
  sv();renderTeachers();
}
function removeSubjDateSched(tid,gid,sid,date){
  const s=getSubj(tid,gid,sid);if(!s)return;
  delete s.dateSchedule[date];
  sv();renderTeachers();toast('Сана ҳазф шуд');
}

// Old functions kept for backward compat (not called from UI)
function renderScheduleSectionForGroup(){return '';}
function renderDateScheduleSectionForGroup(){return '';}
function selectGroupForSchedule(tid,gid){selectedGroupForSchedule[tid]=gid;renderTeachers();}

function toggleTeacherExpand(tid){
  if(expandedTeachers.has(tid)){expandedTeachers.delete(tid);}
  else{expandedTeachers.add(tid);}
  renderTeachers();
}
function toggleSubjExpand(tid,gid,sid){
  const key=tid+'::'+gid+'::'+sid;
  if(expandedSubjects.has(key)){expandedSubjects.delete(key);}
  else{expandedSubjects.add(key);}
  renderTeachers();
}

// Old group-level schedule functions — replaced by per-subject versions above
function toggleDayEnabledForGroup(){}
function toggleDayLessonForGroup(){}
function addDateScheduleForGroup(){}
function updateDateScheduleForGroup(){}
function toggleDateLessonForGroup(){}
function removeDateScheduleForGroup(){}

function addTeacher(){
  const last=document.getElementById('nt-l').value.trim();const first=document.getElementById('nt-f').value.trim();
  if(!last&&!first){toast('Номро ворид кунед!');return;}
  const pw=document.getElementById('nt-pw').value.trim()||'1234';
  const tid=document.getElementById('nt-tid').value.trim();
  const phone=document.getElementById('nt-phone').value.trim();
  // Check if ID already used
  if(tid&&(db.settings.teachers||[]).some(t=>t.tid===tid)){toast('Ин ID аллакай вуҷуд дорад!');return;}
  const t={id:uid(),tid,phone,last,first,subject:document.getElementById('nt-sub').value.trim(),pw,perms:[],groupPerms:{},canChangeView:false,scheduleByGroup:{},dateScheduleByGroup:{}};
  if(!db.settings.teachers)db.settings.teachers=[];
  db.settings.teachers.push(t);sv();closeModal('m-addt');
  document.getElementById('nt-tid').value='';
  document.getElementById('nt-phone').value='';
  ['nt-l','nt-f','nt-sub','nt-pw'].forEach(id=>document.getElementById(id).value='');
  renderTeachers();buildLoginSelect();toast('Омӯзгор илова шуд ✅');
}
function delTeacher(id){if(!confirm('Ҳазф?'))return;db.settings.teachers=db.settings.teachers.filter(x=>x.id!==id);sv();renderTeachers();buildLoginSelect();toast('Ҳазф шуд');}

// ── Edit teacher name/password ──────────────────────
function togglePwVisible(tid){
  const el=document.getElementById('pw-badge-'+tid);
  if(!el)return;
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(el.dataset.shown==='1'){
    el.textContent='🔒 ••••';
    el.dataset.shown='0';
  } else {
    el.textContent='🔓 '+t.pw;
    el.dataset.shown='1';
    // Auto-hide after 5 seconds
    setTimeout(()=>{if(el.dataset.shown==='1'){el.textContent='🔒 ••••';el.dataset.shown='0';}},5000);
  }
}
function openEditTeacher(tid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  document.getElementById('et-id').value=tid;
  document.getElementById('et-l').value=t.last||'';
  document.getElementById('et-f').value=t.first||'';
  document.getElementById('et-sub').value=t.subject||'';
  document.getElementById('et-tid').value=t.tid||'';
  document.getElementById('et-phone').value=t.phone||'';
  document.getElementById('et-pw').value='';
  openModal('m-edt');
}
function saveEditTeacher(){
  const eid=document.getElementById('et-id').value;
  const t=db.settings.teachers.find(x=>x.id===eid);if(!t)return;
  const l=document.getElementById('et-l').value.trim();
  const f=document.getElementById('et-f').value.trim();
  if(!l&&!f){toast('Номро ворид кунед!');return;}
  if(l)t.last=l;if(f)t.first=f;
  t.subject=document.getElementById('et-sub').value.trim();
  const newTid=document.getElementById('et-tid').value.trim();
  if(newTid&&newTid!==t.tid&&(db.settings.teachers||[]).some(x=>x.id!==eid&&x.tid===newTid)){
    toast('Ин ID аллакай вуҷуд дорад!');return;
  }
  t.tid=newTid;
  t.phone=document.getElementById('et-phone').value.trim();
  const pw=document.getElementById('et-pw').value.trim();
  if(pw)t.pw=pw;
  sv();closeModal('m-edt');renderTeachers();buildLoginSelect();toast('Нигоҳ шуд ✅');
}

// ── Group assignment ────────────────────────────────
function removeTeacherGroup(tid,gid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  delete t.groupPerms[gid];
  sv();renderTeachers();
}

let _gssTimer=null;
function showGroupSuggestions(tid,q){
  const box=document.getElementById('gss-'+tid);if(!box)return;
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  const gp=t.groupPerms||{};
  // Unassigned groups only
  const unassigned=db.groups.filter(g=>!gp[g.id]?.att&&!gp[g.id]?.list);
  const lq=(q||'').toLowerCase().trim();
  const matches=lq
    ? unassigned.filter(g=>g.name.toLowerCase().includes(lq)||String(g.code||'').toLowerCase().includes(lq))
    : unassigned.slice(0,12); // show first 12 when empty
  if(!matches.length){
    box.style.display='none';return;
  }
  box.style.display='block';
  box.innerHTML=matches.map(g=>`
    <div onclick="addGroupToTeacher('${tid}','${g.id}')"
      style="padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border);font-size:.8rem;font-weight:600;display:flex;align-items:center;gap:8px"
      onmouseover="this.style.background='var(--blue-l)'"
      onmouseout="this.style.background=''">
      <span style="background:${g.shift===2?'#fed7aa':'#dbeafe'};color:${g.shift===2?'#c2410c':'#1e40af'};border-radius:5px;padding:1px 6px;font-size:.68rem">Б${g.shift||1}</span>
      ${g.name}${g.code?` <span style="color:var(--muted);font-weight:400;font-size:.72rem">${g.code}</span>`:''}
    </div>`).join('');
}
function addGroupToTeacher(tid,gid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  if(!t.groupPerms[gid])t.groupPerms[gid]={att:true,list:false,allowedLessons:[]};
  else{t.groupPerms[gid].att=true;}
  sv();
  // Hide dropdown and clear input
  const box=document.getElementById('gss-'+tid);if(box)box.style.display='none';
  const inp=document.getElementById('gsi-'+tid);if(inp)inp.value='';
  renderTeachers();
  // Reopen expanded state
  if(!expandedTeachers.has(tid))expandedTeachers.add(tid);
  renderTeachers();
  toast('Гурӯҳ илова шуд ✅');
}
function togglePerm(tid,perm){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.perms)t.perms=[];
  if(t.perms.includes(perm))t.perms=t.perms.filter(x=>x!==perm);else t.perms.push(perm);
  sv();renderTeachers();
}
function toggleViewPerm(tid){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  t.canChangeView=!t.canChangeView;sv();renderTeachers();
}
function toggleGPerm(tid,gid,type){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  if(!t.groupPerms[gid])t.groupPerms[gid]={att:false,list:false,allowedLessons:[]};
  t.groupPerms[gid][type]=!t.groupPerms[gid][type];
  if(type==='att' && !t.groupPerms[gid].att){
    t.groupPerms[gid].allowedLessons=[];
  }
  sv();renderTeachers();
}
function toggleLessonPerm(tid,gid,lid,checked){
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  if(!t.groupPerms[gid])t.groupPerms[gid]={att:false,list:false,allowedLessons:[]};
  if(!t.groupPerms[gid].allowedLessons)t.groupPerms[gid].allowedLessons=[];
  if(checked){
    if(!t.groupPerms[gid].allowedLessons.includes(lid)){
      t.groupPerms[gid].allowedLessons.push(lid);
    }
  }else{
    t.groupPerms[gid].allowedLessons = t.groupPerms[gid].allowedLessons.filter(id=>id!==lid);
  }
  sv();renderTeachers();
}

// ══════════════════════════════════════════
//  SUPABASE CONFIG MANAGEMENT
// ══════════════════════════════════════════
function renderSbConfig(){
  const u=document.getElementById('sb-url');
  const k=document.getElementById('sb-key');
  if(u)u.value=localStorage.getItem('sb_url')||'';
  if(k)k.value=localStorage.getItem('sb_key')||'';
  // Show current status
  if(sbConfigured()) setSbStatus('☁️ Пайваст аст: '+SUPABASE_URL,'#f0f9ff','#0369a1');
}
function saveSbConfig(){
  const url=document.getElementById('sb-url').value.trim();
  const key=document.getElementById('sb-key').value.trim();
  if(!url||!key){setSbStatus('❌ URL ва Key-ро ворид кунед','#fee2e2','#dc2626');return;}
  // Save directly as individual keys (used on next load)
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  localStorage.setItem('sb_cfg', JSON.stringify({url, key}));
  setSbStatus('✅ Нигоҳ шуд — барои пайваст тугмаи "Санҷиш" занед','#dcfce7','#166534');
  // Re-init Supabase client with new credentials
  SUPABASE_URL = url;
  SUPABASE_KEY = key;
  _initSb();
  updateSyncStatus('syncing');
  // Try connecting
  lDBCloud().then(ok => {
    if(ok){ updateSyncStatus('online'); startRealtimeSync(); _initDefaults(); renderGroups?.(); buildLoginSelect?.(); setSbStatus('✅ Пайваст шуд ва маълумот гирифта шуд!','#dcfce7','#166534'); }
    else { updateSyncStatus('offline'); setSbStatus('⚠️ Нигоҳ шуд, аммо пайваст нашуд. URL/Key-ро санҷед','#fef9c3','#854d0e'); }
  });
}
async function testSbConn(){
  const url=document.getElementById('sb-url').value.trim()||SUPABASE_URL;
  const key=document.getElementById('sb-key').value.trim()||SUPABASE_KEY;
  setSbStatus('🔄 Санҷиш дар ҷараён...','#f0f9ff','#0369a1');
  try{
    const r=await fetch(`${url}/rest/v1/davomat_data?limit=1`,{headers:{'apikey':key,'Authorization':'Bearer '+key}});
    if(r.ok||r.status===406){setSbStatus('✅ Пайвасти бомуваффақ!','#dcfce7','#166534');}
    else setSbStatus(`❌ Хато ${r.status}: ${r.statusText}`,'#fee2e2','#dc2626');
  }catch(e){setSbStatus('❌ Пайваст нашуд: '+e.message,'#fee2e2','#dc2626');}
}
function setSbStatus(msg,bg,color){
  const el=document.getElementById('sb-status');
  if(!el)return;el.textContent=msg;el.style.background=bg;el.style.color=color;el.style.display='block';
}
async function pushToCloud(){
  setSbStatus('⬆️ Боргузорӣ дар ҷараён...','#f0f9ff','#0369a1');
  try {
    // 1. Push groups + settings
    await Promise.all([sbSet('groups', db.groups), sbSet('settings', db.settings)]);
    // 2. Push all attendance cells
    const attRows=[];
    Object.entries(db.attendance||{}).forEach(([gid,gatt])=>{
      Object.entries(gatt||{}).forEach(([attKey,status])=>{
        const parts=attKey.split('_');
        const sid=parts[0], att_date=parts[1], lid=parts.slice(2).join('_');
        attRows.push({id:`${gid}:${attKey}`,gid,sid,att_date,lid,status,updated_at:new Date().toISOString()});
      });
    });
    if(attRows.length){
      // Upsert in batches of 500
      for(let i=0;i<attRows.length;i+=500){
        await _sb.from('davomat_att').upsert(attRows.slice(i,i+500),{onConflict:'id'});
      }
    }
    setSbStatus(`✅ Боргузорӣ шуд! Гурӯҳ: ${db.groups?.length||0}, Ячейкаҳои давомот: ${attRows.length}`,'#dcfce7','#166534');
  } catch(e) {
    setSbStatus('❌ Хато: '+e.message,'#fee2e2','#dc2626');
  }
}
async function pullFromCloud(){
  setSbStatus('⬇️ Гирифтан...','#f0f9ff','#0369a1');
  const ok=await lDBCloud();
  if(ok){_initDefaults();renderGroups();buildLoginSelect();setSbStatus('✅ Маълумот аз Cloud гирифта шуд!','#dcfce7','#166534');}
  else setSbStatus('❌ Гирифтан нашуд','#fee2e2','#dc2626');
}

// Supabase config аз localStorage дар боло бор шуд (sb_url, sb_key)
// Re-init client if config exists
if(sbConfigured()) _initSb();

// ═══════════════════════════════════════════════════════
//  SUBJECT MANAGEMENT (multi-subject per teacher per group)
// ═══════════════════════════════════════════════════════

// Get all subject-group combinations for a teacher (for login)
function getTeacherSubjects(t){
  const result=[];
  const gp=t.groupPerms||{};
  Object.entries(gp).forEach(([gid,gperm])=>{
    const g=db.groups.find(x=>x.id===gid);if(!g)return;
    const subjects=gperm.subjects||[];
    subjects.forEach(subj=>{
      result.push({gid,groupName:g.name,shift:g.shift||1,subjId:subj.id,subjName:subj.name,lessonId:subj.lessonId});
    });
  });
  return result;
}

// Login: when teacher selected, show subject dropdown
function onLoginWhoChange(){
  // No subject selection on login screen — teacher selects inside cabinet
}

// Open "Add Subject" modal for a teacher-group
function openAddSubject(tid,gid){
  document.getElementById('as-tid').value=tid;
  document.getElementById('as-gid').value=gid;
  document.getElementById('as-name').value='';
  openModal('m-add-subj');
}
function saveAddSubject(){
  const tid=document.getElementById('as-tid').value;
  const gid=document.getElementById('as-gid').value;
  const name=document.getElementById('as-name').value.trim();
  if(!name){toast('Номи фанро ворид кунед!');return;}
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms)t.groupPerms={};
  if(!t.groupPerms[gid])t.groupPerms[gid]={subjects:[],att:true,list:false,allowedLessons:[]};
  if(!t.groupPerms[gid].subjects)t.groupPerms[gid].subjects=[];
  // Check duplicate name
  if(t.groupPerms[gid].subjects.some(s=>s.name.toLowerCase()===name.toLowerCase())){
    toast('Ин фан аллакай вуҷуд дорад!');return;
  }
  // Subject without lessonId — schedule set via тақвим
  t.groupPerms[gid].subjects.push({id:uid(),name,lessonId:null});
  t.groupPerms[gid].att=true;
  // allowedLessons = from schedule (handled by getAllowedLessonIds)
  sv();closeModal('m-add-subj');renderTeachers();buildLoginSelect();
  toast('Фан илова шуд ✅');
}
function removeSubject(tid,gid,subjId){
  if(!confirm('Ин фанро ҳазф кунем?'))return;
  const t=db.settings.teachers.find(x=>x.id===tid);if(!t)return;
  if(!t.groupPerms?.[gid]?.subjects)return;
  t.groupPerms[gid].subjects=t.groupPerms[gid].subjects.filter(s=>s.id!==subjId);
  t.groupPerms[gid].allowedLessons=t.groupPerms[gid].subjects.map(s=>s.lessonId);
  if(!t.groupPerms[gid].subjects.length)t.groupPerms[gid].att=false;
  sv();renderTeachers();buildLoginSelect();toast('Фан ҳазф шуд');
}

// Transfer subject to another teacher
function openTransferSubject(fromTid,gid,subjId){
  const fromT=db.settings.teachers.find(x=>x.id===fromTid);if(!fromT)return;
  const subj=fromT.groupPerms?.[gid]?.subjects?.find(s=>s.id===subjId);if(!subj)return;
  const g=db.groups.find(x=>x.id===gid);
  document.getElementById('ts-from-tid').value=fromTid;
  document.getElementById('ts-gid').value=gid;
  document.getElementById('ts-subj-id').value=subjId;
  document.getElementById('ts-info').innerHTML=
    `<b>Фан:</b> ${subj.name}<br><b>Гурӯҳ:</b> ${g?.name||gid}<br><b>Аз:</b> ${fromT.last} ${fromT.first}`;
  const sel=document.getElementById('ts-to-tid');
  sel.innerHTML='<option value="">— Омӯзгорро интихоб кунед —</option>'+
    db.settings.teachers
      .filter(t=>t.id!==fromTid)
      .map(t=>`<option value="${t.id}">${t.last} ${t.first}${t.subject?' — '+t.subject:''}</option>`)
      .join('');
  openModal('m-transfer-subj');
}
function confirmTransferSubject(){
  const fromTid=document.getElementById('ts-from-tid').value;
  const gid=document.getElementById('ts-gid').value;
  const subjId=document.getElementById('ts-subj-id').value;
  const toTid=document.getElementById('ts-to-tid').value;
  if(!toTid){toast('Омӯзгорро интихоб кунед!');return;}
  const fromT=db.settings.teachers.find(x=>x.id===fromTid);
  const toT=db.settings.teachers.find(x=>x.id===toTid);
  if(!fromT||!toT)return;
  const subj=fromT.groupPerms?.[gid]?.subjects?.find(s=>s.id===subjId);if(!subj)return;
  // Add to new teacher
  if(!toT.groupPerms)toT.groupPerms={};
  if(!toT.groupPerms[gid])toT.groupPerms[gid]={subjects:[],att:true,list:false,allowedLessons:[]};
  if(!toT.groupPerms[gid].subjects)toT.groupPerms[gid].subjects=[];
  toT.groupPerms[gid].subjects.push({...subj,id:uid()});
  toT.groupPerms[gid].att=true;
  toT.groupPerms[gid].allowedLessons=toT.groupPerms[gid].subjects.map(s=>s.lessonId);
  // Remove from old teacher
  fromT.groupPerms[gid].subjects=fromT.groupPerms[gid].subjects.filter(s=>s.id!==subjId);
  fromT.groupPerms[gid].allowedLessons=fromT.groupPerms[gid].subjects.map(s=>s.lessonId);
  if(!fromT.groupPerms[gid].subjects.length)fromT.groupPerms[gid].att=false;
  // NOTE: db.attendance stays unchanged — same lessonId, same keys
  sv();closeModal('m-transfer-subj');renderTeachers();buildLoginSelect();
  toast(`✅ ${subj.name} → ${toT.last} ${toT.first} интиқол шуд`);
}

// JSON Backup
function expJSON(){dl(JSON.stringify(db,null,2),'davomat_backup_'+new Date().toISOString().slice(0,10)+'.json','application/json');toast('JSON Backup ✅');}
function impJSON(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{db=JSON.parse(ev.target.result);sv();renderGroups();toast('JSON импорт ✅');}catch(err){toast('Хато: файл нодуруст!');}};r.readAsText(f,'UTF-8');}
function clearAll(){if(!confirm('Ҳамаро тоза мекунем?'))return;const sh=db.settings.shifts;const adminPw=db.settings.adminPw;db={groups:[],attendance:{},settings:{instName:'',teacherName:'',adminPw,shifts:sh,teachers:[]}};sv();renderGroups();toast('Тоза шуд');}

// ============================================
//  MODAL / TOAST
// ============================================
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));
let _tt;
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>t.classList.remove('show'),2700);}

// ============================================
//  INIT
// ============================================
lDB(); // Load from localStorage first (instant)
_initDefaults();

document.addEventListener('click', e=>{
  document.querySelectorAll('[id^="gss-"]').forEach(el=>{
    if(!el.contains(e.target)&&!e.target.id?.startsWith('gsi-'))el.style.display='none';
  });
});
updDL();updML();updSmsD();updSmsM();
buildLoginSelect();
document.getElementById('main-hdr').style.display='none';

// Then load from Supabase (async — updates UI when ready)
(async()=>{
  if(SUPABASE_URL.includes('YOUR_PROJECT')){
    updateSyncStatus('offline');
    return;
  }
  updateSyncStatus('syncing');
  const ok = await lDBCloud();
  if(ok){
    updateSyncStatus('online');
    _initDefaults();
    buildLoginSelect();
    startRealtimeSync();
  } else {
    updateSyncStatus('offline');
  }
})();

</script>

<!-- ===== Stats Scale Control (safe, single) ===== -->
<script>
(function(){
  // avoid double-declare if file is edited again
  if (typeof window.statsScale === "undefined") window.statsScale = 1;

  window.scaleStats = function(val){
    window.statsScale = val;
    var el = document.getElementById('page-stats');
    if(!el) return;
    el.style.transform = "scale(" + window.statsScale + ")";
    el.style.transformOrigin = "top center";
  };
})();
</script>

<script>

// ══ PWA SERVICE WORKER ══
(function() {
  if ('serviceWorker' in navigator) {
    const swCode = atob('Y29uc3QgQ0FDSEUgPSAnZGF2b21hdC12MTInOwpjb25zdCBBU1NFVFMgPSBbc2VsZi5sb2NhdGlvbi5ocmVmIHx8ICcvJ107CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCBlID0+IHsKICBlLndhaXRVbnRpbCgKICAgIGNhY2hlcy5vcGVuKENBQ0hFKS50aGVuKGMgPT4gYy5hZGRBbGwoQVNTRVRTKSkudGhlbigoKSA9PiBzZWxmLnNraXBXYWl0aW5nKCkpCiAgKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2FjdGl2YXRlJywgZSA9PiB7CiAgZS53YWl0VW50aWwoCiAgICBjYWNoZXMua2V5cygpLnRoZW4oa2V5cyA9PgogICAgICBQcm9taXNlLmFsbChrZXlzLmZpbHRlcihrID0+IGsgIT09IENBQ0hFKS5tYXAoayA9PiBjYWNoZXMuZGVsZXRlKGspKSkKICAgICkudGhlbigoKSA9PiBzZWxmLmNsaWVudHMuY2xhaW0oKSkKICApOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBlID0+IHsKICAvLyBOZXR3b3JrIGZpcnN0LCBmYWxsYmFjayB0byBjYWNoZQogIGUucmVzcG9uZFdpdGgoCiAgICBmZXRjaChlLnJlcXVlc3QpCiAgICAgIC50aGVuKHIgPT4gewogICAgICAgIGlmKHIgJiYgci5zdGF0dXMgPT09IDIwMCAmJiBlLnJlcXVlc3QubWV0aG9kID09PSAnR0VUJykgewogICAgICAgICAgY29uc3QgY2xvbmUgPSByLmNsb25lKCk7CiAgICAgICAgICBjYWNoZXMub3BlbihDQUNIRSkudGhlbihjID0+IGMucHV0KGUucmVxdWVzdCwgY2xvbmUpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0pCiAgICAgIC5jYXRjaCgoKSA9PiBjYWNoZXMubWF0Y2goZS5yZXF1ZXN0KSkKICApOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGUgPT4gewogIGlmKGUuZGF0YSA9PT0gJ3NraXBXYWl0aW5nJykgc2VsZi5za2lwV2FpdGluZygpOwp9KTs=');
    const blob = new Blob([swCode], {type: 'application/javascript'});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl, {scope: './'} )
      .then(reg => {
        console.log('SW registered ✅', reg.scope);
        // Update check
        reg.update();
      })
      .catch(err => console.warn('SW registration failed:', err));
  }
})();


// ══ PWA INSTALL PROMPT ══
let _pwaPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _pwaPrompt = e;
  // Show install button if user is logged in
  const btn = document.getElementById('pwa-install-btn');
  if(btn) btn.style.display = 'flex';
});

function pwaInstall() {
  const statusEl = document.getElementById('pwa-status-text');
  if(!_pwaPrompt) {
    // Manual instructions
    const isChrome = /chrome/i.test(navigator.userAgent);
    const isSafari = /safari/i.test(navigator.userAgent) && !/chrome/i.test(navigator.userAgent);
    let msg = '';
    if(isChrome) msg = '💡 Chrome: Меню (⋮) → "Ба экран илова кунед" -ро пахш кунед';
    else if(isSafari) msg = '💡 Safari: Тугмаи "Share" → "Ба экрани асосӣ илова"';
    else msg = '💡 Браузери меню → "Ба экран илова кунед"';
    toast(msg.slice(3)); // remove emoji for toast
    if(statusEl) { statusEl.textContent = msg; statusEl.style.color = 'var(--yellow)'; }
    return;
  }
  _pwaPrompt.prompt();
  _pwaPrompt.userChoice.then(r => {
    if(r.outcome === 'accepted') {
      toast('✅ Давомот ба телефон насб шуд!');
      if(statusEl) { statusEl.textContent = '✅ Барнома муваффақона насб шуд!'; statusEl.style.color = 'var(--green)'; }
    } else {
      toast('Насбкунӣ бекор карда шуд');
    }
    _pwaPrompt = null;
    const btn = document.getElementById('pwa-install-btn');
    if(btn) btn.style.display = 'none';
  });
}

window.addEventListener('appinstalled', () => {
  toast('🎉 Давомот муваффақона насб шуд!');
  const btn = document.getElementById('pwa-install-btn');
  if(btn) btn.style.display = 'none';
  const statusEl = document.getElementById('pwa-status-text');
  if(statusEl) { statusEl.textContent = '✅ Барнома насб аст — экрани асосиро бубинед!'; statusEl.style.color = 'var(--green)'; }
});

</script>
</body>
</html>
